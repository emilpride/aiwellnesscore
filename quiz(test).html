<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Wellness Analysis - Final Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core/dist/tf-core.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter/dist/tf-converter.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --brand-accent: #debea9;
            --brand-dark-text: #3c3b31;
        }
        html, body { overscroll-behavior: none; font-family: 'Inter', sans-serif; }
        body { background-color: #f3f4f6; }
        #quiz-container { display: flex; flex-direction: column; position: relative; width: 100vw; height: 100vh; height: calc(var(--vh, 1vh) * 100); overflow: hidden; }
        main#steps-wrapper { position: relative; width: 100%; flex-grow: 1; overflow: hidden; }
        .quiz-step {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; background-color: transparent;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease-out;
            opacity: 1; overflow-y: auto;
        }
        .quiz-step:not(.active) { opacity: 0; pointer-events: none; transform: translateX(30px) scale(0.98); }
        .quiz-step.active { transform: translateX(0) scale(1); }
        .quiz-step.prev { transform: translateX(-30px) scale(0.98); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* A11Y: Сброс стилей для кнопок, чтобы они выглядели как div'ы */
        button.answer-option, button.gender-option {
            background: none;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
            text-align: inherit;
        }

        .answer-option { transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; }
        .answer-option:hover:not(:disabled) { transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .answer-option.selected { transform: translateY(-5px) scale(1.02); border-color: var(--brand-accent); box-shadow: 0 0 20px rgba(222, 190, 169, 0.6); }
        .answer-option:disabled { opacity: 0.7; cursor: not-allowed; }

        /* --- СТИЛИ КАМЕРЫ И AR --- */
        #camera-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden; border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        #camera-guide-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); text-align: center; pointer-events: none; }
        #camera-guide-box { width: 70%; aspect-ratio: 1/1.2; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        #camera-guide-box.locked { border-color: #34d399; box-shadow: 0 0 20px #34d399; }
        #camera-countdown { font-size: 5rem; font-weight: 800; position: absolute; }
        
        /* --- СТИЛИ ПРОМЕЖУТОЧНЫХ АНИМАЦИЙ --- */
        .widget-wrapper { background-color: #fff; padding: 1.5rem; border-radius: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #f3f4f6; width: 100%; max-width: 320px; text-align: center; }
        .widget-label { font-weight: 600; color: #4b5563; margin-bottom: 1rem; }
        .bmi-gauge-bg { fill: none; stroke: #e5e7eb; }
        .bmi-gauge-fg { fill: none; stroke: url(#bmi-gradient); stroke-linecap: round; transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .sleep-ring-bg { stroke: #e5e7eb; }
        .sleep-ring-fg { stroke: #818cf8; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .activity-week { display: flex; justify-content: space-around; gap: 8px; }
        .activity-day { width: 36px; height: 36px; border-radius: 10px; background-color: #e5e7eb; color: #6b7280; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .activity-day.active { background-color: var(--brand-accent); color: var(--brand-dark-text); transform: scale(1.15) translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        @keyframes breathe { 0%, 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.1); } 50% { transform: scale(1); box-shadow: 0 0 20px 10px rgba(0, 0, 0, 0.05); } }
        .stress-breather {
            width: 120px; height: 120px; margin: 1rem auto; border-radius: 50%;
            animation-name: breathe;
            animation-iteration-count: infinite;
            transition: background-color 1s ease;
        }
    </style>
</head>
<body>

<div id="quiz-container">
    <header id="quiz-header" class="w-full p-4">
        </header>

    <main id="steps-wrapper">
        <section id="step-0" class="quiz-step active">
            </section>

        <section id="step-1" class="quiz-step prev">
            <div class="question-content w-full max-w-4xl text-center">
                <h2 class="text-3xl font-bold text-gray-900">To personalize your plan...</h2>
                <p class="mt-2 text-lg text-gray-600">Which do you identify with?</p>
                <div class="grid grid-cols-3 gap-4 max-w-4xl mx-auto mt-6">
                    <button class="gender-option answer-option cursor-pointer bg-white p-2 sm:p-4 rounded-2xl flex flex-col items-center justify-end aspect-[3/4] border-2 border-transparent" data-value="Female">
                        <img src="female.png" alt="Female" class="h-full object-contain gender-image">
                        <p class="mt-2 sm:mt-4 text-lg sm:text-xl font-bold text-gray-800">Female</p>
                    </button>
                    <button class="gender-option answer-option cursor-pointer bg-white p-2 sm:p-4 rounded-2xl flex flex-col items-center justify-end aspect-[3/4] border-2 border-transparent" data-value="Male">
                        <img src="male.png" alt="Male" class="h-full object-contain gender-image">
                        <p class="mt-2 sm:mt-4 text-lg sm:text-xl font-bold text-gray-800">Male</p>
                    </button>
                    <button class="gender-option answer-option cursor-pointer bg-white p-2 sm:p-4 rounded-2xl flex flex-col items-center justify-end aspect-[3/4] border-2 border-transparent" data-value="Other">
                         <img src="other.png" alt="Other" class="h-full object-contain gender-image">
                        <p class="mt-2 sm:mt-4 text-lg sm:text-xl font-bold text-gray-800">Other</p>
                    </button>
                </div>
            </div>
        </section>

        <section id="step-2" class="quiz-step prev">
            <div id="question-wrapper" class="w-full max-w-2xl"></div>
        </section>
        
        <section id="step-3" class="quiz-step prev">
            </section>
        
        <section id="step-4" class="quiz-step prev">
            </section>

        <section id="step-5" class="quiz-step prev">
            </section>
        
        <section id="step-6" class="quiz-step prev text-center">
            <div class="animate-fade-in">
                <div id="lottie-thank-you" class="w-48 h-48 mx-auto"></div>
                <h1 class="text-4xl font-extrabold text-gray-900 mt-4">Thank You!</h1>
                <p class="text-lg text-gray-600 mt-2 max-w-md mx-auto">Your personalized wellness report is on its way to your inbox. Get ready to start your journey!</p>
            </div>
        </section>
    </main>

    <footer id="quiz-footer" class="w-full z-10">
        <div id="footer-actions" class="w-full max-w-3xl mx-auto"></div>
    </footer>
</div>

<div id="camera-modal">
    <div id="camera-container">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas"></canvas>
        <div id="camera-guide-overlay">
            <h3 id="camera-guide-text" class="text-lg font-semibold">Расположите лицо в овале</h3>
            <div id="camera-guide-box"></div>
            <div id="camera-countdown"></div>
        </div>
    </div>
</div>
<canvas id="photo-canvas" style="display: none;"></canvas>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        currentStep: 0,
        currentQuestionIndex: -1,
        userAnswers: {},
        userPhotoUrl: null,
        cameraStream: null,
        // AR State
        faceMesh: null,
        cameraAnimFrame: null,
        countdownTimer: null,
        countdownValue: 3,
        // Quiz Data
        quizQuestions: [
            { key: 'gender', type: 'gender_selection' },
            { key: 'userGoal', type: 'options', text: "What's your primary wellness goal?", options: ['Find out my biological age', 'Get a skin condition analysis', 'Get a 7-day improvement plan', 'All of the above!'] },
            { key: 'age', type: 'slider', text: "What's your current age?", min: 18, max: 90, defaultValue: 30, unit: 'years' },
            { key: 'height', type: 'slider', text: "What is your height?", min: 140, max: 220, defaultValue: 175, unit: 'cm' },
            { key: 'weight', type: 'slider', text: "And your current weight?", min: 40, max: 150, defaultValue: 77, unit: 'kg' },
            { key: 'bmi_calculation', type: 'animation' },
            { key: 'sleep', type: 'options', text: "😴 How many hours of quality sleep do you get on average?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], values: [4, 6, 8, 9] },
            { key: 'sleep_visual', type: 'animation' },
            { key: 'activity', type: 'options', text: "🏃‍♀️ How often do you engage in moderate physical activity per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], values: [1, 3, 5, 7] },
            { key: 'activity_visual', type: 'animation' },
            { key: 'stress', type: 'options', text: "🧠 How have you been feeling lately?", options: [ { text: "🧘‍♀️ Calm & Relaxed", value: 2 }, { text: "🙂 Mostly Okay", value: 4 }, { text: " A bit busy", value: 6 }, { text: "🥵 Overwhelmed", value: 8 } ] },
            { key: 'stress_visual', type: 'animation' },
            { key: 'selfie', type: 'camera_step', text: 'AI Photo Analysis', subtext: 'Our AI analyzes your face for non-medical indicators of stress and fatigue. Your photo is deleted instantly after analysis.'},
            { key: 'email', type: 'email_input', text: 'Where should we send your full report?', subtext: 'Get your 10-page wellness analysis delivered to your inbox.' },
        ],
    };

    // --- State Management (LocalStorage) ---
    function saveState() {
        const stateToSave = {
            answers: App.userAnswers,
            index: App.currentQuestionIndex,
            photoUrl: App.userPhotoUrl
        };
        localStorage.setItem('wellnessQuizState', JSON.stringify(stateToSave));
    }

    function loadState() {
        const savedState = localStorage.getItem('wellnessQuizState');
        if (savedState) {
            const data = JSON.parse(savedState);
            App.userAnswers = data.answers || {};
            App.userPhotoUrl = data.photoUrl || null;
            // Устанавливаем индекс на шаг раньше, т.к. next() его увеличит
            App.currentQuestionIndex = (data.index || 0) - 1; 
            
            // Пропускаем онбординг и сразу начинаем опрос
            document.getElementById('step-0').style.display = 'none';
            next();
        }
    }

    // --- Core App Logic ---
    function goToStep(stepIndex) {
        App.currentStep = stepIndex;
        document.querySelectorAll('.quiz-step').forEach((step, index) => {
            step.classList.remove('active', 'prev');
            if (index === stepIndex) step.classList.add('active');
            else if (index < stepIndex) step.classList.add('prev');
        });

        // Показываем/скрываем header/footer
        const isQuizActive = (stepIndex === 1 || stepIndex === 2);
        document.getElementById('quiz-footer').style.display = isQuizActive ? 'block' : 'none';
        // ... (остальная логика для header)
    }

    function handleAnswer(questionKey, answer) {
        App.userAnswers[questionKey] = answer;
        if (questionKey === 'selfie') { App.userPhotoUrl = answer; }
        saveState();
        next();
    }

    function next() {
        App.currentQuestionIndex++;
        const stepConfig = App.quizQuestions[App.currentQuestionIndex];
        if (!stepConfig) {
            // Если вопросы закончились, но мы не на последнем шаге, значит что-то не так.
            // Вместо анализа переходим на страницу профиля, если ответы уже есть.
            goToStep(4);
            // renderWellnessProfile(); // Предполагается, что эта функция будет вызвана
            return;
        }

        switch (stepConfig.type) {
            case 'animation':
                goToStep(2);
                renderAnimation(stepConfig.key);
                break;
            case 'gender_selection':
                goToStep(1);
                // renderGenderSelection(); // Вызывается внутри renderQuestion
                renderQuestion(); // Используем единую функцию
                break;
            default:
                goToStep(2);
                renderQuestion();
                break;
        }
        // ... (логика кнопки "назад" и прогресс-бара)
    }
    
    // --- Rendering Functions ---
    function renderQuestion() {
        const question = App.quizQuestions[App.currentQuestionIndex];
        if (!question) return;

        let wrapper, footerWrapper;
        
        if(question.type === 'gender_selection') {
            wrapper = document.querySelector('#step-1 .question-content');
            // Очищаем футер, т.к. у этого шага свои кнопки
            document.getElementById('footer-actions').innerHTML = '';
            wrapper.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900">To personalize your plan...</h2>
                <p class="mt-2 text-lg text-gray-600">Which do you identify with?</p>
                <div class="grid grid-cols-3 gap-4 max-w-4xl mx-auto mt-6">
                    <button class="gender-option answer-option ..." data-value="Female">...</button>
                    <button class="gender-option answer-option ..." data-value="Male">...</button>
                    <button class="gender-option answer-option ..." data-value="Other">...</button>
                </div>`;
            wrapper.querySelectorAll('.answer-option').forEach(btn => {
                btn.addEventListener('click', (e) => handleOptionClick(e, 'gender', btn.dataset.value));
            });
            return;
        }

        wrapper = document.getElementById('question-wrapper');
        footerWrapper = document.getElementById('footer-actions');
        wrapper.innerHTML = `<h2 class="text-3xl font-bold text-gray-900 text-center">${question.text}</h2>`;
        footerWrapper.innerHTML = ''; // Clear previous buttons

        if (question.type === 'options') {
            const optionsHTML = question.options.map((opt, index) => {
                const displayText = typeof opt === 'object' ? opt.text : opt;
                const value = typeof opt === 'object' ? opt.value : (question.values ? question.values[index] : opt);
                return `<button class="answer-option w-full bg-white p-4 rounded-xl border-2 border-gray-200 text-lg font-semibold text-gray-700" data-value="${value}">${displayText}</button>`;
            }).join('');
            footerWrapper.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-lg mx-auto">${optionsHTML}</div>`;
            footerWrapper.querySelectorAll('.answer-option').forEach(btn => {
                 btn.addEventListener('click', (e) => handleOptionClick(e, question.key, btn.dataset.value));
            });
        } else if (question.type === 'email_input') {
            // ... (код для email input)
            // Важно: в обработчике клика вместо handleAnswer вызываем goToStep(6)
            const emailBtn = footerWrapper.querySelector('#email-confirm-btn');
            emailBtn.addEventListener('click', () => {
                // ... (валидация email)
                if (valid) {
                    App.userAnswers[question.key] = emailInput.value;
                    saveState();
                    goToStep(6);
                    lottie.loadAnimation({ container: document.getElementById('lottie-thank-you'), renderer: 'svg', loop: false, autoplay: true, path: 'thank-you.json' });
                }
            });
        }
        // ... (остальные типы вопросов: slider, camera_step)
    }

    function handleOptionClick(event, key, value) {
        const clickedButton = event.currentTarget;
        const parent = clickedButton.parentElement;
        
        // Disable all buttons
        parent.querySelectorAll('.answer-option').forEach(btn => {
            btn.disabled = true;
        });
        
        clickedButton.classList.add('selected');
        
        setTimeout(() => handleAnswer(key, value), 400);
    }
    
    function renderAnimation(key) {
        // ... (код для renderAnimation, как в предыдущем ответе)
        // UX Улучшение: уменьшаем задержку
        setTimeout(next, 2200);
    }

    function playAnimation(key) {
        // ... (код для playAnimation, как в предыдущем ответе, включая ИСПРАВЛЕННУЮ логику для stress_visual)
    }

    // --- AR Camera Logic ---
    let faceMesh;
    async function initFaceAnalysis() { /* ... как в предыдущем ответе ... */ }
    function onFaceResults(results) { /* ... как в предыдущем ответе ... */ }
    function checkFacePosition(landmarks) { /* ... как в предыдущем ответе ... */ }
    function startCountdown() { /* ... как в предыдущем ответе ... */ }
    function resetCountdown() { /* ... как в предыдущем ответе ... */ }
    async function predictWebcam() { /* ... как в предыдущем ответе ... */ }
    async function openCamera() { /* ... как в предыдущем ответе ... */ }
    function closeCamera() { /* ... как в предыдущем ответе ... */ }
    function capturePhoto() { /* ... как в предыдущем ответе ... */ }


    // --- App Initialization ---
    // setVh();
    // window.addEventListener('resize', setVh);
    loadState(); // Пытаемся загрузить состояние при старте
});
</script>
</body>
</html>
