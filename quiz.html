<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI WELLNESSCORE - Your Personalized Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0c4a6e);
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite;
            color: #e5e7eb;
        }
        #app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: rgba(15, 23, 42, 0.7);
        }
        @media (min-width: 640px) {
            body {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            }
            #app-container {
                max-width: 672px;
                height: 90vh;
                max-height: 850px;
                border-radius: 1rem;
                box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
                border: 1px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
            }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes typing-bubble {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }
        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            animation: typing-bubble 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .lottie-avatar {
            width: 32px;
            height: 32px;
        }
        #camera-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 50;
            /* display is controlled by the 'hidden' class */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 3 / 4;
            border-radius: 1.5rem;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: #000;
        }
        #video, #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #video {
            transform: scaleX(-1);
        }
        #camera-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            color: white;
            padding: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .progress-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 20;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #818cf8 0%, #34d399 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="progress-container sm:rounded-t-2xl">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <header class="p-4 border-b border-white/10 bg-slate-900/50 z-10 flex-shrink-0">
            <h1 class="text-xl font-bold text-center text-indigo-400">AI WELLNESSCORE</h1>
            <p class="text-sm text-center text-gray-400">Your path to a better you starts here</p>
        </header>

        <main id="chat-container" class="flex-1 p-4 sm:p-6 overflow-y-auto no-scrollbar">
            <div id="chat-content" class="space-y-6">
            </div>
        </main>

        <footer id="input-area" class="p-4 border-t border-white/10 bg-slate-800/60 flex-shrink-0">
            <div id="options-container" class="flex flex-nowrap gap-2 mb-3 overflow-x-auto no-scrollbar pb-2 justify-center">
            </div>
            <div id="text-input-container" class="flex items-center gap-2" style="display: none;">
                <input type="text" id="user-input" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-gray-400 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400" placeholder="Type your answer...">
                <button id="send-btn" class="bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform duration-200 transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" /></svg>
                </button>
            </div>
        </footer>
    </div>
   
    <div id="camera-modal" class="hidden">
        <button id="close-camera-btn" class="absolute top-4 right-4 text-white bg-black/50 rounded-full p-2 z-10">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div id="camera-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay-canvas"></canvas>
            <div id="camera-overlay">
                <p id="camera-status" class="text-lg font-medium bg-black bg-opacity-50 px-3 py-1 rounded-full">Initializing scanner...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
   
    <script>
        // --- STATE & DOM ELEMENTS ---
        const chatContent = document.getElementById('chat-content');
        const inputArea = document.getElementById('input-area');
        const optionsContainer = document.getElementById('options-container');
        const textInputContainer = document.getElementById('text-input-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const progressBar = document.getElementById('progressBar');
        const cameraModal = document.getElementById('camera-modal');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const videoEl = document.getElementById('video');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const cameraStatus = document.getElementById('camera-status');
       
        let sessionId = null;
        let currentQuestionIndex = 0;
        const userAnswers = {};
        const totalQuizQuestions = 15;
        let capturedPhotoDataUrl = null;

        // --- QUIZ DATA ---
        const quizQuestions = [
             { id: 'welcome', text: "Hello! I'm your personal AI Wellness Coach. I'll be guiding you through this analysis to help you discover insights about your well-being.", type: 'welcome', options: ["Let's Begin!"] },
            { id: 'disclaimer', text: "Before we begin, a quick heads-up: I'm an AI coach, not a medical doctor. This analysis is for educational purposes only and is not a substitute for professional medical advice. <b>All data, including your photo, is deleted immediately after you view the detailed report.</b><br><br>By continuing, you agree to our <a href='terms.html' target='_blank' class='underline text-indigo-300 hover:text-indigo-200'>Terms of Service</a> and <a href='privacy.html' target='_blank' class='underline text-indigo-300 hover:text-indigo-200'>Privacy Policy</a>.", type: 'disclaimer', options: ['I Understand & Agree'] },
            { id: 'age', text: "Great, let's begin! To start, what's your age?", reason: "Your age helps me calibrate your wellness metrics against demographic data, ensuring your results are relevant to your life stage.", type: 'chips_text', options: ['Under 18', '18-25', '26-35', '36-50', '50+'], placeholder: 'Or type your exact age...' },
            { id: 'gender', text: "Great start! Now, what's your biological sex?", reason: "This allows me to consider physiological differences that can influence wellness factors.", type: 'chips_text', options: ['Male', 'Female'], placeholder: 'Or prefer not to say...' },
            { id: 'height', text: "Perfect. Let's talk about your height. (e.g., 5 ft 10 in)", reason: "Your height and weight are used to calculate your Body Mass Index (BMI), a basic indicator of physical health.", type: 'chips_text', options: ["Under 5'0\"", "5'0\" - 5'5\"", "5'6\" - 5'11\"", "6'0\"+"], placeholder: 'Or type your exact height...' },
            { id: 'weight', text: "Thanks! And your current weight in pounds?", reason: "This, along with your height, gives us a baseline for physical wellness metrics.", type: 'chips_text', options: ['Under 120 lbs', '120-150 lbs', '151-180 lbs', '181-220 lbs', '220+ lbs'], placeholder: 'Or type your exact weight...' },
            { id: 'sleep', text: "Sleep is crucial. How many hours of <i>quality</i> sleep do you get on an average night?", reason: "Sleep is the foundation of recovery for both mind and body. The quality of your sleep reveals a lot about your overall well-being.", type: 'chips_text', options: ['Less than 5', '5-6 hours', '7-8 hours', 'More than 8'], placeholder: 'Or type a specific number...' },
            { id: 'activity', text: "Awesome. Movement is key! How often do you engage in moderate physical activity (like a brisk walk) per week?", reason: "Regular movement is vital for physical and mental health. This helps me understand your energy expenditure.", type: 'chips_text', options: ['Rarely', '1-2 times', '3-4 times', '5+ times'], placeholder: 'Or describe your routine...' },
            { id: 'nutrition', text: "Let's dive into nutrition. How many servings of fruits or vegetables do you typically eat per day?", reason: "This is a key indicator of your micronutrient intake, which fuels your body and brain.", type: 'chips_text', options: ['0-1', '2-3', '4-5', 'More than 5'], placeholder: 'Or type a specific number...' },
            { id: 'processed_food', text: "Honesty is the best policy here. How often do you eat processed or fast food in a typical week?", reason: "Understanding this habit helps me assess potential inflammation and energy level factors.", type: 'chips_text', options: ['Daily', 'A few times a week', 'Once a week', 'Rarely/Never'], placeholder: 'Or describe your habits...' },
            { id: 'hydration', text: "Hydration check! How many glasses of water (approx. 8 oz) do you drink per day?", reason: "Hydration impacts everything from cognitive function to physical performance. It's a simple but powerful wellness lever.", type: 'chips_text', options: ['1-2', '3-4', '5-6', '7+'], placeholder: 'Or type a specific amount...' },
            { id: 'stress', text: "Now for the mind. On a scale of 1 to 10, how would you rate your typical stress level?", reason: "Chronic stress is a major factor in overall wellness. Your self-perception here is a crucial piece of the puzzle.", type: 'chips_text', options: ['1-3 (Low)', '4-6 (Moderate)', '7-8 (High)', '9-10 (Very High)'], placeholder: 'Or type an exact number...' },
            { id: 'mindfulness', text: "Finding calm is a superpower. How often do you practice mindfulness, meditation, or deep breathing?", reason: "This tells me about the tools you use to manage stress and cultivate mental clarity.", type: 'chips_text', options: ['Daily', 'A few times a week', 'Occasionally', 'Never'], placeholder: 'Or describe your practice...' },
            { id: 'mood', text: "Let's check in with your emotions. How would you describe your overall mood on a typical day?", reason: "Your typical mood provides a snapshot of your emotional baseline and mental resilience.", type: 'chips_text', options: ['Energetic & Positive', 'Generally Content', 'Neutral', 'Often Fatigued or Low'], placeholder: 'Or describe in your own words...' },
            { id: 'alcohol', text: "Time for some lifestyle questions. How many alcoholic drinks do you have in a typical week?", reason: "Alcohol can significantly impact sleep quality, recovery, and mood. This helps me get a clearer picture.", type: 'chips_text', options: ['0', '1-3', '4-7', '8+'], placeholder: 'Or type a specific number...' },
            { id: 'smoking', text: "This is a safe space. Do you smoke or use tobacco products?", reason: "This is an important lifestyle factor with significant health implications that I need to consider.", type: 'chips_text', options: ['Yes, daily', 'Yes, occasionally', 'I quit', 'Never'], placeholder: 'Or clarify your situation...' },
            { id: 'screen_time', text: "Last question before the final step! How much time do you spend on screens (phone, computer, TV) outside of work?", reason: "Excessive screen time can affect your sleep, eye health, and mental state. This helps me understand your digital habits.", type: 'chips_text', options: ['Less than 2 hours', '2-4 hours', '4-6 hours', 'More than 6 hours'], placeholder: 'Or estimate your screen time...' },
            { id: 'camera', text: "You did it! That's all the questions. Now for the fun part: a quick selfie. This helps me analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored. Please allow camera access and position your face within the frame.", type: 'camera_button', options: ['Open Camera'] }
        ];

        // --- SERVER COMMUNICATION ---
        const API_ENDPOINT = '/.netlify/functions/quiz';
        async function startQuizSession() {
            try {
                const response = await fetch(API_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'startSession' }) });
                if (!response.ok) throw new Error('Server error');
                const data = await response.json();
                sessionId = data.sessionId;
            } catch (error) {
                console.error('Failed to start session:', error);
                addMessage("Sorry, I'm having trouble connecting. Please refresh.");
                inputArea.style.display = 'none';
            }
        }
        async function saveAnswerToServer(questionId, answer) {
            if (!sessionId) return;
            try {
                await fetch(API_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'saveAnswer', sessionId, questionId, answer }) });
            } catch (error) { console.error('Failed to save answer:', error); }
        }

        // --- CHAT UI LOGIC ---
        function getBotAvatar() {
            const avatar = document.createElement('div');
            avatar.className = 'flex-shrink-0 w-8 h-8 flex items-center justify-center';
            avatar.innerHTML = `<div class="lottie-avatar"></div>`;
            try { lottie.loadAnimation({ container: avatar.querySelector('.lottie-avatar'), renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' }); } catch(e) { console.error("Lottie failed:", e); }
            return avatar;
        }
        function getLargeLottieAvatar() {
            const container = document.createElement('div');
            container.id = 'lottie-avatar';
            container.className = 'w-48 h-48';
            try { lottie.loadAnimation({ container: container, renderer: 'svg', loop: true, autoplay: true, path: 'assistent.json' }); } catch(e) { console.error("Lottie failed:", e); }
            return container;
        }
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'fade-in flex w-full items-end gap-3 justify-start';
            const bubble = document.createElement('div');
            bubble.className = 'max-w-xs md:max-w-md p-3 rounded-2xl bg-indigo-600 text-white rounded-bl-lg flex items-center justify-center space-x-1';
            bubble.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            typingDiv.appendChild(getBotAvatar());
            typingDiv.appendChild(bubble);
            chatContent.appendChild(typingDiv);
            chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;
        }
        function hideTypingIndicator() { document.getElementById('typing-indicator')?.remove(); }
        function addWelcomeMessage(text) {
            const welcomeContainer = document.createElement('div');
            welcomeContainer.className = 'fade-in flex flex-col items-center text-center space-y-4 py-4';
            welcomeContainer.appendChild(getLargeLottieAvatar());
            const textDiv = document.createElement('div');
            textDiv.className = 'text-lg text-gray-200 max-w-sm';
            textDiv.innerHTML = text;
            welcomeContainer.appendChild(textDiv);
            chatContent.appendChild(welcomeContainer);
            chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;
        }
        function addMessage(htmlContent, sender = 'bot') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `max-w-xs md:max-w-md p-3 rounded-2xl ${sender === 'bot' ? 'bg-indigo-600 text-white rounded-bl-lg' : 'bg-slate-700 text-gray-200 rounded-br-lg'}`;
            messageDiv.innerHTML = htmlContent;
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = `fade-in flex w-full items-end gap-3 ${sender === 'bot' ? 'justify-start' : 'justify-end'}`;
            if (sender === 'bot') wrapperDiv.appendChild(getBotAvatar());
            wrapperDiv.appendChild(messageDiv);
            chatContent.appendChild(wrapperDiv);
            chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;
        }
        function updateProgressBar() {
            const answeredQuestions = Object.keys(userAnswers).length;
            progressBar.style.width = `${(answeredQuestions / totalQuizQuestions) * 100}%`;
        }
        function displayQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }
            const question = quizQuestions[currentQuestionIndex];
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                if (question.type === 'welcome') {
                    addWelcomeMessage(question.text);
                } else {
                    let messageHtml = question.text;
                    if (question.reason) {
                        messageHtml += `<br><span class='block mt-2 text-sm text-indigo-200 opacity-80'>${question.reason}</span>`;
                    }
                    addMessage(messageHtml);
                }
                setupInput(question);
            }, 1000 + Math.random() * 500);
        }
        function setupInput(question) {
            optionsContainer.innerHTML = '';
            textInputContainer.style.display = 'none';
            inputArea.style.display = 'block';
            const isSimpleAction = question.type === 'welcome' || question.type === 'disclaimer' || question.type === 'camera_button';
            optionsContainer.className = `flex gap-2 mb-3 pb-2 ${isSimpleAction ? 'justify-center' : 'flex-nowrap overflow-x-auto no-scrollbar'}`;
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = isSimpleAction 
                    ? "px-6 py-3 bg-indigo-500 border border-indigo-400 text-white rounded-full hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all duration-200 font-semibold"
                    : "flex-shrink-0 px-4 py-2 bg-slate-700 border border-slate-600 text-gray-200 rounded-full hover:bg-indigo-500 hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all duration-200";
                
                if (question.type === 'camera_button') {
                    button.onclick = () => handleCameraButtonClick();
                } else {
                    button.onclick = () => handleAnswer(option);
                }
                optionsContainer.appendChild(button);
            });

            if (question.type === 'chips_text') {
                textInputContainer.style.display = 'flex';
                userInput.placeholder = question.placeholder;
                userInput.value = '';
            }
        }
        function handleAnswer(answer) {
            if (!answer || !answer.trim()) return;
            const question = quizQuestions[currentQuestionIndex];
            if (question.type !== 'welcome' && question.type !== 'disclaimer') {
                userAnswers[question.id] = answer;
                saveAnswerToServer(question.id, answer);
                addMessage(answer, 'user');
                updateProgressBar();
            }
            currentQuestionIndex++;
            displayQuestion();
        }
        function handleCameraButtonClick() {
            addMessage("Opening camera...", 'bot');
            optionsContainer.innerHTML = '';
            inputArea.style.display = 'none';
            initCamera();
        }

        // --- CAMERA LOGIC ---
        let faceApiLoaded = false;
        let detectionInterval;
        let videoStream;

        async function loadFaceApiModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                cameraStatus.textContent = 'Loading AI models...';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
                ]);
                faceApiLoaded = true;
                cameraStatus.textContent = 'Position your face';
            } catch (error) {
                console.error("Error loading FaceAPI models:", error);
                addMessage("Sorry, there was a problem preparing the camera analysis. Please try refreshing the page.");
                closeCamera();
            }
        }

        async function initCamera() {
            cameraModal.classList.remove('hidden');

            // FIX: Wait for the next browser paint cycle to ensure the modal has dimensions
            requestAnimationFrame(async () => {
                if (!faceApiLoaded) {
                    await loadFaceApiModels();
                }
                if (!faceApiLoaded) return;

                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    videoEl.srcObject = videoStream;
                    videoEl.onloadedmetadata = () => {
                        videoEl.play();
                        // Now the dimensions will be correct
                        const displaySize = { width: videoEl.clientWidth, height: videoEl.clientHeight };
                        faceapi.matchDimensions(overlayCanvas, displaySize);
                        startFaceDetection(videoEl, overlayCanvas);
                    };
                } catch (err) {
                    console.error("Camera Error:", err);
                    let errorMessage = "Oops, I couldn't access your camera. Please check your browser permissions and refresh the page.";
                    if (err.name === 'NotAllowedError') errorMessage = "Camera access was denied. Please enable it in your browser settings and refresh.";
                    else if (err.name === 'NotFoundError') errorMessage = "No camera was found. Please connect one and refresh.";
                    addMessage(errorMessage);
                    closeCamera();
                }
            });
        }

        function closeCamera() {
            clearInterval(detectionInterval);
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            const context = overlayCanvas.getContext('2d');
            context.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            cameraModal.classList.add('hidden');
            inputArea.style.display = 'block';
            if (currentQuestionIndex < quizQuestions.length) {
                setupInput(quizQuestions[currentQuestionIndex]);
            }
        }

        function startFaceDetection(video, canvas) {
            const context = canvas.getContext('2d');
            let captureTimeout;
            let scanY = 0;
            let scanDirection = 1;

            detectionInterval = setInterval(async () => {
                if (!faceApiLoaded) return;

                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                const resizedDetections = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });

                context.clearRect(0, 0, canvas.width, canvas.height);
                context.save();
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
               
                if (resizedDetections.length > 0) {
                    const box = resizedDetections[0].detection.box;
                   
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                   
                    scanY += 2 * scanDirection;
                    if (scanY > box.height || scanY < 0) {
                        scanDirection *= -1;
                    }
                    context.fillStyle = 'rgba(0, 255, 255, 0.4)';
                    context.fillRect(box.x, box.y + scanY, box.width, 3);
                    context.shadowColor = 'rgba(0, 255, 255, 1)';
                    context.shadowBlur = 10;
                    context.fillRect(box.x, box.y + scanY, box.width, 3);
                    context.shadowBlur = 0;

                    context.strokeStyle = '#00FFFF';
                    context.lineWidth = 3;
                    const cornerLength = 20;
                    context.beginPath();
                    context.moveTo(box.x, box.y + cornerLength);
                    context.lineTo(box.x, box.y);
                    context.lineTo(box.x + cornerLength, box.y);
                    context.stroke();
                    context.beginPath();
                    context.moveTo(box.x + box.width - cornerLength, box.y);
                    context.lineTo(box.x + box.width, box.y);
                    context.lineTo(box.x + box.width, box.y + cornerLength);
                    context.stroke();
                    context.beginPath();
                    context.moveTo(box.x, box.y + box.height - cornerLength);
                    context.lineTo(box.x, box.y + box.height);
                    context.lineTo(box.x + cornerLength, box.y + box.height);
                    context.stroke();
                    context.beginPath();
                    context.moveTo(box.x + box.width - cornerLength, box.y + box.height);
                    context.lineTo(box.x + box.width, box.y + box.height);
                    context.lineTo(box.x + box.width, box.y + box.height - cornerLength);
                    context.stroke();
                   
                    const isGoodSize = box.width > canvas.width * 0.4;
                    if (isGoodSize) {
                        cameraStatus.textContent = "Hold still...";
                        if (!captureTimeout) {
                            captureTimeout = setTimeout(() => takePicture(video), 2000);
                        }
                    } else {
                        cameraStatus.textContent = "Move closer";
                        clearTimeout(captureTimeout);
                        captureTimeout = null;
                    }
                } else {
                    cameraStatus.textContent = "Position your face";
                    clearTimeout(captureTimeout);
                    captureTimeout = null;
                }
                context.restore();
            }, 100);
        }
       
        function takePicture(video) {
            clearInterval(detectionInterval);
            cameraStatus.textContent = "Analysis complete!";
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
           
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');

            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            showPhotoForConfirmation(dataUrl);
        }

        function showPhotoForConfirmation(dataUrl) {
            capturedPhotoDataUrl = dataUrl;
            const messageWrapper = document.createElement('div');
            messageWrapper.id = 'photo-preview-wrapper';
            messageWrapper.className = 'fade-in flex w-full items-end gap-3 justify-start';
           
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'p-3 rounded-2xl bg-indigo-600 text-white rounded-bl-lg';
           
            const text = document.createElement('p');
            text.className = 'mb-2';
            text.textContent = "Here's the photo. Happy with it?";

            const image = new Image();
            image.alt = "Your selfie";
            image.className = "rounded-lg max-w-full h-auto";
           
            image.onload = () => {
                chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;
            };
            image.src = dataUrl;

            contentWrapper.appendChild(text);
            contentWrapper.appendChild(image);
           
            messageWrapper.appendChild(getBotAvatar());
            messageWrapper.appendChild(contentWrapper);
            chatContent.appendChild(messageWrapper);

            chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;

            optionsContainer.innerHTML = '';
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Looks Good!';
            confirmBtn.className = "px-6 py-3 bg-green-500 border border-green-400 text-white rounded-full hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-200 font-semibold";
            confirmBtn.onclick = confirmPhoto;

            const retakeBtn = document.createElement('button');
            retakeBtn.textContent = 'Retake';
            retakeBtn.className = "px-6 py-3 bg-slate-700 border border-slate-600 text-gray-200 rounded-full hover:bg-red-500 hover:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all duration-200 font-semibold";
            retakeBtn.onclick = retakePhoto;
           
            optionsContainer.appendChild(confirmBtn);
            optionsContainer.appendChild(retakeBtn);
            optionsContainer.className = 'flex gap-2 mb-3 pb-2 justify-center';
            textInputContainer.style.display = 'none';
            inputArea.style.display = 'block';
        }

        async function confirmPhoto() {
            addMessage('Looks Good!', 'user');
            
            showTypingIndicator();
            optionsContainer.innerHTML = '';
            inputArea.style.display = 'none';
            
            try {
                const analyzeResponse = await fetch('/.netlify/functions/analyzeFace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoDataUrl: capturedPhotoDataUrl })
                });

                if (!analyzeResponse.ok) {
                    const errorText = await analyzeResponse.text();
                    throw new Error(`Face analysis server error: ${errorText}`);
                }
                
                const faceData = await analyzeResponse.json();
                await saveAnswerToServer('faceAnalysis', faceData);
                document.getElementById('photo-preview-wrapper')?.remove();
                endQuiz();

            } catch (error) {
                console.error('Error during photo analysis step:', error);
                hideTypingIndicator();
                addMessage("Sorry, I couldn't analyze the photo. Let's proceed without it.");
                setTimeout(endQuiz, 1500);
            }
        }

        function retakePhoto() {
            addMessage('Retake', 'user');
            document.getElementById('photo-preview-wrapper')?.remove();
            optionsContainer.innerHTML = '';
            inputArea.style.display = 'none';
            handleCameraButtonClick();
        }

        function endQuiz() {
            inputArea.style.display = 'none';
            progressBar.style.width = '100%';
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addMessage("Thank you for sharing! I'm firing up my neural networks to analyze your results... This is exciting!");
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    const resultUrl = `result.html?sessionId=${sessionId}`;
                    const message = `Done! Your personalized free report is ready. ðŸš€<br><a href='${resultUrl}' class='inline-block mt-4 px-6 py-3 bg-indigo-500 text-white font-semibold rounded-full hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all duration-200'>View My Results</a>`;
                    addMessage(message);
                    localStorage.setItem(`wellnessReport-${sessionId}`, JSON.stringify(userAnswers));
                }, 3000);
            }, 1500);
        }

        // --- INITIALIZATION ---
        async function initQuiz() {
            await startQuizSession();
            if (sessionId) {
                displayQuestion();
            }
        }
        sendBtn.addEventListener('click', () => handleAnswer(userInput.value));
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAnswer(userInput.value);
        });
        closeCameraBtn.addEventListener('click', closeCamera);
        initQuiz();
    </script>

</body>
</html>
