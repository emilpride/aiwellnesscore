<!DOCTYPE html>

<html lang="en">

<head>

Â  Â  <meta charset="UTF-8">

Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">

Â  Â  <title>AI Wellness Quiz</title>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">

Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

Â  Â  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

Â  Â  <script src="https://js.stripe.com/v3/"></script>

Â  Â  <style>

Â  Â  Â  Â  body { font-family: 'Inter',Â 

Â  Â  Â  Â  Â  Â  sans-serif; }

Â  Â  Â  Â  #main-container { overflow: hidden;

Â  Â  Â  Â  }

Â  Â  Â  Â  .chat-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  .chat-container::-webkit-scrollbar { display: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  .chat-bubble { animation: slide-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;

Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes slide-up { 0% { transform: translateY(20px); opacity: 0;

Â  Â  Â  Â  } 100% { transform: translateY(0); opacity: 1; } }

Â  Â  Â  Â  .options-container::-webkit-scrollbar { display: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  .options-container { -ms-overflow-style: none; scrollbar-width: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;

Â  Â  Â  Â  }

Â  Â  Â  Â  .option-btn:hover { transform: translateY(-2px);

Â  Â  Â  Â  }

Â  Â  Â  Â  .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%;

Â  Â  Â  Â  display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }

Â  Â  Â  Â  .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s;

Â  Â  Â  Â  }

Â  Â  Â  Â  .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s;

Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes bounce { 0%, 80%, 100% { transform: scale(0);

Â  Â  Â  Â  } 40% { transform: scale(1.0); } }

Â  Â  Â  Â  .bot-avatar-lottie { width: 40px; height: 40px;

Â  Â  Â  Â  background-color: #5b21b6; border-radius: 50%; box-shadow: 0 0 0 0 rgba(99, 53, 169, 0.7);

Â  Â  Â  Â  animation: pulse 2.5s infinite, avatar-float 3s ease-in-out infinite; }

Â  Â  Â  Â  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7);

Â  Â  Â  Â  } 70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);

Â  Â  Â  Â  } 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0);

Â  Â  Â  Â  } }

Â  Â  Â  Â  @keyframes avatar-float { 0% { transform: translateY(0);

Â  Â  Â  Â  } 50% { transform: translateY(-5px); } 100% { transform: translateY(0);

Â  Â  Â  Â  } }

Â  Â  Â  Â  #camera-modal { position: fixed; top: 0; left: 0; width: 100%;

Â  Â  Â  Â  height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;

Â  Â  Â  Â  }

Â  Â  Â  Â  #camera-modal.active { opacity: 1; pointer-events: all;

Â  Â  Â  Â  }

Â  Â  Â  Â  #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden;

Â  Â  Â  Â  border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); }

Â  Â  Â  Â  #camera-video { width: 100%;

Â  Â  Â  Â  height: 100%; object-fit: cover; transform: scaleX(-1); }

Â  Â  Â  Â  #camera-canvas { position: absolute; top: 0;

Â  Â  Â  Â  left: 0; width: 100%; height: 100%; }

Â  Â  Â  Â  #camera-overlay { position: absolute; bottom: 0;

Â  Â  Â  Â  left: 0; right: 0; padding: 1.5rem; text-align: center; }

Â  Â  Â  Â  #camera-status { background-color: rgba(0,0,0,0.5);

Â  Â  Â  Â  padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s;

Â  Â  Â  Â  }

Â  Â  Â  Â  #progress-bar { animation: glow 2s ease-in-out infinite alternate;

Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes glow { from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7;

Â  Â  Â  Â  } to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1;

Â  Â  Â  Â  } }

Â  Â  Â  Â  .slider-widget { padding: 1rem; background-color: #faf5ff; border-radius: 1rem;

Â  Â  Â  Â  border: 1px solid #e9d5ff; }

Â  Â  Â  Â  .slider-value { font-size: 2.5rem; font-weight: 800; line-height: 1;

Â  Â  Â  Â  transition: color 0.3s ease; }

Â  Â  Â  Â  .slider-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem;

Â  Â  Â  Â  color: #6b21a8; }

Â  Â  Â  Â  .slider-input { -webkit-appearance: none; appearance: none; width: 100%; height: 8px;

Â  Â  Â  Â  background: #d8b4fe; border-radius: 5px; outline: none; opacity: 0.7; transition: opacity .2s;

Â  Â  Â  Â  }

Â  Â  Â  Â  .slider-input-gradient { background: linear-gradient(to right, #22c55e, #facc15, #ef4444);

Â  Â  Â  Â  }

Â  Â  Â  Â  .slider-input:hover { opacity: 1;

Â  Â  Â  Â  }

Â  Â  Â  Â  .slider-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: white;

Â  Â  Â  Â  cursor: pointer; border-radius: 50%; border: 4px solid #8b5cf6; box-shadow: 0 0 5px rgba(0,0,0,0.2);

Â  Â  Â  Â  }

Â  Â  Â  Â  .slider-input::-moz-range-thumb { width: 24px; height: 24px; background: white; cursor: pointer; border-radius: 50%;

Â  Â  Â  Â  border: 4px solid #8b5cf6; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

Â  Â  Â  Â  .slider-markers { display: flex;

Â  Â  Â  Â  justify-content: space-between; font-size: 0.75rem; color: #9ca3af; margin: 0.25rem 0.25rem 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  .confirm-btn { margin-top: 1rem; width: 100%; background-color: #7c3aed; color: white; font-weight: bold;

Â  Â  Â  Â  padding: 0.75rem; border-radius: 0.75rem; transition: background-color 0.2s; }

Â  Â  Â  Â  .confirm-btn:hover { background-color: #6d28d9;

Â  Â  Â  Â  }

Â  Â  Â  Â  .widget-wrapper { max-width: 250px; margin: auto; text-align: center; padding: 1rem; background-color: #faf5ff;

Â  Â  Â  Â  border-radius: 1rem; }

Â  Â  Â  Â  .widget-label { font-weight: 600; color: #6b21a8; margin-bottom: 0.75rem;

Â  Â  Â  Â  }

Â  Â  Â  Â  .sleep-battery { width: 100px; height: 40px; border: 3px solid #c4b5fd; border-radius: 8px;

Â  Â  Â  Â  margin: 0 auto; position: relative; }

Â  Â  Â  Â  .sleep-battery::after { content:''; position: absolute; top: 50%;

Â  Â  Â  Â  right: -10px; transform: translateY(-50%); width: 5px; height: 20px; background-color: #c4b5fd; border-radius: 0 4px 4px 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  .sleep-battery-level { position: absolute; top: 3px; left: 3px; height: 30px; border-radius: 4px;

Â  Â  Â  Â  width: 0%; background-color: #ef4444; transition: width 1.5s ease-out, background-color 1s ease;

Â  Â  Â  Â  }

Â  Â  Â  Â  #hydration-water-fill { transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1);

Â  Â  Â  Â  }

Â  Â  Â  Â  #hydration-percentage { transition: opacity 0.5s; opacity: 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  .stress-bar-track { height: 12px; background-color: #ede9fe; border-radius: 9999px; overflow: hidden;

Â  Â  Â  Â  }

Â  Â  Â  Â  .stress-bar-fill { height: 100%; width: 0%; background-image: linear-gradient(to right, #4ade80, #facc15, #f87171);

Â  Â  Â  Â  border-radius: 9999px; transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); }

Â  Â  Â  Â  .stress-value { font-size: 1.5rem;

Â  Â  Â  Â  font-weight: 700; margin-top: 0.5rem; transition: color 1.5s ease; }

Â  Â  Â  Â  .activity-week { display:flex; justify-content:center;

Â  Â  Â  Â  gap: 0.5rem; }

Â  Â  Â  Â  .activity-day { width: 30px; height: 30px; border-radius: 0.5rem; background-color: #ede9fe;

Â  Â  Â  Â  color: #a78bfa; font-weight: 600; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition: all 0.4s ease-out;

Â  Â  Â  Â  }

Â  Â  Â  Â  .activity-day.active { background-color: #8b5cf6; color: white; transform: scale(1.1);

Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4); }

Â  Â  Â  Â  @keyframes fade-in-up { from { opacity: 0;

Â  Â  Â  Â  transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

Â  Â  Â  Â  .animated-list-item { opacity: 0;

Â  Â  Â  Â  animation: fade-in-up 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;

Â  Â  Â  Â  }

Â  Â  Â  Â  .list-icon-wrapper { background-color: #a78bfa; color: white; padding: 0.5rem; border-radius: 0.5rem; display: flex;

Â  Â  Â  Â  align-items: center; justify-content: center; flex-shrink: 0; }

Â  Â  Â  Â  .bmi-widget { background-color: #faf5ff;

Â  Â  Â  Â  border: 1px solid #e9d5ff; border-radius: 1rem; padding: 1rem; text-align: center; max-width: 250px; margin: auto;

Â  Â  Â  Â  }

Â  Â  Â  Â  .bmi-value { font-size: 2.5rem; font-weight: 800; color: #5b21b6; line-height: 1;

Â  Â  Â  Â  }

Â  Â  Â  Â  .bmi-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem;

Â  Â  Â  Â  }

Â  Â  Â  Â  .bmi-scale { position: relative; height: 10px;

Â  Â  Â  Â  background-image: linear-gradient(to right, #60a5fa, #34d399, #facc15, #f87171); border-radius: 9999px; margin: 0.5rem 0;

Â  Â  Â  Â  }

Â  Â  Â  Â  .bmi-indicator { position: absolute; top: 50%; width: 16px; height: 16px; background-color: white;

Â  Â  Â  Â  border: 3px solid #5b21b6; border-radius: 50%; transform: translate(-50%, -50%); transition: left 1.5s cubic-bezier(0.25, 1, 0.5, 1);

Â  Â  Â  Â  }

Â  Â  Â  Â  .bmi-category { font-size: 0.75rem; font-weight: 500; color: #7e22ce;

Â  Â  Â  Â  }

Â  Â  Â  Â  .bio-age-container { background-color: #f3e8ff; border: 1px solid #d8b4fe; border-radius: 1rem; padding: 1rem;

Â  Â  Â  Â  text-align: center; max-width: 250px; margin: auto; }

Â  Â  Â  Â  .bio-age-header { font-size: 0.875rem; font-weight: 600;

Â  Â  Â  Â  color: #6b21a8; margin-bottom: 0.75rem; }

Â  Â  Â  Â  .bio-age-display { display: flex; justify-content: center; align-items: baseline;

Â  Â  Â  Â  margin-bottom: 1rem; color: #5b21b6; }

Â  Â  Â  Â  #bio-age-value { font-size: 3.75rem; font-weight: 800; line-height: 1;

Â  Â  Â  Â  transition: color 0.3s; }

Â  Â  Â  Â  .bio-age-unit { font-size: 1rem; font-weight: 600; margin-left: 0.5rem;

Â  Â  Â  Â  }

Â  Â  Â  Â  .week-progress { display: flex; justify-content: space-between; margin-bottom: 0.5rem;

Â  Â  Â  Â  }

Â  Â  Â  Â  .week-day { width: 10px; height: 10px; background-color: #ddd6fe; border-radius: 50%;

Â  Â  Â  Â  transition: all 0.5s; }

Â  Â  Â  Â  .week-day.active { background-color: #7c3aed; transform: scale(1.3);

Â  Â  Â  Â  box-shadow: 0 0 8px #a78bfa; }

Â  Â  Â  Â  .analysis-container { display: flex; flex-direction: column;

Â  Â  Â  Â  align-items: center; justify-content: center; padding: 1rem; text-align: center; }

Â  Â  Â  Â  .analysis-animation { width: 160px;

Â  Â  Â  Â  height: 160px; margin-bottom: 1rem; }

Â  Â  Â  Â  #analysis-text { font-size: 1rem; font-weight: 500; color: #4b5563;

Â  Â  Â  Â  transition: opacity 0.5s ease-in-out; min-height: 1.5rem; }

Â  Â  </style>

Â  Â  <script>

!function(f,b,e,v,n,t,s)

{if(f.fbq)return;n=f.fbq=function(){n.callMethod?

n.callMethod.apply(n,arguments):n.queue.push(arguments)};

if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';

n.queue=[];t=b.createElement(e);t.async=!0;

t.src=v;s=b.getElementsByTagName(e)[0];

s.parentNode.insertBefore(t,s)}(window, document,'script',

'https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '785592354117222');

fbq('track', 'PageView');

</script>

<noscript><img height="1" width="1" style="display:none"

src="https://www.facebook.com/tr?id=785592354117222&ev=PageView&noscript=1"

/></noscript>

</head>

<body class="bg-gradient-to-br from-purple-50 to-indigo-100 md:flex md:items-center md:justify-center min-h-screen">

Â  Â  <div id="main-container" class="w-full md:h-[90vh] md:max-w-lg flex flex-col bg-white md:shadow-2xl md:rounded-2xl overflow-hidden">

Â  Â  Â  Â  <div class="w-full bg-gray-200"><div id="progress-bar" class="h-2 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; transition: width 0.5s ease-in-out;"></div></div>

Â  Â  Â  Â Â 

Â  Â  Â  Â  <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>

Â  Â  Â  Â  <div id="options-container-wrapper" class="px-4 pt-1 pb-2"><div id="options-container" class="flex gap-2 overflow-x-auto py-2 options-container"></div></div>

Â  Â  Â  Â  <divÂ 

Â  Â  Â  Â  Â  Â  id="input-area" class="p-4 border-t border-gray-200">

Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">

Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">

Â  Â  Â  Â  Â  Â  Â  Â  <button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button>

Â  Â  Â  Â  Â  Â 

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="payment-form-container"></div>

Â  Â  </div>

Â  Â  <div id="camera-modal">

Â  Â  Â  Â  <div id="camera-container">

Â  Â  Â  Â  Â  Â  <video id="camera-video" autoplay muted playsinline></video><canvas id="camera-canvas"></canvas>

Â  Â  Â  Â  Â  Â  <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4"><svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75"Â 

Â  Â  Â  Â  Â  Â  Â  Â  fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p></div>

Â  Â  Â  Â  Â  Â  <div id="camera-overlay"><p id="camera-status">Position your face in the frame</p></div>

Â  Â  Â  Â  </div>

Â  Â  </div>



Â  Â  <script>

Â  Â  Â  Â  // --- DOM Elements & State ---

Â  Â  Â  Â  const mainContainer = document.getElementById('main-container'), chatContainer = document.getElementById('chat-container'), optionsContainer = document.getElementById('options-container'), optionsContainerWrapper =Â 

Â  Â  Â  Â  Â  Â  document.getElementById('options-container-wrapper'), inputArea = document.getElementById('input-area'), progressBar = document.getElementById('progress-bar'), cameraModal = document.getElementById('camera-modal'), video = document.getElementById('camera-video'), canvas = document.getElementById('camera-canvas'), cameraLoader = document.getElementById('camera-loader'), loaderText = document.getElementById('loader-text'), cameraStatus = document.getElementById('camera-status'), paymentFormContainer = document.getElementById('payment-form-container');

Â  Â  Â  Â Â 

Â  Â  Â  Â  // <<-- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 1: ĞœĞµĞ½ÑĞµĞ¼ const Ğ½Ğ° let, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ÑŒ

Â  Â  Â  Â  let userInput = document.getElementById('user-input'), sendBtn = document.getElementById('send-btn');

Â  Â  Â  Â Â 

Â  Â  Â  Â  // <<-- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 2: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ HTML Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°

Â  Â  Â  Â  const originalInputAreaHTML = inputArea.innerHTML;



Â  Â  Â  Â  let sessionId = null, userAnswers = {}, currentQuestionIndex = 0, detectionInterval, stream, capturedPhotoDataUrl = null, countdownInterval;

Â  Â  Â  Â Â 

class EventManager {

Â  Â  constructor() {

Â  Â  Â  Â  this.handlers = new Map();

Â  Â  }

Â  Â Â 

Â  Â  add(element, event, handler, key = null) {

Â  Â  Â  Â  const handlerKey = key || `${element.id || 'element'}_${event}`;

Â  Â  Â  Â  this.remove(element, event, handlerKey);

Â  Â  Â  Â  this.handlers.set(handlerKey, { element, event, handler });

Â  Â  Â  Â  element.addEventListener(event, handler);

Â  Â  }

Â  Â Â 

Â  Â  remove(element, event, key = null) {

Â  Â  Â  Â  const handlerKey = key || `${element.id || 'element'}_${event}`;

Â  Â  Â  Â  const data = this.handlers.get(handlerKey);

Â  Â  Â  Â  if (data) {

Â  Â  Â  Â  Â  Â  data.element.removeEventListener(data.event, data.handler);

Â  Â  Â  Â  Â  Â  this.handlers.delete(handlerKey);

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  removeAll() {

Â  Â  Â  Â  this.handlers.forEach((data) => {

Â  Â  Â  Â  Â  Â  data.element.removeEventListener(data.event, data.handler);

Â  Â  Â  Â  });

Â  Â  Â  Â  this.handlers.clear();

Â  Â  }

}

const eventManager = new EventManager();



class AnimationManager {

Â  Â  constructor() {

Â  Â  Â  Â  this.animations = new Map();

Â  Â  }

Â  Â Â 

Â  Â  add(containerId, options) {

Â  Â  Â  Â  this.remove(containerId);

Â  Â  Â  Â  const anim = lottie.loadAnimation({

Â  Â  Â  Â  Â  Â  container: document.getElementById(containerId),

Â  Â  Â  Â  Â  Â  ...options

Â  Â  Â  Â  });

Â  Â  Â  Â  this.animations.set(containerId, anim);

Â  Â  Â  Â  return anim;

Â  Â  }

Â  Â Â 

Â  Â  remove(containerId) {

Â  Â  Â  Â  const anim = this.animations.get(containerId);

Â  Â  Â  Â  if (anim) {

Â  Â  Â  Â  Â  Â  anim.destroy();

Â  Â  Â  Â  Â  Â  this.animations.delete(containerId);

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  clear() {

Â  Â  Â  Â  this.animations.forEach(anim => anim.destroy());

Â  Â  Â  Â  this.animations.clear();

Â  Â  }

}

const animationManager = new AnimationManager();



Â  Â  Â  Â  // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ localStorage

function saveQuizState() {

Â  Â  if (sessionId) {

Â  Â  Â  Â  localStorage.setItem('quiz_session_id', sessionId);

Â  Â  Â  Â  localStorage.setItem('quiz_answers', JSON.stringify(userAnswers));

Â  Â  Â  Â  localStorage.setItem('quiz_current_index', currentQuestionIndex);

Â  Â  Â  Â  localStorage.setItem('quiz_timestamp', Date.now());

Â  Â  }

}



function loadQuizState() {

Â  Â  const savedSessionId = localStorage.getItem('quiz_session_id');

Â  Â  const savedAnswers = localStorage.getItem('quiz_answers');

Â  Â  const savedIndex = localStorage.getItem('quiz_current_index');

Â  Â  const savedTimestamp = localStorage.getItem('quiz_timestamp');

Â  Â Â 

Â  Â  if (savedSessionId && savedTimestamp) {

Â  Â  Â  Â  const age = Date.now() - parseInt(savedTimestamp);

Â  Â  Â  Â  if (age < 24 * 60 * 60 * 1000) { // 24 Ñ‡Ğ°ÑĞ°

Â  Â  Â  Â  Â  Â  return {

Â  Â  Â  Â  Â  Â  Â  Â  sessionId: savedSessionId,

Â  Â  Â  Â  Â  Â  Â  Â  answers: savedAnswers ? JSON.parse(savedAnswers) : {},

Â  Â  Â  Â  Â  Â  Â  Â  currentIndex: parseInt(savedIndex) || 0

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  }

Â  Â  }

Â  Â  return null;

}



function clearQuizState() {

Â  Â  localStorage.removeItem('quiz_session_id');

Â  Â  localStorage.removeItem('quiz_answers');

Â  Â  localStorage.removeItem('quiz_current_index');

Â  Â  localStorage.removeItem('quiz_timestamp');

}



function isInAppBrowser() {

Â  Â  const ua = navigator.userAgent || navigator.vendor || window.opera;

Â  Â  return ua.includes('FBAN') || ua.includes('FBAV') ||Â 

Â  Â  Â  Â  Â  Â  ua.includes('Instagram') || ua.includes('Telegram');

}

Â  Â  Â  Â  const messageDelay = 1800;

Â  Â  Â  Â  // --- Utility & Helper Functions ---

Â  Â  Â  Â  const setAppHeight = () => { mainContainer.style.height = `${window.innerHeight}px`;

Â  Â  Â  Â  };

Â  Â  Â  Â  const isMobile = () => window.innerWidth <= 768;

Â  Â  Â  Â  const scrollToBottom = () => { setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 0);

Â  Â  Â  Â  };

Â  Â  Â  Â Â 

Â  Â  Â  Â  function parseHeightToInches(heightVal) {

Â  Â  Â  Â  Â  Â  if (!heightVal) return 68;

Â  Â  Â  Â  Â  Â  if (!isNaN(parseFloat(heightVal))) { return parseFloat(heightVal) / 2.54; }

Â  Â  Â  Â  Â  Â  let inches = 0;

Â  Â  Â  Â  Â  Â  const feetMatch = heightVal.match(/(\d+)\s*(ft|')/); const inchesMatch = heightVal.match(/(\d+)\s*(in|")/);

Â  Â  Â  Â  Â  Â  if (feetMatch) inches += parseInt(feetMatch[1]) * 12; if (inchesMatch) inches += parseInt(inchesMatch[1]);

Â  Â  Â  Â  Â  Â  return inches > 0 ? inches : 68;

Â  Â  Â  Â  }



Â  Â  Â  Â  // --- Animation Functions ---

Â  Â  Â  Â  function playBiologicalAgeAnimation() { const ageElement = document.getElementById('bio-age-value'); if (!ageElement) return; let currentAge = 42; const targetAge = 39; const duration = 2800; constÂ 

Â  Â  Â  Â  Â  Â  steps = currentAge - targetAge; const stepDuration = duration / steps; const dayDuration = duration / 7; for (let i = 1; i <= 7; i++) { setTimeout(() => { const dayEl = document.getElementById(`day-${i}`); if (dayEl) dayEl.classList.add('active'); }, i * dayDuration); } setTimeout(() => { const countdownInterval = setInterval(() => { currentAge--; ageElement.textContent = currentAge; if (currentAge === targetAge) { clearInterval(countdownInterval); ageElement.style.color = '#16a34a'; } }, stepDuration); }, 500); }

Â  Â  Â  Â  function playBmiAnimation() { const heightIn = parseHeightToInches(userAnswers.height);

Â  Â  Â  Â  Â  Â  const weightLbs = (parseInt(userAnswers.weight) || 70) * 2.20462; if (heightIn && weightLbs) { const bmi = ((weightLbs / (heightIn * heightIn)) * 703).toFixed(1);

Â  Â  Â  Â  Â  Â  let category = "Normal"; let percent = 50; if (bmi < 18.5) { category = "Underweight";

Â  Â  Â  Â  Â  Â  percent = (bmi / 18.5) * 25; } else if (bmi < 25) { category = "Normal";

Â  Â  Â  Â  Â  Â  percent = 25 + ((bmi - 18.5) / 6.5) * 50;

Â  Â  Â  Â  Â  Â  } else if (bmi < 30) { category = "Overweight";

Â  Â  Â  Â  Â  Â  percent = 75 + ((bmi - 25) / 5) * 25; } else { category = "Obese"; percent = 100;

Â  Â  Â  Â  Â  Â  } percent = Math.max(5, Math.min(95, percent)); const html = `<div class="bmi-widget"><div id="bmi-value-anim" class="bmi-value">0.0</div><div class="bmi-label">Your Estimated BMI</div><div class="bmi-scale"><div id="bmi-indicator-anim" class="bmi-indicator" style="left: 0%;"></div></div><div id="bmi-category-anim" class="bmi-category">&nbsp;</div></div>`;

Â  Â  Â  Â  Â  Â  addBotMessage(html); setTimeout(() => { const valEl = document.getElementById('bmi-value-anim'); const catEl = document.getElementById('bmi-category-anim'); const indEl = document.getElementById('bmi-indicator-anim'); if(indEl) indEl.style.left = `${percent}%`; if(catEl) catEl.textContent = category; let start = 0; const end = parseFloat(bmi); const animDuration = 1500; const frameDuration = 1000 / 60; const totalFrames = Math.round(animDuration / frameDuration); let frame = 0; const countUp = setInterval(() => { frame++; const progress = frame / totalFrames; const currentVal = (start + (end - start) * progress).toFixed(1); if(valEl) valEl.textContent = currentVal; if (frame === totalFrames) { clearInterval(countUp); if(valEl) valEl.textContent = bmi; } }, frameDuration); }, 100);

Â  Â  Â  Â  Â  Â  } }

Â  Â  Â  Â  function playSleepAnimation() { const answer = userAnswers.sleep || "";

Â  Â  Â  Â  Â  Â  let level = 25; if (answer.includes("5-6")) level = 50; if (answer.includes("7-8")) level = 90;

Â  Â  Â  Â  Â  Â  if (answer.includes("More than 8")) level = 100; const html = `<div class="widget-wrapper"><div class="widget-label">Sleep Recharge</div><svg class="w-16 h-16 mx-auto text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg><div class="sleep-battery mt-2"><div id="sleep-battery-level-anim" class="sleep-battery-level"></div></div></div>`;

Â  Â  Â  Â  Â  Â  addBotMessage(html); setTimeout(() => { const levelEl = document.getElementById('sleep-battery-level-anim'); if (!levelEl) return; let color = '#ef4444'; if (level > 40) color = '#f59e0b'; if (level > 75) color = '#22c55e'; levelEl.style.backgroundColor = color; levelEl.style.width = `${level}%`; }, 100);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  function playActivityAnimation() { const answer = userAnswers.activity || "";

Â  Â  Â  Â  Â  Â  let days = 1; if (answer.includes("1-2")) days = 2; if (answer.includes("3-4")) days = 4; if (answer.includes("5+")) days = 6;

Â  Â  Â  Â  Â  Â  const html = `<div class="widget-wrapper"><div class="widget-label">Your Active Week</div><div class="activity-week" id="activity-week-anim"><div class="activity-day">M</div><div class="activity-day">T</div><div class="activity-day">W</div><div class="activity-day">T</div><div class="activity-day">F</div><div class="activity-day">S</div><div class="activity-day">S</div></div></div>`; addBotMessage(html);

Â  Â  Â  Â  Â  Â  setTimeout(() => { const weekEl = document.getElementById('activity-week-anim'); if (!weekEl) return; const dayElements = weekEl.children; const daysToActivate = [0, 2, 4, 1, 3, 5, 6]; for (let i = 0; i < days; i++) { setTimeout(() => { dayElements[daysToActivate[i]].classList.add('active'); }, i * 250); } }, 100);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  function playHydrationAnimation() { const answer = userAnswers.hydration || "";

Â  Â  Â  Â  Â  Â  let level = 25; if (answer.includes("4-6")) level = 50; if (answer.includes("7-9")) level = 75; if (answer.includes("10+")) level = 100;

Â  Â  Â  Â  Â  Â  const html = `<div class="widget-wrapper"><div class="widget-label">Body Hydration</div><svg class="w-20 h-24 mx-auto" viewBox="0 0 120 160"><defs><clipPath id="humanoid-clip"><path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z"></path></clipPath></defs><g clip-path="url(#humanoid-clip)"><rect x="0" y="0" width="120" height="160" fill="#ede9fe"/><rect id="hydration-water-fill" x="0" y="0" width="120" height="160" fill="#818cf8" style="transform: translateY(160px);"/></g><path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z" fill="none" stroke="#a78bfa" stroke-width="6"/></svg><div id="hydration-percentage" class="font-bold text-xl text-indigo-600 mt-2">0%</div></div>`;

Â  Â  Â  Â  Â  Â  addBotMessage(html); setTimeout(() => { const waterEl = document.getElementById('hydration-water-fill'); const textEl = document.getElementById('hydration-percentage'); if (!waterEl || !textEl) return; const yPos = 160 - (160 * (level / 100)); waterEl.style.transform = `translateY(${yPos}px)`; textEl.style.opacity = '1'; let currentLevel = 0; const levelUp = setInterval(() => { currentLevel++; textEl.textContent = `${currentLevel}%`; if (currentLevel >= level) clearInterval(levelUp); }, 1500 / level); }, 100);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  function playStressGaugeAnimation() { const stressAnswer = userAnswers.stress || "1";

Â  Â  Â  Â  Â  Â  const level = parseInt(stressAnswer.match(/\d+/)[0]); const percent = (level - 1) / 9 * 100; let color = '#4ade80';

Â  Â  Â  Â  Â  Â  if (level > 4) color = '#facc15'; if (level > 7) color = '#f87171';

Â  Â  Â  Â  Â  Â  const html = `<div class="widget-wrapper"><div class="widget-label">Reported Stress Level</div><div class="stress-bar-track"><div id="stress-bar-fill-anim" class="stress-bar-fill"></div></div><div id="stress-value-anim" class="stress-value">${level}/10</div></div>`; addBotMessage(html);

Â  Â  Â  Â  Â  Â  setTimeout(() => { const fillEl = document.getElementById('stress-bar-fill-anim'); const textEl = document.getElementById('stress-value-anim'); if (!fillEl || !textEl) return; fillEl.style.width = `${percent}%`; textEl.style.color = color; }, 100);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  // --- Quiz Data ---

const quizQuestions = [

Â  Â  { key: 'intro_dave', type: 'message', text: "Hey! I'm Dave, your personal AI wellness assistant today. ğŸ‘‹" },

Â  Â  { key: 'name', type: 'question', text: "What should I call you?", options: [], placeholder: "Type your name..." },

Â  Â  {Â 

Â  Â  Â  Â  key: 'intro_purpose', type: 'message', text: (name) => `Great to meet you, ${name}! Here's a quick look at what we'll uncover together: <div class="mt-4 text-sm text-gray-800"><div class="animated-list-item" style="animation-delay: 0.2s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div><span>Calculate your Wellness Score</span></div><div class="animated-list-item" style="animation-delay: 0.6s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg></div><span>Reveal your Biological Age</span></div><div class="animated-list-item" style="animation-delay: 1.0s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg></div><span>Assess your energy & recovery</span></div><div class="animated-list-item" style="animation-delay: 1.4s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></div><span>Measure stress & find solutions</span></div><div class="animated-list-item" style="animation-delay: 1.8s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div><span>Analyze skin health with AI</span></div><div class="animated-list-item" style="animation-delay: 2.2s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L7 8.414V13a1 1 0 11-2 0V8.414L3.293 6.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h5a1 1 0 100-2h-5z" /></svg></div><span>Review nutrition, BMI & more</span></div></div>`

Â  Â  },

Â  Â  { key: 'intro_how', type: 'message', text: "To help you on your wellness journey, I need to get to know you a bit betterâ€”your lifestyle, habits, and a quick, secure look at you.", delayBefore: 3000 },

Â  Â  { key: 'intro_convo', type: 'message', text: "What makes this unique is our relaxed, conversational approach. I'll ask some questions, and you can use the quick-reply buttons or type your own answers. Every detail helps, so I appreciate you taking the time!" },

Â  Â  { key: 'intro_testimonial', type: 'message', text: `<div class="bio-age-container"><div class="bio-age-header">See What A Week Can Do</div><div class="bio-age-display"><span id="bio-age-value">42</span><span class="bio-age-unit">Years</span></div><div class="week-progress"><div class="week-day" id="day-1"></div><div class="week-day" id="day-2"></div><div class="week-day" id="day-3"></div><div class="week-day" id="day-4"></div><div class="week-day" id="day-5"></div><div class="week-day" id="day-6"></div><div class="week-day" id="day-7"></div></div><div class="bio-age-footer">Biological Age Improvement</div></div>`},

Â  Â  { key: 'intro_privacy', type: 'message', text: "And just to be clear about your privacy ğŸ›¡ï¸: your photo is deleted immediately after the AI analysis, and your answers are wiped as soon as you get your report.", delayBefore: 3000 },

Â  Â  { key: 'start_consent', type: 'question', text: "Ready to begin?", options: ["Yes, let's start!"], hideInput: true },

Â  Â  { key: 'age', type: 'slider', text: (name) => `Perfect, ${userAnswers.name || name}! To start, what's your age? ğŸ‚`, label: "Select your age", min: 18, max: 90, step: 1, defaultValue: 30, unit: 'years' },

Â  Â  { key: 'gender', type: 'question', text: "Great start! Now, what's your biological sex? ğŸ§¬", options: ['Male', 'Female', 'Other'], hideInput: true },

Â  Â  { key: 'height', type: 'slider', text: "Perfect. Let's talk about your height. ğŸ“", label: "Select your height", min: 140, max: 220, step: 1, defaultValue: 175, unit: 'cm' },

Â  Â  { key: 'weight', type: 'slider', text: "Thanks! And your current weight? âš–ï¸", label: "Select your weight", min: 40, max: 150, step: 1, defaultValue: 70, unit: 'kg' },

Â  Â  { key: 'bmi_calculation', type: 'message', text: "Calculating your BMI based on your stats...", postAnimationDelay: 2000},

Â  Â  { key: 'sleep', type: 'question', text: "Sleep is crucial. ğŸ˜´ How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], hideInput: true },

Â  Â  { key: 'sleep_visual', type: 'message', text: 'Quality sleep recharges your mind and body.'},

Â  Â  { key: 'activity', type: 'question', text: "Movement is key! ğŸƒâ€â™€ï¸ How often do you engage in moderate physical activity (like a brisk walk) per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], hideInput: true },

Â  Â  { key: 'activity_visual', type: 'message', text: 'Every bit of movement counts!'},

Â  Â  { key: 'nutrition', type: 'question', text: "Let's dive into nutrition. ğŸ¥¦ How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], hideInput: true },

Â  Â  { key: 'processed_food', type: 'question', text: "Honesty is the best policy here. ğŸ˜‰ How often do you eat processed or fast food in a typical week?", options: ["Rarely", "1-2 times", "3-4 times", "Daily"], hideInput: true },

Â  Â  { key: 'hydration', type: 'question', text: "Hydration check! ğŸ’§ How many glasses of water (approx. 8 oz) do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], hideInput: true },

Â  Â  { key: 'hydration_visual', type: 'message', text: "Let's see your hydration level:"},

Â  Â  { key: 'stress', type: 'slider', text: "Now for the mind. ğŸ§  How would you rate your typical stress level?", label: "Drag to indicate your stress level", min: 1, max: 10, step: 1, defaultValue: 5, unit: 'stress', isGradient: true },

Â  Â  { key: 'stress_gauge', type: 'message', text: "Thanks for sharing. Here's what that looks like:"},

Â  Â  { key: 'mindfulness', type: 'question', text: "Finding calm is a superpower. ğŸ§˜â€â™‚ï¸ How often do you practice mindfulness, meditation, or deep breathing?", options: ["Never", "Occasionally", "Weekly", "Daily"], hideInput: true },

Â  Â  { key: 'mood', type: 'question', text: "Let's check in with your emotions. â¤ï¸ How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "It varies a lot", "Often Stressed or Sad"], hideInput: true },

Â  Â  { key: 'alcohol', type: 'question', text: "Time for some lifestyle questions.ğŸ» How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"], hideInput: true },

Â  Â  { key: 'smoking', type: 'question', text: "This is a safe space. ğŸš­ Do you smoke or use tobacco products?", options: ["No, never", "Used to, but quit", "Occasionally", "Yes, daily"], hideInput: true },

Â  Â  { key: 'screen_time', type: 'question', text: "Last question before the final step! ğŸ“± How much time do you spend on screens (phone, computer, TV) outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"], hideInput: true },

Â  Â  { key: 'camera', type: 'final_step', text: "You did it! ğŸ‰ That's all the questions. Now for the fun part: a quick selfie. This helps me analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored. Please allow camera access and position your face within the frame." }

];



Â  Â  Â  Â // --- Core Quiz Logic ---

async function startQuizSession() {

Â  Â  const savedState = loadQuizState();

Â  Â  if (savedState) {

Â  Â  Â  Â  sessionId = savedState.sessionId;

Â  Â  Â  Â  userAnswers = savedState.answers;

Â  Â  Â  Â  currentQuestionIndex = savedState.currentIndex;

Â  Â  Â  Â  console.log('Restored session:', sessionId);

Â  Â  Â  Â  return true;Â 

Â  Â  }

Â  Â Â 

Â  Â  const getDeviceType = () => {

Â  Â  Â  Â  const userAgent = navigator.userAgent.toLowerCase();

Â  Â  Â  Â  const width = window.innerWidth;

Â  Â  Â  Â Â 

Â  Â  Â  Â  let os = 'Unknown';

Â  Â  Â  Â  if (/iphone|ipad|ipod/.test(userAgent)) { os = 'iOS'; }Â 

Â  Â  Â  Â  else if (/android/.test(userAgent)) { os = 'Android'; }Â 

Â  Â  Â  Â  else if (/windows phone/.test(userAgent)) { os = 'Windows Phone'; }Â 

Â  Â  Â  Â  else if (/mac os x/.test(userAgent)) { os = 'macOS'; }Â 

Â  Â  Â  Â  else if (/windows/.test(userAgent)) { os = 'Windows'; }Â 

Â  Â  Â  Â  else if (/linux/.test(userAgent)) { os = 'Linux'; }

Â  Â  Â  Â Â 

Â  Â  Â  Â  let device = 'Desktop';

Â  Â  Â  Â  if (width < 768) { device = 'Mobile'; }Â 

Â  Â  Â  Â  else if (width < 1024) { device = 'Tablet'; }

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (device === 'Mobile' || device === 'Tablet') { return `${device}/${os}`; }

Â  Â  Â  Â  return `${device}/${os}`;

Â  Â  };

Â  Â Â 

Â  Â  const getTrafficSource = () => {

Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);

Â  Â  Â  Â  const utm_source = urlParams.get('utm_source');

Â  Â  Â  Â  const utm_medium = urlParams.get('utm_medium');

Â  Â  Â  Â  const utm_campaign = urlParams.get('utm_campaign');

Â  Â  Â  Â  const ref = document.referrer.toLowerCase();

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (utm_source) {

Â  Â  Â  Â  Â  Â  if (utm_campaign) { return `${utm_source}/${utm_campaign}`; }

Â  Â  Â  Â  Â  Â  if (utm_medium) { return `${utm_source}/${utm_medium}`; }

Â  Â  Â  Â  Â  Â  return utm_source;

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (ref === '') return 'Direct';

Â  Â  Â  Â  if (ref.includes('google.')) return 'Google Search';

Â  Â  Â  Â  if (ref.includes('bing.')) return 'Bing';

Â  Â  Â  Â  if (ref.includes('facebook.com')) return 'Facebook';

Â  Â  Â  Â  if (ref.includes('instagram.com')) return 'Instagram';



Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  const refUrl = new URL(ref);

Â  Â  Â  Â  Â  Â  return `Referral/${refUrl.hostname.replace('www.', '')}`;

Â  Â  Â  Â  } catch {

Â  Â  Â  Â  Â  Â  return 'Referral';

Â  Â  Â  Â  }

Â  Â  };



Â  Â  try {

Â  Â  Â  Â  const response = await fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  body: JSON.stringify({

Â  Â  Â  Â  Â  Â  Â  Â  action: 'startSession',

Â  Â  Â  Â  Â  Â  Â  Â  source: getTrafficSource(),

Â  Â  Â  Â  Â  Â  Â  Â  deviceType: getDeviceType()

Â  Â  Â  Â  Â  Â  })

Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) throw new Error('Could not start session');

Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  sessionId = data.sessionId;

Â  Â  Â  Â  saveQuizState();

Â  Â  Â  Â  return false;

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error('Failed to start session:', error);

Â  Â  Â  Â  addBotMessage("Sorry, I'm having trouble connecting. Please try refreshing the page.");

Â  Â  Â  Â  inputArea.style.display = 'none';

Â  Â  Â  Â  return false;

Â  Â  }

}

Â  Â  Â  Â Â 

async function saveAnswerToServer(questionKey, answer) {

Â  Â  if (!sessionId) {

Â  Â  Â  Â  console.error('No session ID available');

Â  Â  Â  Â  return false;

Â  Â  }

Â  Â  userAnswers[questionKey] = answer;

Â  Â  saveQuizState();

Â  Â  try {

Â  Â  Â  Â  const response = await fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  body: JSON.stringify({

Â  Â  Â  Â  Â  Â  Â  Â  action: 'saveAnswer',

Â  Â  Â  Â  Â  Â  Â  Â  sessionId: sessionId,

Â  Â  Â  Â  Â  Â  Â  Â  questionId: questionKey,

Â  Â  Â  Â  Â  Â  Â  Â  answer: answer

Â  Â  Â  Â  Â  Â  })

Â  Â  Â  Â  });

Â  Â  Â  Â  if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }

Â  Â  Â  Â  return true;

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error('Failed to save answer:', error);

Â  Â  Â  Â  return false;

Â  Â  }

}



Â  Â  Â  Â  function updateProgressBar() { const questionKeys = quizQuestions.filter(q => q.type === 'question' || q.type === 'slider').map(q => q.key);

Â  Â  Â  Â  Â  Â  const totalSteps = questionKeys.length + 1; const completedAnswers = Object.keys(userAnswers).filter(key => questionKeys.includes(key)).length; const photoStepCompleted = userAnswers['selfie'] ? 1 : 0;

Â  Â  Â  Â  Â  Â  const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100; progressBar.style.width = `${progress}%`;

Â  Â  Â  Â  }

Â  Â  Â  Â  function showTypingIndicator() { const typingDiv = document.createElement('div'); typingDiv.id = 'typing-indicator';

Â  Â  Â  Â  Â  Â  typingDiv.className = 'flex justify-start mb-4 chat-bubble'; const avatarId = `avatar-lottie-${Date.now()}`;

Â  Â  Â  Â  Â  Â  typingDiv.innerHTML = `<div id="${avatarId}" class="bot-avatar-lottie mr-3 flex-shrink-0"></div><div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`; chatContainer.appendChild(typingDiv);

Â  Â  Â  Â  Â  Â animationManager.add(avatarId, { renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' });

Â  Â  Â  Â  Â  Â scrollToBottom();

Â  Â  Â  Â  }

Â  Â  Â  Â  function hideTypingIndicator() { document.getElementById('typing-indicator')?.remove();

Â  Â  Â  Â  }

Â  Â  Â  Â  function addBotMessage(html, key = '') {

Â  Â  Â  Â  Â  Â  const messageDiv = document.createElement('div');

Â  Â  Â  Â  Â  Â  if (key === 'intro_dave') {

Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.className = 'mb-4 chat-bubble';

Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.innerHTML = ` <div id="greeting-animation" class="w-full max-w-[250px] mx-auto mb-[-40px] z-10 relative"></div> <div class="flex justify-start"> <div id="greeting-avatar" class="bot-avatar-lottie mr-3 flex-shrink-0 self-end mb-1"></div> <div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div> </div> `;

Â  Â  Â  Â  Â  Â  Â  Â  chatContainer.appendChild(messageDiv);

Â  Â  Â  Â  Â  Â  Â  Â  animationManager.add('greeting-animation', { renderer: 'svg', loop: false, autoplay: true, path: 'assistent.json' });

Â  Â  Â  Â  Â  Â  Â  Â  animationManager.add('greeting-avatar', { renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' });

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.className = 'flex justify-start mb-4 chat-bubble';

Â  Â  Â  Â  Â  Â  Â  Â  const avatarId = `avatar-lottie-${Date.now()}`;

Â  Â  Â  Â  Â  Â  Â  Â  messageDiv.innerHTML = `<div id="${avatarId}" class="bot-avatar-lottie mr-3 flex-shrink-0"></div><div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div>`;

Â  Â  Â  Â  Â  Â  Â  Â  chatContainer.appendChild(messageDiv);

Â  Â  Â  Â  Â  Â  Â  Â  animationManager.add(avatarId, { renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' });

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  }

Â  Â  Â  Â  function addUserMessage(text) { const d = document.createElement('div');

Â  Â  Â  Â  Â  Â  d.className = 'flex justify-end mb-4 chat-bubble'; d.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${text}</div>`; chatContainer.appendChild(d); scrollToBottom();

Â  Â  Â  Â  }

Â  Â  Â  Â  function showOptions(options, handlers) { optionsContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  if (options?.length > 0) { optionsContainerWrapper.classList.remove('hidden'); options.forEach((option, index) => { const button = document.createElement('button'); button.textContent = option.text; button.className = option.class; button.onclick = handlers[index]; optionsContainer.appendChild(button); });

Â  Â  Â  Â  Â  Â  } else { optionsContainerWrapper.classList.add('hidden'); } }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function showSlider(question) {

Â  Â  Â  Â  Â  Â  optionsContainer.innerHTML = '';

Â  Â  Â  Â  Â  Â  optionsContainerWrapper.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  const sliderWrapper = document.createElement('div'); sliderWrapper.className = 'slider-widget w-full';

Â  Â  Â  Â  Â  Â  const formatDisplayValue = (value) => {

Â  Â  Â  Â  Â  Â  Â  Â  if (question.unit === 'stress') { if (value <= 3) return `<span style="color: #22c55e;">Low</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (value <= 7) return `<span style="color: #f59e0b;">Medium</span>`; return `<span style="color: #ef4444;">High</span>`;

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (question.unit === 'cm') { const feet = Math.floor(value / 30.48);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inches = Math.round((value % 30.48) / 2.54); return `${feet}'${inches}" <span class="text-lg ml-2 text-purple-400">(${value} cm)</span>`; }

Â  Â  Â  Â  Â  Â  Â  Â  if (question.unit === 'kg') { const lbs = (value * 2.20462).toFixed(0); return `${lbs} lbs <span class="text-lg ml-2 text-purple-400">(${value} kg)</span>`; }

Â  Â  Â  Â  Â  Â  Â  Â  return `${value} ${question.unit}`;

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const sliderInputClass = question.isGradient ? 'slider-input slider-input-gradient' :Â 

Â  Â  Â  Â  Â  Â  Â  Â  'slider-input';

Â  Â  Â  Â  Â  Â  const markersHTML = question.isGradient ? `<div class="slider-markers"><span>Low</span><span>Medium</span><span>High</span></div>` : '';

Â  Â  Â  Â  Â  Â  sliderWrapper.innerHTML = `<div class="text-center"><div id="slider-value-display" class="slider-value">${formatDisplayValue(question.defaultValue)}</div><div class="slider-label">${question.label}</div></div><input type="range" min="${question.min}" max="${question.max}" value="${question.defaultValue}" step="${question.step}" class="${sliderInputClass}" id="slider-input-range">${markersHTML}<button id="slider-confirm-btn" class="confirm-btn">Confirm</button>`;

Â  Â  Â  Â  Â  Â  optionsContainer.appendChild(sliderWrapper);

Â  Â  Â  Â  Â  Â  const sliderInput = document.getElementById('slider-input-range'), valueDisplay = document.getElementById('slider-value-display'), confirmBtn = document.getElementById('slider-confirm-btn');

Â  Â  Â  Â  Â  Â  sliderInput.addEventListener('input', (e) => { valueDisplay.innerHTML = formatDisplayValue(e.target.value); });

Â  Â  Â  Â  Â  Â  confirmBtn.onclick = () => {

Â  Â  Â  Â  Â  Â  Â  Â  const finalValue = sliderInput.value;

Â  Â  Â  Â  Â  Â  Â  Â  let displayAnswerText = '';

Â  Â  Â  Â  Â  Â  Â  Â  if (question.unit === 'stress') { if (finalValue <= 3) displayAnswerText = 'Low';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (finalValue <= 7) displayAnswerText = 'Medium'; else displayAnswerText = 'High';

Â  Â  Â  Â  Â  Â  Â  Â  } else if (question.unit === 'cm') { const feet = Math.floor(finalValue / 30.48);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const inches = Math.round((finalValue % 30.48) / 2.54); displayAnswerText = `${feet}'${inches}"`;

Â  Â  Â  Â  Â  Â  Â  Â  } else if (question.unit === 'kg') { const lbs = (finalValue * 2.20462).toFixed(0); displayAnswerText = `${lbs} lbs`;

Â  Â  Â  Â  Â  Â  Â  Â  } else { displayAnswerText = `${finalValue} ${question.unit}`; }

Â  Â  Â  Â  Â  Â  Â  Â  handleAnswer(finalValue, displayAnswerText);

Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â }



Â  Â  Â  Â  function handleAnswer(answerToStore, answerToDisplay) {

Â  Â  Â  Â  Â  Â  const valueToStore = (answerToStore || '').toString();

Â  Â  Â  Â  Â  Â  if (!valueToStore.trim()) return;

Â  Â  Â  Â  Â  Â  const currentQuestion = quizQuestions[currentQuestionIndex];

Â  Â  Â  Â  Â  Â  const valueToDisplay = answerToDisplay || valueToStore;

Â  Â  Â  Â  Â  Â  addUserMessage(valueToDisplay);

Â  Â  Â  Â  Â  Â  userAnswers[currentQuestion.key] = valueToStore.trim();

Â  Â  Â  Â  Â  Â  saveAnswerToServer(currentQuestion.key, valueToStore.trim());

Â  Â  Â  Â  Â  Â  userInput.value = '';

Â  Â  Â  Â  Â  Â  userInput.blur();

Â  Â  Â  Â  Â  Â  inputArea.classList.add('hidden'); optionsContainerWrapper.classList.add('hidden');

Â  Â  Â  Â  Â  Â  currentQuestionIndex++; updateProgressBar();

Â  Â  Â  Â  Â  Â  askNextQuestion();

Â  Â  Â  Â  }



Â  Â  Â  Â  function askNextQuestion() {

Â  Â  Â  Â  Â  Â  if (currentQuestionIndex >= quizQuestions.length) return;

Â  Â  Â  Â  Â  Â  const question = quizQuestions[currentQuestionIndex];

Â  Â  Â  Â  Â  Â  showTypingIndicator();

Â  Â  Â  Â  Â  Â  const delay = question.delayBefore || messageDelay;

Â  Â  Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  Â  Â  hideTypingIndicator();

Â  Â  Â  Â  Â  Â  Â  Â  let questionText = typeof question.text === 'function' ? question.text(userAnswers.name || 'friend') : question.text;

Â  Â  Â  Â  Â  Â  Â  Â  let postAnimationDelay = question.postAnimationDelay || 0;

Â  Â  Â  Â  Â  Â  Â  Â  if (question.type === 'message') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage(questionText, question.key);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (question.key === 'intro_testimonial') { setTimeout(playBiologicalAgeAnimation, 500); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (question.key === 'bmi_calculation') { setTimeout(playBmiAnimation, 100); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (question.key === 'stress_gauge') { setTimeout(playStressGaugeAnimation, 100); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (question.key === 'sleep_visual') { setTimeout(playSleepAnimation, 100); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (question.key === 'activity_visual') { setTimeout(playActivityAnimation, 100); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (question.key === 'hydration_visual') { setTimeout(playHydrationAnimation, 100); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentQuestionIndex++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(askNextQuestion, postAnimationDelay);

Â  Â  Â  Â  Â  Â  Â  Â  } else if (question.type === 'question') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage(questionText, question.key);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const optionButtons = question.options.map(opt => ({ text: opt, class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50' }));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const handlers = question.options.map(opt => () => handleAnswer(opt));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showOptions(optionButtons, handlers);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (question.hideInput) { inputArea.classList.add('hidden'); } else { inputArea.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInput.placeholder = question.placeholder || "Type..."; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isMobile()) { userInput.focus(); }

Â  Â  Â  Â  Â  Â  Â  Â  } else if (question.type === 'slider') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage(questionText, question.key);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inputArea.classList.add('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSlider(question);

Â  Â  Â  Â  Â  Â  Â  Â  } else if (question.type === 'final_step') {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inputArea.classList.add('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage(questionText, question.key);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'endQuiz', sessionId: sessionId })

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showCameraStep();

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }, delay);

Â  Â  Â  Â  }



Â  Â  Â  Â  // --- Camera & Payment Logic ---

Â  Â  Â  Â  function showCameraStep() { optionsContainerWrapper.classList.add('hidden');

Â  Â  Â  Â  Â  Â  inputArea.classList.remove('hidden'); inputArea.innerHTML = `<button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors pulse-btn">Open Camera</button>`; document.getElementById('open-camera-btn').onclick = startCamera;

Â  Â  Â  Â  }

Â  Â  Â  Â  async function startCamera() { cameraModal.classList.add('active'); try { const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';

Â  Â  Â  Â  Â  Â  await Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL) ]); loaderText.textContent = "Requesting camera access..."; stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });

Â  Â  Â  Â  Â  Â  video.srcObject = stream; video.onloadedmetadata = () => { cameraLoader.style.display = 'none'; startFaceDetection(); }; } catch (err) { console.error("Camera/Model Error:", err);

Â  Â  Â  Â  Â  Â  loaderText.textContent = "Camera access denied or models failed to load. Please refresh and try again."; setTimeout(stopCamera, 3000);

Â  Â  Â  Â  Â  Â  } }

Â  Â  Â  Â  function stopCamera() { clearInterval(detectionInterval); stream?.getTracks().forEach(track => track.stop()); cameraModal.classList.remove('active'); video.srcObject = null;

Â  Â  Â  Â  }

Â  Â  Â  Â  function startFaceDetection() { let captureTimeout; const context = canvas.getContext('2d');

Â  Â  Â  Â  Â  Â  detectionInterval = setInterval(async () => { const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(); const displaySize = { width: video.clientWidth, height: video.clientHeight }; faceapi.matchDimensions(canvas, displaySize); context.clearRect(0, 0, canvas.width, canvas.height); context.save(); context.translate(canvas.width, 0); context.scale(-1, 1); if (detections.length > 0) { const resizedDetections = faceapi.resizeResults(detections, displaySize); const box = resizedDetections[0].detection.box; context.strokeStyle = 'rgba(0, 255, 255, 0.4)'; context.lineWidth = 1; faceapi.draw.drawFaceLandmarks(canvas, resizedDetections[0].landmarks, { drawLines: true }); context.strokeStyle = '#00FFFF'; context.lineWidth = 3; context.shadowColor = '#00FFFF'; context.shadowBlur = 10; const cornerLength = box.width * 0.1; context.beginPath(); context.moveTo(box.x, box.y + cornerLength); context.lineTo(box.x, box.y); context.lineTo(box.x + cornerLength, box.y);

Â  Â  Â  Â  Â  Â  Â  Â  context.moveTo(box.x + box.width - cornerLength, box.y); context.lineTo(box.x + box.width, box.y); context.lineTo(box.x + box.width, box.y + cornerLength);

Â  Â  Â  Â  Â  Â  Â  Â  context.moveTo(box.x, box.y + box.height - cornerLength); context.lineTo(box.x, box.y + box.height); context.lineTo(box.x + cornerLength, box.y + box.height);

Â  Â  Â  Â  Â  Â  Â  Â  context.moveTo(box.x + box.width - cornerLength, box.y + box.height); context.lineTo(box.x + box.width, box.y + box.height);

Â  Â  Â  Â  Â  Â  Â  Â  context.lineTo(box.x + box.width, box.y + box.height - cornerLength); context.stroke(); context.shadowBlur = 0; const isGoodSize = box.width > canvas.width * 0.4;

Â  Â  Â  Â  Â  Â  Â  Â  if (isGoodSize) { cameraStatus.textContent = "Hold still..."; if (!captureTimeout) { captureTimeout = setTimeout(() => takePhoto(), 1500);

Â  Â  Â  Â  Â  Â  Â  Â  } } else { cameraStatus.textContent = "Move closer"; clearTimeout(captureTimeout); captureTimeout = null;

Â  Â  Â  Â  Â  Â  Â  Â  } } else { cameraStatus.textContent = "Position your face"; clearTimeout(captureTimeout); captureTimeout = null; } context.restore(); }, 100);

Â  Â  Â  Â  }

Â  Â  Â  Â  function takePhoto() { clearInterval(detectionInterval); cameraStatus.textContent = "Perfect!"; const photoCanvas = document.createElement('canvas');

Â  Â  Â  Â  Â  Â  photoCanvas.width = video.videoWidth; photoCanvas.height = video.videoHeight; const photoContext = photoCanvas.getContext('2d'); photoContext.translate(video.videoWidth, 0); photoContext.scale(-1, 1); photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

Â  Â  Â  Â  Â  Â  capturedPhotoDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9); userAnswers['selfie'] = 'Photo taken'; stopCamera(); updateProgressBar(); showPhotoForConfirmation();

Â  Â  Â  Â  }



function askForEmailAfterPhoto() {

Â  Â  return new Promise((resolve) => {

Â  Â  Â  Â  if (userAnswers.email) {

Â  Â  Â  Â  Â  Â  console.log('Email already collected:', userAnswers.email);

Â  Â  Â  Â  Â  Â  resolve();

Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }



Â  Â  Â  Â  addBotMessage("One last crucial step! Please enter your email to receive the report summary.");

Â  Â  Â  Â Â 

Â  Â  Â  Â  // <<-- Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• 3: Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ

Â  Â  Â  Â  inputArea.innerHTML = originalInputAreaHTML;

Â  Â  Â  Â  userInput = document.getElementById('user-input');

Â  Â  Â  Â  sendBtn = document.getElementById('send-btn');



Â  Â  Â  Â  inputArea.classList.remove('hidden');

Â  Â  Â  Â  userInput.value = '';

Â  Â  Â  Â  userInput.placeholder = "your@email.com";

Â  Â  Â  Â  userInput.type = 'email';

Â  Â  Â  Â Â 

Â  Â  Â  Â  eventManager.remove(sendBtn, 'click', 'email_submit');

Â  Â  Â  Â  eventManager.remove(userInput, 'keypress', 'email_keypress');

Â  Â  Â  Â Â 

Â  Â  Â  Â  if (!isMobile()) {Â 

Â  Â  Â  Â  Â  Â  userInput.focus();Â 

Â  Â  Â  Â  }



Â  Â  Â  Â  const emailSubmitHandler = async () => {

Â  Â  Â  Â  Â  Â  const email = userInput.value.trim();

Â  Â  Â  Â  Â  Â  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

Â  Â  Â  Â  Â  Â  if (!emailRegex.test(email)) {

Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage("Hmm, that doesn't look like a valid email. Could you please double-check it?");

Â  Â  Â  Â  Â  Â  Â  Â  userInput.focus();

Â  Â  Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  userAnswers.email = email;

Â  Â  Â  Â  Â  Â  addUserMessage(email);

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  await saveAnswerToServer('email', email);

Â  Â  Â  Â  Â  Â  } catch (error) {

Â  Â  Â  Â  Â  Â  Â  Â  console.error('Failed to save email:', error);

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  eventManager.remove(sendBtn, 'click', 'email_submit');

Â  Â  Â  Â  Â  Â  eventManager.remove(userInput, 'keypress', 'email_keypress');

Â  Â  Â  Â  Â  Â  inputArea.classList.add('hidden');

Â  Â  Â  Â  Â  Â  userInput.value = '';

Â  Â  Â  Â  Â  Â  userInput.type = 'text';

Â  Â  Â  Â  Â  Â  userInput.placeholder = "Type your answer...";

Â  Â  Â  Â  Â  Â  resolve();

Â  Â  Â  Â  };



Â  Â  Â  Â  const keyPressHandler = (e) => {

Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {

Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  Â  Â  emailSubmitHandler();

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  };



Â  Â  Â  Â  eventManager.add(sendBtn, 'click', emailSubmitHandler, 'email_submit');

Â  Â  Â  Â  eventManager.add(userInput, 'keypress', keyPressHandler, 'email_keypress');

Â  Â  });

}

Â  Â  Â  Â  async function startAnalysisAndShowForm() {

Â  Â  addUserMessage("Looks Good!");

Â  Â  document.getElementById('photo-preview-wrapper')?.remove();

Â  Â  optionsContainerWrapper.classList.add('hidden');

Â  Â  inputArea.classList.add('hidden');



Â  Â  await askForEmailAfterPhoto();Â 



Â  Â  showCompletionAnimation();

Â  Â  try {

Â  Â  Â  Â  Â  Â  const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', {

Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ photoDataUrl: capturedPhotoDataUrl })

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!analyzeResponse.ok) throw new Error('Skin analysis failed');

Â  Â  Â  Â  Â  Â  const analysisData = await analyzeResponse.json();

Â  Â  Â  Â  Â  Â  await fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'saveAnalysisData', sessionId: sessionId, analysisData: analysisData })

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  fetch('/.netlify/functions/result-background', {

Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ sessionId: sessionId })

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } catch (error) {

Â  Â  Â  Â  Â  Â  console.error('Error during analysis process:', error);

Â  Â  Â  Â  Â  Â  hideTypingIndicator();

Â  Â  Â  Â  Â  Â  addBotMessage("Sorry, an issue occurred. We'll use standard analysis for your report.");

Â  Â  Â  Â  Â  Â  fetch('/.netlify/functions/result-background', {

Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ sessionId: sessionId })

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  showPaymentForm();

Â  Â  Â  Â  }

Â  Â  }



Â  Â  Â  Â  function showPhotoForConfirmation() { const d = document.createElement('div');

Â  Â  Â  Â  Â  Â  d.id = 'photo-preview-wrapper'; d.className = 'flex justify-start mb-4 chat-bubble'; const i = `<div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs"><p class="mb-2">Here's the photo.

Â  Â  Â  Â  Â  Â  Happy with it?</p><img src="${capturedPhotoDataUrl}" alt="Your selfie" class="rounded-lg"/></div>`; d.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 flex-shrink-0 bot-avatar-lottie overflow-hidden" id="photo-confirm-avatar"></div>${i}`;

Â  Â  Â  Â  Â  Â  chatContainer.appendChild(d);

Â  Â  Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  Â  Â  animationManager.add('photo-confirm-avatar', { renderer: 'svg', loop: false, autoplay: true, path: 'avatar.json' });

Â  Â  Â  Â  Â  Â  const o = [ { text: 'Looks Good!', class: 'option-btn bg-green-500 border-green-600 text-white px-4 py-2 rounded-full text-sm flex-shrink-0 font-semibold' }, { text: 'Retake', class: 'option-btn bg-white border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm flex-shrink-0' } ];

Â  Â  Â  Â  Â  Â  const h = [startAnalysisAndShowForm, retakePhoto]; showOptions(o, h); inputArea.classList.add('hidden'); }

Â  Â  Â  Â  function retakePhoto() { addUserMessage("Retake");

Â  Â  Â  Â  Â  Â  document.getElementById('photo-preview-wrapper')?.remove(); optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); startCamera(); }

Â  Â  Â  Â Â 

Â  Â  Â  Â  let stripe, elements, clientSecret;

Â  Â  Â  Â  async function showPaymentForm() {

Â  Â  fbq('track', 'InitiateCheckout', {value: 9.99, currency: 'USD'});

Â  Â  let hasSentAddPaymentInfo = false;

Â  Â Â 

Â  Â  const sendAddPaymentInfoEvent = () => {

Â  Â  Â  Â  if (!hasSentAddPaymentInfo) {

Â  Â  Â  Â  Â  Â  fbq('track', 'AddPaymentInfo');

Â  Â  Â  Â  Â  Â  hasSentAddPaymentInfo = true;

Â  Â  Â  Â  Â  Â  console.log('Meta Event: AddPaymentInfo sent.');

Â  Â  Â  Â  }

Â  Â  };



Â  Â  optionsContainerWrapper.classList.add('hidden');

Â  Â  inputArea.classList.add('hidden');

Â  Â  const formHtml = `<div class="p-4 bg-gray-50 border-t"><div id="payment-wrapper" class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6"><div class="text-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Unlock Full Report</h2></div><div class="bg-purple-100 text-purple-800 rounded-lg p-3 text-center mb-4"><p class="text-sm font-medium">Limited Time Offer (-30%)</p><p id="countdown-timer" class="text-2xl font-bold tracking-wider">10:00</p></div><div class="text-center mb-4"><span class="text-3xl font-bold text-gray-800">$9.99</span><span class="text-lg text-gray-400 line-through ml-2">$14.99</span></div><form id="payment-form" class="space-y-4"><div id="payment-request-button"></div><div id="card-element" class="p-3 border border-gray-300 rounded-md shadow-sm"></div><button id="submit-payment" type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition-colors text-lg shadow-md"><span id="button-text">Pay now</span></button><div id="payment-message" class="hidden text-center text-red-500 text-sm pt-1"></div></form></div></div>`;

Â  Â  paymentFormContainer.innerHTML = formHtml;

Â  Â  paymentFormContainer.classList.remove('hidden');

Â  Â  scrollToBottom();

Â  Â  startCountdown();



Â  Â  stripe = Stripe('pk_live_51S1YfdPBAI3bxeVkFNBty0jUIvH37x0U3yZCOMu3Idd8Ei0XmAHP5vqRwbOR1cCNk4G48naTwy40n9enHvOlrYIB00LtAI8Nzb');



Â  Â  try {

Â  Â  Â  Â  const response = await fetch('/.netlify/functions/payment', {

Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  body: JSON.stringify({ sessionId: sessionId })

Â  Â  Â  Â  });

Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  clientSecret = data.clientSecret;

Â  Â  Â  Â  if (!clientSecret) throw new Error("Client secret not received.");

Â  Â  Â  Â Â 

Â  Â  Â  Â  elements = stripe.elements({ clientSecret });



Â  Â  Â  Â  const paymentRequest = stripe.paymentRequest({

Â  Â  Â  Â  Â  Â  country: 'US',

Â  Â  Â  Â  Â  Â  currency: 'usd',

Â  Â  Â  Â  Â  Â  total: { label: 'AI Wellness Report', amount: 999 },

Â  Â  Â  Â  Â  Â  requestPayerName: true,

Â  Â  Â  Â  Â  Â  requestPayerEmail: true,

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  const prButton = elements.create('paymentRequestButton', { paymentRequest });

Â  Â  Â  Â Â 

Â  Â  Â  Â  const canMakePayment = await paymentRequest.canMakePayment();

Â  Â  Â  Â  if (canMakePayment) {

Â  Â  Â  Â  Â  Â  prButton.mount('#payment-request-button');

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  document.getElementById('payment-request-button').style.display = 'none';

Â  Â  Â  Â  }



Â  Â  Â  Â  paymentRequest.on('paymentmethod', async (ev) => {

Â  Â  Â  Â  Â  Â  sendAddPaymentInfoEvent();

Â  Â  Â  Â  Â  Â  const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(clientSecret, { payment_method: ev.paymentMethod.id }, { handleActions: false });

Â  Â  Â  Â  Â  Â  if (confirmError) {

Â  Â  Â  Â  Â  Â  Â  Â  ev.complete('fail');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('payment-message').textContent = confirmError.message;

Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  ev.complete('success');

Â  Â  Â  Â  Â  Â  Â  Â  if (paymentIntent.status === "succeeded") {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleSuccessfulPayment();

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  });

Â  Â  Â  Â Â 

Â  Â  Â  Â  const cardElement = elements.create("card", { style: { base: { fontSize: '16px' } } });

Â  Â  Â  Â  cardElement.mount("#card-element");

Â  Â  Â  Â  cardElement.on('focus', () => { sendAddPaymentInfoEvent(); });

Â  Â  Â  Â  const paymentForm = document.getElementById('payment-form');

Â  Â  Â  Â  paymentForm.addEventListener('submit', handlePayment);

Â  Â  } catch (error) {

Â  Â  Â  Â  console.error("Failed to initialize payment form:", error);

Â  Â  Â  Â  document.getElementById('payment-wrapper').innerHTML = `<p class="text-center text-red-500">Could not load payment form. Error: ${error.message}</p>`;

Â  Â  }

}



Â  Â  Â  Â  async function handlePayment(e) {

Â  Â  e.preventDefault();

Â  Â  const submitButton = document.getElementById('submit-payment');

Â  Â  const messageDiv = document.getElementById('payment-message');

Â  Â  submitButton.disabled = true;

Â  Â  const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {

Â  Â  Â  Â  payment_method: { card: elements.getElement('card'), }

Â  Â  });

Â  Â  if (error) {

Â  Â  Â  Â  messageDiv.textContent = error.message;

Â  Â  Â  Â  messageDiv.classList.remove('hidden');

Â  Â  Â  Â  submitButton.disabled = false;

Â  Â  Â  Â  await fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'updatePayment', sessionId: sessionId, status: 'failed', amountUSD: '0' })

Â  Â  Â  Â  });

Â  Â  } else if (paymentIntent) {

Â  Â  Â  Â  if (paymentIntent.status === 'succeeded') {

Â  Â  Â  Â  Â  Â  await fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'updatePayment', sessionId: sessionId, status: 'succeeded', amountUSD: '9.99' })

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  handleSuccessfulPayment();

Â  Â  Â  Â  } else if (paymentIntent.status === 'requires_action') {

Â  Â  Â  Â  Â  Â  messageDiv.textContent = 'Additional authentication required';

Â  Â  Â  Â  Â  Â  messageDiv.classList.remove('hidden');

Â  Â  Â  Â  }

Â  Â  }

}



Â  Â  Â  Â  function handleSuccessfulPayment() {

Â  Â  Â  Â  Â  Â  clearQuizState();

Â  Â  Â  Â  Â  Â  paymentFormContainer.innerHTML = `<div class="p-8 text-center"><svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><h3 class="text-2xl font-bold mt-4">Payment Successful!</h3><p class="text-gray-600 mt-2">Finalizing your report...</p></div>`;

Â  Â  Â  Â  Â  Â  scrollToBottom();

Â  Â  Â  Â  Â  Â  setTimeout(() => { window.location.href = `result.html?session_id=${sessionId}&payment=success`; }, 2500);

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function startCountdown() {

Â  Â  Â  Â  Â  Â  let duration = 600;

Â  Â  Â  Â  Â  Â  const timerEl = document.getElementById('countdown-timer');Â 

Â  Â  Â  Â  Â  Â  if (!timerEl) return;Â 

Â  Â  Â  Â  Â  Â  countdownInterval = setInterval(() => {

Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor(duration / 60).toString().padStart(2, '0');

Â  Â  Â  Â  Â  Â  Â  Â  const seconds = (duration % 60).toString().padStart(2, '0');

Â  Â  Â  Â  Â  Â  Â  Â  timerEl.textContent = `${minutes}:${seconds}`;

Â  Â  Â  Â  Â  Â  Â  Â  duration--;

Â  Â  Â  Â  Â  Â  Â  Â  if (duration < 0) { clearInterval(countdownInterval); timerEl.textContent = "00:00"; }

Â  Â  Â  Â  Â  Â  }, 1000);

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  function showCompletionAnimation() {

Â  Â  Â  Â  Â  Â  const analysisAnimationPath = 'loader-animation.json';

Â  Â  Â  Â  Â  Â  confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });Â 

Â  Â  Â  Â  Â  Â  showTypingIndicator();

Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  hideTypingIndicator();Â 

Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage("Awesome work! You've completed the assessment. ğŸ¥³ I'm now analyzing your results...");Â 

Â  Â  Â  Â  Â  Â  Â  Â  inputArea.innerHTML = `<div class="analysis-container"><div id="analysis-animation" class="analysis-animation"></div><p id="analysis-text">Initializing analysis...</p></div>`;Â 

Â  Â  Â  Â  Â  Â  Â  Â  inputArea.classList.remove('hidden');Â 

Â  Â  Â  Â  Â  Â  Â  Â  scrollToBottom();Â 

Â  Â  Â  Â  Â  Â  Â  Â  animationManager.add('analysis-animation', { renderer: 'svg', loop: true, autoplay: true, path: analysisAnimationPath });

Â  Â  Â  Â  Â  Â  Â  Â  const analysisSteps = [ "Analyzing your data...", "Checking lifestyle factors...", "Scanning skin health...", "Calculating biological age...", "Almost ready..." ];

Â  Â  Â  Â  Â  Â  Â  Â  const analysisTextElement = document.getElementById('analysis-text');Â 

Â  Â  Â  Â  Â  Â  Â  Â let currentStep = 0;Â 

Â  Â  Â  Â  Â  Â  Â  Â  const intervalId = setInterval(() => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentStep < analysisSteps.length) {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analysisTextElement.style.opacity = '0';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analysisTextElement.textContent = analysisSteps[currentStep];Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  analysisTextElement.style.opacity = '1';Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStep++;Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { clearInterval(intervalId); }Â 

Â  Â  Â  Â  Â  Â  Â  Â  }, 1600);

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  inputArea.classList.add('hidden');Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showTypingIndicator();Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideTypingIndicator();Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage("Great! Your preliminary analysis is complete. Just one final step to unlock your full, personalized report.");Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPaymentForm();Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1200);Â 

Â  Â  Â  Â  Â  Â  Â  Â  }, analysisSteps.length * 1600 + 500);

Â  Â  Â  Â  Â  Â  }, 1000);Â 

Â  Â  Â  Â  }



Â  Â  Â  Â async function initQuiz() {

Â  Â  setAppHeight();

Â  Â  const urlParams = new URLSearchParams(window.location.search);

Â  Â  const urlSessionId = urlParams.get('session');

Â  Â Â 

Â  Â  if (urlSessionId) {

Â  Â  Â  Â  sessionId = urlSessionId;

Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  const response = await fetch('/.netlify/functions/quiz', {

Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',

Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },

Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: 'getSession', sessionId: sessionId })

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (response.ok) {

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (data.answers) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userAnswers = data.answers;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveQuizState();

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (error) { console.error('Failed to load session data:', error); }

Â  Â  Â  Â  showCompletionAnimation();

Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  inputArea.classList.add('hidden');

Â  Â  Â  Â  Â  Â  showTypingIndicator();

Â  Â  Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  Â  Â  hideTypingIndicator();

Â  Â  Â  Â  Â  Â  Â  Â  addBotMessage("Welcome back! Let's complete your payment to get your full report.");

Â  Â  Â  Â  Â  Â  Â  Â  showPaymentForm();

Â  Â  Â  Â  Â  Â  }, 1200);

Â  Â  Â  Â  }, 1000);

Â  Â  Â  Â  return;

Â  Â  }

Â  Â Â 

Â  Â  const isNewSession = await startQuizSession();

Â  Â Â 

Â  Â  if (!isNewSession && currentQuestionIndex > 0) {

Â  Â  Â  Â  addBotMessage("Welcome back! Let's continue where you left off.");

Â  Â  Â  Â  updateProgressBar();

Â  Â  Â  Â  askNextQuestion();

Â  Â  } else {

Â  Â  Â  Â  if (sessionId) {

Â  Â  Â  Â  Â  Â  askNextQuestion();

Â  Â  Â  Â  }

Â  Â  }

}



let globalHandlersActive = false;



function setupGlobalHandlers() {

Â  Â  if (globalHandlersActive) return;

Â  Â Â 

Â  Â  const globalClickHandler = () => {

Â  Â  Â  Â  if (!inputArea.classList.contains('hidden') && userInput.type !== 'email') {

Â  Â  Â  Â  Â  Â  handleAnswer(userInput.value);

Â  Â  Â  Â  }

Â  Â  };

Â  Â Â 

Â  Â  const globalKeyHandler = (e) => {

Â  Â  Â  Â  if (e.key === 'Enter' && !inputArea.classList.contains('hidden') && userInput.type !== 'email') {

Â  Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  Â  handleAnswer(userInput.value);

Â  Â  Â  Â  }

Â  Â  };

Â  Â Â 

Â  Â  eventManager.add(sendBtn, 'click', globalClickHandler, 'global_click');

Â  Â  eventManager.add(userInput, 'keypress', globalKeyHandler, 'global_keypress');

Â  Â  globalHandlersActive = true;

}



function cleanup() {

Â  Â  eventManager.removeAll();

Â  Â  animationManager.clear();

Â  Â  if (detectionInterval) { clearInterval(detectionInterval); detectionInterval = null; }

Â  Â  if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }

Â  Â  if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }

Â  Â  if (video && video.srcObject) { video.srcObject = null; }

}

window.addEventListener('beforeunload', cleanup);



window.addEventListener('resize', setAppHeight);

inputArea.classList.add('hidden');

setupGlobalHandlers();

initQuiz();

Â  Â  </script>

Â  Â  <script>

Â  Â  Â  Â  fbq('track', 'ViewContent');

Â  Â  Â  Â  if (isInAppBrowser()) {

Â  Â  Â  Â  Â  Â  console.log('In-app browser detected:', navigator.userAgent);

Â  Â  Â  Â  }

Â  Â  </script>

</body>

</html>
