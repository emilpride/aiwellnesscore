<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-container { 
            scroll-behavior: smooth; 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .chat-container::-webkit-scrollbar { 
            display: none;
        }
        .chat-bubble { animation: slide-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes slide-up {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .options-container::-webkit-scrollbar { display: none; }
        .options-container { -ms-overflow-style: none; scrollbar-width: none; }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .bot-avatar { animation: avatar-float 3s ease-in-out infinite; }
        @keyframes avatar-float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
            100% { transform: translateY(0); }
        }

        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden; border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); }
        #camera-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #camera-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; text-align: center; }
        #camera-status { background-color: rgba(0,0,0,0.5); padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s; }

        #progress-bar {
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7; }
            to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1; }
        }
        .pulse-btn {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); }
            100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
        }
        .payment-form {
            animation: slide-up-form 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes slide-up-form {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        /* Style for the list in the bot message */
        .bot-list { list-style: none; padding-left: 20px; }
        .bot-list li { position: relative; margin-bottom: 8px; }
        .bot-list li::before {
            content: '✓';
            position: absolute;
            left: -20px;
            color: #8b5cf6; /* A purple checkmark */
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 md:flex md:items-center md:justify-center min-h-screen">
    <div id="main-container" class="w-full md:h-[90vh] md:max-w-lg flex flex-col bg-white md:shadow-2xl md:rounded-2xl overflow-hidden">
        <div class="w-full bg-gray-200">
            <div id="progress-bar" class="h-2 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
        </div>
        
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        
        <div id="options-container-wrapper" class="px-4 pt-1 pb-2">
             <div id="options-container" class="flex gap-2 overflow-x-auto py-2 options-container"></div>
        </div>
        
        <div id="input-area" class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>

        <div id="payment-form-container" class="hidden"></div>
    </div>

    <div id="camera-modal">
        <div id="camera-container">
            <video id="camera-video" autoplay muted playsinline></video>
            <canvas id="camera-canvas"></canvas>
            <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p>
            </div>
            <div id="camera-overlay">
                <p id="camera-status">Position your face in the frame</p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const mainContainer = document.getElementById('main-container'); 
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const optionsContainer = document.getElementById('options-container');
        const optionsContainerWrapper = document.getElementById('options-container-wrapper');
        const inputArea = document.getElementById('input-area');
        const progressBar = document.getElementById('progress-bar');
        const cameraModal = document.getElementById('camera-modal');
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        const cameraLoader = document.getElementById('camera-loader');
        const loaderText = document.getElementById('loader-text');
        const cameraStatus = document.getElementById('camera-status');
        const paymentFormContainer = document.getElementById('payment-form-container');

        // --- State ---
        let sessionId = null;
        const userAnswers = {};
        let currentQuestionIndex = 0;
        let detectionInterval;
        let stream;
        let capturedPhotoDataUrl = null;
        let countdownInterval;

        // --- Quiz Data ---
        const quizQuestions = [
            { key: 'intro_dave', type: 'message', text: "Hey! I'm Dave, your personal AI wellness assistant today. 👋" },
            { key: 'name', type: 'question', text: "What should I call you?", options: [], placeholder: "Type your name..." },
            { 
                key: 'intro_purpose', 
                type: 'message', 
                text: (name) => `Great to meet you, ${name}! Here's a quick look at what we'll uncover together:
                    <ul class="bot-list mt-2 text-sm">
                        <li>Calculate your Wellness Score</li>
                        <li>Reveal your Biological Age</li>
                        <li>Assess your energy and recovery levels</li>
                        <li>Measure your stress and find ways to reduce it</li>
                        <li>Analyze your skin health with AI insights</li>
                        <li>Review nutrition, BMI & life expectancy</li>
                        <li>Highlight healthy habits & areas for improvement</li>
                        <li>Provide a personalized 7-day improvement plan</li>
                    </ul>`
            },
            { key: 'intro_how', type: 'message', text: "To help you on your wellness journey, I need to get to know you a bit better—your lifestyle, habits, and a quick, secure look at you." },
            { key: 'intro_convo', type: 'message', text: "What makes this unique is our relaxed, conversational approach. I'll ask some questions, and you can use the quick-reply buttons or type your own answers. Every detail helps, so I appreciate you taking the time!" },
            { key: 'intro_testimonial', type: 'message', text: "Our users often start feeling improvements within the first week of following their personalized recommendations. 📈" }, // Placeholder for graph animation
            { key: 'intro_privacy', type: 'message', text: "And just to be clear about your privacy 🛡️: your photo is deleted immediately after the AI analysis, and your answers are wiped as soon as you get your report." },
            { key: 'start_consent', type: 'question', text: "Ready to begin?", options: ["Yes, let's start!"], hideInput: true },
            
            // --- Original Questions Start Here ---
            { key: 'age', type: 'question', text: (name) => `Perfect, ${name}! To start, what's your age? 🎂`, options: [], placeholder: "Type your exact age..." },
            { key: 'gender', type: 'question', text: "Great start! Now, what's your biological sex? 🧬", options: ['Male', 'Female'], placeholder: "or type your gender..." },
            { key: 'height', type: 'question', text: "Perfect. Let's talk about your height. 📏 (e.g., 5 ft 10 in)", options: ["Under 5 ft", "5'0\" - 5'5\"", "5'6\" - 5'11\"", "6'0\" - 6'5\"", "Over 6'5\""], placeholder: "or type your height..." },
            { key: 'weight', type: 'question', text: "Thanks! And your current weight in pounds? ⚖️", options: ["Under 120 lbs", "120-150 lbs", "151-180 lbs", "181-220 lbs", "Over 220 lbs"], placeholder: "or type your weight in lbs..." },
            { key: 'sleep', type: 'question', text: "Sleep is crucial. 😴 How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], placeholder: "or type your sleep hours..." },
            { key: 'mot_sleep', type: 'message', text: "Excellent. Quality sleep is the foundation of wellness. 👍" },
            { key: 'activity', type: 'question', text: "Awesome. Movement is key! 🏃‍♀️ How often do you engage in moderate physical activity (like a brisk walk) per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], placeholder: "or type how many times..." },
            { key: 'mot_activity', type: 'message', text: "Great job! Every bit of movement counts. ✨" },
            { key: 'nutrition', type: 'question', text: "Let's dive into nutrition. 🥦 How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], placeholder: "or type number of servings..." },
            { key: 'processed_food', type: 'question', text: "Honesty is the best policy here. 😉 How often do you eat processed or fast food in a typical week?", options: ["Rarely", "1-2 times", "3-4 times", "Daily"], placeholder: "or type how often..." },
            { key: 'mot_nutrition', type: 'message', text: "Thanks for sharing. Nutrition is fuel for your body and mind! ⛽" },
            { key: 'hydration', type: 'question', text: "Hydration check! 💧 How many glasses of water (approx. 8 oz) do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], placeholder: "or type number of glasses..." },
            { key: 'stress', type: 'question', text: "Now for the mind. 🧠 On a scale of 1 to 10, how would you rate your typical stress level?", options: ["1-3 (Low)", "4-6 (Moderate)", "7-8 (High)", "9-10 (Very High)"], placeholder: "or type a number from 1-10..." },
            { key: 'mindfulness', type: 'question', text: "Finding calm is a superpower. 🧘‍♂️ How often do you practice mindfulness, meditation, or deep breathing?", options: ["Never", "Occasionally", "Weekly", "Daily"], placeholder: "or type how often..." },
            { key: 'mot_mind', type: 'message', text: "Awesome! Taking time for your mind is just as important as for your body. 🙏" },
            { key: 'mood', type: 'question', text: "Let's check in with your emotions. ❤️ How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "Neutral", "Often Stressed or Sad"], placeholder: "or describe your mood..." },
            { key: 'alcohol', type: 'question', text: "Time for some lifestyle questions. 🍻 How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"], placeholder: "or type number of drinks..." },
            { key: 'smoking', type: 'question', text: "This is a safe space. 🚭 Do you smoke or use tobacco products?", options: ["No", "Occasionally", "Yes, daily"], placeholder: "or type your answer..." },
            { key: 'screen_time', type: 'question', text: "Last question before the final step! 📱 How much time do you spend on screens (phone, computer, TV) outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"], placeholder: "or type number of hours..." },
            { key: 'camera', type: 'final_step', text: "You did it! 🎉 That's all the questions. Now for the fun part: a quick selfie. This helps me analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored. Please allow camera access and position your face within the frame." }
        ];

        // --- Utility Functions ---
        const setAppHeight = () => {
            mainContainer.style.height = `${window.innerHeight}px`;
        };

        const isMobile = () => window.innerWidth <= 768;
        const scrollToBottom = () => {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 0);
        };


        // --- SERVER COMMUNICATION ---
        async function startQuizSession() {
            try {
                const response = await fetch('/.netlify/functions/quiz', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ action: 'startSession' }) 
                });
                if (!response.ok) throw new Error('Server error starting session');
                const data = await response.json();
                sessionId = data.sessionId;
            } catch (error) {
                console.error('Failed to start session:', error);
                addBotMessage("Sorry, I'm having trouble connecting to my brain right now. 🧠 Please try refreshing the page.");
                inputArea.style.display = 'none';
            }
        }

        async function saveAnswerToServer(questionKey, answer) {
            if (!sessionId) return;
            try {
                await fetch('/.netlify/functions/quiz', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ action: 'saveAnswer', sessionId, questionId: questionKey, answer }) 
                });
            } catch (error) { 
                console.error('Failed to save answer:', error); 
            }
        }

        async function proceedToAnalysis() {
            try {
                const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoDataUrl: capturedPhotoDataUrl })
                });

                let faceData = null;
                if (!analyzeResponse.ok) {
                    console.error('Face analysis failed, but continuing.');
                    faceData = { error: 'Analysis failed', details: await analyzeResponse.text() };
                } else {
                    faceData = await analyzeResponse.json();
                }

                await saveAnswerToServer('faceAnalysis', faceData);

                await fetch('/.netlify/functions/result-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });

                showCompletionAnimation();

            } catch (error) {
                console.error('Error during photo analysis step:', error);
                addBotMessage("I had a little trouble with the photo analysis, but don't worry! I'll generate your report with the rest of your answers.");
                await saveAnswerToServer('faceAnalysis', { error: error.message });
                await fetch('/.netlify/functions/result-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
                showCompletionAnimation();
            }
        }
        
        // --- Main UI Functions ---
        
        function updateProgressBar() {
            const questionKeys = quizQuestions.filter(q => q.type === 'question').map(q => q.key);
            const totalSteps = questionKeys.length + 1; // +1 for the final photo step
            const completedAnswers = Object.keys(userAnswers).filter(key => questionKeys.includes(key)).length;
            const photoStepCompleted = userAnswers['selfie'] ? 1 : 0;
            const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100;
            progressBar.style.width = `${progress}%`;
        }


        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex justify-start mb-4 chat-bubble';
            typingDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>`;
            chatContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }

        function addBotMessage(html) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start mb-4 chat-bubble';
            messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div>`;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end mb-4 chat-bubble';
            messageDiv.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${text}</div>`;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function showOptions(options, handlers) {
            optionsContainer.innerHTML = '';
            if (options?.length > 0) {
                optionsContainerWrapper.classList.remove('hidden');
                options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.textContent = option.text;
                    button.className = option.class;
                    button.onclick = handlers[index];
                    optionsContainer.appendChild(button);
                });
            } else {
                 optionsContainerWrapper.classList.add('hidden');
            }
        }

        function handleAnswer(answer) {
            if (!answer.trim()) return;
            const currentQuestion = quizQuestions[currentQuestionIndex];
            addUserMessage(answer);
            
            userAnswers[currentQuestion.key] = answer.trim();
            saveAnswerToServer(currentQuestion.key, answer.trim());
            
            userInput.value = '';
            inputArea.classList.add('hidden');
            optionsContainerWrapper.classList.add('hidden');

            currentQuestionIndex++;
            updateProgressBar();
            askNextQuestion();
        }

        function askNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                return;
            }

            const question = quizQuestions[currentQuestionIndex];
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                let questionText = typeof question.text === 'function' ? question.text(userAnswers.name || 'friend') : question.text;

                if (question.type === 'message') {
                    addBotMessage(questionText);
                    currentQuestionIndex++;
                    askNextQuestion();
                } else if (question.type === 'question') {
                    addBotMessage(questionText);
                    const optionButtons = question.options.map(opt => ({ text: opt, class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50' }));
                    const handlers = question.options.map(opt => () => handleAnswer(opt));
                    showOptions(optionButtons, handlers);
                    
                    if (question.hideInput) {
                        inputArea.classList.add('hidden');
                    } else {
                        inputArea.classList.remove('hidden');
                        userInput.placeholder = question.placeholder || "Type your answer...";
                    }
                    if (!isMobile()) {
                        userInput.focus();
                    }
                } else if (question.type === 'final_step') {
                    inputArea.classList.add('hidden');
                    addBotMessage(questionText);
                    showCameraStep();
                }
            }, 1200);
        }

        function showCameraStep() {
            optionsContainerWrapper.classList.add('hidden');
            inputArea.classList.remove('hidden');
            inputArea.innerHTML = `
                <button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors pulse-btn">
                    Open Camera
                </button>`;
            document.getElementById('open-camera-btn').onclick = startCamera;
        }

        // --- Camera and Face Detection Logic ---

        async function startCamera() {
            cameraModal.classList.add('active');
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
                ]);

                loaderText.textContent = "Requesting camera access...";
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    cameraLoader.style.display = 'none';
                    startFaceDetection();
                };

            } catch (err) {
                console.error("Camera/Model Error:", err);
                loaderText.textContent = "Camera access denied or models failed to load. Please refresh and try again.";
                setTimeout(stopCamera, 3000);
            }
        }
        
        function stopCamera() {
            clearInterval(detectionInterval);
            stream?.getTracks().forEach(track => track.stop());
            cameraModal.classList.remove('active');
            video.srcObject = null;
        }

        function startFaceDetection() {
            let captureTimeout;
            const context = canvas.getContext('2d');

            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
                
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.save();
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
                
                if (detections.length > 0) {
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    const box = resizedDetections[0].detection.box;

                    context.strokeStyle = 'rgba(0, 255, 255, 0.4)';
                    context.lineWidth = 1;
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections[0].landmarks, { drawLines: true });
                    
                    context.strokeStyle = '#00FFFF';
                    context.lineWidth = 3;
                    context.shadowColor = '#00FFFF';
                    context.shadowBlur = 10;
                    const cornerLength = box.width * 0.1;
                    context.beginPath();
                    context.moveTo(box.x, box.y + cornerLength); context.lineTo(box.x, box.y); context.lineTo(box.x + cornerLength, box.y);
                    context.moveTo(box.x + box.width - cornerLength, box.y); context.lineTo(box.x + box.width, box.y); context.lineTo(box.x + box.width, box.y + cornerLength);
                    context.moveTo(box.x, box.y + box.height - cornerLength); context.lineTo(box.x, box.y + box.height); context.lineTo(box.x + cornerLength, box.y + box.height);
                    context.moveTo(box.x + box.width - cornerLength, box.y + box.height); context.lineTo(box.x + box.width, box.y + box.height); context.lineTo(box.x + box.width, box.y + box.height - cornerLength);
                    context.stroke();
                    context.shadowBlur = 0;


                    const isGoodSize = box.width > canvas.width * 0.4;
                    if (isGoodSize) {
                        cameraStatus.textContent = "Hold still...";
                         if (!captureTimeout) {
                            captureTimeout = setTimeout(() => takePhoto(), 1500);
                        }
                    } else {
                         cameraStatus.textContent = "Move closer";
                         clearTimeout(captureTimeout);
                         captureTimeout = null;
                    }
                } else {
                    cameraStatus.textContent = "Position your face";
                    clearTimeout(captureTimeout);
                    captureTimeout = null;
                }
                context.restore();
            }, 100);
        }

        function takePhoto() {
            clearInterval(detectionInterval);
            cameraStatus.textContent = "Perfect!";
            const photoCanvas = document.createElement('canvas');
            photoCanvas.width = video.videoWidth;
            photoCanvas.height = video.videoHeight;
            const photoContext = photoCanvas.getContext('2d');
            
            photoContext.translate(video.videoWidth, 0);
            photoContext.scale(-1, 1);
            photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            capturedPhotoDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9);
            userAnswers['selfie'] = 'Photo taken';
            
            stopCamera();
            updateProgressBar();
            showPhotoForConfirmation();
        }

        function showPhotoForConfirmation() {
            const messageWrapper = document.createElement('div');
            messageWrapper.id = 'photo-preview-wrapper';
            messageWrapper.className = 'flex justify-start mb-4 chat-bubble';

            const imageHtml = `<div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">
                <p class="mb-2">Here's the photo. Happy with it?</p>
                <img src="${capturedPhotoDataUrl}" alt="Your selfie" class="rounded-lg"/>
            </div>`;
            
            messageWrapper.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                ${imageHtml}`;
            
            chatContainer.appendChild(messageWrapper);
            scrollToBottom();

            const confirmOptions = [
                { text: 'Looks Good!', class: 'option-btn bg-green-500 border-green-600 text-white px-4 py-2 rounded-full text-sm flex-shrink-0 font-semibold' },
                { text: 'Retake', class: 'option-btn bg-white border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm flex-shrink-0' }
            ];
            const handlers = [showPaymentForm, retakePhoto];
            showOptions(confirmOptions, handlers);
            inputArea.classList.add('hidden');
        }

        function retakePhoto() {
            addUserMessage("Retake");
            const photoPreview = document.getElementById('photo-preview-wrapper');
            if (photoPreview) photoPreview.remove();
            optionsContainerWrapper.classList.add('hidden');
            inputArea.classList.add('hidden');
            startCamera();
        }

        // --- Payment Form Logic ---
        function showPaymentForm() {
            addUserMessage("Looks Good!");
            document.getElementById('photo-preview-wrapper')?.remove();
            optionsContainerWrapper.classList.add('hidden');
            inputArea.classList.add('hidden');
            
            const formHtml = `
            <div class="payment-form p-4 border-t border-gray-200 bg-gray-50">
                <div class="relative bg-black/20 backdrop-blur-xl border border-white/10 text-white p-6 rounded-2xl shadow-lg overflow-hidden">
                    
                    <div class="sticky top-0 z-10 bg-black/30 backdrop-blur-sm -mx-6 -mt-6 mb-5 p-2 rounded-t-2xl text-center">
                        <p class="text-sm text-purple-200 font-medium">This exclusive offer ends in:</p>
                        <p id="countdown-timer" class="text-2xl font-bold tracking-widest">10:00</p>
                    </div>

                    <div class="relative z-0">
                        <h3 class="text-2xl font-extrabold text-center">Unlock Your Full Report</h3>
                        
                        <div class="my-5 text-center">
                            <span class="text-5xl font-extrabold text-white">$9.99</span>
                            <span class="text-xl font-medium text-gray-400 line-through ml-2">$24.99</span>
                        </div>

                        <div class="space-y-3">
                            <div class="bg-white/5 border border-white/20 rounded-lg p-3 flex items-center gap-3 text-sm text-gray-300 placeholder-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                                <span class="flex-1">Card Number</span>
                                <span>MM / YY</span>
                                <span>CVC</span>
                            </div>
                        </div>

                        <button id="pay-btn" class="mt-5 w-full bg-purple-600 font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-all text-lg shadow-lg shadow-purple-500/20">
                           Pay Now & Get Report
                        </button>
                         <p class="text-xs text-purple-200/60 mt-3 text-center flex items-center justify-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg>
                            SSL Secure Payment
                        </p>
                    </div>
                </div>
            </div>`;
            paymentFormContainer.innerHTML = formHtml;
            paymentFormContainer.classList.remove('hidden');
            scrollToBottom();

            document.getElementById('pay-btn').onclick = handlePayment;
            startCountdown();
        }

        function startCountdown() {
            let duration = 10 * 60; // 10 minutes
            const timerEl = document.getElementById('countdown-timer');
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                const seconds = (duration % 60).toString().padStart(2, '0');
                timerEl.textContent = `${minutes}:${seconds}`;
                duration--;
                if (duration < 0) {
                    clearInterval(countdownInterval);
                    timerEl.textContent = "00:00";
                    document.getElementById('pay-btn').textContent = "Offer Expired";
                    document.getElementById('pay-btn').disabled = true;
                }
            }, 1000);
        }

        function handlePayment() {
            clearInterval(countdownInterval);
            paymentFormContainer.innerHTML = '';
            paymentFormContainer.classList.add('hidden');
            proceedToAnalysis();
        }
        
        function showCompletionAnimation() {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
            
            setTimeout(() => {
                 showTypingIndicator();
                 setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage("Awesome work! You've completed the assessment. 🥳 I'm now analyzing your results...");
                    inputArea.innerHTML = `<div class="text-center p-2"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div><p class="text-gray-600 mt-2">This will just take a moment...</p></div>`;
                    inputArea.style.display = 'block';
                    
                    setTimeout(() => {
                        const resultUrl = `/results.html?sessionId=${sessionId}`;
                        hideTypingIndicator();
                        addBotMessage(`All done! Your personalized report is ready. 🚀 <br><a href="${resultUrl}" class="inline-block mt-2 bg-purple-600 text-white font-bold py-2 px-6 rounded-full hover:bg-purple-700 transition-colors">View My Report</a>`);
                        inputArea.style.display = 'none';
                    }, 8000);
                }, 1000);
            }, 1500);
        }

        // --- Event Listeners & Initial Call ---
        async function initQuiz() {
            setAppHeight(); 
            await startQuizSession();
            if (sessionId) {
                askNextQuestion();
            }
        }
        
        sendBtn.addEventListener('click', () => handleAnswer(userInput.value));
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAnswer(userInput.value);
        });

        window.addEventListener('resize', setAppHeight);
        
        inputArea.classList.add('hidden');
        initQuiz();

    </script>
</body>
</html>
