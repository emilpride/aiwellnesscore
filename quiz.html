<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Face Recognition Script -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <!-- Confetti Animation Script -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-container { 
            scroll-behavior: smooth; 
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .chat-container::-webkit-scrollbar { 
            display: none; /* Chrome, Safari, Opera*/
        }
        .chat-bubble { animation: slide-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes slide-up {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .options-container::-webkit-scrollbar { display: none; }
        .options-container { -ms-overflow-style: none; scrollbar-width: none; }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* Avatar Animation */
        .bot-avatar { animation: avatar-float 3s ease-in-out infinite; }
        @keyframes avatar-float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
            100% { transform: translateY(0); }
        }

        /* Camera Modal Styles */
        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 640px; aspect-ratio: 3/4; overflow: hidden; border-radius: 1.5rem; background: #111; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #camera-loader p { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        #face-outline {
            position: absolute;
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            transition: all 0.2s ease-out;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.7);
            opacity: 0;
        }
        #face-outline.detected {
             border-color: #4ade80; /* green-400 */
             box-shadow: 0 0 30px rgba(74, 222, 128, 0.9);
             opacity: 1;
        }

        /* New Animations */
        #progress-bar {
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7; }
            to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1; }
        }
        .pulse-btn {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); }
            100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); }
        }

    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 md:flex md:items-center md:justify-center min-h-screen">
    <div class="w-full h-screen md:h-[90vh] md:max-w-lg flex flex-col bg-white md:shadow-2xl md:rounded-2xl overflow-hidden">
        <!-- Progress Bar -->
        <div class="w-full bg-gray-200">
            <div id="progress-bar" class="h-2 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
        </div>
        
        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        
        <!-- Options Area -->
        <div id="options-container-wrapper" class="px-4">
             <div id="options-container" class="flex gap-2 overflow-x-auto py-3 options-container"></div>
        </div>
        
        <!-- Input Area -->
        <div id="input-area" class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal">
        <div id="camera-container">
            <video id="camera-video" autoplay muted playsinline></video>
            <canvas id="camera-canvas"></canvas>
            <div id="face-outline"></div>
            <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const optionsContainer = document.getElementById('options-container');
        const optionsContainerWrapper = document.getElementById('options-container-wrapper');
        const inputArea = document.getElementById('input-area');
        const progressBar = document.getElementById('progress-bar');
        const cameraModal = document.getElementById('camera-modal');
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        const cameraLoader = document.getElementById('camera-loader');
        const loaderText = document.getElementById('loader-text');

        // --- State ---
        let sessionId = null;
        const userAnswers = {};
        let currentQuestionIndex = 0;
        let detectionInterval;
        let stream;

        // --- Quiz Data ---
        const quizQuestions = [
            { key: 'welcome', type: 'message', text: "Hello! üëã I'm your personal AI Wellness Coach. I'll be guiding you through this analysis to help you discover insights about your well-being." },
            { key: 'disclaimer', type: 'message', text: "Before we begin, a quick heads-up: ‚òùÔ∏è I'm an AI coach, not a medical doctor. This analysis is for educational purposes only and is not a substitute for professional medical advice." },
            { key: 'terms', type: 'question', text: "Your privacy is our top priority. üõ°Ô∏è Everything is secure and anonymous. We never store your photo, and all your data is permanently deleted right after you get your report. Please confirm you agree to our <a href='#' target='_blank' class='underline text-purple-600'>Terms</a> and <a href='#' target='_blank' class='underline text-purple-600'>Privacy Policy</a> to continue.", options: ["I Understand & Agree"] },
            { key: 'name', type: 'question', text: "Great, let's get started! What should I call you? üòä", options: [], placeholder: "Type your name..." },
            { key: 'age', type: 'question', text: (name) => `Perfect, ${name}! To start, what's your age? üéÇ`, options: ['Under 18', '18-25', '26-35', '36-50', '50+'], placeholder: "or type your age..." },
            { key: 'gender', type: 'question', text: "Great start! Now, what's your biological sex? üß¨", options: ['Male', 'Female'], placeholder: "or type your gender..." },
            { key: 'height', type: 'question', text: "Perfect. Let's talk about your height. üìè (e.g., 5 ft 10 in)", options: ["Under 5 ft", "5'0\" - 5'5\"", "5'6\" - 5'11\"", "6'0\" - 6'5\"", "Over 6'5\""], placeholder: "or type your height..." },
            { key: 'weight', type: 'question', text: "Thanks! And your current weight in pounds? ‚öñÔ∏è", options: ["Under 120 lbs", "120-150 lbs", "151-180 lbs", "181-220 lbs", "Over 220 lbs"], placeholder: "or type your weight in lbs..." },
            { key: 'sleep', type: 'question', text: "Sleep is crucial. üò¥ How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], placeholder: "or type your sleep hours..." },
            { key: 'mot_sleep', type: 'message', text: "Excellent. Quality sleep is the foundation of wellness. üëç" },
            { key: 'activity', type: 'question', text: "Awesome. Movement is key! üèÉ‚Äç‚ôÄÔ∏è How often do you engage in moderate physical activity (like a brisk walk) per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], placeholder: "or type how many times..." },
            { key: 'mot_activity', type: 'message', text: "Great job! Every bit of movement counts. ‚ú®" },
            { key: 'nutrition', type: 'question', text: "Let's dive into nutrition. ü•¶ How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], placeholder: "or type number of servings..." },
            { key: 'processed_food', type: 'question', text: "Honesty is the best policy here. üòâ How often do you eat processed or fast food in a typical week?", options: ["Rarely", "1-2 times", "3-4 times", "Daily"], placeholder: "or type how often..." },
            { key: 'mot_nutrition', type: 'message', text: "Thanks for sharing. Nutrition is fuel for your body and mind! ‚õΩ" },
            { key: 'hydration', type: 'question', text: "Hydration check! üíß How many glasses of water (approx. 8 oz) do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], placeholder: "or type number of glasses..." },
            { key: 'stress', type: 'question', text: "Now for the mind. üß† On a scale of 1 to 10, how would you rate your typical stress level?", options: ["1-3 (Low)", "4-6 (Moderate)", "7-8 (High)", "9-10 (Very High)"], placeholder: "or type a number from 1-10..." },
            { key: 'mindfulness', type: 'question', text: "Finding calm is a superpower. üßò‚Äç‚ôÇÔ∏è How often do you practice mindfulness, meditation, or deep breathing?", options: ["Never", "Occasionally", "Weekly", "Daily"], placeholder: "or type how often..." },
            { key: 'mot_mind', type: 'message', text: "Awesome! Taking time for your mind is just as important as for your body. üôè" },
            { key: 'mood', type: 'question', text: "Let's check in with your emotions. ‚ù§Ô∏è How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "Neutral", "Often Stressed or Sad"], placeholder: "or describe your mood..." },
            { key: 'alcohol', type: 'question', text: "Time for some lifestyle questions. üçª How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"], placeholder: "or type number of drinks..." },
            { key: 'smoking', type: 'question', text: "This is a safe space. üö≠ Do you smoke or use tobacco products?", options: ["No", "Occasionally", "Yes, daily"], placeholder: "or type your answer..." },
            { key: 'screen_time', type: 'question', text: "Last question before the final step! üì± How much time do you spend on screens (phone, computer, TV) outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"], placeholder: "or type number of hours..." },
            { key: 'camera', type: 'final_step', text: "You did it! üéâ That's all the questions. Now for the fun part: a quick selfie. This helps me analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored. Please allow camera access and position your face within the frame." }
        ];

        // --- SERVER COMMUNICATION ---
        async function startQuizSession() {
            try {
                const response = await fetch('/.netlify/functions/quiz', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ action: 'startSession' }) 
                });
                if (!response.ok) throw new Error('Server error starting session');
                const data = await response.json();
                sessionId = data.sessionId;
                console.log('Session started:', sessionId);
            } catch (error) {
                console.error('Failed to start session:', error);
                addBotMessage("Sorry, I'm having trouble connecting to my brain right now. üß† Please try refreshing the page.");
                inputArea.style.display = 'none';
            }
        }

        async function saveAnswerToServer(questionKey, answer) {
            if (!sessionId) return;
            try {
                await fetch('/.netlify/functions/quiz', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ action: 'saveAnswer', sessionId, questionId: questionKey, answer }) 
                });
            } catch (error) { 
                console.error('Failed to save answer:', error); 
                // Optionally notify user of save failure
            }
        }

        async function confirmPhotoAndAnalyze(photoDataUrl) {
            const processingMessage = document.createElement('div');
            processingMessage.className = 'text-center p-2';
            processingMessage.innerHTML = `<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div><p class="text-gray-600 mt-2">Analyzing photo and preparing your report...</p>`;
            inputArea.innerHTML = '';
            inputArea.appendChild(processingMessage);
            inputArea.style.display = 'block';

            try {
                // Step 1: Analyze the photo
                const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ photoDataUrl })
                });

                let faceData = null;
                if (!analyzeResponse.ok) {
                    console.error('Face analysis failed, but continuing.');
                    faceData = { error: 'Analysis failed', details: await analyzeResponse.text() };
                } else {
                    faceData = await analyzeResponse.json();
                }

                // Step 2: Save the analysis data (or error) to the session
                await saveAnswerToServer('faceAnalysis', faceData);

                // Step 3: Trigger the background report generation
                await fetch('/.netlify/functions/result-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });

                // Step 4: Show completion and redirect
                showCompletionAnimation();

            } catch (error) {
                console.error('Error during photo analysis step:', error);
                addBotMessage("I had a little trouble with the photo analysis, but don't worry! I'll generate your report with the rest of your answers.");
                await saveAnswerToServer('faceAnalysis', { error: error.message });
                 // Still trigger background generation
                await fetch('/.netlify/functions/result-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
                showCompletionAnimation();
            }
        }
        
        // --- Main UI Functions ---
        
        function updateProgressBar() {
            const questionKeys = quizQuestions.filter(q => q.type === 'question' && q.key !== 'terms').map(q => q.key);
            const totalSteps = questionKeys.length + 1; // +1 for the photo step
            const completedAnswers = Object.keys(userAnswers).filter(key => questionKeys.includes(key)).length;
            const photoStepCompleted = userAnswers['selfie'] ? 1 : 0;
            const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100;
            progressBar.style.width = `${progress}%`;
        }


        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex justify-start mb-4 chat-bubble';
            typingDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>`;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator')?.remove();
        }

        function addBotMessage(html) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start mb-4 chat-bubble';
            messageDiv.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end mb-4 chat-bubble';
            messageDiv.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${text}</div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function showOptions(options) {
            optionsContainer.innerHTML = '';
            if (options?.length > 0) {
                optionsContainerWrapper.classList.remove('hidden');
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50';
                    button.onclick = () => handleAnswer(option);
                    optionsContainer.appendChild(button);
                });
            } else {
                 optionsContainerWrapper.classList.add('hidden');
            }
        }

        function handleAnswer(answer) {
            if (!answer.trim()) return;
            const currentQuestion = quizQuestions[currentQuestionIndex];
            addUserMessage(answer);
            
            if (currentQuestion.key !== 'terms') {
                userAnswers[currentQuestion.key] = answer.trim();
                saveAnswerToServer(currentQuestion.key, answer.trim());
            }
            
            userInput.value = '';
            
            if (currentQuestion.key === 'terms') {
                inputArea.classList.add('hidden');
            }

            currentQuestionIndex++;
            updateProgressBar();
            askNextQuestion();
        }

        function askNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                return;
            }

            const question = quizQuestions[currentQuestionIndex];
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                let questionText = typeof question.text === 'function' ? question.text(userAnswers.name || 'friend') : question.text;

                if (question.type === 'message') {
                    addBotMessage(questionText);
                    currentQuestionIndex++;
                    askNextQuestion();
                } else if (question.type === 'question') {
                    addBotMessage(questionText);
                    showOptions(question.options);
                    
                    if (question.key === 'terms') {
                        inputArea.classList.add('hidden');
                    } else {
                        inputArea.classList.remove('hidden');
                        userInput.placeholder = question.placeholder || "Type your answer...";
                    }
                    userInput.focus();
                } else if (question.type === 'final_step') {
                    inputArea.classList.add('hidden');
                    addBotMessage(questionText);
                    showCameraStep();
                }
            }, 1200);
        }

        function showCameraStep() {
            optionsContainerWrapper.classList.add('hidden');
            inputArea.classList.remove('hidden');
            inputArea.innerHTML = `
                <button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors pulse-btn">
                    Open Camera
                </button>`;
            document.getElementById('open-camera-btn').onclick = startCamera;
        }

        // --- Camera and Face Detection Logic ---

        async function startCamera() {
            cameraModal.classList.add('active');
            try {
                // Using a more reliable model path
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
                ]);

                loaderText.textContent = "Requesting camera access...";
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    cameraLoader.style.display = 'none';
                    startFaceDetection();
                };

            } catch (err) {
                console.error("Camera/Model Error:", err);
                loaderText.textContent = "Camera access denied or models failed to load. Please refresh and try again.";
                setTimeout(stopCamera, 3000);
            }
        }
        
        function stopCamera() {
            clearInterval(detectionInterval);
            stream?.getTracks().forEach(track => track.stop());
            cameraModal.classList.remove('active');
            video.srcObject = null;
        }

        function startFaceDetection() {
            let faceDetectedFrames = 0;

            detectionInterval = setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
                
                if (detections.length > 0 && detections[0].score > 0.85) {
                    faceDetectedFrames++;
                } else {
                    faceDetectedFrames = 0;
                }

                if (faceDetectedFrames > 30) { // Require ~1 second of stable detection
                    takePhoto();
                }
            }, 100);
        }

        function takePhoto() {
            clearInterval(detectionInterval);
            const photoCanvas = document.createElement('canvas');
            photoCanvas.width = video.videoWidth;
            photoCanvas.height = video.videoHeight;
            const photoContext = photoCanvas.getContext('2d');
            
            photoContext.translate(video.videoWidth, 0);
            photoContext.scale(-1, 1);
            photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            const photoDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9);
            userAnswers['selfie'] = 'Photo taken'; // Mark step as complete
            
            stopCamera();
            addUserMessage("Photo Taken üëç");
            updateProgressBar();
            confirmPhotoAndAnalyze(photoDataUrl);
        }
        
        function showCompletionAnimation() {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
            
            setTimeout(() => {
                 showTypingIndicator();
                 setTimeout(() => {
                    hideTypingIndicator();
                    addBotMessage("Awesome work! You've completed the assessment. ü•≥ I'm now analyzing your results...");
                    inputArea.innerHTML = `<div class="text-center p-2"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div><p class="text-gray-600 mt-2">This will just take a moment...</p></div>`;
                    
                    setTimeout(() => {
                        const resultUrl = `/results.html?sessionId=${sessionId}`;
                        hideTypingIndicator();
                        addBotMessage(`All done! Your personalized report is ready. üöÄ <br><a href="${resultUrl}" class="inline-block mt-2 bg-purple-600 text-white font-bold py-2 px-6 rounded-full hover:bg-purple-700 transition-colors">View My Report</a>`);
                        inputArea.style.display = 'none';
                    }, 8000); // Simulate report generation time
                }, 1000);
            }, 1500);
        }

        // --- Event Listeners & Initial Call ---
        async function initQuiz() {
            await startQuizSession();
            if (sessionId) {
                askNextQuestion();
            }
        }
        
        sendBtn.addEventListener('click', () => handleAnswer(userInput.value));
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAnswer(userInput.value);
        });
        
        inputArea.classList.add('hidden');
        initQuiz();

    </script>
</body>
</html>

