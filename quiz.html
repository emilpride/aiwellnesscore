<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }
        .chat-bubble { animation: slide-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes slide-up { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .options-container::-webkit-scrollbar { display: none; }
        .options-container { -ms-overflow-style: none; scrollbar-width: none; }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .bot-avatar { animation: avatar-float 3s ease-in-out infinite; }
        @keyframes avatar-float { 0% { transform: translateY(0); } 50% { transform: translateY(-4px); } 100% { transform: translateY(0); } }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden; border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); }
        #camera-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #camera-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; text-align: center; }
        #camera-status { background-color: rgba(0,0,0,0.5); padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s; }
        #progress-bar { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7; } to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1; } }
        .pulse-btn { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation { 0% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(168, 85, 247, 0); } 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0); } }
        .payment-form { animation: slide-up-form 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes slide-up-form { 0% { transform: translateY(100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
        .animate-blob { animation: blob 7s infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        .pulse-btn-custom { animation: pulse-custom 2s infinite; }
        @keyframes pulse-custom { 0% { box-shadow: 0 0 0 0 rgba(109, 40, 217, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(109, 40, 217, 0); } 100% { box-shadow: 0 0 0 0 rgba(109, 40, 217, 0); } }
        .analysis-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; text-align: center; }
        .analysis-animation { position: relative; width: 60px; height: 60px; margin-bottom: 1rem; }
        .analysis-animation::before, .analysis-animation::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 2px solid; }
        .analysis-animation::before { border-color: #c4b5fd; animation: analysis-pulse 2s cubic-bezier(0.2, 0.8, 0.2, 1) infinite; }
        .analysis-animation::after { border-color: #8b5cf6; border-top-color: transparent; animation: analysis-spin 1.2s linear infinite; }
        #analysis-text { color: #4b5563; font-weight: 500; transition: opacity 0.5s ease-in-out; }
        @keyframes analysis-pulse { 0% { transform: scale(0.6); opacity: 0.5; } 50% { opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }
        @keyframes analysis-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .bio-age-container { background-color: #f3e8ff; border: 1px solid #d8b4fe; border-radius: 1rem; padding: 1rem; text-align: center; max-width: 250px; margin: auto; }
        .bio-age-header { font-size: 0.875rem; font-weight: 600; color: #6b21a8; margin-bottom: 0.75rem; }
        .bio-age-display { display: flex; justify-content: center; align-items: baseline; margin-bottom: 1rem; color: #5b21b6; }
        #bio-age-value { font-size: 3.75rem; font-weight: 800; line-height: 1; transition: color 0.3s; }
        .bio-age-unit { font-size: 1rem; font-weight: 600; margin-left: 0.5rem; }
        .week-progress { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .week-day { width: 10px; height: 10px; background-color: #ddd6fe; border-radius: 50%; transition: all 0.5s; }
        .week-day.active { background-color: #7c3aed; transform: scale(1.3); box-shadow: 0 0 8px #a78bfa; }
        .bio-age-footer { font-size: 0.75rem; color: #7e22ce; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animated-list-item { opacity: 0; animation: fade-in-up 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .list-icon-wrapper { background-color: #a78bfa; color: white; padding: 0.5rem; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .bmi-widget { background-color: #faf5ff; border: 1px solid #e9d5ff; border-radius: 1rem; padding: 1rem; text-align: center; max-width: 250px; margin: auto; }
        .bmi-value { font-size: 2.5rem; font-weight: 800; color: #5b21b6; line-height: 1; }
        .bmi-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; }
        .bmi-scale { position: relative; height: 10px; background-image: linear-gradient(to right, #60a5fa, #34d399, #facc15, #f87171); border-radius: 9999px; margin: 0.5rem 0; }
        .bmi-indicator { position: absolute; top: 50%; width: 16px; height: 16px; background-color: white; border: 3px solid #5b21b6; border-radius: 50%; transform: translate(-50%, -50%); transition: left 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .bmi-category { font-size: 0.75rem; font-weight: 500; color: #7e22ce; }
        
        /* -- NEW & IMPROVED ANIMATION STYLES -- */
        .widget-wrapper { max-width: 250px; margin: auto; text-align: center; padding: 1rem; background-color: #faf5ff; border-radius: 1rem; }
        .widget-label { font-weight: 600; color: #6b21a8; margin-bottom: 0.75rem; }

        .sleep-battery { width: 100px; height: 40px; border: 3px solid #c4b5fd; border-radius: 8px; margin: 0 auto; position: relative; }
        .sleep-battery::after { content:''; position: absolute; top: 50%; right: -10px; transform: translateY(-50%); width: 5px; height: 20px; background-color: #c4b5fd; border-radius: 0 4px 4px 0; }
        .sleep-battery-level { position: absolute; top: 3px; left: 3px; height: 30px; border-radius: 4px; width: 0%; background-color: #ef4444; transition: width 1.5s ease-out, background-color 1s ease; }
        
        #hydration-water-fill { transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
        #hydration-percentage { transition: opacity 0.5s; opacity: 0; }
        
        .stress-bar-track { height: 12px; background-color: #ede9fe; border-radius: 9999px; overflow: hidden; }
        .stress-bar-fill { height: 100%; width: 0%; background-image: linear-gradient(to right, #4ade80, #facc15, #f87171); border-radius: 9999px; transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .stress-value { font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem; transition: color 1.5s ease; }

        .activity-week { display:flex; justify-content:center; gap: 0.5rem; }
        .activity-day { width: 30px; height: 30px; border-radius: 0.5rem; background-color: #ede9fe; color: #a78bfa; font-weight: 600; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition: all 0.4s ease-out; }
        .activity-day.active { background-color: #8b5cf6; color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4); }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 md:flex md:items-center md:justify-center min-h-screen">
    <div id="main-container" class="w-full md:h-[90vh] md:max-w-lg flex flex-col bg-white md:shadow-2xl md:rounded-2xl overflow-hidden">
        <div class="w-full bg-gray-200"><div id="progress-bar" class="h-2 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; transition: width 0.5s ease-in-out;"></div></div>
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        <div id="options-container-wrapper" class="px-4 pt-1 pb-2"><div id="options-container" class="flex gap-2 overflow-x-auto py-2 options-container"></div></div>
        <div id="input-area" class="p-4 border-t border-gray-200">
            <div class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button>
            </div>
        </div>
        <div id="payment-form-container" class="hidden"></div>
    </div>
    <div id="camera-modal">
        <div id="camera-container">
            <video id="camera-video" autoplay muted playsinline></video><canvas id="camera-canvas"></canvas>
            <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4"><svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p></div>
            <div id="camera-overlay"><p id="camera-status">Position your face in the frame</p></div>
        </div>
    </div>

    <script>
        // --- DOM Elements & State ---
        const mainContainer = document.getElementById('main-container'), chatContainer = document.getElementById('chat-container'), userInput = document.getElementById('user-input'), sendBtn = document.getElementById('send-btn'), optionsContainer = document.getElementById('options-container'), optionsContainerWrapper = document.getElementById('options-container-wrapper'), inputArea = document.getElementById('input-area'), progressBar = document.getElementById('progress-bar'), cameraModal = document.getElementById('camera-modal'), video = document.getElementById('camera-video'), canvas = document.getElementById('camera-canvas'), cameraLoader = document.getElementById('camera-loader'), loaderText = document.getElementById('loader-text'), cameraStatus = document.getElementById('camera-status'), paymentFormContainer = document.getElementById('payment-form-container');
        let sessionId = null, userAnswers = {}, currentQuestionIndex = 0, detectionInterval, stream, capturedPhotoDataUrl = null, countdownInterval;
        const messageDelay = 1800;

        // --- Quiz Data ---
        const quizQuestions = [
            { key: 'intro_dave', type: 'message', text: "Hey! I'm Dave, your personal AI wellness assistant today. üëã" },
            { key: 'name', type: 'question', text: "What should I call you?", options: [], placeholder: "Type your name..." },
            { 
                key: 'intro_purpose', 
                type: 'message', 
                text: (name) => `Great to meet you, ${name}! Here's a quick look at what we'll uncover together:
                    <div class="mt-4 text-sm text-gray-800">
                        <div class="animated-list-item" style="animation-delay: 0.2s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div><span>Calculate your Wellness Score</span></div>
                        <div class="animated-list-item" style="animation-delay: 0.6s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" /></svg></div><span>Reveal your Biological Age</span></div>
                        <div class="animated-list-item" style="animation-delay: 1.0s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h.01a1 1 0 100-2H10zm3 0a1 1 0 000 2h.01a1 1 0 100-2H13zm-3 4a1 1 0 000 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" /></svg></div><span>Assess your energy & recovery</span></div>
                        <div class="animated-list-item" style="animation-delay: 1.4s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></div><span>Measure stress & find solutions</span></div>
                        <div class="animated-list-item" style="animation-delay: 1.8s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div><span>Analyze skin health with AI</span></div>
                        <div class="animated-list-item" style="animation-delay: 2.2s;"><div class="list-icon-wrapper"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 1.293a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L7 8.414V13a1 1 0 11-2 0V8.414L3.293 6.707a1 1 0 010-1.414zM11 12a1 1 0 100 2h5a1 1 0 100-2h-5z" /></svg></div><span>Review nutrition, BMI & more</span></div>
                    </div>`
            },
            { key: 'intro_how', type: 'message', text: "To help you on your wellness journey, I need to get to know you a bit better‚Äîyour lifestyle, habits, and a quick, secure look at you." },
            { key: 'intro_convo', type: 'message', text: "What makes this unique is our relaxed, conversational approach. I'll ask some questions, and you can use the quick-reply buttons or type your own answers. Every detail helps, so I appreciate you taking the time!" },
            { key: 'intro_testimonial', type: 'message', text: `<div class="bio-age-container"><div class="bio-age-header">See What A Week Can Do</div><div class="bio-age-display"><span id="bio-age-value">42</span><span class="bio-age-unit">Years</span></div><div class="week-progress"><div class="week-day" id="day-1"></div><div class="week-day" id="day-2"></div><div class="week-day" id="day-3"></div><div class="week-day" id="day-4"></div><div class="week-day" id="day-5"></div><div class="week-day" id="day-6"></div><div class="week-day" id="day-7"></div></div><div class="bio-age-footer">Biological Age Improvement</div></div>`},
            { key: 'intro_privacy', type: 'message', text: "And just to be clear about your privacy üõ°Ô∏è: your photo is deleted immediately after the AI analysis, and your answers are wiped as soon as you get your report.", delayBefore: 3000 },
            { key: 'start_consent', type: 'question', text: "Ready to begin?", options: ["Yes, let's start!"], hideInput: true },
            { key: 'age', type: 'question', text: (name) => `Perfect, ${name}! To start, what's your age? üéÇ`, options: [], placeholder: "Type your exact age..." },
            { key: 'gender', type: 'question', text: "Great start! Now, what's your biological sex? üß¨", options: ['Male', 'Female'], placeholder: "or type your gender..." },
            { key: 'height', type: 'question', text: "Perfect. Let's talk about your height. üìè (e.g., 5 ft 10 in)", options: ["Under 5 ft", "5'0\" - 5'5\"", "5'6\" - 5'11\"", "6'0\" - 6'5\"", "Over 6'5\""], placeholder: "or type your height..." },
            { key: 'weight', type: 'question', text: "Thanks! And your current weight in pounds? ‚öñÔ∏è", options: ["Under 120 lbs", "120-150 lbs", "151-180 lbs", "181-220 lbs", "Over 220 lbs"], placeholder: "or type your weight in lbs..." },
            { key: 'bmi_calculation', type: 'message', text: "Calculating your BMI based on your stats...", postAnimationDelay: 2000},
            { key: 'sleep', type: 'question', text: "Sleep is crucial. üò¥ How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], placeholder: "or type your sleep hours..." },
            { key: 'sleep_visual', type: 'message', text: 'Quality sleep recharges your mind and body.'},
            { key: 'activity', type: 'question', text: "Movement is key! üèÉ‚Äç‚ôÄÔ∏è How often do you engage in moderate physical activity (like a brisk walk) per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], placeholder: "or type how many times..." },
            { key: 'activity_visual', type: 'message', text: 'Every bit of movement counts!'},
            { key: 'nutrition', type: 'question', text: "Let's dive into nutrition. ü•¶ How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], placeholder: "or type number of servings..." },
            { key: 'processed_food', type: 'question', text: "Honesty is the best policy here. üòâ How often do you eat processed or fast food in a typical week?", options: ["Rarely", "1-2 times", "3-4 times", "Daily"], placeholder: "or type how often..." },
            { key: 'hydration', type: 'question', text: "Hydration check! üíß How many glasses of water (approx. 8 oz) do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], placeholder: "or type number of glasses..." },
            { key: 'hydration_visual', type: 'message', text: "Let's see your hydration level:"},
            { key: 'stress', type: 'question', text: "Now for the mind. üß† On a scale of 1 to 10, how would you rate your typical stress level?", options: ["1-3 (Low)", "4-6 (Moderate)", "7-8 (High)", "9-10 (Very High)"], placeholder: "or type a number from 1-10..." },
            { key: 'stress_gauge', type: 'message', text: "Thanks for sharing. Here's what that looks like:"},
            { key: 'mindfulness', type: 'question', text: "Finding calm is a superpower. üßò‚Äç‚ôÇÔ∏è How often do you practice mindfulness, meditation, or deep breathing?", options: ["Never", "Occasionally", "Weekly", "Daily"], placeholder: "or type how often..." },
            { key: 'mood', type: 'question', text: "Let's check in with your emotions. ‚ù§Ô∏è How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "Neutral", "Often Stressed or Sad"], placeholder: "or describe your mood..." },
            { key: 'alcohol', type: 'question', text: "Time for some lifestyle questions. üçª How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"], placeholder: "or type number of drinks..." },
            { key: 'smoking', type: 'question', text: "This is a safe space. üö≠ Do you smoke or use tobacco products?", options: ["No", "Occasionally", "Yes, daily"], placeholder: "or type your answer..." },
            { key: 'screen_time', type: 'question', text: "Last question before the final step! üì± How much time do you spend on screens (phone, computer, TV) outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"], placeholder: "or type number of hours..." },
            { key: 'camera', type: 'final_step', text: "You did it! üéâ That's all the questions. Now for the fun part: a quick selfie. This helps me analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored. Please allow camera access and position your face within the frame." }
        ];

        // --- Utility & Helper Functions ---
        const setAppHeight = () => { mainContainer.style.height = `${window.innerHeight}px`; };
        const isMobile = () => window.innerWidth <= 768;
        const scrollToBottom = () => { setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 0); };
        function parseHeightToInches(heightStr) { if (!heightStr) return 68; let inches = 0; const feetMatch = heightStr.match(/(\d+)\s*(ft|')/); const inchesMatch = heightStr.match(/(\d+)\s*(in|")/); if (feetMatch) inches += parseInt(feetMatch[1]) * 12; if (inchesMatch) inches += parseInt(inchesMatch[1]); if (inches === 0 && !isNaN(parseFloat(heightStr))) { const parts = heightStr.split(/[\s.]+/); if(parts.length > 0) inches += parseInt(parts[0]) * 12; if(parts.length > 1) inches += parseInt(parts[1]); } return inches > 0 ? inches : 68; }

        // --- Animation Functions ---
        function playBiologicalAgeAnimation() { const ageElement = document.getElementById('bio-age-value'); if (!ageElement) return; let currentAge = 42; const targetAge = 39; const duration = 2800; const steps = currentAge - targetAge; const stepDuration = duration / steps; const dayDuration = duration / 7; for (let i = 1; i <= 7; i++) { setTimeout(() => { const dayEl = document.getElementById(`day-${i}`); if (dayEl) dayEl.classList.add('active'); }, i * dayDuration); } setTimeout(() => { const countdownInterval = setInterval(() => { currentAge--; ageElement.textContent = currentAge; if (currentAge === targetAge) { clearInterval(countdownInterval); ageElement.style.color = '#16a34a'; } }, stepDuration); }, 500); }
        function playBmiAnimation() { const heightIn = parseHeightToInches(userAnswers.height); const weightLbs = parseInt(userAnswers.weight) || 160; if (heightIn && weightLbs) { const bmi = ((weightLbs / (heightIn * heightIn)) * 703).toFixed(1); let category = "Normal"; let percent = 50; if (bmi < 18.5) { category = "Underweight"; percent = (bmi / 18.5) * 25; } else if (bmi < 25) { category = "Normal"; percent = 25 + ((bmi - 18.5) / 6.5) * 50; } else if (bmi < 30) { category = "Overweight"; percent = 75 + ((bmi - 25) / 5) * 25; } else { category = "Obese"; percent = 100; } percent = Math.max(5, Math.min(95, percent)); const html = `<div class="bmi-widget"><div id="bmi-value-anim" class="bmi-value">0.0</div><div class="bmi-label">Your Estimated BMI</div><div class="bmi-scale"><div id="bmi-indicator-anim" class="bmi-indicator" style="left: 0%;"></div></div><div id="bmi-category-anim" class="bmi-category">&nbsp;</div></div>`; addBotMessage(html); setTimeout(() => { const valEl = document.getElementById('bmi-value-anim'); const catEl = document.getElementById('bmi-category-anim'); const indEl = document.getElementById('bmi-indicator-anim'); if(indEl) indEl.style.left = `${percent}%`; if(catEl) catEl.textContent = category; let start = 0; const end = parseFloat(bmi); const animDuration = 1500; const frameDuration = 1000 / 60; const totalFrames = Math.round(animDuration / frameDuration); let frame = 0; const countUp = setInterval(() => { frame++; const progress = frame / totalFrames; const currentVal = (start + (end - start) * progress).toFixed(1); if(valEl) valEl.textContent = currentVal; if (frame === totalFrames) { clearInterval(countUp); if(valEl) valEl.textContent = bmi; } }, frameDuration); }, 100); } }
        function playSleepAnimation() { const answer = userAnswers.sleep || ""; let level = 25; if (answer.includes("5-6")) level = 50; if (answer.includes("7-8")) level = 90; if (answer.includes("More than 8")) level = 100; const html = `<div class="widget-wrapper"><div class="widget-label">Sleep Recharge</div><svg class="w-16 h-16 mx-auto text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg><div class="sleep-battery mt-2"><div id="sleep-battery-level-anim" class="sleep-battery-level"></div></div></div>`; addBotMessage(html); setTimeout(() => { const levelEl = document.getElementById('sleep-battery-level-anim'); if (!levelEl) return; let color = '#ef4444'; if (level > 40) color = '#f59e0b'; if (level > 75) color = '#22c55e'; levelEl.style.backgroundColor = color; levelEl.style.width = `${level}%`; }, 100); }
        function playActivityAnimation() { const answer = userAnswers.activity || ""; let days = 1; if (answer.includes("1-2")) days = 2; if (answer.includes("3-4")) days = 4; if (answer.includes("5+")) days = 6; const html = `<div class="widget-wrapper"><div class="widget-label">Your Active Week</div><div class="activity-week" id="activity-week-anim"><div class="activity-day">M</div><div class="activity-day">T</div><div class="activity-day">W</div><div class="activity-day">T</div><div class="activity-day">F</div><div class="activity-day">S</div><div class="activity-day">S</div></div></div>`; addBotMessage(html); setTimeout(() => { const weekEl = document.getElementById('activity-week-anim'); if (!weekEl) return; const dayElements = weekEl.children; const daysToActivate = [0, 2, 4, 1, 3, 5, 6]; for (let i = 0; i < days; i++) { setTimeout(() => { dayElements[daysToActivate[i]].classList.add('active'); }, i * 250); } }, 100); }
        function playHydrationAnimation() { const answer = userAnswers.hydration || ""; let level = 25; if (answer.includes("4-6")) level = 50; if (answer.includes("7-9")) level = 75; if (answer.includes("10+")) level = 100; const html = `<div class="widget-wrapper"><div class="widget-label">Body Hydration</div><svg class="w-20 h-24 mx-auto" viewBox="0 0 120 160"><defs><clipPath id="humanoid-clip"><path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z"></path></clipPath></defs><g clip-path="url(#humanoid-clip)"><rect x="0" y="0" width="120" height="160" fill="#ede9fe"/><rect id="hydration-water-fill" x="0" y="0" width="120" height="160" fill="#818cf8" style="transform: translateY(160px);"/></g><path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z" fill="none" stroke="#a78bfa" stroke-width="6"/></svg><div id="hydration-percentage" class="font-bold text-xl text-indigo-600 mt-2">0%</div></div>`; addBotMessage(html); setTimeout(() => { const waterEl = document.getElementById('hydration-water-fill'); const textEl = document.getElementById('hydration-percentage'); if (!waterEl || !textEl) return; const yPos = 160 - (160 * (level / 100)); waterEl.style.transform = `translateY(${yPos}px)`; textEl.style.opacity = '1'; let currentLevel = 0; const levelUp = setInterval(() => { currentLevel++; textEl.textContent = `${currentLevel}%`; if (currentLevel >= level) clearInterval(levelUp); }, 1500 / level); }, 100); }
        function playStressGaugeAnimation() { const stressAnswer = userAnswers.stress || "1-3 (Low)"; const level = parseInt(stressAnswer.match(/\d+/)[0]); const percent = (level - 1) / 9 * 100; let color = '#4ade80'; if (level > 4) color = '#facc15'; if (level > 7) color = '#f87171'; const html = `<div class="widget-wrapper"><div class="widget-label">Reported Stress Level</div><div class="stress-bar-track"><div id="stress-bar-fill-anim" class="stress-bar-fill"></div></div><div id="stress-value-anim" class="stress-value">${level}/10</div></div>`; addBotMessage(html); setTimeout(() => { const fillEl = document.getElementById('stress-bar-fill-anim'); const textEl = document.getElementById('stress-value-anim'); if (!fillEl || !textEl) return; fillEl.style.width = `${percent}%`; textEl.style.color = color; }, 100); }

        // --- Core Quiz Logic ---
        async function startQuizSession() { try { sessionId = `session_${new Date().getTime()}`; } catch (error) { console.error('Failed to start session:', error); addBotMessage("Sorry, I'm having trouble connecting. Please refresh."); inputArea.style.display = 'none'; } }
        async function saveAnswerToServer(questionKey, answer) { if (!sessionId) return; try { console.log(`Saving: ${questionKey} = ${answer}`); } catch (error) { console.error('Failed to save answer:', error); } }
        async function proceedToAnalysis() { try { await saveAnswerToServer('faceAnalysis', { status: 'mocked success' }); showCompletionAnimation(); } catch (error) { console.error('Error during analysis:', error); addBotMessage("I had a little trouble with the photo analysis, but we can proceed."); showPaymentForm(); } }
        function updateProgressBar() { const questionKeys = quizQuestions.filter(q => q.type === 'question').map(q => q.key); const totalSteps = questionKeys.length + 1; const completedAnswers = Object.keys(userAnswers).filter(key => questionKeys.includes(key)).length; const photoStepCompleted = userAnswers['selfie'] ? 1 : 0; const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100; progressBar.style.width = `${progress}%`; }
        function showTypingIndicator() { const d = document.createElement('div'); d.id = 'typing-indicator'; d.className = 'flex justify-start mb-4 chat-bubble'; d.innerHTML = `<div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`; chatContainer.appendChild(d); scrollToBottom(); }
        function hideTypingIndicator() { document.getElementById('typing-indicator')?.remove(); }
        function addBotMessage(html) { const d = document.createElement('div'); d.className = 'flex justify-start mb-4 chat-bubble'; d.innerHTML = `<div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div>`; chatContainer.appendChild(d); scrollToBottom(); }
        function addUserMessage(text) { const d = document.createElement('div'); d.className = 'flex justify-end mb-4 chat-bubble'; d.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${text}</div>`; chatContainer.appendChild(d); scrollToBottom(); }
        function showOptions(options, handlers) { optionsContainer.innerHTML = ''; if (options?.length > 0) { optionsContainerWrapper.classList.remove('hidden'); options.forEach((option, index) => { const button = document.createElement('button'); button.textContent = option.text; button.className = option.class; button.onclick = handlers[index]; optionsContainer.appendChild(button); }); } else { optionsContainerWrapper.classList.add('hidden'); } }
        function handleAnswer(answer) { if (!answer.trim()) return; const currentQuestion = quizQuestions[currentQuestionIndex]; addUserMessage(answer); userAnswers[currentQuestion.key] = answer.trim(); saveAnswerToServer(currentQuestion.key, answer.trim()); userInput.value = ''; inputArea.classList.add('hidden'); optionsContainerWrapper.classList.add('hidden'); currentQuestionIndex++; updateProgressBar(); askNextQuestion(); }

        function askNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) return;
            const question = quizQuestions[currentQuestionIndex];
            showTypingIndicator();
            const delay = question.delayBefore || messageDelay;
            
            setTimeout(() => {
                hideTypingIndicator();
                let questionText = typeof question.text === 'function' ? question.text(userAnswers.name || 'friend') : question.text;
                let postAnimationDelay = question.postAnimationDelay || 0;

                if (question.type === 'message') {
                    addBotMessage(questionText);
                    if (question.key === 'intro_testimonial') { setTimeout(playBiologicalAgeAnimation, 500); }
                    else if (question.key === 'bmi_calculation') { setTimeout(playBmiAnimation, 100); }
                    else if (question.key === 'stress_gauge') { setTimeout(playStressGaugeAnimation, 100); }
                    else if (question.key === 'sleep_visual') { setTimeout(playSleepAnimation, 100); }
                    else if (question.key === 'activity_visual') { setTimeout(playActivityAnimation, 100); }
                    else if (question.key === 'hydration_visual') { setTimeout(playHydrationAnimation, 100); }
                    
                    currentQuestionIndex++;
                    setTimeout(askNextQuestion, postAnimationDelay);
                } else if (question.type === 'question') {
                    addBotMessage(questionText);
                    const optionButtons = question.options.map(opt => ({ text: opt, class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50' }));
                    const handlers = question.options.map(opt => () => handleAnswer(opt));
                    showOptions(optionButtons, handlers);
                    if (question.hideInput) { inputArea.classList.add('hidden'); } else { inputArea.classList.remove('hidden'); userInput.placeholder = question.placeholder || "Type..."; }
                    if (!isMobile()) { userInput.focus(); }
                } else if (question.type === 'final_step') {
                    inputArea.classList.add('hidden'); addBotMessage(questionText); showCameraStep();
                }
            }, delay);
        }

        // --- Camera & Payment Logic ---
        function showCameraStep() { optionsContainerWrapper.classList.add('hidden'); inputArea.classList.remove('hidden'); inputArea.innerHTML = `<button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors pulse-btn">Open Camera</button>`; document.getElementById('open-camera-btn').onclick = startCamera; }
        async function startCamera() { cameraModal.classList.add('active'); try { const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'; await Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL) ]); loaderText.textContent = "Requesting camera access..."; stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); video.srcObject = stream; video.onloadedmetadata = () => { cameraLoader.style.display = 'none'; startFaceDetection(); }; } catch (err) { console.error("Camera/Model Error:", err); loaderText.textContent = "Camera access denied or models failed to load. Please refresh and try again."; setTimeout(stopCamera, 3000); } }
        function stopCamera() { clearInterval(detectionInterval); stream?.getTracks().forEach(track => track.stop()); cameraModal.classList.remove('active'); video.srcObject = null; }
        function startFaceDetection() { let captureTimeout; const context = canvas.getContext('2d'); detectionInterval = setInterval(async () => { const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(); const displaySize = { width: video.clientWidth, height: video.clientHeight }; faceapi.matchDimensions(canvas, displaySize); context.clearRect(0, 0, canvas.width, canvas.height); context.save(); context.translate(canvas.width, 0); context.scale(-1, 1); if (detections.length > 0) { const resizedDetections = faceapi.resizeResults(detections, displaySize); const box = resizedDetections[0].detection.box; context.strokeStyle = 'rgba(0, 255, 255, 0.4)'; context.lineWidth = 1; faceapi.draw.drawFaceLandmarks(canvas, resizedDetections[0].landmarks, { drawLines: true }); context.strokeStyle = '#00FFFF'; context.lineWidth = 3; context.shadowColor = '#00FFFF'; context.shadowBlur = 10; const cornerLength = box.width * 0.1; context.beginPath(); context.moveTo(box.x, box.y + cornerLength); context.lineTo(box.x, box.y); context.lineTo(box.x + cornerLength, box.y); context.moveTo(box.x + box.width - cornerLength, box.y); context.lineTo(box.x + box.width, box.y); context.lineTo(box.x + box.width, box.y + cornerLength); context.moveTo(box.x, box.y + box.height - cornerLength); context.lineTo(box.x, box.y + box.height); context.lineTo(box.x + cornerLength, box.y + box.height); context.moveTo(box.x + box.width - cornerLength, box.y + box.height); context.lineTo(box.x + box.width, box.y + box.height); context.lineTo(box.x + box.width, box.y + box.height - cornerLength); context.stroke(); context.shadowBlur = 0; const isGoodSize = box.width > canvas.width * 0.4; if (isGoodSize) { cameraStatus.textContent = "Hold still..."; if (!captureTimeout) { captureTimeout = setTimeout(() => takePhoto(), 1500); } } else { cameraStatus.textContent = "Move closer"; clearTimeout(captureTimeout); captureTimeout = null; } } else { cameraStatus.textContent = "Position your face"; clearTimeout(captureTimeout); captureTimeout = null; } context.restore(); }, 100); }
        function takePhoto() { clearInterval(detectionInterval); cameraStatus.textContent = "Perfect!"; const photoCanvas = document.createElement('canvas'); photoCanvas.width = video.videoWidth; photoCanvas.height = video.videoHeight; const photoContext = photoCanvas.getContext('2d'); photoContext.translate(video.videoWidth, 0); photoContext.scale(-1, 1); photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight); capturedPhotoDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9); userAnswers['selfie'] = 'Photo taken'; stopCamera(); updateProgressBar(); showPhotoForConfirmation(); }
        function startAnalysisAndShowForm() { addUserMessage("Looks Good!"); document.getElementById('photo-preview-wrapper')?.remove(); optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); proceedToAnalysis(); }
        function showPhotoForConfirmation() { const d = document.createElement('div'); d.id = 'photo-preview-wrapper'; d.className = 'flex justify-start mb-4 chat-bubble'; const i = `<div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs"><p class="mb-2">Here's the photo. Happy with it?</p><img src="${capturedPhotoDataUrl}" alt="Your selfie" class="rounded-lg"/></div>`; d.innerHTML = `<div class="w-10 h-10 rounded-full bg-purple-500 text-white flex items-center justify-center mr-3 flex-shrink-0 bot-avatar"><svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>${i}`; chatContainer.appendChild(d); scrollToBottom(); const o = [ { text: 'Looks Good!', class: 'option-btn bg-green-500 border-green-600 text-white px-4 py-2 rounded-full text-sm flex-shrink-0 font-semibold' }, { text: 'Retake', class: 'option-btn bg-white border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm flex-shrink-0' } ]; const h = [startAnalysisAndShowForm, retakePhoto]; showOptions(o, h); inputArea.classList.add('hidden'); }
        function retakePhoto() { addUserMessage("Retake"); document.getElementById('photo-preview-wrapper')?.remove(); optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); startCamera(); }
        function showPaymentForm() { optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); const formHtml = `<div class="payment-form p-4 border-t border-gray-100 bg-gradient-to-br from-indigo-50 to-purple-50"><div class="relative bg-white/20 backdrop-blur-3xl border border-white/40 shadow-xl p-6 rounded-3xl overflow-hidden transform hover:scale-[1.01] transition-all duration-300"><div class="absolute inset-0 z-0 opacity-10"><div class="absolute top-1/4 left-1/4 w-32 h-32 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div><div class="absolute top-1/2 right-1/4 w-32 h-32 bg-indigo-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div><div class="absolute bottom-1/4 left-1/2 w-32 h-32 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div></div><div class="sticky top-0 z-20 bg-white/30 backdrop-blur-xl -mx-6 -mt-6 mb-5 p-3 rounded-t-3xl text-center shadow-md"><p class="text-sm font-semibold text-gray-800 opacity-80">This exclusive offer ends in:</p><p id="countdown-timer" class="text-3xl font-extrabold text-purple-700 tracking-widest mt-1 drop-shadow-md">10:00</p></div><div class="relative z-10 text-center"><h3 class="text-3xl font-extrabold text-gray-900 mb-2 leading-tight">Unlock Your Full Report</h3><p class="text-gray-600 text-lg mb-6">Get your personalized wellness insights today!</p><div class="my-6"><span class="text-6xl font-extrabold text-purple-700">$9.99</span><span class="text-2xl font-medium text-gray-500 line-through ml-3">$24.99</span></div><div class="space-y-4 mb-6"><div class="bg-white/50 border border-white/60 rounded-xl p-4 flex items-center gap-4 text-base text-gray-800 shadow-inner focus-within:ring-2 focus-within:ring-purple-400 transition-all duration-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-purple-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg><input type="text" placeholder="Card Number" class="flex-1 bg-transparent border-none outline-none placeholder-gray-500 text-gray-900" /><input type="text" placeholder="MM/YY" class="w-20 bg-transparent border-none outline-none placeholder-gray-500 text-gray-900 text-right" /><input type="text" placeholder="CVC" class="w-16 bg-transparent border-none outline-none placeholder-gray-500 text-gray-900 text-right" /></div></div><button id="pay-btn" class="mt-4 w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 text-xl shadow-lg shadow-purple-500/30 transform hover:-translate-y-1 active:scale-95 pulse-btn-custom">Pay Now & Get Report</button><p class="text-sm text-gray-600 mt-4 flex items-center justify-center gap-2 opacity-80"><svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2.167 6.884a6.5 6.5 0 000 6.232c-.378 1.401-1.309 3.037-3.003 4.298C-.15 18.067 2.059 20 5 20h10c2.94 0 5.15-1.933 4.836-3.884-1.694-1.261-2.625-2.897-3.003-4.298a6.5 6.5 0 000-6.232c.378-1.401 1.309-3.037 3.003-4.298C19.85 1.933 17.94 0 15 0H5C2.06 0-.15 1.933.167 3.884c1.694 1.261 2.625 2.897 3.003 4.298zM9 10a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1zm3 0a1 1 0 011-1h.01a1 1 0 110 2H13a1 1 0 01-1-1zm-6 0a1 1 0 011-1h.01a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>Your payment is secured by SSL encryption.</p></div></div></div>`; paymentFormContainer.innerHTML = formHtml; paymentFormContainer.classList.remove('hidden'); scrollToBottom(); document.getElementById('pay-btn').onclick = handlePayment; startCountdown(); }
        function startCountdown() { let duration = 600; const timerEl = document.getElementById('countdown-timer'); countdownInterval = setInterval(() => { const minutes = Math.floor(duration / 60).toString().padStart(2, '0'); const seconds = (duration % 60).toString().padStart(2, '0'); timerEl.textContent = `${minutes}:${seconds}`; duration--; if (duration < 0) { clearInterval(countdownInterval); timerEl.textContent = "00:00"; document.getElementById('pay-btn').textContent = "Offer Expired"; document.getElementById('pay-btn').disabled = true; } }, 1000); }
        function handlePayment() { clearInterval(countdownInterval); paymentFormContainer.innerHTML = ''; paymentFormContainer.classList.add('hidden'); showTypingIndicator(); setTimeout(() => { hideTypingIndicator(); addBotMessage("Thank you! Your payment is being processed. (This is a demo and no payment was taken)."); }, 1500); }
        function showCompletionAnimation() { confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } }); showTypingIndicator(); setTimeout(() => { hideTypingIndicator(); addBotMessage("Awesome work! You've completed the assessment. ü•≥ I'm now analyzing your results..."); inputArea.innerHTML = `<div class="analysis-container"><div class="analysis-animation"></div><p id="analysis-text">Initializing analysis...</p></div>`; inputArea.classList.remove('hidden'); scrollToBottom(); const analysisSteps = [ "Analyzing your data...", "Checking lifestyle factors...", "Scanning skin health...", "Calculating biological age...", "Almost ready..." ]; const analysisTextElement = document.getElementById('analysis-text'); let currentStep = 0; const intervalId = setInterval(() => { if (currentStep < analysisSteps.length) { analysisTextElement.style.opacity = '0'; setTimeout(() => { analysisTextElement.textContent = analysisSteps[currentStep]; analysisTextElement.style.opacity = '1'; }, 500); currentStep++; } else { clearInterval(intervalId); } }, 1600); setTimeout(() => { inputArea.classList.add('hidden'); showTypingIndicator(); setTimeout(() => { hideTypingIndicator(); addBotMessage("Great! Your preliminary analysis is complete. Just one final step to unlock your full, personalized report."); showPaymentForm(); }, 1200); }, analysisSteps.length * 1600 + 500); }, 1000); }

        // --- Initial Call ---
        async function initQuiz() { setAppHeight(); await startQuizSession(); if (sessionId) { askNextQuestion(); } }
        sendBtn.addEventListener('click', () => handleAnswer(userInput.value));
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAnswer(userInput.value); });
        window.addEventListener('resize', setAppHeight);
        inputArea.classList.add('hidden');
        initQuiz();
    </script>
</body>
</html>
