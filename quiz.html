<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI WELLNESSCORE - Your Personalized Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0c4a6e);
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite;
            color: #e5e7eb;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes typing-bubble {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }
        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            animation: typing-bubble 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes breathing {
            0%, 100% { transform: scale(1); box-shadow: 0 0 5px rgba(129, 140, 248, 0); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(129, 140, 248, 0.5); }
        }
        .breathing-avatar {
            animation: breathing 3s ease-in-out infinite;
        }
        #camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            border-radius: 1.5rem;
            overflow: hidden;
            border: 4px solid transparent;
            transition: border-color 0.3s ease;
        }
        #camera-container.face-detected { border-color: #22c55e; }
        #camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .progress-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 20;
            overflow: hidden;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #818cf8 0%, #34d399 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl h-[90vh] bg-slate-900/70 backdrop-blur-xl ring-1 ring-white/10 rounded-2xl shadow-2xl flex flex-col overflow-hidden relative">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <header class="p-4 border-b border-white/10 bg-slate-900/50 z-10">
            <h1 class="text-xl font-bold text-center text-indigo-400">AI WELLNESSCORE</h1>
            <p class="text-sm text-center text-gray-400">Your path to a better you starts here</p>
        </header>

        <main id="chat-container" class="flex-1 p-6 overflow-y-auto no-scrollbar">
            <div id="chat-content" class="space-y-6">
            </div>
        </main>

        <footer id="input-area" class="p-4 border-t border-white/10 bg-slate-800/60">
            <div id="options-container" class="flex flex-nowrap gap-2 mb-3 overflow-x-auto no-scrollbar pb-2 justify-center">
            </div>
            <div id="text-input-container" class="flex items-center gap-2" style="display: none;">
                <input type="text" id="user-input" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-gray-400 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400" placeholder="Type your answer...">
                <button id="send-btn" class="bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform duration-200 transform active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" /></svg>
                </button>
            </div>
        </footer>
    </div>

    <!-- NEW, SIMPLIFIED CAMERA MODAL -->
    <div id="camera-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md flex-col items-center justify-center z-50 hidden p-4">
        <p id="camera-feedback" class="text-white text-lg font-semibold mb-4 text-center"></p>
        <div class="relative w-full max-w-xs aspect-square rounded-full overflow-hidden border-4 border-slate-600" id="camera-border">
             <video id="video" class="w-full h-full object-cover scale-x-[-1]" autoplay muted playsinline></video>
             <canvas id="camera-overlay" class="absolute top-0 left-0"></canvas>
        </div>
        <button id="manual-capture-btn" class="mt-6 bg-white/20 text-white px-6 py-2 rounded-full">Manual Capture</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.20.0/dist/tf-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.20.0/dist/tf-backend-webgl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection@1.0.2/dist/face-detection.min.js"></script>
    
    <script>
        const chatContent = document.getElementById('chat-content');
        const inputArea = document.getElementById('input-area');
        const optionsContainer = document.getElementById('options-container');
        const textInputContainer = document.getElementById('text-input-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const progressBar = document.getElementById('progressBar');

        const cameraModal = document.getElementById('camera-modal');
        const cameraFeedback = document.getElementById('camera-feedback');
        const cameraBorder = document.getElementById('camera-border');
        const video = document.getElementById('video');
        const overlay = document.getElementById('camera-overlay');
        const manualCaptureBtn = document.getElementById('manual-capture-btn');

        const quizQuestions = [
            { id: 'welcome', text: "Hello! I'm your personal AI Wellness Coach. Let's discover insights about your well-being.", type: 'welcome', options: ["Let's Begin!"] },
            { id: 'disclaimer', text: "Quick heads-up: This is an educational tool, not medical advice. <b>Your photo is deleted immediately after analysis.</b><br><br>By continuing, you agree to our <a href='#' target='_blank' class='underline text-indigo-300'>Terms</a> and <a href='#' target='_blank' class='underline text-indigo-300'>Privacy Policy</a>.", type: 'disclaimer', options: ['I Understand & Agree'] },
            { id: 'age', text: "Great! To start, what's your age?", type: 'chips_text', options: ['Under 18', '18-25', '26-35', '36-50', '50+'], placeholder: 'Or type your exact age...' },
            { id: 'gender', text: "What's your biological sex?", type: 'chips_text', options: ['Male', 'Female'], placeholder: 'Or prefer not to say...' },
            { id: 'height', text: "Perfect. What's your height? (e.g., 5 ft 10 in)", type: 'chips_text', options: ["Under 5'0\"", "5'0\" - 5'5\"", "5'6\" - 5'11\"", "6'0\"+"], placeholder: 'Or type your exact height...' },
            { id: 'weight', text: "Thanks! And your current weight in pounds?", type: 'chips_text', options: ['Under 120 lbs', '120-150 lbs', '151-180 lbs', '181-220 lbs', '220+ lbs'], placeholder: 'Or type your exact weight...' },
            { id: 'sleep', text: "How many hours of <i>quality</i> sleep do you get on an average night?", type: 'chips_text', options: ['Less than 5', '5-6 hours', '7-8 hours', 'More than 8'], placeholder: 'Or type a specific number...' },
            { id: 'activity', text: "How often do you engage in moderate physical activity per week?", type: 'chips_text', options: ['Rarely', '1-2 times', '3-4 times', '5+ times'], placeholder: 'Or describe your routine...' },
            { id: 'nutrition', text: "How many servings of fruits or vegetables do you typically eat per day?", type: 'chips_text', options: ['0-1', '2-3', '4-5', 'More than 5'], placeholder: 'Or type a specific number...' },
            { id: 'processed_food', text: "How often do you eat processed or fast food in a typical week?", type: 'chips_text', options: ['Daily', 'A few times a week', 'Once a week', 'Rarely/Never'], placeholder: 'Or describe your habits...' },
            { id: 'hydration', text: "How many glasses of water do you drink per day?", type: 'chips_text', options: ['1-2', '3-4', '5-6', '7+'], placeholder: 'Or type a specific amount...' },
            { id: 'stress', text: "On a scale of 1 to 10, how would you rate your typical stress level?", type: 'chips_text', options: ['1-3 (Low)', '4-6 (Moderate)', '7-8 (High)', '9-10 (Very High)'], placeholder: 'Or type an exact number...' },
            { id: 'mindfulness', text: "How often do you practice mindfulness or meditation?", type: 'chips_text', options: ['Daily', 'A few times a week', 'Occasionally', 'Never'], placeholder: 'Or describe your practice...' },
            { id: 'mood', text: "How would you describe your overall mood on a typical day?", type: 'chips_text', options: ['Energetic & Positive', 'Generally Content', 'Neutral', 'Often Fatigued or Low'], placeholder: 'Or describe in your own words...' },
            { id: 'alcohol', text: "How many alcoholic drinks do you have in a typical week?", type: 'chips_text', options: ['0', '1-3', '4-7', '8+'], placeholder: 'Or type a specific number...' },
            { id: 'smoking', text: "Do you smoke or use tobacco products?", type: 'chips_text', options: ['Yes, daily', 'Yes, occasionally', 'I quit', 'Never'], placeholder: 'Or clarify...' },
            { id: 'screen_time', text: "Last question! How much screen time (outside of work) do you average per day?", type: 'chips_text', options: ['Less than 2 hours', '2-4 hours', '4-6 hours', 'More than 6 hours'], placeholder: 'Or estimate...' },
            { id: 'camera', text: "You did it! Now for the final step: a quick selfie. This helps me analyze non-medical indicators like stress and fatigue. Your photo is never stored.", type: 'camera_button', options: ['Open Camera'] }
        ];

        let currentQuestionIndex = 0;
        const userAnswers = {};
        let sessionId = null;
        const totalQuizQuestions = quizQuestions.filter(q => q.type !== 'welcome' && q.type !== 'disclaimer' && q.type !== 'camera_button').length;
        let faceDetector;
        let detectionInterval;

        function updateProgressBar() {
            const answeredQuestions = Object.keys(userAnswers).length;
            const progress = (answeredQuestions / totalQuizQuestions) * 100;
            progressBar.style.width = `${progress}%`;
        }
        
        function getBotAvatar() {
            const avatar = document.createElement('div');
            avatar.className = 'flex-shrink-0 w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center ring-1 ring-white/20 breathing-avatar';
            avatar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
            return avatar;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'fade-in flex w-full items-end gap-3 justify-start';
            const bubble = document.createElement('div');
            bubble.className = 'max-w-xs md:max-w-md p-3 rounded-2xl bg-indigo-600 text-white rounded-bl-lg flex items-center justify-center space-x-1';
            bubble.innerHTML = `<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>`;
            typingDiv.appendChild(getBotAvatar());
            typingDiv.appendChild(bubble);
            chatContent.appendChild(typingDiv);
            chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        
        function addMessage(htmlContent, sender = 'bot') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `max-w-xs md:max-w-md p-3 rounded-2xl ${sender === 'bot' ? 'bg-indigo-600 text-white rounded-bl-lg' : 'bg-slate-700 text-gray-200 rounded-br-lg'}`;
            messageDiv.innerHTML = htmlContent;
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = `fade-in flex w-full items-end gap-3 ${sender === 'bot' ? 'justify-start' : 'justify-end'}`;
            if (sender === 'bot') wrapperDiv.appendChild(getBotAvatar());
            wrapperDiv.appendChild(messageDiv);
            chatContent.appendChild(wrapperDiv);
            chatContent.parentElement.scrollTop = chatContent.parentElement.scrollHeight;
        }

        function displayQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }
            const question = quizQuestions[currentQuestionIndex];
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                let messageHtml = question.text;
                if (question.reason) {
                    messageHtml += `<br><span class='block mt-2 text-sm text-indigo-200 opacity-80'>${question.reason}</span>`;
                }
                addMessage(messageHtml);
                setupInput(question);
            }, 1000 + Math.random() * 500);
        }

        function setupInput(question) {
            optionsContainer.innerHTML = '';
            textInputContainer.style.display = 'none';
            inputArea.style.display = 'block';
            const isSimpleAction = question.type === 'welcome' || question.type === 'disclaimer' || question.type === 'camera_button';
            optionsContainer.className = `flex gap-2 mb-3 pb-2 ${isSimpleAction ? 'justify-center' : 'flex-nowrap overflow-x-auto no-scrollbar'}`;
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = isSimpleAction 
                    ? "px-6 py-3 bg-indigo-500 border border-indigo-400 text-white rounded-full hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all duration-200 font-semibold"
                    : "flex-shrink-0 px-4 py-2 bg-slate-700 border border-slate-600 text-gray-200 rounded-full hover:bg-indigo-500 hover:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-all duration-200";
                button.onclick = () => handleAnswer(option);
                optionsContainer.appendChild(button);
            });
            if (question.type === 'chips_text') {
                textInputContainer.style.display = 'flex';
                userInput.placeholder = question.placeholder;
                userInput.value = '';
                userInput.focus();
            }
        }

        async function handleAnswer(answer) {
            if (!answer || !answer.trim()) return;
            const question = quizQuestions[currentQuestionIndex];
            if (question.type !== 'welcome' && question.type !== 'disclaimer') {
                userAnswers[question.id] = answer;
                addMessage(answer, 'user');
                updateProgressBar();
            }
            currentQuestionIndex++;
            displayQuestion();
        }
        
        async function initCamera() {
            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');
            if (!faceDetector) {
                cameraFeedback.textContent = "Loading AI model...";
                const model = faceDetection.SupportedModels.MediaPipeFaceDetector;
                const detectorConfig = { runtime: 'tfjs' };
                faceDetector = await faceDetection.createDetector(model, detectorConfig);
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                video.onloadeddata = () => {
                    video.play();
                    startFaceDetection(video);
                };
            } catch (err) {
                cameraFeedback.textContent = "Please allow camera access.";
            }
        }

        function startFaceDetection(video) {
            let captureTimeout;
            detectionInterval = setInterval(async () => {
                const faces = await faceDetector.estimateFaces(video, { flipHorizontal: false });
                if (faces.length === 1) {
                    cameraBorder.classList.remove('border-red-500');
                    cameraBorder.classList.add('border-green-500');
                    cameraFeedback.textContent = "Perfect! Hold still...";
                    if (!captureTimeout) {
                        captureTimeout = setTimeout(() => takePicture(video), 1500);
                    }
                } else {
                    cameraBorder.classList.remove('border-green-500');
                    cameraBorder.classList.add('border-red-500');
                    cameraFeedback.textContent = "Please center your face";
                    clearTimeout(captureTimeout);
                    captureTimeout = null;
                }
            }, 300);
        }

        function takePicture(video) {
            clearInterval(detectionInterval);
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            userAnswers['selfie'] = canvas.toDataURL('image/jpeg', 0.8);
            video.srcObject.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
            endQuiz();
        }

        function endQuiz() {
            inputArea.style.display = 'none';
            progressBar.style.width = '100%';
            showTypingIndicator();
            setTimeout(() => {
                hideTypingIndicator();
                addMessage("Thank you! Analyzing your results...");
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addMessage("Done! Your report is ready. ðŸš€ <a href='result.html' class='font-bold underline text-indigo-300'>View my results</a>");
                }, 3000);
            }, 1500);
        }

        sendBtn.addEventListener('click', () => handleAnswer(userInput.value));
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAnswer(userInput.value); });
        manualCaptureBtn.addEventListener('click', () => takePicture(video));

        displayQuestion();
    </script>

</body>
</html>
