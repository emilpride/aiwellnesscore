<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .chat-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }
        .chat-bubble { animation: slide-up 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes slide-up { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .options-container::-webkit-scrollbar { display: none; }
        .options-container { -ms-overflow-style: none; scrollbar-width: none; }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .bot-avatar-lottie { width: 40px; height: 40px; background-color: #5b21b6; border-radius: 50%; box-shadow: 0 0 0 0 rgba(99, 53, 169, 0.7); animation: pulse 2.5s infinite, avatar-float 3s ease-in-out infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); } }
        @keyframes avatar-float { 0% { transform: translateY(0); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0); } }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden; border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); }
        #camera-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #camera-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; text-align: center; }
        #camera-status { background-color: rgba(0,0,0,0.5); padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s; }
        #progress-bar { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7; } to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1; } }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∏—Å–ª–æ–≤–æ–≥–æ —Å–∫—Ä–æ–ª–ª–µ—Ä–∞ */
        .scroller-container {
            text-align: center;
            padding: 1rem 0;
            position: relative;
        }
        .scroller-wrapper {
            display: flex;
            overflow-x: scroll;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞ iOS */
            scrollbar-width: none; /* Firefox */
        }
        .scroller-wrapper::-webkit-scrollbar { display: none; /* Chrome, Safari */ }
        .scroller-item {
            flex: 0 0 60px; /* –®–∏—Ä–∏–Ω–∞ –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* 24px */
            color: #9ca3af; /* gray-400 */
            scroll-snap-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .scroller-item.active {
            font-size: 2.25rem; /* 36px */
            font-weight: 800;
            color: #4f46e5; /* indigo-600 */
            transform: scale(1.1);
        }
        .scroller-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            border: 2px solid #a78bfa; /* purple-400 */
            border-radius: 0.75rem; /* rounded-xl */
            pointer-events: none;
        }
         .analysis-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; text-align: center; }
        .analysis-animation { width: 80px; height: 80px; margin-bottom: 1rem; }
        #analysis-text { font-size: 1rem; font-weight: 500; color: #4b5563; transition: opacity 0.5s ease-in-out; min-height: 1.5rem; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-indigo-100 md:flex md:items-center md:justify-center min-h-screen">
    <div id="main-container" class="w-full md:h-[90vh] md:max-w-lg flex flex-col bg-white md:shadow-2xl md:rounded-2xl overflow-hidden">
        <div class="w-full bg-gray-200"><div id="progress-bar" class="h-2 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; transition: width 0.5s ease-in-out;"></div></div>
        
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        <div id="options-container-wrapper" class="px-4 pt-1 pb-2"><div id="options-container" class="flex gap-2 overflow-x-auto py-2 options-container"></div></div>
         <div id="input-area" class="p-4 border-t border-gray-200">
            </div>
         <div id="payment-form-container"></div>
    </div>
    <div id="camera-modal">
        <div id="camera-container">
            <video id="camera-video" autoplay muted playsinline></video><canvas id="camera-canvas"></canvas>
            <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4"><svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p></div>
            <div id="camera-overlay"><p id="camera-status">Position your face in the frame</p></div>
        </div>
    </div>

    <script>
        // --- DOM Elements & State ---
        const mainContainer = document.getElementById('main-container'), chatContainer = document.getElementById('chat-container'), optionsContainer = document.getElementById('options-container'), optionsContainerWrapper = document.getElementById('options-container-wrapper'), inputArea = document.getElementById('input-area'), progressBar = document.getElementById('progress-bar'), cameraModal = document.getElementById('camera-modal'), video = document.getElementById('camera-video'), canvas = document.getElementById('camera-canvas'), cameraLoader = document.getElementById('camera-loader'), loaderText = document.getElementById('loader-text'), cameraStatus = document.getElementById('camera-status'), paymentFormContainer = document.getElementById('payment-form-container');
        let sessionId = null, userAnswers = {}, currentQuestionIndex = 0, detectionInterval, stream, capturedPhotoDataUrl = null, scrollerTimeout, countdownInterval;

        // --- Quiz Data ---
        const quizQuestions = [
            { key: 'intro_dave', type: 'message', text: "Hey! I'm Dave, your personal AI wellness assistant today. üëã" },
            { key: 'name', type: 'question', text: "What should I call you?", placeholder: "Type your name..." },
            { key: 'intro_purpose', type: 'message', text: (name) => `Great to meet you, ${name}! Here's a quick look at what we'll uncover together...` },
            { key: 'intro_privacy', type: 'message', text: "To start, I'll ask a few questions about your lifestyle. Your answers are confidential and are deleted after the analysis." },
            { key: 'start_consent', type: 'question', text: "Ready to begin?", options: ["Yes, let's start!"] },
            
            { key: 'age', type: 'scroller', text: "To start, what's your age? üéÇ", min: 16, max: 80, initial: 28, unit: 'years' },
            { key: 'gender', type: 'question', text: "Great start! Now, what's your biological sex? üß¨", options: ['Male', 'Female'] },
            { key: 'height', type: 'scroller', text: "Perfect. And what is your height? üìè", min: 140, max: 220, initial: 175, unit: 'cm' },
            { key: 'weight', type: 'scroller', text: "Thanks! And your current weight? ‚öñÔ∏è", min: 40, max: 150, initial: 70, unit: 'kg' },

            { key: 'sleep', type: 'question', text: "Sleep is crucial. üò¥ How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"] },
            { key: 'activity', type: 'question', text: "Movement is key! üèÉ‚Äç‚ôÄÔ∏è How often do you engage in moderate physical activity per week?", options: ["Rarely or never", "1-2 times", "3-4 times", "5+ times"] },
            { key: 'nutrition', type: 'question', text: "Let's dive into nutrition. ü•¶ How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"] },
            { key: 'processed_food', type: 'question', text: "How often do you eat processed or fast food?", options: ["Almost never", "A few times a month", "A few times a week", "Almost every day"] },
            { key: 'hydration', type: 'question', text: "Hydration check! üíß How many glasses of water do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"] },
            { key: 'stress', type: 'question', text: "On a scale of 1 to 10, how would you rate your typical stress level?", options: ["1-3 (Low)", "4-6 (Moderate)", "7-8 (High)", "9-10 (Very High)"] },
            { key: 'mindfulness', type: 'question', text: "How often do you practice mindfulness, meditation, or deep breathing?", options: ["Never", "Rarely (a few times a month)", "Weekly", "Several times a week", "Daily"] },
            { key: 'mood', type: 'question', text: "How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "It varies a lot", "Often Stressed or Sad"] },
            { key: 'alcohol', type: 'question', text: "How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"] },
            { key: 'smoking', type: 'question', text: "Do you smoke or use tobacco products?", options: ["No", "Occasionally", "Yes, daily"] },
            { key: 'screen_time', type: 'question', text: "How much time do you spend on screens (phone, computer, TV) outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"] },

            { key: 'camera', type: 'final_step', text: "You did it! üéâ That's all the questions. Now for the fun part: a quick selfie. This helps me analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored. Please allow camera access and position your face within the frame." }
        ];

        // --- Core Quiz Logic ---
        
        async function startQuizSession() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const utmSource = urlParams.get('utm_source');
                const utmMedium = urlParams.get('utm_medium');
                const referrer = document.referrer;
                let trafficSource = 'direct';
                if (utmSource) {
                    trafficSource = `${utmSource}${utmMedium ? `/${utmMedium}` : ''}`;
                } else if (referrer) {
                    const referrerHost = new URL(referrer).hostname;
                    if (referrerHost.includes('google') || referrerHost.includes('bing') || referrerHost.includes('yandex')) {
                        trafficSource = 'organic';
                    } else {
                        trafficSource = referrerHost;
                    }
                }
                const getDeviceType = () => {
                    const ua = navigator.userAgent;
                    if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "tablet";
                    if (/Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua)) {
                        if (/iPhone|iPad|iPod/i.test(ua)) return "ios";
                        if (/Android/i.test(ua)) return "android";
                        return "mobile";
                    }
                    return "desktop";
                };
                
                const response = await fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'startSession',
                        source: trafficSource,
                        deviceType: getDeviceType()
                    })
                });

                if (!response.ok) throw new Error('Server error starting session.');
                const data = await response.json();
                sessionId = data.sessionId;
                if (!sessionId) throw new Error('No sessionId received.');
            } catch (error) {
                console.error('Failed to start session:', error);
                addBotMessage("Sorry, I'm having trouble connecting to our services. Please refresh the page to try again.");
                inputArea.style.display = 'none';
            }
        }

        function handleAnswer(answer) {
            if (answer === null || answer === undefined || answer.toString().trim() === '') return;
            const currentQuestion = quizQuestions[currentQuestionIndex];
            addUserMessage(typeof answer === 'string' ? answer : `${answer} ${currentQuestion.unit || ''}`);
            userAnswers[currentQuestion.key] = answer;
            saveAnswerToServer(currentQuestion.key, answer);
            
            const userInputEl = document.getElementById('user-input');
            if (userInputEl) userInputEl.value = '';
            inputArea.innerHTML = '';
            inputArea.classList.add('hidden');
            optionsContainerWrapper.classList.add('hidden');
            optionsContainer.innerHTML = '';

            currentQuestionIndex++;
            updateProgressBar();
            askNextQuestion();
        }

        function askNextQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) return;
            const question = quizQuestions[currentQuestionIndex];
            showTypingIndicator();
            const delay = question.delayBefore || 1200;
            
            setTimeout(() => {
                hideTypingIndicator();
                let questionText = typeof question.text === 'function' ? question.text(userAnswers.name || 'friend') : question.text;
                
                if (question.type === 'message') {
                    addBotMessage(questionText, question.key);
                    currentQuestionIndex++;
                    askNextQuestion();
                } else if (question.type === 'question') {
                    addBotMessage(questionText, question.key);
                    if (question.options) {
                        const optionButtons = question.options.map(opt => ({ text: opt, class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50' }));
                        const handlers = question.options.map(opt => () => handleAnswer(opt));
                        showOptions(optionButtons, handlers);
                    }
                    if (question.placeholder) {
                        inputArea.innerHTML = `<div class="flex items-center gap-2"><input type="text" id="user-input" placeholder="${question.placeholder}" class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500"><button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button></div>`;
                        inputArea.classList.remove('hidden');
                        document.getElementById('send-btn').addEventListener('click', () => handleAnswer(document.getElementById('user-input').value));
                        document.getElementById('user-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAnswer(document.getElementById('user-input').value); });
                    }
                } else if (question.type === 'scroller') {
                    addBotMessage(questionText, question.key);
                    displayNumberScroller(question.key, question.min, question.max, question.initial, question.unit);
                } else if (question.type === 'final_step') {
                    inputArea.classList.add('hidden');
                    addBotMessage(questionText, question.key);
                    showCameraStep();
                }
            }, delay);
        }

        function displayNumberScroller(key, min, max, initial, unit) {
            let selectedValue = initial;
            optionsContainer.innerHTML = `
                <div class="scroller-container w-full">
                    <div class="scroller-indicator"></div>
                    <div id="scroller-wrapper" class="scroller-wrapper"></div>
                </div>
            `;
            const wrapper = document.getElementById('scroller-wrapper');
            wrapper.innerHTML += '<div style="flex: 0 0 50%;"></div>';
            for (let i = min; i <= max; i++) {
                const item = document.createElement('div');
                item.className = 'scroller-item';
                item.textContent = i;
                item.dataset.value = i;
                if (i === initial) item.classList.add('active');
                wrapper.appendChild(item);
            }
            wrapper.innerHTML += '<div style="flex: 0 0 50%;"></div>';
            
            const initialEl = wrapper.querySelector(`[data-value="${initial}"]`);
            if (initialEl) {
                setTimeout(() => {
                    initialEl.scrollIntoView({ behavior: 'auto', inline: 'center' });
                }, 100);
            }

            wrapper.addEventListener('scroll', () => {
                clearTimeout(scrollerTimeout);
                scrollerTimeout = setTimeout(() => {
                    const wrapperRect = wrapper.getBoundingClientRect();
                    const centerX = wrapperRect.left + wrapperRect.width / 2;
                    let closestEl = null;
                    let minDistance = Infinity;

                    wrapper.querySelectorAll('.scroller-item').forEach(el => {
                        const elRect = el.getBoundingClientRect();
                        const elCenterX = elRect.left + elRect.width / 2;
                        const distance = Math.abs(centerX - elCenterX);
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            closestEl = el;
                        }
                    });

                    if (closestEl) {
                        wrapper.querySelectorAll('.scroller-item.active').forEach(activeEl => activeEl.classList.remove('active'));
                        closestEl.classList.add('active');
                        selectedValue = parseInt(closestEl.dataset.value);
                    }
                }, 150);
            });

            optionsContainerWrapper.classList.remove('hidden');
            
            inputArea.innerHTML = `<button id="confirm-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors">Confirm ${unit}</button>`;
            inputArea.classList.remove('hidden');
            document.getElementById('confirm-btn').onclick = () => handleAnswer(selectedValue);
        }

        // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
        async function saveAnswerToServer(questionKey, answer) { if (!sessionId) return; try { await fetch('/.netlify/functions/quiz', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'saveAnswer', sessionId: sessionId, questionId: questionKey, answer: answer }) }); } catch (error) { console.error('Failed to save answer:', error); } }
        async function proceedToAnalysis() { addBotMessage("Analyzing your photo with our AI... This may take a moment."); showTypingIndicator(); try { const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ photoDataUrl: capturedPhotoDataUrl }) }); if (!analyzeResponse.ok) throw new Error('Skin analysis API returned an error.'); const analysisResult = await analyzeResponse.json(); await saveAnswerToServer('faceAnalysis', analysisResult); hideTypingIndicator(); showCompletionAnimation(); } catch (error) { hideTypingIndicator(); console.error('Error during photo analysis:', error); addBotMessage("I had a little trouble with the photo analysis, but we can still generate a report from your answers. Continuing..."); showCompletionAnimation(); } }
        function updateProgressBar() { const questionKeys = quizQuestions.filter(q => q.type === 'question' || q.type === 'scroller').map(q => q.key); const totalSteps = questionKeys.length + 1; const completedAnswers = Object.keys(userAnswers).filter(key => questionKeys.includes(key)).length; const photoStepCompleted = userAnswers['selfie'] ? 1 : 0; const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100; progressBar.style.width = `${progress}%`; }
        function showTypingIndicator() { const typingDiv = document.createElement('div'); typingDiv.id = 'typing-indicator'; typingDiv.className = 'flex justify-start mb-4 chat-bubble'; const avatarId = `avatar-lottie-${Date.now()}`; typingDiv.innerHTML = `<div id="${avatarId}" class="bot-avatar-lottie mr-3 flex-shrink-0"></div><div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`; chatContainer.appendChild(typingDiv); lottie.loadAnimation({ container: document.getElementById(avatarId), renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' }); scrollToBottom(); }
        function hideTypingIndicator() { document.getElementById('typing-indicator')?.remove(); }
        function addBotMessage(html, key = '') { const messageDiv = document.createElement('div'); if (key === 'intro_dave') { messageDiv.className = 'mb-4 chat-bubble'; messageDiv.innerHTML = `<div id="greeting-animation" class="w-full max-w-[250px] mx-auto mb-[-40px] z-10 relative"></div><div class="flex justify-start"><div id="greeting-avatar" class="bot-avatar-lottie mr-3 flex-shrink-0 self-end mb-1"></div><div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div></div>`; chatContainer.appendChild(messageDiv); lottie.loadAnimation({ container: document.getElementById('greeting-animation'), renderer: 'svg', loop: false, autoplay: true, path: 'assistent.json' }); lottie.loadAnimation({ container: document.getElementById('greeting-avatar'), renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' }); } else { messageDiv.className = 'flex justify-start mb-4 chat-bubble'; const avatarId = `avatar-lottie-${Date.now()}`; messageDiv.innerHTML = `<div id="${avatarId}" class="bot-avatar-lottie mr-3 flex-shrink-0"></div><div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${html}</div>`; chatContainer.appendChild(messageDiv); lottie.loadAnimation({ container: document.getElementById(avatarId), renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' }); } scrollToBottom(); }
        function addUserMessage(text) { const d = document.createElement('div'); d.className = 'flex justify-end mb-4 chat-bubble'; d.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-xs">${text}</div>`; chatContainer.appendChild(d); scrollToBottom(); }
        function showOptions(options, handlers) { optionsContainer.innerHTML = ''; if (options?.length > 0) { optionsContainerWrapper.classList.remove('hidden'); options.forEach((option, index) => { const button = document.createElement('button'); button.textContent = option.text; button.className = option.class; button.onclick = handlers[index]; optionsContainer.appendChild(button); }); } else { optionsContainerWrapper.classList.add('hidden'); } }
        function showCameraStep() { optionsContainerWrapper.classList.add('hidden'); inputArea.classList.remove('hidden'); inputArea.innerHTML = `<button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors">Open Camera</button>`; document.getElementById('open-camera-btn').onclick = startCamera; }
        async function startCamera() { cameraModal.classList.add('active'); try { const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'; await Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL) ]); loaderText.textContent = "Requesting camera access..."; stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); video.srcObject = stream; video.onloadedmetadata = () => { cameraLoader.style.display = 'none'; startFaceDetection(); }; } catch (err) { console.error("Camera/Model Error:", err); loaderText.textContent = "Camera access denied or models failed to load. Please refresh and try again."; setTimeout(stopCamera, 3000); } }
        function stopCamera() { clearInterval(detectionInterval); stream?.getTracks().forEach(track => track.stop()); cameraModal.classList.remove('active'); video.srcObject = null; }
        function startFaceDetection() { let captureTimeout; const context = canvas.getContext('2d'); detectionInterval = setInterval(async () => { const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(); const displaySize = { width: video.clientWidth, height: video.clientHeight }; faceapi.matchDimensions(canvas, displaySize); context.clearRect(0, 0, canvas.width, canvas.height); context.save(); context.translate(canvas.width, 0); context.scale(-1, 1); if (detections.length > 0) { const resizedDetections = faceapi.resizeResults(detections, displaySize); const isGoodSize = resizedDetections[0].detection.box.width > canvas.width * 0.4; if (isGoodSize) { cameraStatus.textContent = "Hold still..."; if (!captureTimeout) { captureTimeout = setTimeout(() => takePhoto(), 1500); } } else { cameraStatus.textContent = "Move closer"; clearTimeout(captureTimeout); captureTimeout = null; } } else { cameraStatus.textContent = "Position your face"; clearTimeout(captureTimeout); captureTimeout = null; } context.restore(); }, 100); }
        function takePhoto() { clearInterval(detectionInterval); cameraStatus.textContent = "Perfect!"; const photoCanvas = document.createElement('canvas'); photoCanvas.width = video.videoWidth; photoCanvas.height = video.videoHeight; const photoContext = photoCanvas.getContext('2d'); photoContext.translate(video.videoWidth, 0); photoContext.scale(-1, 1); photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight); capturedPhotoDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9); userAnswers['selfie'] = 'Photo taken'; stopCamera(); updateProgressBar(); showPhotoForConfirmation(); }
        async function startAnalysisAndShowForm() { addUserMessage("Looks Good!"); document.getElementById('photo-preview-wrapper')?.remove(); optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); try { await fetch('/.netlify/functions/quiz', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'endQuiz', sessionId: sessionId }) }); } catch (error) { console.error('Failed to record quiz end time:', error); } proceedToAnalysis(); }
        function showPhotoForConfirmation() { const d = document.createElement('div'); d.id = 'photo-preview-wrapper'; d.className = 'flex justify-start mb-4 chat-bubble'; const i = `<div class="bg-purple-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-xs"><p class="mb-2">Here's the photo. Happy with it?</p><img src="${capturedPhotoDataUrl}" alt="Your selfie" class="rounded-lg"/></div>`; d.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 flex-shrink-0 bot-avatar-lottie overflow-hidden" id="photo-confirm-avatar"></div>${i}`; chatContainer.appendChild(d); lottie.loadAnimation({ container: document.getElementById('photo-confirm-avatar'), renderer: 'svg', loop: false, autoplay: true, path: 'avatar.json' }); scrollToBottom(); const o = [ { text: 'Looks Good!', class: 'option-btn bg-green-500 border-green-600 text-white px-4 py-2 rounded-full text-sm flex-shrink-0 font-semibold' }, { text: 'Retake', class: 'option-btn bg-white border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm flex-shrink-0' } ]; const h = [startAnalysisAndShowForm, retakePhoto]; showOptions(o, h); }
        function retakePhoto() { addUserMessage("Retake"); document.getElementById('photo-preview-wrapper')?.remove(); optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); startCamera(); }
        function showCompletionAnimation() { confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } }); showTypingIndicator(); setTimeout(() => { hideTypingIndicator(); addBotMessage("Awesome work! You've completed the assessment. ü•≥ I'm now analyzing your results..."); inputArea.innerHTML = `<div class="analysis-container"><div id="analysis-animation" class="analysis-animation"></div><p id="analysis-text">Initializing analysis...</p></div>`; inputArea.classList.remove('hidden'); scrollToBottom(); lottie.loadAnimation({ container: document.getElementById('analysis-animation'), renderer: 'svg', loop: true, autoplay: true, path: 'https://lottie.host/e5902521-107f-4a6c-90a2-a7d519a4e157/V92s2n3n1T.json' }); const analysisSteps = ["Analyzing your data...", "Checking lifestyle factors...", "Scanning skin health...", "Calculating biological age...", "Almost ready..."]; const analysisTextElement = document.getElementById('analysis-text'); let currentStep = 0; const intervalId = setInterval(() => { if (currentStep < analysisSteps.length) { analysisTextElement.style.opacity = '0'; setTimeout(() => { analysisTextElement.textContent = analysisSteps[currentStep]; analysisTextElement.style.opacity = '1'; }, 500); currentStep++; } else { clearInterval(intervalId); } }, 1600); setTimeout(() => { inputArea.classList.add('hidden'); showTypingIndicator(); setTimeout(() => { hideTypingIndicator(); addBotMessage("Great! Your preliminary analysis is complete. Just one final step to unlock your full, personalized report."); showPaymentForm(); }, 1200); }, analysisSteps.length * 1600 + 500); }, 1000); }
        function showPaymentForm() { optionsContainerWrapper.classList.add('hidden'); inputArea.classList.add('hidden'); const formHtml = `<div class="p-4 bg-gray-50 border-t"><div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6"><div class="text-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Secure Checkout</h2><p class="text-gray-500">Unlock your full wellness report</p></div><div class="bg-purple-100 text-purple-800 rounded-lg p-3 text-center mb-6"><p class="text-sm font-medium">Special offer ends in:</p><p id="countdown-timer" class="text-2xl font-bold tracking-wider">10:00</p></div><div class="flex justify-between items-center mb-6 pb-4 border-b"><span class="text-gray-600">Full Wellness Report</span><div class="text-right"><span class="text-xl font-bold text-gray-800">$9.99</span><span class="text-sm text-gray-400 line-through ml-2">$24.99</span></div></div><div class="space-y-4"><div><label for="card-number" class="text-sm font-medium text-gray-700">Card Information</label><div class="mt-1 flex items-center relative border border-gray-300 rounded-md shadow-sm focus-within:ring-1 focus-within:ring-purple-500 focus-within:border-purple-500"><input type="text" id="card-number" class="block w-full border-0 p-3 rounded-md placeholder-gray-400 focus:ring-0 sm:text-sm" placeholder="Card Number"><div class="absolute right-3 flex items-center space-x-1 pointer-events-none"><img src="https://img.icons8.com/color/48/000000/visa.png" class="h-6"/><img src="https://img.icons8.com/color/48/000000/mastercard-logo.png" class="h-6"/></div></div></div><div class="flex space-x-4"><div class="w-1/2"><label for="expiry-date" class="text-sm font-medium text-gray-700">Expiration</label><input type="text" id="expiry-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="MM / YY"></div><div class="w-1/2"><label for="cvc" class="text-sm font-medium text-gray-700">CVC</label><input type="text" id="cvc" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="123"></div></div></div><button id="pay-btn" class="mt-8 w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition-colors text-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">Pay $9.99 Now</button><div class="mt-4 flex items-center justify-center text-xs text-gray-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>Secure payment processing</div></div></div>`; paymentFormContainer.innerHTML = formHtml; paymentFormContainer.classList.remove('hidden'); scrollToBottom(); document.getElementById('pay-btn').onclick = handlePayment; startCountdown(); }
        function startCountdown() { let duration = 600; const timerEl = document.getElementById('countdown-timer'); if (!timerEl) return; countdownInterval = setInterval(() => { const minutes = Math.floor(duration / 60).toString().padStart(2, '0'); const seconds = (duration % 60).toString().padStart(2, '0'); timerEl.textContent = `${minutes}:${seconds}`; duration--; if (duration < 0) { clearInterval(countdownInterval); timerEl.textContent = "00:00"; const payBtn = document.getElementById('pay-btn'); if (payBtn) { payBtn.textContent = "Offer Expired"; payBtn.disabled = true; } } }, 1000); }
        async function handlePayment() { clearInterval(countdownInterval); paymentFormContainer.innerHTML = ''; paymentFormContainer.classList.add('hidden'); showTypingIndicator(); setTimeout(async () => { hideTypingIndicator(); addBotMessage("‚úÖ Payment successful! (This was a demo, you were not charged). We are now generating your final report. You will be redirected shortly."); try { await fetch('/.netlify/functions/quiz', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'updatePayment', sessionId: sessionId, status: 'success', amountUSD: 9.99 }) }); await fetch('/.netlify/functions/result-background', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId: sessionId }) }); setTimeout(() => { window.location.href = `/result.html?session_id=${sessionId}`; }, 2500); } catch (error) { console.error('Failed to trigger report generation:', error); addBotMessage("Sorry, something went wrong after the payment step. Please try again."); } }, 1500); }

        // --- Initial Call ---
        async function initQuiz() {
            setAppHeight();
            await startQuizSession();
            if (sessionId) {
                askNextQuestion();
            }
        }
        
        window.addEventListener('resize', setAppHeight);
        inputArea.classList.add('hidden');
        initQuiz();
    </script>
</body>
</html>
