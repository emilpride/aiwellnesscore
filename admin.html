<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AI WellnessCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        :root {
            --bg-dark: #111827; --bg-light: #1F2937; --border-color: #374151;
            --text-main: #F9FAFB; --text-secondary: #9CA3AF; --accent-purple: #8b5cf6;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; }
        .form-input { background-color: var(--bg-light); border: 1px solid var(--border-color); }
        .stat-card { background-color: var(--bg-light); border: 1px solid var(--border-color); }
        .tab-button { transition: all 0.2s; }
        .tab-button.active { color: var(--accent-purple); border-color: var(--accent-purple); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Стили для сортировки */
        .table-custom th.sortable { cursor: pointer; user-select: none; }
        .table-custom th.sortable:hover { background-color: #374151; }
        .sort-icon { display: inline-block; width: 1em; text-align: center; color: var(--text-secondary); }
        .sort-icon.asc, .sort-icon.desc { color: var(--text-main); }

        #column-filter-dropdown { transition: opacity 0.2s, transform 0.2s; }
        .column-hidden { display: none; }
        .funnel-bar { background: linear-gradient(90deg, var(--accent-purple) 0%, #6366f1 100%); transition: width 0.5s ease-in-out; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        @media (max-width: 1024px) {
            .table-custom thead, .funnel-table thead { display: none; }
            .table-custom tr, .funnel-table tr { display: block; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; overflow: hidden; background-color: var(--bg-light); }
            .table-custom td, .funnel-table td { display: grid; grid-template-columns: 110px 1fr; gap: 0.5rem; text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border-color); }
            .table-custom tr td:last-child, .funnel-table tr td:last-child { border-bottom: none; }
            .table-custom td::before, .funnel-table td::before { content: attr(data-label); font-weight: 600; color: var(--text-secondary); text-align: left; padding-right: 0.5rem; }
            .table-custom td.column-hidden { display: none !important; }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="antialiased">

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Admin Panel Access</h2>
            <form id="login-form">
                <input type="password" id="password-input" placeholder="Enter Access Password" class="w-full form-input rounded-md p-3 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md mt-4 transition-colors">Login</button>
                <p id="login-error" class="text-red-400 text-center mt-4 text-sm"></p>
            </form>
        </div>
    </div>

    <main id="admin-panel" class="hidden p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                <h1 class="text-3xl font-bold text-white text-center sm:text-left">AI WellnessCore Dashboard</h1>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div class="flex-grow flex items-center gap-2 w-full">
                        <label for="start-date-stats" class="text-sm font-medium text-gray-400 flex-shrink-0">From:</label>
                        <input type="date" id="start-date-stats" class="form-input w-full">
                    </div>
                    <div class="flex-grow flex items-center gap-2 w-full">
                        <label for="end-date-stats" class="text-sm font-medium text-gray-400 flex-shrink-0">To:</label>
                        <input type="date" id="end-date-stats" class="form-input w-full">
                    </div>
                    <button id="refresh-data-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 w-full sm:w-auto justify-center">
                        <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                        <span class="sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
            
            <div class="border-b border-gray-700 mt-6">
                <nav class="-mb-px flex flex-wrap space-x-4 sm:space-x-8" aria-label="Tabs">
                    <button id="tab-stats" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Statistics</button>
                    <button id="tab-sessions" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500">Sessions</button>
                    <button id="tab-messages" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500">Messages</button>
                    <button id="tab-funnel" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500">Funnel Analysis</button>
                </nav>
            </div>
            
            <div id="content-stats" class="tab-content active mt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="stat-card p-4 rounded-lg text-center"><p class="text-sm font-medium text-gray-400">Total Revenue</p><p id="stat-total-revenue" class="text-3xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-4 rounded-lg text-center"><p class="text-sm font-medium text-gray-400">Average Check</p><p id="stat-avg-check" class="text-3xl font-bold mt-1">$0.00</p></div>
                    <div class="stat-card p-4 rounded-lg text-center"><p class="text-sm font-medium text-gray-400">Conversion Rate</p><p id="stat-conversion" class="text-3xl font-bold mt-1">0%</p></div>
                    <div class="stat-card p-4 rounded-lg text-center"><p class="text-sm font-medium text-gray-400">Total Errors</p><p id="stat-total-errors" class="text-3xl font-bold mt-1 text-red-400">0</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">OS Breakdown</h3><div id="stat-os-breakdown"></div></div>
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Gender Breakdown</h3><div id="stat-gender-breakdown"></div></div>
                    </div>
                    <div class="lg:col-span-1 space-y-4">
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Average Age</h3><div id="stat-avg-age"></div></div>
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Average Duration</h3><p id="stat-avg-duration" class="text-2xl font-semibold"></p></div>
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Most Popular Drop-off</h3><p id="stat-top-dropoff" class="text-lg font-semibold text-yellow-400"></p></div>
                    </div>
                    <div class="lg:col-span-1 space-y-4">
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Top Traffic Sources</h3><ul id="stat-top-sources" class="space-y-1 text-sm"></ul></div>
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Top Countries</h3><ul id="stat-top-countries" class="space-y-1 text-sm"></ul></div>
                        <div class="stat-card p-4 rounded-lg"><h3 class="font-bold mb-2">Top User Goal</h3><p id="stat-top-goal" class="text-lg font-semibold text-purple-400"></p></div>
                    </div>
                </div>
            </div>

            <div id="content-sessions" class="tab-content mt-6">
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="text" id="search-input" placeholder="Search by IP, Email or Country..." class="w-full sm:w-1/3 form-input rounded-md p-2 text-white">
                    <div class="relative ml-auto">
                        <button id="column-filter-btn" class="form-input p-2 rounded-md hover:border-gray-400 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                            Columns
                        </button>
                        <div id="column-filter-dropdown" class="hidden absolute top-full right-0 mt-2 w-48 bg-gray-700 border border-gray-600 rounded-md shadow-lg z-10 p-2 space-y-1 origin-top-right"></div>
                    </div>
                </div>
                <div class="mt-4 overflow-x-auto rounded-lg">
                    <table class="min-w-full divide-y divide-gray-700 table-custom">
                        <thead class="bg-gray-800">
                            <tr>
                                <th data-column="number" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable"># <span class="sort-icon"></span></th>
                                <th data-column="createdAt" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Date <span class="sort-icon"></span></th>
                                <th data-column="deviceType" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Device/Source <span class="sort-icon"></span></th>
                                <th data-column="ipAddress" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">IP/Country <span class="sort-icon"></span></th>
                                <th data-column="email" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Email <span class="sort-icon"></span></th>
                                <th data-column="user" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User</th>
                                <th data-column="userGoal" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">User Goal <span class="sort-icon"></span></th>
                                <th data-column="progressPercent" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Progress <span class="sort-icon"></span></th>
                                <th data-column="durationMs" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Duration <span class="sort-icon"></span></th>
                                <th data-column="dropOffPoint" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Drop-off Point <span class="sort-icon"></span></th>
                                <th data-column="paymentStatus" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Payment <span class="sort-icon"></span></th>
                                <th data-column="errorCount" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider sortable">Errors <span class="sort-icon"></span></th>
                                <th data-column="link" class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Link</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table-body" class="bg-gray-900"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="content-messages" class="tab-content mt-6">
                <div id="messages-container" class="space-y-4"></div>
            </div>

            <div id="content-funnel" class="tab-content mt-6">
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h2 class="text-xl font-bold text-white">Funnel Analysis</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 items-end">
                        <div><label class="block text-sm font-medium text-gray-400">Traffic Sources</label><div id="funnel-sources-checkboxes" class="form-input w-full mt-1 h-32 overflow-y-auto p-2 space-y-1"></div></div>
                        <button id="analyze-funnel-btn" class="w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Analyze</button>
                    </div>
                </div>
                <div id="funnel-results-container" class="mt-6"></div>
            </div>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const loginForm = document.getElementById('login-form'), passwordInput = document.getElementById('password-input'),
            loginError = document.getElementById('login-error'), loginModal = document.getElementById('login-modal'),
            adminPanel = document.getElementById('admin-panel'), refreshBtn = document.getElementById('refresh-data-btn'),
            refreshIcon = document.getElementById('refresh-icon');

        let allSessionsData = [], statisticsData = {}, allMessagesData = [], adminPassword = null;
        let sortState = { column: 'createdAt', direction: 'desc' };

        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        async function fetchAndRenderData(password, isInitialLoad = false) {
            if (!password) { loginError.textContent = 'Password is required.'; return; }
            if(isInitialLoad) {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                document.getElementById('end-date-stats').value = formatDate(today);
                document.getElementById('start-date-stats').value = formatDate(yesterday);
            }
            loginError.textContent = ''; refreshBtn.disabled = true; refreshIcon.classList.add('animate-spin');
            try {
                const startDate = document.getElementById('start-date-stats').value, endDate = document.getElementById('end-date-stats').value;
                const response = await fetch('/.netlify/functions/getAdminData', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password, startDate: startDate || null, endDate: endDate || null })
                });
                if (response.status === 401) throw new Error('Incorrect password.');
                if (!response.ok) throw new Error('Could not fetch data from server.');
                const { sessions, statistics, messages } = await response.json();
                allSessionsData = sessions; statisticsData = statistics; allMessagesData = messages;
                if (!adminPassword) {
                    adminPassword = password;
                    loginModal.classList.add('hidden'); adminPanel.classList.remove('hidden');
                    setupUI();
                }
                renderAll();
            } catch (error) {
                console.error("Fetch Error:", error.message); loginError.textContent = error.message;
                if (adminPassword) alert("Error fetching data: " + error.message);
            } finally {
                refreshBtn.disabled = false; refreshIcon.classList.remove('animate-spin');
            }
        }

        loginForm.addEventListener('submit', async (e) => { e.preventDefault(); await fetchAndRenderData(passwordInput.value, true); });
        refreshBtn.addEventListener('click', () => { if (adminPassword) fetchAndRenderData(adminPassword); });

        function setupUI() {
            document.getElementById('search-input').addEventListener('input', () => renderTable(allSessionsData));
            ['start-date-stats', 'end-date-stats'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => { if (adminPassword) fetchAndRenderData(adminPassword); });
            });

            const tabs = document.querySelectorAll('.tab-button'), tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => { t.classList.remove('active', 'text-purple-400', 'border-purple-400'); t.classList.add('text-gray-400', 'border-transparent'); });
                    tab.classList.add('active', 'text-purple-400', 'border-purple-400');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tab.id.replace('tab-', 'content-')).classList.add('active');
                });
            });
            
            document.getElementById('sessions-table-body').addEventListener('click', (event) => {
                if (event.target.classList.contains('toggle-errors-btn')) {
                    const button = event.target, sessionId = button.dataset.sessionId, errorRow = document.getElementById(`errors-${sessionId}`);
                    if (errorRow) { errorRow.classList.toggle('hidden'); button.textContent = errorRow.classList.contains('hidden') ? `Show (${button.dataset.errorCount})` : 'Hide'; }
                }
                if (event.target.classList.contains('truncate-email')) {
                    event.target.textContent = event.target.dataset.fullEmail;
                    event.target.classList.remove('truncate-email', 'cursor-pointer', 'text-purple-400');
                }
            });
            
            document.getElementById('analyze-funnel-btn').addEventListener('click', calculateAndRenderFunnel);
            setupColumnFilter();
            setupTableSorting();
        }
        
        function setupTableSorting() {
            document.querySelectorAll('#content-sessions th.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.column;
                    if (sortState.column === column) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = column;
                        sortState.direction = 'desc';
                    }
                    renderTable(allSessionsData);
                });
            });
        }

        function setupColumnFilter() {
            const btn = document.getElementById('column-filter-btn'), dropdown = document.getElementById('column-filter-dropdown'), tableHeaders = document.querySelectorAll('#content-sessions th[data-column]');
            const defaultVisible = ['number', 'date', 'device', 'ip', 'progress'];
            dropdown.innerHTML = Array.from(tableHeaders).map(th => {
                const key = th.dataset.column;
                const text = th.textContent.replace('▲', '').replace('▼', '').trim() || '#';
                const isChecked = defaultVisible.includes(key) ? 'checked' : '';
                return `<label class="flex items-center space-x-2 text-sm p-1 hover:bg-gray-600 rounded cursor-pointer"><input type="checkbox" data-column="${key}" class="column-toggle-cb" ${isChecked}><span>${text}</span></label>`;
            }).join('');
            btn.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => { if (!dropdown.contains(e.target) && !btn.contains(e.target)) dropdown.classList.add('hidden'); });
            dropdown.querySelectorAll('.column-toggle-cb').forEach(cb => cb.addEventListener('change', updateColumnVisibility));
            updateColumnVisibility();
        }

        function updateColumnVisibility() {
            document.querySelectorAll('.column-toggle-cb').forEach(cb => {
                document.querySelectorAll(`[data-column="${cb.dataset.column}"]`).forEach(cell => cell.classList.toggle('column-hidden', !cb.checked));
            });
        }

        function renderAll() {
            renderStats(statisticsData); renderTable(allSessionsData); renderMessages(allMessagesData); populateFunnelFilters();
        }
        
        function renderStats(stats) {
            document.getElementById('stat-total-revenue').textContent = `$${stats.totalRevenue}`;
            document.getElementById('stat-avg-check').textContent = `$${stats.avgCheck}`;
            document.getElementById('stat-conversion').textContent = `${stats.conversionRate}%`;
            document.getElementById('stat-total-errors').textContent = stats.totalErrors;
            const createBar = (item) => `<div class="flex justify-between items-center text-sm mb-1"><span class="capitalize">${item.os || item.gender}</span><span>${item.percent}%</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-purple-500 h-2 rounded-full" style="width:${item.percent}%"></div></div>`;
            if (stats.osBreakdown) document.getElementById('stat-os-breakdown').innerHTML = stats.osBreakdown.map(createBar).join('<div class="h-2"></div>');
            if (stats.genderBreakdown) document.getElementById('stat-gender-breakdown').innerHTML = stats.genderBreakdown.map(createBar).join('<div class="h-2"></div>');
            document.getElementById('stat-avg-age').innerHTML = `<div class="flex justify-around text-center"><div><p class="text-xs text-gray-400">Avg. Female</p><p class="text-2xl font-semibold">${stats.avgFemaleAge}</p></div><div><p class="text-xs text-gray-400">Avg. Male</p><p class="text-2xl font-semibold">${stats.avgMaleAge}</p></div></div>`;
            document.getElementById('stat-avg-duration').textContent = stats.avgDuration;
            document.getElementById('stat-top-dropoff').textContent = stats.topDropOff[0].replace(/_/g, ' ');
            document.getElementById('stat-top-goal').textContent = stats.topUserGoal[0].replace(/_/g, ' ');
            const renderTopList = (id, data) => {
                const ul = document.getElementById(id);
                ul.innerHTML = (!data || data.length === 0) ? `<li class="text-xs text-gray-500">No data</li>` : data.map(([n, c]) => `<li class="flex justify-between"><span>${n}</span><strong>${c}</strong></li>`).join('');
            };
            renderTopList('stat-top-sources', stats.topTrafficSources);
            renderTopList('stat-top-countries', stats.topCountries);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('sessions-table-body');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            let filteredData = data.filter(s => (s.ipAddress.toLowerCase().includes(searchTerm) || s.country.toLowerCase().includes(searchTerm) || (s.email && s.email.toLowerCase().includes(searchTerm))));
            
            const { column, direction } = sortState;
            const totalSessions = statisticsData.totalSessions || 0;
            const newerSessionsCount = statisticsData.newerSessionsCount || 0;
            
            filteredData.sort((a, b) => {
                let valA, valB;
                if (column === 'number') {
                    valA = totalSessions - newerSessionsCount - allSessionsData.indexOf(a);
                    valB = totalSessions - newerSessionsCount - allSessionsData.indexOf(b);
                } else {
                    valA = a[column];
                    valB = b[column];
                }
                
                if (typeof valA === 'string') { valA = valA.toLowerCase(); }
                if (typeof valB === 'string') { valB = (valB || '').toString().toLowerCase(); }
                
                if (valA == null) return 1;
                if (valB == null) return -1;

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });

            if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="13" class="text-center p-6 text-gray-400">No sessions match filters.</td></tr>`; return; }
            
            tableBody.innerHTML = filteredData.map(session => {
                const sessionIndex = allSessionsData.findIndex(s => s.id === session.id);
                // Если findIndex не находит (например, при фильтрации), используем оригинальный индекс из `data`
                const originalIndex = (sessionIndex === -1) ? data.indexOf(session) : sessionIndex;
                const sessionNumber = totalSessions - newerSessionsCount - originalIndex;

                const paymentStatusClass = session.paymentStatus === 'succeeded' ? 'bg-green-500 text-green-100' : session.paymentStatus === 'pending' ? 'bg-yellow-500 text-yellow-100' : 'bg-red-500 text-red-100';
                let emailDisplay = `<span class="text-purple-400">${session.email || 'N/A'}</span>`;
                if ((session.email || '').length > 20) { emailDisplay = `<span class="truncate-email cursor-pointer text-purple-400" data-full-email="${session.email}">${session.email.substring(0, 17)}...</span>`; }
                
                let rowHtml = `<tr class="main-row">
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="#" data-column="number">${sessionNumber}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Date" data-column="createdAt">${new Date(session.createdAt).toLocaleString('en-GB',{dateStyle:'short',timeStyle:'short'})}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Device/Source" data-column="deviceType"><div class="font-medium">${session.deviceType}</div><div class="text-gray-400">${session.trafficSource}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="IP/Country" data-column="ipAddress"><div class="font-medium">${session.ipAddress}</div><div class="text-gray-400">${session.country}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Email" data-column="email">${emailDisplay}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="User" data-column="user"><div class="font-medium">${session.gender}</div><div class="text-gray-400">Age: ${session.age}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="User Goal" data-column="userGoal">${session.userGoal}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Progress" data-column="progressPercent">${session.progress}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Duration" data-column="durationMs">${session.duration}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Drop-off Point" data-column="dropOffPoint">${session.dropOffPoint}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Payment" data-column="paymentStatus"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${paymentStatusClass}">${session.paymentStatus}</span><div class="text-gray-400">${session.paymentAmount}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Errors" data-column="errorCount">${session.errorCount > 0 ? `<button data-session-id="${session.id}" data-error-count="${session.errorCount}" class="toggle-errors-btn bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">Show (${session.errorCount})</button>` : '—'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300" data-label="Link" data-column="link">${session.resultLink && session.paymentStatus === 'succeeded' ? `<a href="/${session.resultLink}" target="_blank" class="text-purple-400 hover:text-purple-300">View</a>` : '<span class="text-gray-500 text-lg">❌</span>'}</td>
                </tr>`;

                if (session.errors && session.errors.length > 0) {
                    rowHtml += `<tr id="errors-${session.id}" class="hidden"><td colspan="13" class="p-3 bg-gray-800" data-label="Error Details">${session.errors.map(err => `<div class="border-b border-gray-700 py-2 last:border-b-0"><p class="text-red-400 font-semibold">${err.message||'Unknown Error'}</p><p class="text-gray-400 text-xs font-mono break-all">${err.details||'No details'}</p><p class="text-gray-500 text-xs mt-1">${new Date(err.timestamp).toLocaleString()}</p></div>`).join('')}</td></tr>`;
                }
                return rowHtml;
            }).join('');
            
            updateColumnVisibility();
            updateSortIcons();
        }

        function updateSortIcons() {
            document.querySelectorAll('#content-sessions th.sortable .sort-icon').forEach(icon => { icon.textContent = ''; icon.classList.remove('asc', 'desc'); });
            const activeTh = document.querySelector(`#content-sessions th[data-column="${sortState.column}"]`);
            if (activeTh) {
                const icon = activeTh.querySelector('.sort-icon');
                icon.textContent = sortState.direction === 'asc' ? '▲' : '▼';
                icon.classList.add(sortState.direction);
            }
        }

        function renderMessages(data) {
            const container = document.getElementById('messages-container');
            container.innerHTML = (!data || data.length === 0) ? `<div class="text-center p-6 bg-gray-800 rounded-lg text-gray-400">No new messages.</div>` : data.map(msg => `<div class="bg-gray-800 border border-gray-700 rounded-lg p-4"><div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-2"><div><p class="font-semibold text-white">${msg.subject}</p><p class="text-sm text-gray-400">From: <a href="mailto:${msg.email}" class="text-purple-400 hover:underline">${msg.name}</a></p></div><span class="text-xs text-gray-500">${msg.receivedAt}</span></div><p class="text-gray-300 whitespace-pre-wrap">${msg.message}</p></div>`).join('');
        }

        function populateFunnelFilters() {
            const sources = [...new Set(allSessionsData.map(s => s.trafficSource))].sort();
            document.getElementById('funnel-sources-checkboxes').innerHTML = sources.map(s => `<label class="flex items-center space-x-2 text-sm text-gray-300 hover:bg-gray-700 p-1 rounded cursor-pointer"><input type="checkbox" value="${s}" class="funnel-source-checkbox h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-600 focus:ring-purple-500"><span>${s}</span></label>`).join('');
        }

        function calculateAndRenderFunnel() {
            const selectedSources = [...document.querySelectorAll('.funnel-source-checkbox:checked')].map(cb => cb.value);
            const startDateInput = document.getElementById('start-date-stats').value, endDateInput = document.getElementById('end-date-stats').value;
            let filteredSessions = allSessionsData.filter(s => (selectedSources.length === 0 || selectedSources.includes(s.trafficSource)) && (!startDateInput || new Date(s.createdAt) >= new Date(startDateInput)) && (!endDateInput || new Date(s.createdAt) <= new Date(endDateInput + 'T23:59:59')));
            const funnelSteps = [ { name: '1. Quiz Page Viewed', condition: s => true }, { name: '2. "Let\'s Start" Clicked', condition: s => s.events && s.events.hasOwnProperty('quizStarted') }, { name: '3. Goal', condition: s => s.answers && s.answers.hasOwnProperty('userGoal') }, { name: '4. Age', condition: s => s.answers && s.answers.hasOwnProperty('age') }, { name: '5. Sex (Gender)', condition: s => s.answers && s.answers.hasOwnProperty('gender') }, { name: '6. Height', condition: s => s.answers && s.answers.hasOwnProperty('height') }, { name: '7. Weight', condition: s => s.answers && s.answers.hasOwnProperty('weight') }, { name: '8. Sleep', condition: s => s.answers && s.answers.hasOwnProperty('sleep') }, { name: '9. Activity', condition: s => s.answers && s.answers.hasOwnProperty('activity') }, { name: '10. Nutrition', condition: s => s.answers && s.answers.hasOwnProperty('nutrition') }, { name: '11. Processed Food', condition: s => s.answers && s.answers.hasOwnProperty('processed_food') }, { name: '12. Hydration', condition: s => s.answers && s.answers.hasOwnProperty('hydration') }, { name: '13. Mindfulness', condition: s => s.answers && s.answers.hasOwnProperty('mindfulness') }, { name: '14. Mood', condition: s => s.answers && s.answers.hasOwnProperty('mood') }, { name: '15. Alcohol', condition: s => s.answers && s.answers.hasOwnProperty('alcohol') }, { name: '16. Smoking', condition: s => s.answers && s.answers.hasOwnProperty('smoking') }, { name: '17. Screen Time', condition: s => s.answers && s.answers.hasOwnProperty('screen_time') }, { name: '18. Photo (Selfie)', condition: s => s.answers && s.answers.hasOwnProperty('selfie') }, { name: '19. Email', condition: s => s.answers && s.answers.hasOwnProperty('email') }, { name: '20. Profile Page Viewed', condition: s => s.events && s.events.hasOwnProperty('profilePageViewed') }, { name: '21. Payment Page Viewed', condition: s => s.events && s.events.hasOwnProperty('paymentPageViewed') }, { name: '22. Purchase Completed', condition: s => s.paymentStatus === 'succeeded' } ];
            const container = document.getElementById('funnel-results-container'), initialCount = filteredSessions.length;
            if (initialCount === 0) { container.innerHTML = '<p class="text-center text-gray-400 mt-4">No sessions found for the selected filters.</p>'; return; }
            let results = [], currentSessions = filteredSessions, previousStepCount = initialCount;
            funnelSteps.forEach(step => {
                currentSessions = currentSessions.filter(step.condition);
                const count = currentSessions.length;
                results.push({ name: step.name, count: count, convFromPrev: previousStepCount > 0 ? ((count / previousStepCount) * 100).toFixed(1) : '0.0', convFromTotal: initialCount > 0 ? ((count / initialCount) * 100).toFixed(1) : '0.0' });
                previousStepCount = count;
            });
            renderFunnelResults(results);
        }

        function renderFunnelResults(results) {
            const container = document.getElementById('funnel-results-container');
            const maxCount = results.length > 0 ? results[0].count : 0;
            if (maxCount === 0) { container.innerHTML = '<p class="text-center text-gray-400 mt-4">No sessions found for the selected filters.</p>'; return; }
            const tableRows = results.map((step, i) => `<tr class="${i > 0 && parseFloat(step.convFromPrev) < 50.0 ? 'bg-red-900 bg-opacity-40' : 'border-b border-gray-700'}"><td data-label="Step" class="py-3 px-4 text-sm text-white">${step.name}</td><td data-label="Users" class="py-3 px-4 text-sm text-white font-bold text-center">${step.count}</td><td data-label="Conv. (Step)" class="py-3 px-4 text-sm text-gray-400 text-center">${step.convFromPrev}%</td><td data-label="Conv. (Total)" class="py-3 px-4 text-sm text-gray-400 text-center">${step.convFromTotal}%</td><td data-label="Visualization" class="py-3 px-4 w-1/3"><div class="w-full bg-gray-700 rounded-full h-6"><div class="funnel-bar h-6 rounded-full flex items-center justify-center text-xs font-bold text-white px-2" style="width: ${maxCount > 0 ? (step.count / maxCount * 100) > 5 ? (step.count / maxCount * 100) : 5 : 5}%">${step.convFromTotal}%</div></div></td></tr>`).join('');
            container.innerHTML = `<div class="overflow-x-auto rounded-lg border border-gray-700 mt-6"><table class="min-w-full funnel-table"><thead><tr><th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Step</th><th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase">Users</th><th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase">Conv. (Step)</th><th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase">Conv. (Total)</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Visualization</th></tr></thead><tbody class="bg-gray-800">${tableRows}</tbody></table></div>`;
        }
    });
    </script>
</body>
</html>

