<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AI WellnessCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        :root {
            --bg-dark: #111827;
            --bg-light: #1F2937; --border-color: #374151;
            --text-main: #F9FAFB; --text-secondary: #9CA3AF; --accent-purple: #8b5cf6;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; }
        .table-custom th, .funnel-table th { background-color: var(--bg-light); }
        .table-custom tr.main-row:hover { background-color: #374151; }
        .form-input { background-color: var(--bg-light); border: 1px solid var(--border-color); }
        .stat-card { background-color: var(--bg-light); border: 1px solid var(--border-color); }
        .tab-button { transition: all 0.2s; }
        .tab-button.active { color: var(--accent-purple); border-color: var(--accent-purple); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .bar-chart-bar { background-color: var(--accent-purple); transition: width 0.5s ease-out; }
        .funnel-bar {
            background: linear-gradient(90deg, var(--accent-purple) 0%, #6366f1 100%);
            transition: width 0.5s ease-in-out;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media (max-width: 1024px) {
            .table-custom thead,
            .funnel-table thead {
                display: none;
            }

            .table-custom tr,
            .funnel-table tr {
                display: block;
                margin-bottom: 1rem; /* Уменьшаем отступ между карточками */
                border: 1px solid var(--border-color);
                border-radius: 0.5rem;
                overflow: hidden;
                background-color: var(--bg-light);
            }

            .table-custom td,
            .funnel-table td {
                display: grid;
                /* Новая сетка: заголовок 110px, значение - остальное */
                grid-template-columns: 110px 1fr; 
                gap: 0.5rem; /* Уменьшаем отступ между заголовком и значением */
                text-align: left;
                padding: 0.5rem 0.75rem; /* Уменьшаем вертикальные отступы */
                border-bottom: 1px solid var(--border-color);
            }
            
            .table-custom tr td:last-child,
            .funnel-table tr td:last-child {
                border-bottom: none;
            }

            .table-custom td::before,
            .funnel-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-secondary);
                text-align: left;
                padding-right: 0.5rem; /* Добавляем небольшой отступ справа от заголовка */
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Admin Panel Access</h2>
            <form id="login-form">
                <input type="password" id="password-input" placeholder="Enter Access Password" class="w-full form-input rounded-md p-3 text-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md mt-4 transition-colors">Login</button>
                <p id="login-error" class="text-red-400 text-center mt-4 text-sm"></p>
            </form>
        </div>
    </div>

    <main id="admin-panel" class="hidden p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                <h1 class="text-3xl font-bold text-white text-center sm:text-left">AI WellnessCore Dashboard</h1>
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div class="flex-grow flex items-center gap-2 w-full">
                        <label for="start-date-stats" class="text-sm font-medium text-gray-400 flex-shrink-0">From:</label>
                        <input type="date" id="start-date-stats" class="form-input w-full">
                    </div>
                    <div class="flex-grow flex items-center gap-2 w-full">
                        <label for="end-date-stats" class="text-sm font-medium text-gray-400 flex-shrink-0">To:</label>
                        <input type="date" id="end-date-stats" class="form-input w-full">
                    </div>
                    <button id="refresh-data-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 w-full sm:w-auto justify-center">
                        <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                        <span class="sm:inline">Refresh</span>
                    </button>
                </div>
            </div>
            
            <div class="border-b border-gray-700 mt-6">
                <nav class="-mb-px flex flex-wrap space-x-4 sm:space-x-8" aria-label="Tabs">
                    <button id="tab-stats" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Statistics</button>
                    <button id="tab-sessions" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500">Sessions</button>
                    <button id="tab-messages" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500">Messages</button>
                    <button id="tab-funnel" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-200 hover:border-gray-500">Funnel Analysis</button>
                </nav>
            </div>

            <div id="content-stats" class="tab-content active mt-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-6">
                        <div class="stat-card p-6 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">Total Revenue</p>
                            <p id="stat-total-revenue" class="text-3xl font-bold mt-1">$0.00</p>
                        </div>
                        <div class="stat-card p-6 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">Average Check</p>
                            <p id="stat-avg-check" class="text-3xl font-bold mt-1">$0.00</p>
                        </div>
                        <div class="stat-card p-6 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">Conversion Rate</p>
                            <p id="stat-conversion" class="text-3xl font-bold mt-1">0%</p>
                        </div>
                    </div>
                    <div class="md:col-span-2 space-y-6">
                        <div class="stat-card p-6 rounded-lg">
                            <p class="text-lg font-bold text-white mb-4">Conversion Funnel</p>
                            <div class="space-y-4">
                                <div id="funnel-start"></div>
                                <div id="funnel-finish"></div>
                                <div id="funnel-paid"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="stat-card p-6 rounded-lg">
                                <p class="text-lg font-bold text-white mb-4">Top Traffic Sources</p>
                                <ul id="stat-top-sources" class="space-y-2"></ul>
                            </div>
                            <div class="stat-card p-6 rounded-lg">
                                <p class="text-lg font-bold text-white mb-4">Top Countries</p>
                                <ul id="stat-top-countries" class="space-y-2"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-sessions" class="tab-content mt-6">
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="text" id="search-input" placeholder="Search by IP, Email or Country..." class="w-full sm:w-1/3 form-input rounded-md p-2 text-white">
                    <select id="status-filter" class="w-full sm:w-auto form-input rounded-md p-2 text-white">
                        <option value="">All Payment Statuses</option>
                        <option value="succeeded">Succeeded</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div class="mt-4 overflow-x-auto rounded-lg">
                    <table class="min-w-full divide-y divide-gray-700 table-custom">
                        <thead class="bg-gray-800">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">#</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Device/Source</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">IP/Country</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User Goal</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Progress</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Duration</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Drop-off Point</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Payment</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Errors</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Link</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table-body" class="bg-gray-900"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="content-messages" class="tab-content mt-6">
                <div id="messages-container" class="space-y-4"></div>
            </div>

            <div id="content-funnel" class="tab-content mt-6">
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h2 class="text-xl font-bold text-white">Funnel Analysis</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-400">Traffic Sources</label>
                            <div id="funnel-sources-checkboxes" class="form-input w-full mt-1 h-32 overflow-y-auto p-2 space-y-1">
                                </div>
                        </div>
                        <div>
                            <label for="funnel-start-date" class="block text-sm font-medium text-gray-400">Start Date</label>
                            <input type="date" id="funnel-start-date" class="form-input w-full mt-1">
                        </div>
                        <div>
                            <label for="funnel-end-date" class="block text-sm font-medium text-gray-400">End Date</label>
                            <input type="date" id="funnel-end-date" class="form-input w-full mt-1">
                        </div>
                    </div>
                    <button id="analyze-funnel-btn" class="mt-4 w-full md:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md transition-colors">Analyze</button>
                </div>
                <div id="funnel-results-container" class="mt-6"></div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password-input');
            const loginError = document.getElementById('login-error');
            const loginModal = document.getElementById('login-modal');
            const adminPanel = document.getElementById('admin-panel');
            const refreshBtn = document.getElementById('refresh-data-btn');
            const refreshIcon = document.getElementById('refresh-icon');

            let allSessionsData = [];
            let statisticsData = {};
            let allMessagesData = [];
            let adminPassword = null;

            async function fetchAndRenderData(password) {
                if (!password) { loginError.textContent = 'Password is required.'; return; }
                loginError.textContent = '';
                refreshBtn.disabled = true;
                refreshIcon.classList.add('animate-spin');

                try {
                    const startDate = document.getElementById('start-date-stats').value;
                    const endDate = document.getElementById('end-date-stats').value;

                    const response = await fetch('/.netlify/functions/getAdminData', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: password,
                            startDate: startDate || null,
                            endDate: endDate || null
                        })
                    });
                    if (response.status === 401) throw new Error('Incorrect password.');
                    if (!response.ok) throw new Error('Could not fetch data from server.');
                    const { sessions, statistics, messages } = await response.json();
                    
                    allSessionsData = sessions;
                    statisticsData = statistics;
                    allMessagesData = messages;

                    if (!adminPassword) {
                        adminPassword = password;
                        loginModal.classList.add('hidden');
                        adminPanel.classList.remove('hidden');
                        setupUI();
                    }
                    renderAll();
                } catch (error) {
                    console.error("Fetch Error:", error.message);
                    loginError.textContent = error.message;
                    if (adminPassword) {
                        alert("Error fetching data: " + error.message);
                    }
                } finally {
                    refreshBtn.disabled = false;
                    refreshIcon.classList.remove('animate-spin');
                }
            }

            loginForm.addEventListener('submit', async (e) => { e.preventDefault(); await fetchAndRenderData(passwordInput.value); });
            refreshBtn.addEventListener('click', () => { if (adminPassword) fetchAndRenderData(adminPassword); });

            function setupUI() {
                const searchInput = document.getElementById('search-input');
                const statusFilter = document.getElementById('status-filter');
                const tabs = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                const tableBody = document.getElementById('sessions-table-body');
                const analyzeFunnelBtn = document.getElementById('analyze-funnel-btn');
                
                const startDateInput = document.getElementById('start-date-stats');
                const endDateInput = document.getElementById('end-date-stats');
                startDateInput.addEventListener('change', () => { if (adminPassword) fetchAndRenderData(adminPassword); });
                endDateInput.addEventListener('change', () => { if (adminPassword) fetchAndRenderData(adminPassword); });

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => { 
                            t.classList.remove('active', 'text-purple-400', 'border-purple-400');
                            t.classList.add('text-gray-400', 'border-transparent', 'hover:text-gray-200', 'hover:border-gray-500');
                        });
                        tab.classList.add('active', 'text-purple-400', 'border-purple-400');
                        tab.classList.remove('text-gray-400', 'border-transparent', 'hover:text-gray-200', 'hover:border-gray-500');

                        tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(tab.id.replace('tab-', 'content-')).classList.add('active');
                    });
                });

                const applyFilters = () => renderTable(allSessionsData);
                searchInput.addEventListener('input', applyFilters);
                statusFilter.addEventListener('change', applyFilters);

                tableBody.addEventListener('click', (event) => {
                    if (event.target.classList.contains('toggle-errors-btn')) {
                        const button = event.target;
                        const sessionId = button.dataset.sessionId;
                        const errorRow = document.getElementById(`errors-${sessionId}`);
                        if (errorRow) {
                            const isHidden = errorRow.classList.toggle('hidden');
                            button.textContent = isHidden ? `Show (${button.dataset.errorCount})` : 'Hide';
                        }
                    }
                    if (event.target.classList.contains('truncate-email')) {
                        const element = event.target;
                        element.textContent = element.dataset.fullEmail;
                        element.classList.remove('truncate-email', 'cursor-pointer', 'text-purple-400');
                        element.classList.add('text-gray-300');
                    }
                });
                analyzeFunnelBtn.addEventListener('click', calculateAndRenderFunnel);
            }

            function renderAll() {
                renderStats(statisticsData);
                renderTable(allSessionsData);
                renderMessages(allMessagesData);
                populateFunnelFilters();
            }

            function renderStats(stats) {
                document.getElementById('stat-total-revenue').textContent = `$${stats.totalRevenue}`;
                document.getElementById('stat-avg-check').textContent = `$${stats.avgCheck}`;
                document.getElementById('stat-conversion').textContent = `${stats.conversionRate}%`;
                const funnelStart = stats.totalSessions || 0;
                const funnelFinish = Math.round((stats.totalSessions || 0) * (parseFloat(stats.quizCompletionRate) / 100));
                const funnelPaid = stats.successfulPayments || 0;
                document.getElementById('funnel-start').innerHTML = createFunnelStep('Sessions Started', funnelStart, funnelStart, '#6366f1');
                document.getElementById('funnel-finish').innerHTML = createFunnelStep('Quiz Finished', funnelFinish, funnelStart, '#7c3aed');
                document.getElementById('funnel-paid').innerHTML = createFunnelStep('Payment Completed', funnelPaid, funnelStart, '#a855f7');
                renderTopList('stat-top-sources', stats.topTrafficSources);
                renderTopList('stat-top-countries', stats.topCountries);
            }
            
            function createFunnelStep(label, value, total, color) {
                const percent = total > 0 ? (value / total * 100).toFixed(1) : 0;
                return `<div class="flex items-center justify-between text-sm"><p class="text-gray-300">${label}</p><p class="font-bold text-white">${value}</p></div><div class="w-full bg-gray-700 rounded-full h-2.5 mt-1"><div class="bar-chart-bar h-2.5 rounded-full" style="width: ${percent}%; background-color:${color};"></div></div>`;
            }

            function renderTopList(elementId, data) {
                const ul = document.getElementById(elementId);
                ul.innerHTML = '';
                if (!data || data.length === 0) {
                    ul.innerHTML = `<li class="text-sm text-gray-500">No data available</li>`;
                    return;
                }
                data.forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center text-sm';
                    li.innerHTML = `<span class="text-gray-300">${name}</span><span class="font-semibold text-white">${count}</span>`;
                    ul.appendChild(li);
                });
            }

            function renderTable(data) {
                const tableBody = document.getElementById('sessions-table-body');
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const statusValue = document.getElementById('status-filter').value;

                let filteredData = data.filter(session => {
                    const searchMatch = session.ipAddress.toLowerCase().includes(searchTerm) || session.country.toLowerCase().includes(searchTerm) || (session.email && session.email.toLowerCase().includes(searchTerm));
                    const statusMatch = statusValue ? session.paymentStatus === statusValue : true;
                    return searchMatch && statusMatch;
                });

                if (filteredData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="13" class="text-center p-6 text-gray-400">No sessions match filters.</td></tr>`;
                    return;
                }
                
                let tableHTML = '';
                filteredData.forEach((session, index) => {
                    const paymentStatusClass = session.paymentStatus === 'succeeded' ? 'bg-green-500 text-green-100' : (session.paymentStatus === 'pending' ? 'bg-yellow-500 text-yellow-100' : 'bg-red-500 text-red-100');
                    
                    const email = session.email || 'N/A';
                    let emailDisplay;
                    if (email.length > 20 && email !== 'N/A') {
                        emailDisplay = `<span class="truncate-email cursor-pointer text-purple-400" data-full-email="${email}">${email.substring(0, 17)}...</span>`;
                    } else {
                        emailDisplay = `<span class="text-purple-400">${email}</span>`;
                    }

                    tableHTML += `
                        <tr class="main-row">
                            <td data-label="#" class="px-4 py-3 whitespace-nowrap text-sm text-gray-400 font-medium">${filteredData.length - index}</td>
                            <td data-label="Date" class="px-4 py-3 whitespace-nowrap text-sm">${new Date(session.createdAt).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short', hour12: false })}</td>
                            <td data-label="Device/Source" class="px-4 py-3 whitespace-nowrap text-sm"><div class="font-medium">${session.deviceType}</div><div class="text-gray-400">${session.trafficSource}</div></td>
                            <td data-label="IP/Country" class="px-4 py-3 whitespace-nowrap text-sm"><div class="font-medium">${session.ipAddress}</div><div class="text-gray-400">${session.country}</div></td>
                            <td data-label="Email" class="px-4 py-3 whitespace-nowrap text-sm">${emailDisplay}</td>
                            <td data-label="User" class="px-4 py-3 whitespace-nowrap text-sm"><div class="font-medium">${session.gender}</div><div class="text-gray-400">Age: ${session.age}</div></td>
                            <td data-label="User Goal" class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${session.userGoal}</td>
                            <td data-label="Progress" class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${session.progress}</td>
                            <td data-label="Duration" class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${session.duration}</td>
                            <td data-label="Drop-off Point" class="px-4 py-3 whitespace-nowrap text-sm text-yellow-400 font-mono">${session.dropOffPoint}</td>
                            <td data-label="Payment" class="px-4 py-3 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${paymentStatusClass}">${session.paymentStatus}</span><div class="text-gray-400">${session.paymentAmount}</div></td>
                            <td data-label="Errors" class="px-4 py-3 whitespace-nowrap text-sm">
                                ${session.errors && session.errors.length > 0 
                                    ? `<button data-session-id="${session.id}" data-error-count="${session.errors.length}" class="toggle-errors-btn bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600">Show (${session.errors.length})</button>`
                                    : '<span class="text-gray-600">—</span>'
                                }
                            </td>
                            <td data-label="Link" class="px-4 py-3 whitespace-nowrap text-sm text-center">${session.resultLink && session.paymentStatus === 'succeeded' ? `<a href="/${session.resultLink}" target="_blank" class="text-purple-400 hover:text-purple-300">View</a>` : '<span class="text-gray-500 text-lg">❌</span>'}</td>
                        </tr>
                    `;
                    if (session.errors && session.errors.length > 0) {
                        let errorsHTML = session.errors.map(err => `
                            <div class="border-b border-gray-700 py-2 last:border-b-0">
                                <p class="text-red-400 font-semibold">${err.message || 'Unknown Error'}</p>
                                <p class="text-gray-400 text-xs font-mono break-all">${err.details || 'No details'}</p>
                                <p class="text-gray-500 text-xs mt-1">${new Date(err.timestamp).toLocaleString()}</p>
                            </div>
                        `).join('');

                        tableHTML += `
                            <tr id="errors-${session.id}" class="hidden">
                                <td colspan="13" class="p-3 bg-gray-800" data-label="Error Details">${errorsHTML}</td>
                            </tr>
                        `;
                    }
                });
                tableBody.innerHTML = tableHTML;
            }

            function renderMessages(data) {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="text-center p-6 bg-gray-800 rounded-lg text-gray-400">No new messages.</div>`;
                    return;
                }
                data.forEach(msg => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 border border-gray-700 rounded-lg p-4';
                    card.innerHTML = `
                        <div class="flex justify-between items-center border-b border-gray-600 pb-2 mb-2">
                            <div>
                                <p class="font-semibold text-white">${msg.subject}</p>
                                <p class="text-sm text-gray-400">From: <a href="mailto:${msg.email}" class="text-purple-400 hover:underline">${msg.name}</a></p>
                            </div>
                            <span class="text-xs text-gray-500">${msg.receivedAt}</span>
                        </div>
                        <p class="text-gray-300 whitespace-pre-wrap">${msg.message}</p>
                    `;
                    container.appendChild(card);
                });
            }

            function populateFunnelFilters() {
                const sources = [...new Set(allSessionsData.map(s => s.trafficSource))].sort();
                const container = document.getElementById('funnel-sources-checkboxes');
                container.innerHTML = '';
                sources.forEach(source => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 text-sm text-gray-300 hover:bg-gray-700 p-1 rounded cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" value="${source}" class="funnel-source-checkbox h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-600 focus:ring-purple-500">
                        <span>${source}</span>
                    `;
                    container.appendChild(label);
                });
            }

            function calculateAndRenderFunnel() {
                const checkedCheckboxes = document.querySelectorAll('.funnel-source-checkbox:checked');
                const selectedSources = [...checkedCheckboxes].map(cb => cb.value);
                const startDateInput = document.getElementById('funnel-start-date').value;
                const endDateInput = document.getElementById('funnel-end-date').value;
                const filteredSessions = allSessionsData.filter(session => {
                    const sessionDate = new Date(session.createdAt);
                    const sourceMatch = selectedSources.length === 0 || selectedSources.includes(session.trafficSource);
                    const startDateMatch = !startDateInput || sessionDate >= new Date(startDateInput);
                    const endDateMatch = !endDateInput || sessionDate <= new Date(endDateInput + 'T23:59:59');
                    return sourceMatch && startDateMatch && endDateMatch;
                });

                const funnelSteps = [
                    { name: '1. Session Started', condition: s => true },
                    { name: '2. Goal', condition: s => s.answers && s.answers.hasOwnProperty('userGoal') },
                    { name: '3. Age', condition: s => s.answers && s.answers.hasOwnProperty('age') },
                    { name: '4. Sex (Gender)', condition: s => s.answers && s.answers.hasOwnProperty('gender') },
                    { name: '5. Height', condition: s => s.answers && s.answers.hasOwnProperty('height') },
                    { name: '6. Weight', condition: s => s.answers && s.answers.hasOwnProperty('weight') },
                    { name: '7. Sleep', condition: s => s.answers && s.answers.hasOwnProperty('sleep') },
                    { name: '8. Activity', condition: s => s.answers && s.answers.hasOwnProperty('activity') },
                    { name: '9. Nutrition', condition: s => s.answers && s.answers.hasOwnProperty('nutrition') },
                    { name: '10. Processed Food', condition: s => s.answers && s.answers.hasOwnProperty('processed_food') },
                    { name: '11. Hydration', condition: s => s.answers && s.answers.hasOwnProperty('hydration') },
                    { name: '12. Mindfulness', condition: s => s.answers && s.answers.hasOwnProperty('mindfulness') },
                    { name: '13. Mood', condition: s => s.answers && s.answers.hasOwnProperty('mood') },
                    { name: '14. Alcohol', condition: s => s.answers && s.answers.hasOwnProperty('alcohol') },
                    { name: '15. Smoking', condition: s => s.answers && s.answers.hasOwnProperty('smoking') },
                    { name: '16. Screen Time', condition: s => s.answers && s.answers.hasOwnProperty('screen_time') },
                    { name: '17. Photo (Selfie)', condition: s => s.answers && s.answers.hasOwnProperty('selfie') },
                    { name: '18. Email', condition: s => s.answers && s.answers.hasOwnProperty('email') },
                    { name: '19. Profile Page Viewed', condition: s => s.events && s.events.hasOwnProperty('profilePageViewed') },
                    { name: '20. Payment Page Viewed', condition: s => s.events && s.events.hasOwnProperty('paymentPageViewed') },
                    { name: '21. Purchase Completed', condition: s => s.paymentStatus === 'succeeded' }
                ];

                let results = [];
                const initialCount = filteredSessions.length;

                if (initialCount === 0) {
                     document.getElementById('funnel-results-container').innerHTML = '<p class="text-center text-gray-400 mt-4">No sessions found for the selected filters.</p>';
                     return;
                }
                
                let previousStepCount = initialCount;
                funnelSteps.forEach(step => {
                    const stepSessions = filteredSessions.filter(step.condition);
                    const count = stepSessions.length;
                    
                    results.push({
                        name: step.name,
                        count: count,
                        convFromPrev: previousStepCount > 0 ? ((count / previousStepCount) * 100).toFixed(1) : '0.0',
                        convFromTotal: initialCount > 0 ? ((count / initialCount) * 100).toFixed(1) : '0.0'
                    });
                    
                    previousStepCount = count;
                });
                renderFunnelResults(results);
            }

            function renderFunnelResults(results) {
                const container = document.getElementById('funnel-results-container');
                const maxCount = results.length > 0 ? results[0].count : 0;
                
                if (maxCount === 0) {
                     container.innerHTML = '<p class="text-center text-gray-400 mt-4">No sessions found for the selected filters.</p>';
                     return;
                }

                const tableRows = results.map((step, index) => {
                    const dropOffThreshold = 50.0;
                    let rowClass = 'border-b border-gray-700';

                    if (index > 0 && parseFloat(step.convFromPrev) < dropOffThreshold) {
                        rowClass += ' bg-red-900 bg-opacity-40'; 
                    }

                    const barWidth = maxCount > 0 ? (step.count / maxCount * 100) : 0;

                    return `
                        <tr class="${rowClass}">
                            <td data-label="Step" class="py-3 px-4 text-sm text-white">${step.name}</td>
                            <td data-label="Users" class="py-3 px-4 text-sm text-white font-bold text-center">${step.count}</td>
                            <td data-label="Conv. (Step)" class="py-3 px-4 text-sm text-gray-400 text-center">${step.convFromPrev}%</td>
                            <td data-label="Conv. (Total)" class="py-3 px-4 text-sm text-gray-400 text-center">${step.convFromTotal}%</td>
                            <td data-label="Visualization" class="py-3 px-4 w-1/3">
                                <div class="w-full bg-gray-700 rounded-full h-6">
                                    <div class="funnel-bar h-6 rounded-full flex items-center justify-center text-xs font-bold text-white px-2" style="width: ${barWidth > 5 ? barWidth : 5}%">
                                       ${step.convFromTotal}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="overflow-x-auto rounded-lg border border-gray-700 mt-6">
                        <table class="min-w-full funnel-table">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Step</th>
                                    <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase">Users</th>
                                    <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase">Conv. (Step)</th>
                                    <th class="py-3 px-4 text-center text-xs font-medium text-gray-300 uppercase">Conv. (Total)</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-300 uppercase">Visualization</th>
                                </tr>
                            </thead>
                            <tbody class="bg-gray-800">${tableRows}</tbody>
                        </table>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
