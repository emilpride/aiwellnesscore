<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body, html {
            overscroll-behavior-y: contain;
            font-family: 'Inter', sans-serif;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .full-screen-container {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            position: relative;
        }
        #swiper-container {
            transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swiper-wrapper {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swiper-slide {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .swiper-slide.active {
            opacity: 1;
            transform: scale(1);
        }
        .dot {
            transition: background-color 0.3s, transform 0.3s;
        }
        .dot.active {
            background-color: #8b5cf6;
            transform: scale(1.25);
        }
        .slide-content > * {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        #chat-section {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: translateY(100%);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; background-color: #f9fafb;
        }
        #chat-section.active { transform: translateY(0); }
        #chat-header { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); background-color: white; }
        .chat-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }
        .chat-bubble { animation: popIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) both; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); }
        #camera-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden; border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); }
        #camera-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #camera-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1.5rem; text-align: center; }
        #camera-status { background-color: rgba(0,0,0,0.5); padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s; }
        .slider-widget { padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; width: 100%; max-width: 300px; margin: auto; }
        .slider-value { font-size: 2.5rem; font-weight: 800; line-height: 1; transition: color 0.3s ease; }
        .slider-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; color: #6b21a8; }
        .slider-input { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d1d5db; border-radius: 5px; outline: none; transition: opacity .2s; }
        .slider-input-gradient { background: linear-gradient(to right, #22c55e, #facc15, #ef4444); }
        .slider-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: white; cursor: pointer; border-radius: 50%; border: 4px solid #8b5cf6; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .slider-markers { display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af; margin: 0.25rem 0.25rem 0; }
        .confirm-btn { margin-top: 1rem; width: 100%; background-color: #7c3aed; color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.75rem; transition: background-color 0.2s; }
        .widget-wrapper, .bmi-widget, .analysis-container { padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; max-width: 250px; margin: auto; text-align: center; }
        .sleep-battery { width: 100px; height: 40px; border: 3px solid #c4b5fd; border-radius: 8px; margin: 0 auto; position: relative; } .sleep-battery::after { content:''; position: absolute; top: 50%; right: -10px; transform: translateY(-50%); width: 5px; height: 20px; background-color: #c4b5fd; border-radius: 0 4px 4px 0; } .sleep-battery-level { position: absolute; top: 3px; left: 3px; height: 30px; border-radius: 4px; width: 0%; background-color: #ef4444; transition: width 1.5s ease-out, background-color 1s ease; }
        .activity-week { display:flex; justify-content:center; gap: 0.5rem; } .activity-day { width: 30px; height: 30px; border-radius: 0.5rem; background-color: #ede9fe; color: #a78bfa; font-weight: 600; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition: all 0.4s ease-out; } .activity-day.active { background-color: #8b5cf6; color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4); }
        #hydration-water-fill { transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); } #hydration-percentage { transition: opacity 0.5s; opacity: 0; }
        .stress-bar-track { height: 12px; background-color: #ede9fe; border-radius: 9999px; overflow: hidden; } .stress-bar-fill { height: 100%; width: 0%; background-image: linear-gradient(to right, #4ade80, #facc15, #f87171); border-radius: 9999px; transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); } .stress-value { font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem; transition: color 1.5s ease; }
    </style>
</head>
<body class="bg-gray-50">

<div id="app-container" class="full-screen-container bg-white">
    <!-- ONBOARDING SWIPER -->
    <div id="swiper-container" class="relative w-full h-full flex flex-col">
        <div class="flex-grow w-full h-full overflow-hidden">
            <div id="swiper-wrapper" class="swiper-wrapper flex h-full">
                <!-- Slide 1 -->
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center slide-content"><div id="dave-animation" class="w-48 h-48 mx-auto"></div><h1 class="text-3xl font-bold text-gray-800 mt-4">Hey! I'm Dave.</h1><p class="text-gray-600 mt-2">Your personal AI wellness assistant. Let's unlock your potential together.</p></div>
                </div>
                <!-- Slide 2 -->
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-left w-full max-w-sm slide-content"><h2 class="text-2xl font-bold text-gray-800 text-center mb-6">What you'll get:</h2><ul class="space-y-4"><li class="flex items-center" style="animation-delay: 0.5s;"><span class="text-2xl mr-3">üéØ</span> <div><h3 class="font-semibold">Wellness Score</h3><p class="text-sm text-gray-500">Your comprehensive health rating</p></div></li><li class="flex items-center" style="animation-delay: 0.7s;"><span class="text-2xl mr-3">‚è≥</span> <div><h3 class="font-semibold">Biological Age</h3><p class="text-sm text-gray-500">How "young" you are for your years</p></div></li><li class="flex items-center" style="animation-delay: 0.9s;"><span class="text-2xl mr-3">üåø</span> <div><h3 class="font-semibold">Skin & Stress Analysis</h3><p class="text-sm text-gray-500">Learn about hidden factors</p></div></li><li class="flex items-center" style="animation-delay: 1.1s;"><span class="text-2xl mr-3">üó∫Ô∏è</span> <div><h3 class="font-semibold">Personalized Plan</h3><p class="text-sm text-gray-500">A 7-day plan for improvement</p></div></li></ul></div>
                </div>
                <!-- Slide 3 -->
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center slide-content"><h2 class="text-2xl font-bold text-gray-800 mb-6">Lower Your Biological Age</h2><div class="flex justify-center items-center space-x-4"><div class="text-center"><p class="text-gray-500">Chronological</p><p id="chrono-age" class="text-5xl font-bold text-gray-400">35</p></div><div id="arrow-animation" class="w-20 h-20"></div><div class="text-center"><p class="text-purple-600 font-semibold">Biological</p><p id="bio-age" class="text-6xl font-extrabold text-purple-600">32</p></div></div><p class="text-gray-600 mt-6 max-w-xs mx-auto">Our plan is designed to help you feel younger and more energetic.</p></div>
                </div>
                <!-- Slide 4 -->
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center max-w-sm slide-content"><h2 class="text-2xl font-bold text-gray-800 mb-8">Your Privacy is Our Priority</h2><div class="space-y-6"><div class="flex items-center text-left" style="animation-delay: 0.5s;"><span class="text-3xl mr-4">üì∏</span><p class="text-gray-600">Your photo is **never stored** and is deleted immediately after analysis.</p></div><div class="flex items-center text-left" style="animation-delay: 0.7s;"><span class="text-3xl mr-4">üîí</span><p class="text-gray-600">All your data is anonymized and protected by encryption.</p></div><div class="flex items-center text-left" style="animation-delay: 0.9s;"><span class="text-3xl mr-4">‚öïÔ∏è</span><p class="text-gray-600">This is not medical advice. All recommendations are for informational purposes only.</p></div></div></div>
                </div>
            </div>
        </div>
        <div class="py-8 px-6">
            <div id="dots-container" class="flex justify-center items-center space-x-3 mb-6"></div>
            <button id="start-quiz-btn" class="w-full bg-purple-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-lg shadow-purple-200">Let's start</button>
        </div>
    </div>

    <!-- CHAT INTERFACE -->
    <div id="chat-section">
        <div id="chat-header" class="p-4 border-b border-gray-100 flex items-center gap-3 flex-shrink-0">
            <div id="dave-chat-avatar" class="w-12 h-12"></div>
            <div><h3 class="font-bold text-lg text-gray-800">Dave</h3><p id="dave-status" class="text-sm text-green-500 font-semibold transition-all duration-300">Online</p></div>
        </div>
        <div class="w-full bg-gray-200"><div id="progress-bar" class="h-1 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; transition: width 0.5s ease-in-out;"></div></div>
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto"></div>
        <div id="options-container-wrapper" class="px-4 pt-1 pb-2"><div id="options-container" class="flex gap-2 overflow-x-auto py-2"></div></div>
        <div id="input-area" class="p-4 border-t border-gray-200 hidden"><div class="flex items-center gap-2"><input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500"><button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg></button></div></div>
        <div id="payment-form-container"></div>
    </div>
</div>

<!-- CAMERA MODAL -->
<div id="camera-modal"><div id="camera-container"><video id="camera-video" autoplay muted playsinline></video><canvas id="camera-canvas"></canvas><div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4"><svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p></div><div id="camera-overlay"><p id="camera-status">Position your face in the frame</p></div></div></div>

<script>
    // --- SETUP & ONBOARDING ---
    const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    window.addEventListener('resize', setVh); setVh();
    lottie.loadAnimation({ container: document.getElementById('dave-animation'), renderer: 'svg', loop: true, autoplay: true, path: 'assistent.json' });
    lottie.loadAnimation({ container: document.getElementById('arrow-animation'), renderer: 'svg', loop: true, autoplay: true, path: 'https://assets2.lottiefiles.com/packages/lf20_l5qvxiqp.json' });

    const swiperWrapper = document.getElementById('swiper-wrapper'); const slides = document.querySelectorAll('.swiper-slide'); const dotsContainer = document.getElementById('dots-container'); const startQuizBtn = document.getElementById('start-quiz-btn'); let currentSlide = 0, autoSwipeTimer, touchStartX = 0, touchEndX = 0; function goToSlide(slideIndex, isAuto = false) { if (!isAuto) resetAutoSwipe(); currentSlide = slideIndex; swiperWrapper.style.transform = `translateX(-${currentSlide * 100}%)`; slides.forEach((s, i) => s.classList.toggle('active', i === currentSlide)); document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide)); if (slideIndex === 2) { animateNumbers(); } }
    const nextSlide = () => goToSlide((currentSlide + 1) % slides.length, true); const resetAutoSwipe = () => { clearInterval(autoSwipeTimer); autoSwipeTimer = setInterval(nextSlide, 3500); }; slides.forEach((_, i) => { const dot = document.createElement('div'); dot.className = 'dot w-2 h-2 bg-gray-300 rounded-full cursor-pointer'; dot.onclick = () => goToSlide(i); dotsContainer.appendChild(dot); }); const handleSwipe = () => { if (touchEndX < touchStartX - 50) nextSlide(); if (touchEndX > touchStartX + 50) goToSlide((currentSlide - 1 + slides.length) % slides.length); }; swiperWrapper.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; clearInterval(autoSwipeTimer); }, { passive: true }); swiperWrapper.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); resetAutoSwipe(); });
    function animateNumbers() { const chronoAgeEl = document.getElementById('chrono-age'); const bioAgeEl = document.getElementById('bio-age'); let start = 18, endChrono = 35, endBio = 32; chronoAgeEl.innerText = start; bioAgeEl.innerText = start; const interval = setInterval(() => { start++; if (start <= endChrono) chronoAgeEl.innerText = start; if (start <= endBio) bioAgeEl.innerText = start; if (start > endChrono) clearInterval(interval); }, 50); }
    startQuizBtn.addEventListener('click', () => { clearInterval(autoSwipeTimer); const swiperContainer = document.getElementById('swiper-container'); const chatSection = document.getElementById('chat-section'); swiperContainer.style.opacity = '0'; swiperContainer.style.transform = 'scale(0.9)'; setTimeout(() => { swiperContainer.style.display = 'none'; chatSection.classList.add('active'); lottie.loadAnimation({ container: document.getElementById('dave-chat-avatar'), renderer: 'svg', loop: true, autoplay: true, path: 'avatar.json' }); initQuiz(); }, 600); });
    goToSlide(0);

    // --- FULL QUIZ LOGIC ---
    const chatContainer = document.getElementById('chat-container'), optionsContainer = document.getElementById('options-container'), optionsContainerWrapper = document.getElementById('options-container-wrapper'), inputArea = document.getElementById('input-area'), progressBar = document.getElementById('progress-bar'), cameraModal = document.getElementById('camera-modal'), video = document.getElementById('camera-video'), canvas = document.getElementById('camera-canvas'), cameraLoader = document.getElementById('camera-loader'), loaderText = document.getElementById('loader-text'), cameraStatus = document.getElementById('camera-status'), paymentFormContainer = document.getElementById('payment-form-container'), daveStatusEl = document.getElementById('dave-status');
    let userInput = document.getElementById('user-input'), sendBtn = document.getElementById('send-btn');
    let sessionId = null, userAnswers = {}, currentQuestionIndex = 0, stream, capturedPhotoDataUrl = null, countdownInterval;

    async function logErrorToServer(errorDetails) { if (!sessionId) { console.error("Cannot log error: no sessionId.", errorDetails); return; } try { await fetch('/.netlify/functions/quiz', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'logError', sessionId: sessionId, error: { source: 'frontend', message: errorDetails.message, details: errorDetails.details || 'N/A' } }) }); } catch (e) { console.error("Failed to even send the error log:", e); } }
    function initializeGlobalErrorHandlers() { window.onerror = function(message, source, lineno, colno, error) { logErrorToServer({ message: `Uncaught Error: ${message}`, details: `at ${source}:${lineno}:${colno}` }); return false; }; window.addEventListener('unhandledrejection', event => { logErrorToServer({ message: 'Unhandled Promise Rejection', details: event.reason?.message || 'No details available' }); }); }
    
    const setDaveStatus = (status) => { daveStatusEl.style.opacity = '0'; setTimeout(() => { if (status === 'typing...') { daveStatusEl.classList.remove('text-green-500'); daveStatusEl.classList.add('text-yellow-500'); } else { daveStatusEl.classList.remove('text-yellow-500'); daveStatusEl.classList.add('text-green-500'); } daveStatusEl.textContent = status; daveStatusEl.style.opacity = '1'; }, 200); };
    
    const quizQuestions = [ { key: 'name', type: 'question', text: "Alright, let's get started. First, what should I call you?", placeholder: "Type your name..." }, { key: 'intro_purpose', type: 'message', text: (name) => `Perfect, ${name}. I'm now calibrating my analysis just for you...`, delayBefore: 1500 }, { key: 'age', type: 'slider', text: (name) => `To start, what's your age? üéÇ`, label: "Select your age", min: 18, max: 90, step: 1, defaultValue: 30, unit: 'years' }, { key: 'gender', type: 'question', text: "Got it. What's your biological sex? üß¨", options: ['Male', 'Female', 'Other'], hideInput: true }, { key: 'height', type: 'slider', text: "Perfect. And your height? üìè", label: "Select your height", min: 140, max: 220, step: 1, defaultValue: 175, unit: 'cm' }, { key: 'weight', type: 'slider', text: "Thanks! And your current weight? ‚öñÔ∏è", label: "Select your weight", min: 40, max: 150, step: 1, defaultValue: 70, unit: 'kg' }, { key: 'bmi_calculation', type: 'message', text: "Calculating your BMI based on your stats...", postAnimationDelay: 2000 }, { key: 'sleep', type: 'question', text: "Sleep is crucial. üò¥ How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], hideInput: true }, { key: 'sleep_visual', type: 'message', text: 'Quality sleep recharges your mind and body.' }, { key: 'activity', type: 'question', text: "Movement is key! üèÉ‚Äç‚ôÄÔ∏è How often do you engage in moderate physical activity per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], hideInput: true }, { key: 'activity_visual', type: 'message', text: 'Every bit of movement counts!' }, { key: 'nutrition', type: 'question', text: "Let's talk nutrition. ü•¶ How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], hideInput: true }, { key: 'hydration', type: 'question', text: "Hydration check! üíß How many glasses of water do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], hideInput: true }, { key: 'hydration_visual', type: 'message', text: "Let's see your hydration level:" }, { key: 'stress', type: 'slider', text: "Now for the mind. üß† How would you rate your typical stress level?", label: "Drag to indicate your stress level", min: 1, max: 10, step: 1, defaultValue: 5, unit: 'stress', isGradient: true }, { key: 'mood', type: 'question', text: "Let's check in. How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "It varies a lot", "Often Stressed or Sad"], hideInput: true }, { key: 'camera', type: 'final_step', text: "You did it! üéâ That's all the questions. The final step is a quick selfie. This helps my AI analyze non-medical indicators of stress and fatigue. Your photo is processed on the fly and never stored." }];

    async function initQuiz() { await startQuizSession(); if (sessionId) askNextQuestion(); }
    async function startQuizSession() { try { const res = await fetch('/.netlify/functions/quiz', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'startSession'})}); if (!res.ok) throw new Error('Server error'); const data = await res.json(); sessionId = data.sessionId; initializeGlobalErrorHandlers(); } catch (e) { addBotMessage("Sorry, couldn't connect to the server. Please refresh."); } }
    async function saveAnswerToServer(key, value) { userAnswers[key] = value; if (!sessionId) return; try { await fetch('/.netlify/functions/quiz', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'saveAnswer', sessionId, questionId: key, answer: value})}); } catch(e){ console.error(e); } }
    
    function askNextQuestion() {
        if (currentQuestionIndex >= quizQuestions.length) { showCompletionAnimation(); return; }
        const question = quizQuestions[currentQuestionIndex];
        setDaveStatus('typing...');
        setTimeout(() => {
            setDaveStatus('Online');
            let text = typeof question.text === 'function' ? question.text(userAnswers.name) : question.text;
            addBotMessage(text);
            
            let postAnimationDelay = question.postAnimationDelay || 0;
            if (question.type === 'message') {
                if (question.key === 'bmi_calculation') playBmiAnimation();
                else if (question.key === 'sleep_visual') playSleepAnimation();
                else if (question.key === 'activity_visual') playActivityAnimation();
                else if (question.key === 'hydration_visual') playHydrationAnimation();
                currentQuestionIndex++;
                setTimeout(askNextQuestion, postAnimationDelay || question.delayBefore || 1500);
            } else if (question.type === 'question') {
                showOptions(question.options.map(opt => ({ text: opt, class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50' })), question.options.map(opt => () => handleAnswer(opt)));
                if(!question.hideInput) { inputArea.classList.remove('hidden'); userInput.placeholder = question.placeholder; userInput.focus(); }
            } else if (question.type === 'slider') {
                showSlider(question);
            } else if (question.type === 'final_step') {
                showCameraStep();
            }
            updateProgressBar();
        }, 1200 + Math.random() * 500);
    }
    
    function showOptions(options, handlers) { optionsContainer.innerHTML = ''; if (options?.length > 0) { optionsContainerWrapper.classList.remove('hidden'); options.forEach((option, index) => { const button = document.createElement('button'); button.textContent = option.text; button.className = option.class; button.onclick = handlers[index]; optionsContainer.appendChild(button); }); } else { optionsContainerWrapper.classList.add('hidden'); } }
    
    function showSlider(question) {
        optionsContainer.innerHTML = ''; optionsContainerWrapper.classList.remove('hidden');
        const sliderWrapper = document.createElement('div'); sliderWrapper.className = 'slider-widget';
        const formatDisplayValue = (value) => { if (question.unit === 'stress') { if (value <= 3) return `<span style="color: #22c55e;">Low</span>`; if (value <= 7) return `<span style="color: #f59e0b;">Medium</span>`; return `<span style="color: #ef4444;">High</span>`; } if (question.unit === 'cm') { const feet = Math.floor(value / 30.48); const inches = Math.round((value % 30.48) / 2.54); return `${feet}'${inches}" <span class="text-lg ml-2 text-purple-400">(${value} cm)</span>`; } if (question.unit === 'kg') { const lbs = (value * 2.20462).toFixed(0); return `${lbs} lbs <span class="text-lg ml-2 text-purple-400">(${value} kg)</span>`; } return `${value} ${question.unit}`; };
        const sliderInputClass = question.isGradient ? 'slider-input slider-input-gradient' : 'slider-input'; const markersHTML = question.isGradient ? `<div class="slider-markers"><span>Low</span><span>Medium</span><span>High</span></div>` : '';
        sliderWrapper.innerHTML = `<div class="text-center"><div id="slider-value-display" class="slider-value">${formatDisplayValue(question.defaultValue)}</div><div class="slider-label">${question.label}</div></div><input type="range" min="${question.min}" max="${question.max}" value="${question.defaultValue}" step="${question.step}" class="${sliderInputClass}" id="slider-input-range">${markersHTML}<button id="slider-confirm-btn" class="confirm-btn">Confirm</button>`;
        optionsContainer.appendChild(sliderWrapper);
        const sliderInput = document.getElementById('slider-input-range'), valueDisplay = document.getElementById('slider-value-display'), confirmBtn = document.getElementById('slider-confirm-btn');
        sliderInput.addEventListener('input', (e) => { valueDisplay.innerHTML = formatDisplayValue(e.target.value); });
        confirmBtn.onclick = () => {
            const finalValue = sliderInput.value; let displayAnswerText = '';
            if (question.unit === 'stress') { if (finalValue <= 3) displayAnswerText = 'Low'; else if (finalValue <= 7) displayAnswerText = 'Medium'; else displayAnswerText = 'High'; } else if (question.unit === 'cm') { const feet = Math.floor(finalValue / 30.48); const inches = Math.round((finalValue % 30.48) / 2.54); displayAnswerText = `${feet}'${inches}"`; } else if (question.unit === 'kg') { const lbs = (finalValue * 2.20462).toFixed(0); displayAnswerText = `${lbs} lbs`; } else { displayAnswerText = `${finalValue} ${question.unit}`; }
            handleAnswer(finalValue, displayAnswerText);
        };
    }
    
    function handleAnswer(answerToStore, answerToDisplay) { const q = quizQuestions[currentQuestionIndex]; addUserMessage(answerToDisplay || answerToStore); saveAnswerToServer(q.key, answerToStore); userInput.value = ''; inputArea.classList.add('hidden'); optionsContainerWrapper.classList.add('hidden'); currentQuestionIndex++; askNextQuestion(); }
    function addUserMessage(text) { const d = document.createElement('div'); d.className = 'flex justify-end mb-4 chat-bubble'; d.innerHTML = `<div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">${text}</div>`; chatContainer.appendChild(d); chatContainer.scrollTop = chatContainer.scrollHeight; }
    function addBotMessage(html) { const d = document.createElement('div'); d.className = 'flex justify-start mb-4 chat-bubble'; d.innerHTML = `<div class="bg-gray-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">${html}</div>`; chatContainer.appendChild(d); chatContainer.scrollTop = chatContainer.scrollHeight; }
    function updateProgressBar() { progressBar.style.width = `${(currentQuestionIndex / quizQuestions.length) * 100}%`; }
    sendBtn.addEventListener('click', () => handleAnswer(userInput.value, userInput.value)); userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAnswer(userInput.value, userInput.value); });

    function parseHeightToInches(heightVal) { if (!heightVal) return 68; if (!isNaN(parseFloat(heightVal))) { return parseFloat(heightVal) / 2.54; } let inches = 0; const feetMatch = heightVal.match(/(\d+)\s*(ft|')/); const inchesMatch = heightVal.match(/(\d+)\s*(in|")/); if (feetMatch) inches += parseInt(feetMatch[1]) * 12; if (inchesMatch) inches += parseInt(inchesMatch[1]); return inches > 0 ? inches : 68; }
    function playBmiAnimation() { const heightIn = parseHeightToInches(userAnswers.height); const weightLbs = (parseInt(userAnswers.weight) || 70) * 2.20462; if (heightIn && weightLbs) { const bmi = ((weightLbs / (heightIn * heightIn)) * 703).toFixed(1); let category = "Normal"; if (bmi < 18.5) category = "Underweight"; else if (bmi >= 25 && bmi <30) category = "Overweight"; else if (bmi >= 30) category = "Obese"; const html = `<div class="bmi-widget"><div class="text-3xl font-bold">${bmi}</div><div>${category}</div></div>`; addBotMessage(html); } }
    function playSleepAnimation() { const answer = userAnswers.sleep || ""; let level = 25; if (answer.includes("5-6")) level = 50; if (answer.includes("7-8")) level = 90; if (answer.includes("More than 8")) level = 100; const html = `<div class="widget-wrapper"><div class="widget-label">Sleep Recharge</div><div class="sleep-battery mt-2"><div id="sleep-battery-level-anim" class="sleep-battery-level"></div></div></div>`; addBotMessage(html); setTimeout(() => { const levelEl = document.getElementById('sleep-battery-level-anim'); if (!levelEl) return; let color = '#ef4444'; if (level > 40) color = '#f59e0b'; if (level > 75) color = '#22c55e'; levelEl.style.backgroundColor = color; levelEl.style.width = `${level}%`; }, 100); }
    function playActivityAnimation() { const answer = userAnswers.activity || ""; let days = 1; if (answer.includes("1-2")) days = 2; if (answer.includes("3-4")) days = 4; if (answer.includes("5+")) days = 6; const html = `<div class="widget-wrapper"><div class="widget-label">Your Active Week</div><div class="activity-week" id="activity-week-anim">${[...'MTWTFSS'].map(d=>`<div class="activity-day">${d}</div>`).join('')}</div></div>`; addBotMessage(html); setTimeout(() => { const weekEl = document.getElementById('activity-week-anim'); if (!weekEl) return; const dayElements = weekEl.children; const daysToActivate = [0, 2, 4, 1, 3, 5, 6]; for (let i = 0; i < days; i++) { setTimeout(() => { dayElements[daysToActivate[i]].classList.add('active'); }, i * 250); } }, 100); }
    function playHydrationAnimation() { const answer = userAnswers.hydration || ""; let level = 25; if (answer.includes("4-6")) level = 50; if (answer.includes("7-9")) level = 75; if (answer.includes("10+")) level = 100; const html = `<div class="widget-wrapper"><div class="widget-label">Body Hydration</div><svg class="w-20 h-24 mx-auto" viewBox="0 0 120 160"><defs><clipPath id="humanoid-clip"><path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z"></path></clipPath></defs><g clip-path="url(#humanoid-clip)"><rect x="0" y="0" width="120" height="160" fill="#ede9fe"/><rect id="hydration-water-fill" x="0" y="0" width="120" height="160" fill="#818cf8" style="transform: translateY(160px);"/></g><path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z" fill="none" stroke="#a78bfa" stroke-width="6"/></svg><div id="hydration-percentage" class="font-bold text-xl text-indigo-600 mt-2">0%</div></div>`; addBotMessage(html); setTimeout(() => { const waterEl = document.getElementById('hydration-water-fill'); const textEl = document.getElementById('hydration-percentage'); if (!waterEl || !textEl) return; const yPos = 160 - (160 * (level / 100)); waterEl.style.transform = `translateY(${yPos}px)`; textEl.style.opacity = '1'; let currentLevel = 0; const levelUp = setInterval(() => { currentLevel++; textEl.textContent = `${currentLevel}%`; if (currentLevel >= level) clearInterval(levelUp); }, 1500 / level); }, 100); }
    
    // --- Camera, Payment and Completion logic ---
    function showCameraStep() { optionsContainerWrapper.classList.add('hidden'); inputArea.classList.remove('hidden'); inputArea.innerHTML = `<button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors">Open Camera</button>`; document.getElementById('open-camera-btn').onclick = startCamera; }
    async function startCamera() { /* ... Full camera logic ... */ }
    function showCompletionAnimation() { addBotMessage("Amazing! That's everything I need. Give me a moment while I analyze your results..."); /* ... Full completion logic ... */ }

</script>

</body>
</html>

