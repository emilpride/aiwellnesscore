<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body, html {
            overscroll-behavior-y: contain; [cite: 380]
            font-family: 'Inter', sans-serif; [cite: 381]
            height: 100%; [cite: 381]
            margin: 0; [cite: 381]
            overflow: hidden; [cite: 381]
        }
        .full-screen-container {
            height: 100vh; [cite: 382]
            height: calc(var(--vh, 1vh) * 100); [cite: 382]
            overflow: hidden; [cite: 382]
            position: relative; [cite: 382]
        }
        #swiper-container {
            transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); [cite: 383]
        }
        .swiper-wrapper {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); [cite: 384]
        }
        .swiper-slide {
            flex-shrink: 0; [cite: 385]
            width: 100%; [cite: 385]
            height: 100%; [cite: 386]
            opacity: 0; [cite: 386]
            transform: scale(0.95); [cite: 386]
            transition: opacity 0.6s ease-out, transform 0.6s ease-out; [cite: 386]
        }
        .swiper-slide.active {
            opacity: 1; [cite: 387]
            transform: scale(1); [cite: 387]
        }
        .dot {
            transition: background-color 0.3s, transform 0.3s; [cite: 388]
        }
        .dot.active {
            background-color: #8b5cf6; [cite: 389]
            transform: scale(1.25); [cite: 389]
        }
        .slide-content > * {
            opacity: 0; [cite: 390]
            transform: translateY(20px); [cite: 390]
            animation: fadeInUp 0.8s 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; [cite: 391]
        }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); [cite: 392] } }
        #chat-section {
            position: absolute; [cite: 393]
            top: 0; left: 0; width: 100%; height: 100%; [cite: 393]
            transform: translateY(100%); [cite: 394]
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); [cite: 394]
            display: flex; [cite: 394]
            flex-direction: column; background-color: #f9fafb; [cite: 394]
        }
        #chat-section.active { transform: translateY(0); [cite: 395] }
        #chat-header { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); [cite: 396]
            background-color: white; [cite: 396] }
        .chat-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; [cite: 397] }
        .chat-container::-webkit-scrollbar { display: none; [cite: 398] }
        .chat-bubble { animation: popIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) both; [cite: 399] }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; [cite: 400] } 100% { transform: scale(1); opacity: 1; [cite: 400] } }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; [cite: 401] }
        .option-btn:hover { transform: translateY(-2px); [cite: 402] }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; [cite: 403]
            display: inline-block; animation: bounce 1.4s infinite ease-in-out both; [cite: 403] }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; [cite: 404] }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; [cite: 405] }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); [cite: 406] } 40% { transform: scale(1.0); [cite: 406] } }
        #camera-modal { position: fixed; top: 0; [cite: 407]
            left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; [cite: 408]
            transition: opacity 0.3s ease; [cite: 408] }
        #camera-modal.active { opacity: 1; pointer-events: all; [cite: 409] }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden; [cite: 410]
            border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); [cite: 410] }
        #camera-video { width: 100%; [cite: 411]
            height: 100%; object-fit: cover; transform: scaleX(-1); [cite: 411] }
        #camera-canvas { position: absolute; top: 0; [cite: 412]
            left: 0; width: 100%; height: 100%; [cite: 412] }
        #camera-overlay { position: absolute; bottom: 0; [cite: 413]
            left: 0; right: 0; padding: 1.5rem; text-align: center; [cite: 413] }
        #camera-status { background-color: rgba(0,0,0,0.5); [cite: 414]
            padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s; [cite: 415]
        }
        #progress-bar { animation: glow 2s ease-in-out infinite alternate; [cite: 416] }
        @keyframes glow { from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7; [cite: 417] } to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1; [cite: 418] } }
        .slider-widget { padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; width: 100%; [cite: 419]
            max-width: 300px; margin: auto; [cite: 419] }
        .slider-value { font-size: 2.5rem; font-weight: 800; line-height: 1; [cite: 420]
            transition: color 0.3s ease; [cite: 420] }
        .slider-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; [cite: 421]
            color: #6b21a8; [cite: 421] }
        .slider-input { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; [cite: 422]
            background: #d1d5db; border-radius: 5px; outline: none; transition: opacity .2s; [cite: 422] }
        .slider-input-gradient { background: linear-gradient(to right, #22c55e, #facc15, #ef4444); [cite: 423] }
        .slider-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: white; [cite: 424]
            cursor: pointer; border-radius: 50%; border: 4px solid #8b5cf6; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); [cite: 425]
        }
        .slider-input::-moz-range-thumb { width: 24px; height: 24px; background: white; cursor: pointer; border-radius: 50%; [cite: 426]
            border: 4px solid #8b5cf6; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); [cite: 427]
        }
        .slider-markers { display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af; [cite: 428]
            margin: 0.25rem 0.25rem 0; [cite: 428] }
        .confirm-btn { margin-top: 1rem; width: 100%; background-color: #7c3aed; [cite: 429]
            color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.75rem; transition: background-color 0.2s; [cite: 430]
        }
        .confirm-btn:hover { background-color: #6d28d9; [cite: 431] }
        .widget-wrapper, .bmi-widget, .analysis-container { padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; max-width: 250px; [cite: 432]
            margin: auto; text-align: center; [cite: 432] }
        .widget-label { font-weight: 600; color: #6b21a8; margin-bottom: 0.75rem; [cite: 433] }
        .sleep-battery { width: 100px; height: 40px; border: 3px solid #c4b5fd; border-radius: 8px; [cite: 434]
            margin: 0 auto; position: relative; [cite: 434] }
        .sleep-battery::after { content:''; position: absolute; top: 50%; [cite: 435]
            right: -10px; transform: translateY(-50%); width: 5px; height: 20px; background-color: #c4b5fd; border-radius: 0 4px 4px 0; [cite: 436]
        }
        .sleep-battery-level { position: absolute; top: 3px; left: 3px; height: 30px; border-radius: 4px; [cite: 437]
            width: 0%; background-color: #ef4444; transition: width 1.5s ease-out, background-color 1s ease; [cite: 438]
        }
        .activity-week { display:flex; justify-content:center; gap: 0.5rem; [cite: 439] }
        .activity-day { width: 30px; height: 30px; border-radius: 0.5rem; background-color: #ede9fe; color: #a78bfa; [cite: 440]
            font-weight: 600; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition: all 0.4s ease-out; [cite: 441]
        }
        .activity-day.active { background-color: #8b5cf6; color: white; transform: scale(1.1); [cite: 442]
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4); [cite: 442] }
        #hydration-water-fill { transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); [cite: 443] }
        #hydration-percentage { transition: opacity 0.5s; opacity: 0; [cite: 444] }
        .stress-bar-track { height: 12px; background-color: #ede9fe; border-radius: 9999px; overflow: hidden; [cite: 445] }
        .stress-bar-fill { height: 100%; width: 0%; background-image: linear-gradient(to right, #4ade80, #facc15, #f87171); [cite: 446]
            border-radius: 9999px; transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); [cite: 446] }
        .stress-value { font-size: 1.5rem; [cite: 447]
            font-weight: 700; margin-top: 0.5rem; transition: color 1.5s ease; [cite: 447] }
        .bmi-value { font-size: 2.5rem; [cite: 448]
            font-weight: 800; color: #5b21b6; line-height: 1; [cite: 448] }
        .bmi-scale { position: relative; height: 10px; [cite: 449]
            background-image: linear-gradient(to right, #60a5fa, #34d399, #facc15, #f87171); border-radius: 9999px; margin: 0.5rem 0; [cite: 450]
        }
        .bmi-indicator { position: absolute; top: 50%; width: 16px; height: 16px; background-color: white; [cite: 451]
            border: 3px solid #5b21b6; border-radius: 50%; transform: translate(-50%, -50%); transition: left 1.5s cubic-bezier(0.25, 1, 0.5, 1); [cite: 452]
        }
    </style>
    <script>
        !function(f,b,e,v,n,t,s)
        [cite_start]{if(f.fbq)return;n=f.fbq=function(){n.callMethod? [cite: 453]
        n.callMethod.apply(n,arguments):n.queue.push(arguments)}; [cite: 453]
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '785592354117222');
        fbq('track', 'PageView'); [cite: 454]
    </script>
</head>
<body class="bg-gray-50">

<div id="app-container" class="full-screen-container bg-white">
    <div id="swiper-container" class="relative w-full h-full flex flex-col">
        <div class="flex-grow w-full h-full overflow-hidden">
            <div id="swiper-wrapper" class="swiper-wrapper flex h-full">
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center slide-content"> [cite: 455]
                        <div id="dave-animation" class="w-48 h-48 mx-auto"></div>
                        <h1 class="text-3xl font-bold text-gray-800 mt-4">Hey! [cite: 456] I'm Dave.</h1> [cite: 456]
                        <p class="text-gray-600 mt-2">Your personal AI wellness assistant. [cite: 457] Let's unlock your potential together.</p> [cite: 457]
                    </div>
                </div>
                </div> [cite: 458]
        </div>
        <div class="py-8 px-6">
            <div id="dots-container" class="flex justify-center items-center space-x-3 mb-6"></div>
            <button id="start-quiz-btn" class="w-full bg-purple-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-lg shadow-purple-200">Let's start</button>
        </div>
    </div>

    <div id="chat-section">
        <div id="chat-header" class="p-4 border-b border-gray-100 flex items-center gap-3 flex-shrink-0"> [cite: 459]
            <div id="dave-chat-avatar" class="w-12 h-12"></div>
            <div>
                <h3 class="font-bold text-lg text-gray-800">Dave</h3>
                <p id="dave-status" class="text-sm text-green-500 font-semibold transition-all duration-300">Online</p>
            </div>
        </div>
        <div class="w-full bg-gray-200"> [cite: 460]
            <div id="progress-bar" class="h-1 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%; [cite: 461]
            transition: width 0.5s ease-in-out;"></div> [cite: 461]
        </div>
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        <div id="options-container-wrapper" class="px-4 pt-1 pb-2 hidden">
            <div id="options-container" class="flex gap-2 overflow-x-auto py-2"></div>
        </div>
        <div id="input-area" class="p-4 border-t border-gray-200 hidden">
            <div class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500"> [cite: 462]
                <button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /> [cite: 463]
                    </svg>
                </button>
            </div>
        </div>
        <div id="payment-form-container"></div>
    </div>
</div>

<div id="camera-modal">
    <div id="camera-container">
        <video id="camera-video" autoplay muted playsinline></video>
        <canvas id="camera-canvas"></canvas> [cite: 464]
        <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
            <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> [cite: 465]
            </svg>
            <p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p>
        </div>
        <div id="camera-overlay">
            <p id="camera-status">Position your face in the frame</p>
        </div>
    </div>
</div>

<script>
    // --- VIEWPORT & INITIALIZATION ---
    const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); [cite: 88]
    window.addEventListener('resize', setVh); [cite: 89]
    setVh();

    // --- GLOBAL STATE ---
    let sessionId = null, userAnswers = {}, currentQuestionIndex = 0; [cite: 89]
    let detectionInterval, stream, capturedPhotoDataUrl = null, countdownInterval; [cite: 90]
    let stripe, elements, clientSecret; [cite: 90]
    // --- DOM ELEMENTS ---
    const chatContainer = document.getElementById('chat-container'),
        optionsContainer = document.getElementById('options-container'),
        optionsContainerWrapper = document.getElementById('options-container-wrapper'),
        inputArea = document.getElementById('input-area'),
        progressBar = document.getElementById('progress-bar'),
        cameraModal = document.getElementById('camera-modal'),
        video = document.getElementById('camera-video'),
        canvas = document.getElementById('camera-canvas'),
        cameraLoader = document.getElementById('camera-loader'),
        loaderText = document.getElementById('loader-text'), [cite: 92]
        cameraStatus = document.getElementById('camera-status'),
        paymentFormContainer = document.getElementById('payment-form-container'),
        daveStatusEl = document.getElementById('dave-status'); [cite: 92]
    let userInput = document.getElementById('user-input'),
        sendBtn = document.getElementById('send-btn'); [cite: 93]
    const originalInputAreaHTML = inputArea.innerHTML; [cite: 93]
    // --- ERROR LOGGING ---
    async function logErrorToServer(errorDetails) {
        if (!sessionId) {
            console.error("Cannot log error: no sessionId.", errorDetails); [cite: 94]
            return; [cite: 95]
        }
        try {
            await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'logError', [cite: 95]
                    sessionId: sessionId, [cite: 96]
                    error: {
                        source: 'frontend',
                        message: errorDetails.message,
                        details: errorDetails.details || 'N/A' [cite: 97]
                    }
                })
            }); [cite: 97]
        } catch (e) {
            console.error("Failed to send error log:", e); [cite: 98]
        }
    }

    function initializeGlobalErrorHandlers() {
        window.onerror = function(message, source, lineno, colno, error) {
            logErrorToServer({
                message: `Uncaught Error: ${message}`,
                details: `at ${source}:${lineno}:${colno}`
            }); [cite: 99]
            return false; [cite: 100]
        };
        window.addEventListener('unhandledrejection', event => {
            logErrorToServer({
                message: 'Unhandled Promise Rejection',
                details: event.reason?.message || 'No details available'
            });
        }); [cite: 101]
    }

    // --- EVENT MANAGER ---
    class EventManager {
        constructor() { this.handlers = new Map(); [cite: 102] }
        add(element, event, handler, key = null) {
            const handlerKey = key || `${element.id || 'element'}_${event}`; [cite: 103]
            this.remove(element, event, handlerKey);
            this.handlers.set(handlerKey, { element, event, handler });
            element.addEventListener(event, handler); [cite: 104]
        }
        remove(element, event, key = null) {
            const handlerKey = key || `${element.id || 'element'}_${event}`; [cite: 105]
            const data = this.handlers.get(handlerKey);
            if (data) {
                data.element.removeEventListener(data.event, data.handler); [cite: 105]
                this.handlers.delete(handlerKey); [cite: 106]
            }
        }
        removeAll() {
            this.handlers.forEach((data) => {
                data.element.removeEventListener(data.event, data.handler);
            }); [cite: 107]
            this.handlers.clear(); [cite: 107]
        }
    }
    const eventManager = new EventManager(); [cite: 108]
    // --- ANIMATION MANAGER ---
    class AnimationManager {
        constructor() { this.animations = new Map(); [cite: 109] }
        add(containerId, options) {
            this.remove(containerId); [cite: 110]
            const container = document.getElementById(containerId);
            if (!container) return null;
            const anim = lottie.loadAnimation({
                container: container,
                ...options
            }); [cite: 111]
            this.animations.set(containerId, anim); [cite: 111]
            return anim;
        }
        remove(containerId) {
            const anim = this.animations.get(containerId); [cite: 112]
            if (anim) {
                anim.destroy();
                this.animations.delete(containerId); [cite: 113]
            }
        }
        clear() {
            this.animations.forEach(anim => anim.destroy()); [cite: 114]
            this.animations.clear(); [cite: 114]
        }
    }
    const animationManager = new AnimationManager(); [cite: 115]
    // --- ONBOARDING SWIPER ---
    animationManager.add('dave-animation', { 
        renderer: 'svg', 
        loop: true, 
        autoplay: true, 
        path: 'assistent.json' 
    }); [cite: 116]
    const swiperWrapper = document.getElementById('swiper-wrapper');
    const slides = document.querySelectorAll('.swiper-slide');
    const dotsContainer = document.getElementById('dots-container');
    const startQuizBtn = document.getElementById('start-quiz-btn'); [cite: 117]
    let currentSlide = 0, autoSwipeTimer, touchStartX = 0, touchEndX = 0; [cite: 117]
    function goToSlide(slideIndex, isAuto = false) {
        if (!isAuto) resetAutoSwipe();
        currentSlide = slideIndex; [cite: 118]
        swiperWrapper.style.transform = `translateX(-${currentSlide * 100}%)`; [cite: 119]
        slides.forEach((s, i) => s.classList.toggle('active', i === currentSlide));
        document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide)); [cite: 120]
    }

    const nextSlide = () => goToSlide((currentSlide + 1) % slides.length, true); [cite: 121]
    const resetAutoSwipe = () => {
        clearInterval(autoSwipeTimer);
        autoSwipeTimer = setInterval(nextSlide, 3500);
    }; [cite: 122]
    slides.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.className = 'dot w-2 h-2 bg-gray-300 rounded-full cursor-pointer';
        dot.onclick = () => goToSlide(i);
        dotsContainer.appendChild(dot);
    }); [cite: 123]
    const handleSwipe = () => {
        if (touchEndX < touchStartX - 50) nextSlide(); [cite: 124]
        if (touchEndX > touchStartX + 50) goToSlide((currentSlide - 1 + slides.length) % slides.length); [cite: 124]
    }; [cite: 125]
    swiperWrapper.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        clearInterval(autoSwipeTimer);
    }, { passive: true }); [cite: 125]
    swiperWrapper.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
        resetAutoSwipe();
    }); [cite: 127]
    startQuizBtn.addEventListener('click', () => {
        clearInterval(autoSwipeTimer);
        const swiperContainer = document.getElementById('swiper-container');
        const chatSection = document.getElementById('chat-section');
        swiperContainer.style.opacity = '0';
        swiperContainer.style.transform = 'scale(0.9)';
        setTimeout(() => {
            swiperContainer.style.display = 'none';
            chatSection.classList.add('active');
            animationManager.add('dave-chat-avatar', { [cite: 128]
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'avatar.json'
            });
            initQuiz();
        }, 600); [cite: 129]
    });

    goToSlide(0);

    // --- SESSION MANAGEMENT ---
    function saveQuizState() {
        if (sessionId) {
            localStorage.setItem('quiz_session_id', sessionId); [cite: 129]
            localStorage.setItem('quiz_answers', JSON.stringify(userAnswers)); [cite: 130]
            localStorage.setItem('quiz_current_index', currentQuestionIndex);
            localStorage.setItem('quiz_timestamp', Date.now());
        }
    }

    function loadQuizState() {
        const savedSessionId = localStorage.getItem('quiz_session_id'); [cite: 131]
        const savedAnswers = localStorage.getItem('quiz_answers'); [cite: 131]
        const savedIndex = localStorage.getItem('quiz_current_index');
        const savedTimestamp = localStorage.getItem('quiz_timestamp'); [cite: 132]
        if (savedSessionId && savedTimestamp) {
            const age = Date.now() - parseInt(savedTimestamp); [cite: 132]
            if (age < 24 * 60 * 60 * 1000) {
                return {
                    sessionId: savedSessionId,
                    answers: savedAnswers ? [cite: 134]
                    JSON.parse(savedAnswers) : {}, [cite: 134]
                    currentIndex: parseInt(savedIndex) || 0 [cite: 135]
                }; [cite: 135]
            }
        }
        return null; [cite: 137]
    }

    function clearQuizState() {
        localStorage.removeItem('quiz_session_id');
        localStorage.removeItem('quiz_answers');
        localStorage.removeItem('quiz_current_index');
        localStorage.removeItem('quiz_timestamp'); [cite: 138]
    }

    // --- DAVE STATUS ---
    const setDaveStatus = (status) => {
        daveStatusEl.style.opacity = '0'; [cite: 138]
        setTimeout(() => {
            if (status === 'typing...') {
                daveStatusEl.classList.remove('text-green-500');
                daveStatusEl.classList.add('text-yellow-500');
            } else {
                daveStatusEl.classList.remove('text-yellow-500');
                daveStatusEl.classList.add('text-green-500');
            } [cite: 140]
            daveStatusEl.textContent = status;
            daveStatusEl.style.opacity = '1';
        }, 200); [cite: 141]
    };

    // --- QUIZ QUESTIONS ---
    const quizQuestions = [
        { key: 'name', type: 'question', text: "Alright, let's get started. First, what should I call you?", placeholder: "Type your name..." },
        { key: 'intro_purpose', type: 'message', text: (name) => `Perfect, ${name}. [cite: 142] I'm now calibrating my analysis just for you...`, delayBefore: 1500 }, [cite: 142]
        { key: 'age', type: 'slider', text: "To start, what's your age? üéÇ", label: "Select your age", min: 18, max: 90, step: 1, defaultValue: 30, unit: 'years' },
        { key: 'gender', type: 'question', text: "Got it. What's your biological sex? üß¨", options: ['Male', 'Female', 'Other'], hideInput: true },
        { key: 'height', type: 'slider', text: "Perfect. And your height? üìè", label: "Select your height", min: 140, max: 220, step: 1, 
            defaultValue: 175, unit: 'cm' }, [cite: 143]
        { key: 'weight', type: 'slider', text: "Thanks! And your current weight? ‚öñÔ∏è", label: "Select your weight", min: 40, max: 150, step: 1, defaultValue: 70, unit: 'kg' },
        { key: 'bmi_calculation', type: 'message', text: "Calculating your BMI based on your stats...", postAnimationDelay: 2000 },
        { key: 'sleep', type: 'question', text: "Sleep is crucial. üò¥ How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], hideInput: true }, [cite: 144]
        { key: 'sleep_visual', type: 'message', text: 'Quality sleep recharges your mind and body.' [cite: 145] },
        { key: 'activity', type: 'question', text: "Movement is key! üèÉ‚Äç‚ôÄÔ∏è How often do you engage in moderate physical activity per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], hideInput: true },
        { key: 'activity_visual', type: 'message', text: 'Every bit of movement counts!' [cite: 146] },
        { key: 'nutrition', type: 'question', text: "Let's talk nutrition. ü•¶ How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], hideInput: true },
        { key: 'processed_food', type: 'question', text: "Honesty is the best policy here. üòâ How often do you eat processed or fast food in a typical week?", options: ["Rarely", "1-2 times", "3-4 times", "Daily"], hideInput: true },
        { key: 'hydration', type: 'question', text: "Hydration check! üíß How many glasses of water do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], hideInput: true }, [cite: 147]
        { key: 'hydration_visual', type: 'message', text: "Let's see your hydration level:" },
        { key: 'stress', type: 'slider', text: "Now for the mind. üß† How would you rate your typical stress level?", label: "Drag to indicate your stress level", min: 1, max: 10, step: 1, defaultValue: 5, unit: 'stress', isGradient: true },
        { key: 'stress_gauge', type: 'message', text: "Thanks for sharing. Here's what that looks like:" }, [cite: 148]
        { key: 'mindfulness', type: 'question', text: "Finding calm is a superpower. [cite: 149] üßò‚Äç‚ôÇÔ∏è How often do you practice mindfulness, meditation, or deep breathing?", options: ["Never", "Occasionally", "Weekly", "Daily"], hideInput: true }, [cite: 149]
        { key: 'mood', type: 'question', text: "Let's check in. ‚ù§Ô∏è How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "It varies a lot", "Often Stressed or Sad"], hideInput: true },
        { key: 'alcohol', type: 'question', text: "Time for some lifestyle questions. [cite: 150] üçª How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"], hideInput: true }, [cite: 150]
        { key: 'smoking', type: 'question', text: "This is a safe space. [cite: 151] üö≠ Do you smoke or use tobacco products?", options: ["No, never", "Used to, but quit", "Occasionally", "Yes, daily"], hideInput: true }, [cite: 151]
        { key: 'screen_time', type: 'question', text: "Last question before the final step! [cite: 152] üì± How much time do you spend on screens outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"], hideInput: true }, [cite: 152]
        { key: 'camera', type: 'final_step', text: "You did it! [cite: 153] üéâ That's all the questions. The final step is a quick selfie. This helps analyze non-medical indicators. [cite: 153] Your photo is processed instantly and never stored." } [cite: 154]
    ];

    // --- SESSION START ---
    async function startQuizSession() {
        const savedState = loadQuizState();
        if (savedState) {
            sessionId = savedState.sessionId;
            userAnswers = savedState.answers;
            currentQuestionIndex = savedState.currentIndex;
            console.log('Restored session:', sessionId); [cite: 155]
            initializeGlobalErrorHandlers();
            return true;
        }

        const getDeviceType = () => {
            const userAgent = navigator.userAgent.toLowerCase();
            const width = window.innerWidth;
            let os = 'Unknown';
            if (/iphone|ipad|ipod/.test(userAgent)) os = 'iOS'; [cite: 156]
            else if (/android/.test(userAgent)) os = 'Android'; [cite: 156]
            else if (/windows phone/.test(userAgent)) os = 'Windows Phone'; [cite: 156]
            else if (/mac os x/.test(userAgent)) os = 'macOS'; [cite: 156]
            else if (/windows/.test(userAgent)) os = 'Windows'; [cite: 156]
            else if (/linux/.test(userAgent)) os = 'Linux'; [cite: 157]
            
            let device = 'Desktop';
            if (width < 768) device = 'Mobile'; [cite: 157]
            else if (width < 1024) device = 'Tablet'; [cite: 158]
            
            return `${device}/${os}`;
        }; [cite: 158]
        const getTrafficSource = () => {
            const urlParams = new URLSearchParams(window.location.search); [cite: 159]
            const utm_source = urlParams.get('utm_source'); [cite: 160]
            const utm_medium = urlParams.get('utm_medium');
            const utm_campaign = urlParams.get('utm_campaign');
            const ref = document.referrer.toLowerCase(); [cite: 160]
            if (utm_source) {
                if (utm_campaign) return `${utm_source}/${utm_campaign}`; [cite: 161]
                if (utm_medium) return `${utm_source}/${utm_medium}`; [cite: 162]
                return utm_source;
            }
            
            if (ref === '') return 'Direct'; [cite: 162]
            if (ref.includes('google.')) return 'Google Search'; [cite: 163]
            if (ref.includes('bing.')) return 'Bing';
            if (ref.includes('facebook.com')) return 'Facebook';
            if (ref.includes('instagram.com')) return 'Instagram'; [cite: 163]
            try {
                const refUrl = new URL(ref); [cite: 164]
                return `Referral/${refUrl.hostname.replace('www.', '')}`; [cite: 165]
            } catch {
                return 'Referral'; [cite: 165]
            }
        };

        try {
            const response = await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'startSession', [cite: 167]
                    source: getTrafficSource(),
                    deviceType: getDeviceType()
                })
            }); [cite: 167]
            if (!response.ok) throw new Error('Could not start session'); [cite: 168]
            
            const data = await response.json();
            sessionId = data.sessionId;
            saveQuizState();
            initializeGlobalErrorHandlers();
            return false; [cite: 169]
        } catch (error) {
            console.error('Failed to start session:', error); [cite: 169]
            addBotMessage("Sorry, I'm having trouble connecting. Please try refreshing the page."); [cite: 170]
            inputArea.style.display = 'none';
            return false; [cite: 171]
        }
    }

    async function saveAnswerToServer(questionKey, answer) {
        if (!sessionId) {
            console.error('No session ID available'); [cite: 171]
            return false; [cite: 172]
        }
        
        userAnswers[questionKey] = answer; [cite: 172]
        saveQuizState(); [cite: 173]
        
        try {
            const response = await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveAnswer',
                    sessionId: sessionId, [cite: 174]
                    questionId: questionKey,
                    answer: answer
                })
            }); [cite: 174]
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`); [cite: 175]
            }
            return true; [cite: 176]
        } catch (error) {
            console.error('Failed to save answer:', error); [cite: 177]
            return false; [cite: 178]
        }
    }

    // --- UI FUNCTIONS ---
    function updateProgressBar() {
        const questionKeys = quizQuestions.filter(q => 
            q.type === 'question' || q.type === 'slider'
        ).map(q => q.key); [cite: 178]
        const totalSteps = questionKeys.length + 1; [cite: 179]
        const completedAnswers = Object.keys(userAnswers).filter(key => 
            questionKeys.includes(key)
        ).length; [cite: 179]
        const photoStepCompleted = userAnswers['selfie'] ? 1 : 0; [cite: 180]
        const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100; [cite: 180]
        progressBar.style.width = `${progress}%`; [cite: 181]
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement('div'); [cite: 181]
        typingDiv.id = 'typing-indicator'; [cite: 182]
        typingDiv.className = 'flex justify-start mb-4 chat-bubble';
        typingDiv.innerHTML = `
            <div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `; [cite: 183]
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator')?.remove(); [cite: 184]
    }

    function addBotMessage(html) {
        const messageDiv = document.createElement('div'); [cite: 184]
        messageDiv.className = 'flex justify-start mb-4 chat-bubble'; [cite: 185]
        messageDiv.innerHTML = `
            <div class="bg-gray-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">
                ${html}
            </div>
        `; [cite: 185]
        chatContainer.appendChild(messageDiv); [cite: 186]
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addUserMessage(text) {
        const d = document.createElement('div'); [cite: 186]
        d.className = 'flex justify-end mb-4 chat-bubble'; [cite: 187]
        d.innerHTML = `
            <div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">
                ${text}
            </div>
        `; [cite: 187]
        chatContainer.appendChild(d); [cite: 188]
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function showOptions(options, handlers) {
        optionsContainer.innerHTML = ''; [cite: 188]
        if (options?.length > 0) {
            optionsContainerWrapper.classList.remove('hidden'); [cite: 189]
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = option.class;
                button.onclick = handlers[index];
                optionsContainer.appendChild(button);
            }); [cite: 191]
        } else {
            optionsContainerWrapper.classList.add('hidden'); [cite: 191]
        }
    }

    function showSlider(question) {
        optionsContainer.innerHTML = ''; [cite: 192]
        optionsContainerWrapper.classList.remove('hidden'); [cite: 193]
        inputArea.classList.add('hidden');
        
        const sliderWrapper = document.createElement('div');
        sliderWrapper.className = 'slider-widget';
        
        const formatDisplayValue = (value) => {
            if (question.unit === 'stress') {
                if (value <= 3) return `<span style="color: #22c55e;">Low</span>`; [cite: 193]
                if (value <= 7) return `<span style="color: #f59e0b;">Medium</span>`; [cite: 194]
                return `<span style="color: #ef4444;">High</span>`; [cite: 194]
            }
            if (question.unit === 'cm') {
                const feet = Math.floor(value / 30.48); [cite: 195]
                const inches = Math.round((value % 30.48) / 2.54); [cite: 196]
                return `${feet}'${inches}" <span class="text-lg ml-2 text-purple-400">(${value} cm)</span>`;
            }
            if (question.unit === 'kg') {
                const lbs = (value * 2.20462).toFixed(0);
                return `${lbs} lbs <span class="text-lg ml-2 text-purple-400">(${value} kg)</span>`;
            }
            return `${value} ${question.unit}`; [cite: 197]
        };
        
        const sliderInputClass = question.isGradient ? 'slider-input slider-input-gradient' : 'slider-input';
        const markersHTML = question.isGradient ? 
            `<div class="slider-markers"><span>Low</span><span>Medium</span><span>High</span></div>` : '';
        
        sliderWrapper.innerHTML = `
            <div class="text-center"> [cite: 198]
                <div id="slider-value-display" class="slider-value">${formatDisplayValue(question.defaultValue)}</div>
                <div class="slider-label">${question.label}</div>
            </div>
            <input type="range" min="${question.min}" max="${question.max}" value="${question.defaultValue}" 
                   step="${question.step}" class="${sliderInputClass}" id="slider-input-range">
            ${markersHTML} [cite: 199]
            <button id="slider-confirm-btn" class="confirm-btn">Confirm</button>
        `; [cite: 199]
        optionsContainer.appendChild(sliderWrapper); [cite: 200]
        
        const sliderInput = document.getElementById('slider-input-range');
        const valueDisplay = document.getElementById('slider-value-display');
        const confirmBtn = document.getElementById('slider-confirm-btn'); [cite: 200]
        sliderInput.addEventListener('input', (e) => {
            valueDisplay.innerHTML = formatDisplayValue(e.target.value);
        }); [cite: 202]
        confirmBtn.onclick = () => {
            const finalValue = sliderInput.value; [cite: 202]
            let displayAnswerText = ''; [cite: 203]
            
            if (question.unit === 'stress') {
                if (finalValue <= 3) displayAnswerText = 'Low'; [cite: 203]
                else if (finalValue <= 7) displayAnswerText = 'Medium'; [cite: 204]
                else displayAnswerText = 'High'; [cite: 204]
            } else if (question.unit === 'cm') {
                const feet = Math.floor(finalValue / 30.48); [cite: 205]
                const inches = Math.round((finalValue % 30.48) / 2.54); [cite: 206]
                displayAnswerText = `${feet}'${inches}"`;
            } else if (question.unit === 'kg') {
                const lbs = (finalValue * 2.20462).toFixed(0);
                displayAnswerText = `${lbs} lbs`;
            } else {
                displayAnswerText = `${finalValue} ${question.unit}`; [cite: 207]
            }
            
            handleAnswer(finalValue, displayAnswerText);
        };
    }

    // --- ANIMATIONS ---
    function parseHeightToInches(heightVal) {
        if (!heightVal) return 68;
        if (!isNaN(parseFloat(heightVal))) {
            return parseFloat(heightVal) / 2.54; [cite: 207]
        }
        let inches = 0;
        const feetMatch = heightVal.match(/(\d+)\s*(ft|')/);
        const inchesMatch = heightVal.match(/(\d+)\s*(in|")/); [cite: 208]
        if (feetMatch) inches += parseInt(feetMatch[1]) * 12; [cite: 209]
        if (inchesMatch) inches += parseInt(inchesMatch[1]);
        return inches > 0 ? inches : 68; [cite: 210]
    }

    function playBmiAnimation() {
        const heightIn = parseHeightToInches(userAnswers.height); [cite: 210]
        const weightLbs = (parseInt(userAnswers.weight) || 70) * 2.20462;
        
        if (heightIn && weightLbs) {
            const bmi = ((weightLbs / (heightIn * heightIn)) * 703).toFixed(1); [cite: 211]
            let category = "Normal"; [cite: 212]
            let percent = 50;
            
            if (bmi < 18.5) {
                category = "Underweight"; [cite: 212]
                percent = (bmi / 18.5) * 25; [cite: 213]
            } else if (bmi < 25) {
                category = "Normal"; [cite: 213]
                percent = 25 + ((bmi - 18.5) / 6.5) * 50; [cite: 214]
            } else if (bmi < 30) {
                category = "Overweight"; [cite: 215]
                percent = 75 + ((bmi - 25) / 5) * 25; [cite: 216]
            } else {
                category = "Obese"; [cite: 217]
                percent = 100; [cite: 218]
            }
            
            percent = Math.max(5, Math.min(95, percent)); [cite: 218]
            const html = `
                <div class="bmi-widget">
                    <div id="bmi-value-anim" class="bmi-value">0.0</div>
                    <div class="text-sm font-semibold text-gray-600 mb-2">Your Estimated BMI</div>
                    <div class="bmi-scale">
                        <div id="bmi-indicator-anim" class="bmi-indicator" style="left: 0%;"></div> [cite: 220]
                    </div>
                    <div id="bmi-category-anim" class="text-sm font-medium text-purple-600 mt-2">&nbsp;</div>
                </div>
            `; [cite: 220]
            addBotMessage(html); [cite: 221]
            
            setTimeout(() => {
                const valEl = document.getElementById('bmi-value-anim');
                const catEl = document.getElementById('bmi-category-anim');
                const indEl = document.getElementById('bmi-indicator-anim');
                
                if(indEl) indEl.style.left = `${percent}%`;
                if(catEl) catEl.textContent = category; [cite: 222]
                
                let start = 0;
                const end = parseFloat(bmi);
                const animDuration = 1500;
                const frameDuration = 1000 / 60; [cite: 223]
                const totalFrames = Math.round(animDuration / frameDuration);
                let frame = 0;
                
                const countUp = setInterval(() => {
                    frame++; [cite: 224]
                    const progress = frame / totalFrames;
                    const currentVal = (start + (end - start) * progress).toFixed(1);
                    if(valEl) valEl.textContent = currentVal;
                    if (frame === totalFrames) { [cite: 225]
                        clearInterval(countUp); [cite: 225]
                        if(valEl) valEl.textContent = bmi; [cite: 226]
                    }
                }, frameDuration); [cite: 226]
            }, 100);
        }
    }

    function playSleepAnimation() {
        const answer = userAnswers.sleep || ""; [cite: 228]
        let level = 25;
        if (answer.includes("5-6")) level = 50;
        if (answer.includes("7-8")) level = 90; [cite: 228]
        if (answer.includes("More than 8")) level = 100; [cite: 229]
        
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Sleep Recharge</div>
                <svg class="w-16 h-16 mx-auto text-purple-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /> [cite: 230]
                </svg>
                <div class="sleep-battery mt-2">
                    <div id="sleep-battery-level-anim" class="sleep-battery-level"></div>
                </div>
            </div>
        `; [cite: 231]
        
        addBotMessage(html);
        
        setTimeout(() => {
            const levelEl = document.getElementById('sleep-battery-level-anim');
            if (!levelEl) return;
            
            let color = '#ef4444';
            if (level > 40) color = '#f59e0b';
            if (level > 75) color = '#22c55e'; [cite: 232]
            
            levelEl.style.backgroundColor = color;
            levelEl.style.width = `${level}%`;
        }, 100); [cite: 233]
    }

    function playActivityAnimation() {
        const answer = userAnswers.activity || ""; [cite: 233]
        let days = 1; [cite: 234]
        if (answer.includes("1-2")) days = 2;
        if (answer.includes("3-4")) days = 4;
        if (answer.includes("5+")) days = 6; [cite: 234]
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Your Active Week</div>
                <div class="activity-week" id="activity-week-anim">
                    <div class="activity-day">M</div>
                    <div class="activity-day">T</div>
                    <div class="activity-day">W</div> [cite: 236]
                    <div class="activity-day">T</div>
                    <div class="activity-day">F</div>
                    <div class="activity-day">S</div>
                    <div class="activity-day">S</div> [cite: 237]
                </div>
            </div>
        `; [cite: 237]
        addBotMessage(html); [cite: 238]
        
        setTimeout(() => {
            const weekEl = document.getElementById('activity-week-anim');
            if (!weekEl) return;
            
            const dayElements = weekEl.children;
            const daysToActivate = [0, 2, 4, 1, 3, 5, 6];
            
            for (let i = 0; i < days; i++) { [cite: 239]
                setTimeout(() => {
                    dayElements[daysToActivate[i]].classList.add('active');
                }, i * 250);
            }
        }, 100); [cite: 240]
    }

    function playHydrationAnimation() {
        const answer = userAnswers.hydration || ""; [cite: 240]
        let level = 25; [cite: 241]
        if (answer.includes("4-6")) level = 50;
        if (answer.includes("7-9")) level = 75;
        if (answer.includes("10+")) level = 100; [cite: 241]
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Body Hydration</div>
                <svg class="w-20 h-24 mx-auto" viewBox="0 0 120 160">
                    <defs>
                        <clipPath id="humanoid-clip"> [cite: 243]
                            <path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z"></path>
                        </clipPath>
                    </defs>
                    <g clip-path="url(#humanoid-clip)"> [cite: 244]
                        <rect x="0" y="0" width="120" height="160" fill="#ede9fe"/>
                        <rect id="hydration-water-fill" x="0" y="0" width="120" height="160" fill="#818cf8" style="transform: translateY(160px);"/>
                    </g>
                    <path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z" fill="none" stroke="#a78bfa" stroke-width="6"/> [cite: 245]
                </svg>
                <div id="hydration-percentage" class="font-bold text-xl text-indigo-600 mt-2">0%</div>
            </div>
        `; [cite: 246]
        
        addBotMessage(html);
        
        setTimeout(() => {
            const waterEl = document.getElementById('hydration-water-fill');
            const textEl = document.getElementById('hydration-percentage');
            if (!waterEl || !textEl) return;
            
            const yPos = 160 - (160 * (level / 100));
            waterEl.style.transform = `translateY(${yPos}px)`;
            textEl.style.opacity = '1'; [cite: 247]
            
            let currentLevel = 0;
            const levelUp = setInterval(() => {
                currentLevel++;
                textEl.textContent = `${currentLevel}%`;
                if (currentLevel >= level) clearInterval(levelUp); [cite: 248]
            }, 1500 / level);
        }, 100); [cite: 249]
    }

    function playStressGaugeAnimation() {
        const stressAnswer = userAnswers.stress || "1"; [cite: 249]
        const level = parseInt(stressAnswer.match(/\d+/)[0]); [cite: 250]
        const percent = (level - 1) / 9 * 100;
        
        let color = '#4ade80'; [cite: 250]
        if (level > 4) color = '#facc15'; [cite: 251]
        if (level > 7) color = '#f87171'; [cite: 251]
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Reported Stress Level</div>
                <div class="stress-bar-track">
                    <div id="stress-bar-fill-anim" class="stress-bar-fill"></div>
                </div>
                <div id="stress-value-anim" class="stress-value">${level}/10</div> [cite: 253]
            </div>
        `; [cite: 253]
        addBotMessage(html); [cite: 254]
        
        setTimeout(() => {
            const fillEl = document.getElementById('stress-bar-fill-anim');
            const textEl = document.getElementById('stress-value-anim');
            if (!fillEl || !textEl) return;
            
            fillEl.style.width = `${percent}%`;
            textEl.style.color = color;
        }, 100); [cite: 255]
    }

    // --- QUIZ FLOW ---
    function handleAnswer(answerToStore, answerToDisplay) {
        const valueToStore = (answerToStore || '').toString(); [cite: 255]
        if (!valueToStore.trim()) return; [cite: 256]
        
        const currentQuestion = quizQuestions[currentQuestionIndex];
        const valueToDisplay = answerToDisplay || valueToStore;
        
        addUserMessage(valueToDisplay);
        userAnswers[currentQuestion.key] = valueToStore.trim();
        saveAnswerToServer(currentQuestion.key, valueToStore.trim()); [cite: 256]
        userInput.value = ''; [cite: 257]
        userInput.blur();
        inputArea.classList.add('hidden');
        optionsContainerWrapper.classList.add('hidden');
        
        currentQuestionIndex++;
        updateProgressBar();
        askNextQuestion();
    }

    function askNextQuestion() {
        if (currentQuestionIndex >= quizQuestions.length) return; [cite: 257]
        const question = quizQuestions[currentQuestionIndex]; [cite: 258]
        const messageDelay = 1800;
        
        setDaveStatus('typing...');
        showTypingIndicator();
        
        const delay = question.delayBefore || messageDelay; [cite: 258]
        setTimeout(() => {
            hideTypingIndicator();
            setDaveStatus('Online');
            
            let questionText = typeof question.text === 'function' ? 
                question.text(userAnswers.name || 'friend') : question.text;
            
            let postAnimationDelay = question.postAnimationDelay || 0; [cite: 260]
            
            if (question.type === 'message') {
                addBotMessage(questionText);
                
                if (question.key === 'bmi_calculation') {
                    setTimeout(playBmiAnimation, 100); [cite: 261]
                } else if (question.key === 'stress_gauge') {
                    setTimeout(playStressGaugeAnimation, 100);
                } else if (question.key === 'sleep_visual') {
                    setTimeout(playSleepAnimation, 100);
                } else if (question.key === 'activity_visual') { [cite: 262]
                    setTimeout(playActivityAnimation, 100);
                } else if (question.key === 'hydration_visual') {
                    setTimeout(playHydrationAnimation, 100); [cite: 262]
                }
                
                currentQuestionIndex++; [cite: 263]
                setTimeout(askNextQuestion, postAnimationDelay || 1500); [cite: 264]
                
            } else if (question.type === 'question') {
                addBotMessage(questionText); [cite: 264]
                const optionButtons = question.options?.map(opt => ({
                    text: opt,
                    class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50'
                })); [cite: 265]
                const handlers = question.options?.map(opt => () => handleAnswer(opt)); [cite: 266]
                
                if (question.options && question.options.length > 0) {
                    showOptions(optionButtons, handlers); [cite: 266]
                }
                
                if (question.hideInput) {
                    inputArea.classList.add('hidden'); [cite: 267]
                } else {
                    inputArea.classList.remove('hidden'); [cite: 268]
                    userInput.placeholder = question.placeholder || "Type..."; [cite: 269]
                    if (window.innerWidth > 768) {
                        userInput.focus(); [cite: 269]
                    }
                }
                
            } else if (question.type === 'slider') {
                addBotMessage(questionText); [cite: 270]
                showSlider(question); [cite: 271]
                
            } else if (question.type === 'final_step') {
                inputArea.classList.add('hidden'); [cite: 271]
                addBotMessage(questionText); [cite: 272]
                
                fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'endQuiz',
                        sessionId: sessionId [cite: 273]
                    })
                }); [cite: 273]
                showCameraStep(); [cite: 274]
            }
        }, delay); [cite: 274]
    }

    // --- CAMERA FUNCTIONALITY ---
    function showCameraStep() {
        optionsContainerWrapper.classList.add('hidden'); [cite: 275]
        inputArea.classList.remove('hidden'); [cite: 276]
        inputArea.innerHTML = `
            <button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors pulse-btn">
                Open Camera
            </button>
        `; [cite: 276]
        document.getElementById('open-camera-btn').onclick = startCamera; [cite: 277]
    }

    async function startCamera() {
        cameraModal.classList.add('active'); [cite: 277]
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'; [cite: 278]
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
            ]); [cite: 279]
            loaderText.textContent = "Requesting camera access..."; [cite: 280]
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' }
            }); [cite: 280]
            video.srcObject = stream; [cite: 281]
            video.onloadedmetadata = () => {
                cameraLoader.style.display = 'none'; [cite: 281]
                startFaceDetection(); [cite: 282]
            };
        } catch (err) {
            console.error("Camera/Model Error:", err); [cite: 282]
            logErrorToServer({
                message: 'Camera or Face-API Model Error',
                details: err.message
            }); [cite: 283]
            loaderText.textContent = "Camera access denied. Please refresh and try again."; [cite: 284]
            setTimeout(stopCamera, 3000); [cite: 284]
        }
    }

    function stopCamera() {
        clearInterval(detectionInterval); [cite: 285]
        stream?.getTracks().forEach(track => track.stop()); [cite: 286]
        cameraModal.classList.remove('active');
        video.srcObject = null;
    }

    function startFaceDetection() {
        let captureTimeout; [cite: 286]
        const context = canvas.getContext('2d');
        
        detectionInterval = setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video,
                new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);
            
            context.clearRect(0, 0, canvas.width, canvas.height); [cite: 288]
            context.save();
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            
            if (detections.length > 0) {
                const resizedDetections = faceapi.resizeResults(detections, displaySize); [cite: 289]
                const box = resizedDetections[0].detection.box;
                
                context.strokeStyle = 'rgba(0, 255, 255, 0.4)';
                context.lineWidth = 1;
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections[0].landmarks, { drawLines: true });
                context.strokeStyle = '#00FFFF'; [cite: 290]
                context.lineWidth = 3; [cite: 291]
                context.shadowColor = '#00FFFF';
                context.shadowBlur = 10;
                
                const cornerLength = box.width * 0.1;
                context.beginPath();
                context.moveTo(box.x, box.y + cornerLength); [cite: 291]
                context.lineTo(box.x, box.y); [cite: 292]
                context.lineTo(box.x + cornerLength, box.y);
                context.moveTo(box.x + box.width - cornerLength, box.y);
                context.lineTo(box.x + box.width, box.y); [cite: 292]
                context.lineTo(box.x + box.width, box.y + cornerLength); [cite: 293]
                context.moveTo(box.x, box.y + box.height - cornerLength);
                context.lineTo(box.x, box.y + box.height); [cite: 293]
                context.lineTo(box.x + cornerLength, box.y + box.height); [cite: 294]
                context.moveTo(box.x + box.width - cornerLength, box.y + box.height);
                context.lineTo(box.x + box.width, box.y + box.height); [cite: 294]
                context.lineTo(box.x + box.width, box.y + box.height - cornerLength); [cite: 295]
                context.stroke();
                context.shadowBlur = 0;
                
                const isGoodSize = box.width > canvas.width * 0.4; [cite: 295]
                if (isGoodSize) {
                    cameraStatus.textContent = "Hold still..."; [cite: 296]
                    if (!captureTimeout) {
                        captureTimeout = setTimeout(() => takePhoto(), 1500); [cite: 297]
                    }
                } else {
                    cameraStatus.textContent = "Move closer"; [cite: 298]
                    clearTimeout(captureTimeout); [cite: 299]
                    captureTimeout = null;
                }
            } else {
                cameraStatus.textContent = "Position your face"; [cite: 299]
                clearTimeout(captureTimeout); [cite: 300]
                captureTimeout = null;
            }
            context.restore();
        }, 100); [cite: 301]
    }

    function takePhoto() {
        clearInterval(detectionInterval);
        cameraStatus.textContent = "Perfect!"; [cite: 301]
        const photoCanvas = document.createElement('canvas'); [cite: 302]
        photoCanvas.width = video.videoWidth;
        photoCanvas.height = video.videoHeight;
        const photoContext = photoCanvas.getContext('2d');
        
        photoContext.translate(video.videoWidth, 0);
        photoContext.scale(-1, 1); [cite: 302]
        photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight); [cite: 303]
        
        capturedPhotoDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9);
        userAnswers['selfie'] = 'Photo taken';
        
        stopCamera();
        updateProgressBar();
        showPhotoForConfirmation(); [cite: 304]
    }

    function showPhotoForConfirmation() {
        const d = document.createElement('div'); [cite: 304]
        d.id = 'photo-preview-wrapper'; [cite: 305]
        d.className = 'flex justify-start mb-4 chat-bubble';
        d.innerHTML = `
            <div class="bg-gray-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">
                <p class="mb-2">Here's the photo. [cite: 305]
                Happy with it?</p> [cite: 306]
                <img src="${capturedPhotoDataUrl}" alt="Your selfie" class="rounded-lg"/>
            </div>
        `; [cite: 306]
        chatContainer.appendChild(d); [cite: 307]
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        const options = [
            { text: 'Looks Good!', class: 'option-btn bg-green-500 border-green-600 text-white px-4 py-2 rounded-full text-sm flex-shrink-0 font-semibold' },
            { text: 'Retake', class: 'option-btn bg-white border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm flex-shrink-0' }
        ]; [cite: 307]
        const handlers = [startAnalysisAndShowForm, retakePhoto]; [cite: 308]
        showOptions(options, handlers);
        inputArea.classList.add('hidden');
    }

    function retakePhoto() {
        addUserMessage("Retake"); [cite: 308]
        document.getElementById('photo-preview-wrapper')?.remove(); [cite: 309]
        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.add('hidden');
        startCamera();
    }

    // --- EMAIL & PAYMENT ---
    function askForEmailAfterPhoto() {
        return new Promise((resolve) => {
            if (userAnswers.email) {
                resolve();
                return;
            }
            addBotMessage("One last crucial step! Please enter your email to receive the report summary."); [cite: 310]
            inputArea.innerHTML = originalInputAreaHTML;
            userInput = document.getElementById('user-input');
            sendBtn = document.getElementById('send-btn');
            inputArea.classList.remove('hidden');
            userInput.value = '';
            userInput.placeholder = "your@email.com"; [cite: 311]
            userInput.type = 'email';
            
            eventManager.remove(sendBtn, 'click', 'email_submit');
            eventManager.remove(userInput, 'keypress', 'email_keypress');
            
            if (window.innerWidth > 768) {
                userInput.focus(); [cite: 312]
            }
            
            const emailSubmitHandler = async () => {
                const email = userInput.value.trim(); [cite: 312]
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; [cite: 313]
                
                if (!emailRegex.test(email)) {
                    addBotMessage("Hmm, that doesn't look like a valid email. Could you please double-check it?"); [cite: 313]
                    userInput.focus(); [cite: 314]
                    return;
                }
                
                userAnswers.email = email; [cite: 314]
                addUserMessage(email); [cite: 315]
                
                try {
                    await saveAnswerToServer('email', email); [cite: 315]
                } catch (error) {
                    console.error('Failed to save email:', error); [cite: 316]
                }
                
                eventManager.remove(sendBtn, 'click', 'email_submit'); [cite: 317]
                eventManager.remove(userInput, 'keypress', 'email_keypress'); [cite: 318]
                inputArea.classList.add('hidden');
                userInput.value = '';
                userInput.type = 'text';
                userInput.placeholder = "Type your answer...";
                resolve();
            }; [cite: 318]
            const keyPressHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); [cite: 319]
                    emailSubmitHandler(); [cite: 320]
                }
            };
            
            eventManager.add(sendBtn, 'click', emailSubmitHandler, 'email_submit'); [cite: 320]
            eventManager.add(userInput, 'keypress', keyPressHandler, 'email_keypress'); [cite: 321]
        });
    }

    async function startAnalysisAndShowForm() {
        addUserMessage("Looks Good!"); [cite: 321]
        await saveAnswerToServer('selfie', 'Photo taken'); [cite: 322]
        document.getElementById('photo-preview-wrapper')?.remove();
        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.add('hidden');
        
        await askForEmailAfterPhoto();
        showCompletionAnimation(); [cite: 322]
        try {
            const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ photoDataUrl: capturedPhotoDataUrl })
            }); [cite: 323]
            if (!analyzeResponse.ok) throw new Error('Skin analysis failed'); [cite: 324]
            
            const analysisData = await analyzeResponse.json(); [cite: 324]
            await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveAnalysisData',
                    sessionId: sessionId,
                    analysisData: analysisData [cite: 326]
                })
            }); [cite: 326]
            fetch('/.netlify/functions/result-background', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
            }); [cite: 327]
        } catch (error) {
            console.error('Error during analysis process:', error); [cite: 328]
            logErrorToServer({
                message: 'Skin Analysis or Result Generation Error',
                details: error.message
            }); [cite: 329]
            hideTypingIndicator(); [cite: 330]
            addBotMessage("Sorry, an issue occurred. We'll use standard analysis for your report."); [cite: 330]
            fetch('/.netlify/functions/result-background', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
            }); [cite: 332]
        }
    }

    function showCompletionAnimation() {
        const analysisAnimationPath = 'loader-animation.json'; [cite: 332]
        confetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.6 }
        }); [cite: 333]
        setDaveStatus('typing...'); [cite: 334]
        showTypingIndicator();
        
        setTimeout(() => {
            hideTypingIndicator();
            setDaveStatus('Online');
            addBotMessage("Awesome work! You've completed the assessment. ü•≥ I'm now analyzing your results...");
            
            inputArea.innerHTML = `
                <div class="analysis-container">
                    <div id="analysis-animation" class="w-32 h-32 mx-auto mb-4"></div> [cite: 335]
                    <p id="analysis-text" class="text-gray-600">Initializing analysis...</p>
                </div>
            `; [cite: 335]
            inputArea.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            animationManager.add('analysis-animation', { [cite: 336]
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: analysisAnimationPath
            }); [cite: 337]
            
            const analysisSteps = [
                "Analyzing your data...",
                "Checking lifestyle factors...",
                "Scanning skin health...",
                "Calculating biological age...", [cite: 338]
                "Almost ready..."
            ]; [cite: 338]
            const analysisTextElement = document.getElementById('analysis-text'); [cite: 339]
            let currentStep = 0;
            
            const intervalId = setInterval(() => {
                if (currentStep < analysisSteps.length) {
                    analysisTextElement.style.opacity = '0';
                    setTimeout(() => {
                        analysisTextElement.textContent = analysisSteps[currentStep]; [cite: 340]
                        analysisTextElement.style.opacity = '1';
                    }, 500);
                    currentStep++;
                } else {
                    clearInterval(intervalId); [cite: 341]
                }
            }, 1600); [cite: 341]
            setTimeout(() => {
                inputArea.classList.add('hidden');
                setDaveStatus('typing...');
                showTypingIndicator();
                
                setTimeout(() => {
                    hideTypingIndicator(); [cite: 343]
                    setDaveStatus('Online');
                    addBotMessage("Great! Your preliminary analysis is complete. Just one final step to unlock your full, personalized report.");
                    showPaymentForm();
                }, 1200);
            }, analysisSteps.length * 1600 + 500); [cite: 344]
        }, 1000); [cite: 344]
    }

    async function showPaymentForm() {
        fbq('track', 'InitiateCheckout', {value: 9.99, currency: 'USD'}); [cite: 345]
        let hasSentAddPaymentInfo = false; [cite: 346]
        const sendAddPaymentInfoEvent = () => {
            if (!hasSentAddPaymentInfo) {
                fbq('track', 'AddPaymentInfo'); [cite: 346]
                hasSentAddPaymentInfo = true; [cite: 347]
            }
        };
        
        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.add('hidden'); [cite: 347]
        const formHtml = `
            <div class="p-4 bg-gray-50 border-t">
                <div id="payment-wrapper" class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800">Unlock Full Report</h2>
                    </div> [cite: 349]
                    <div class="bg-purple-100 text-purple-800 rounded-lg p-3 text-center mb-4">
                        <p class="text-sm font-medium">Limited Time Offer (-30%)</p>
                        <p id="countdown-timer" class="text-2xl font-bold tracking-wider">10:00</p>
                    </div> [cite: 350]
                    <div class="text-center mb-4">
                        <span class="text-3xl font-bold text-gray-800">$9.99</span>
                        <span class="text-lg text-gray-400 line-through ml-2">$14.99</span>
                    </div> [cite: 351]
                    <form id="payment-form" class="space-y-4">
                        <div id="payment-request-button"></div>
                        <div id="card-element" class="p-3 border border-gray-300 rounded-md shadow-sm"></div>
                        <button id="submit-payment" type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition-colors text-lg shadow-md"> [cite: 352]
                            <span id="button-text">Pay now</span>
                        </button>
                        <div id="payment-message" class="hidden text-center text-red-500 text-sm pt-1"></div> [cite: 353]
                    </form>
                </div>
            </div>
        `; [cite: 353]
        paymentFormContainer.innerHTML = formHtml; [cite: 354]
        paymentFormContainer.classList.remove('hidden');
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        startCountdown();
        
        stripe = Stripe('pk_live_51S1YfdPBAI3bxeVkFNBty0jUIvH37x0U3yZCOMu3Idd8Ei0XmAHP5vqRwbOR1cCNk4G48naTwy40n9enHvOlrYIB00LtAI8Nzb'); [cite: 354]
        try {
            const response = await fetch('/.netlify/functions/payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
            }); [cite: 355]
            const data = await response.json(); [cite: 356]
            clientSecret = data.clientSecret;
            
            if (!clientSecret) throw new Error("Client secret not received."); [cite: 356]
            elements = stripe.elements({ clientSecret }); [cite: 357]
            
            const paymentRequest = stripe.paymentRequest({
                country: 'US',
                currency: 'usd',
                total: { label: 'AI Wellness Report', amount: 999 },
                requestPayerName: true,
                requestPayerEmail: true [cite: 358]
            });
            
            const prButton = elements.create('paymentRequestButton', { paymentRequest }); [cite: 358]
            const canMakePayment = await paymentRequest.canMakePayment(); [cite: 359]
            
            if (canMakePayment) {
                prButton.mount('#payment-request-button'); [cite: 359]
            } else {
                document.getElementById('payment-request-button').style.display = 'none'; [cite: 360]
            }
            
            paymentRequest.on('paymentmethod', async (ev) => {
                sendAddPaymentInfoEvent();
                const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(
                    clientSecret,
                    { payment_method: ev.paymentMethod.id }, [cite: 362]
                    { handleActions: false }
                );
                
                if (confirmError) {
                    ev.complete('fail'); [cite: 363]
                    document.getElementById('payment-message').textContent = confirmError.message;
                } else {
                    ev.complete('success');
                    if (paymentIntent.status === "succeeded") {
                        handleSuccessfulPayment(); [cite: 364]
                    }
                }
            }); [cite: 364]
            const cardElement = elements.create("card", {
                style: { base: { fontSize: '16px' } }
            }); [cite: 365]
            cardElement.mount("#card-element"); [cite: 366]
            
            cardElement.on('focus', () => {
                sendAddPaymentInfoEvent();
            }); [cite: 366]
            const paymentForm = document.getElementById('payment-form'); [cite: 367]
            paymentForm.addEventListener('submit', handlePayment);
            
        } catch (error) {
            console.error("Failed to initialize payment form:", error); [cite: 367]
            logErrorToServer({
                message: 'Stripe Payment Form Initialization Failed',
                details: error.message
            }); [cite: 368]
            document.getElementById('payment-wrapper').innerHTML = 
                `<p class="text-center text-red-500">Could not load payment form. [cite: 369]
                Error: ${error.message}</p>`; [cite: 370]
        }
    }

    async function handlePayment(e) {
        e.preventDefault(); [cite: 370]
        const submitButton = document.getElementById('submit-payment'); [cite: 371]
        const messageDiv = document.getElementById('payment-message');
        
        submitButton.disabled = true; [cite: 371]
        try {
            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: elements.getElement('card')
                }
            }); [cite: 372]
            if (error) {
                logErrorToServer({
                    message: 'Stripe Payment Confirmation Error',
                    details: error.message
                }); [cite: 373]
                messageDiv.textContent = error.message; [cite: 374]
                messageDiv.classList.remove('hidden');
                submitButton.disabled = false;
                
                await fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updatePayment', [cite: 375]
                        sessionId: sessionId,
                        status: 'failed',
                        amountUSD: '0'
                    })
                }); [cite: 376]
            } else if (paymentIntent) {
                if (paymentIntent.status === 'succeeded') {
                    await fetch('/.netlify/functions/quiz', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ [cite: 378]
                            action: 'updatePayment',
                            sessionId: sessionId,
                            status: 'succeeded', [cite: 379]
                            amountUSD: '9.99'
                        })
                    });
                }
            }
        } catch(err) {
            //...
        }
    }
</script>

</body>
</html>
