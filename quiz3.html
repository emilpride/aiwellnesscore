<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Wellness Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body, html {
            overscroll-behavior-y: contain;
            font-family: 'Inter', sans-serif;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        .full-screen-container {
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            position: relative;
        }
        #swiper-container {
            transition: opacity 0.6s ease-out, transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swiper-wrapper {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swiper-slide {
            flex-shrink: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .swiper-slide.active {
            opacity: 1;
            transform: scale(1);
        }
        .dot {
            transition: background-color 0.3s, transform 0.3s;
        }
        .dot.active {
            background-color: #8b5cf6;
            transform: scale(1.25);
        }
        .slide-content > * {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
        }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        #chat-section {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transform: translateY(100%);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column; background-color: #f9fafb;
        }
        #chat-section.active { transform: translateY(0); }
        #chat-header { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
            background-color: white; }
        .chat-container { scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; }
        .chat-container::-webkit-scrollbar { display: none; }
        .chat-bubble { animation: popIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) both; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .option-btn { transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .option-btn:hover { transform: translateY(-2px); }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%;
            display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        #camera-modal { position: fixed; top: 0;
            left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease; }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        #camera-container { position: relative; width: 90%; max-width: 400px; aspect-ratio: 3/4; overflow: hidden;
            border-radius: 1.5rem; background: #111; border: 1px solid rgba(255,255,255,0.2); }
        #camera-video { width: 100%;
            height: 100%; object-fit: cover; transform: scaleX(-1); }
        #camera-canvas { position: absolute; top: 0;
            left: 0; width: 100%; height: 100%; }
        #camera-overlay { position: absolute; bottom: 0;
            left: 0; right: 0; padding: 1.5rem; text-align: center; }
        #camera-status { background-color: rgba(0,0,0,0.5);
            padding: 0.5rem 1rem; border-radius: 9999px; display: inline-block; color: white; font-weight: 500; transition: background-color 0.3s;
        }
        #progress-bar { animation: glow 2s ease-in-out infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 2px #a855f7, 0 0 4px #a855f7; } to { box-shadow: 0 0 6px #6366f1, 0 0 8px #6366f1; } }
        .slider-widget { padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; width: 100%;
            max-width: 300px; margin: auto; }
        .slider-value { font-size: 2.5rem; font-weight: 800; line-height: 1;
            transition: color 0.3s ease; }
        .slider-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem;
            color: #6b21a8; }
        .slider-input { -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background: #d1d5db; border-radius: 5px; outline: none; transition: opacity .2s; }
        .slider-input-gradient { background: linear-gradient(to right, #22c55e, #facc15, #ef4444); }
        .slider-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: white;
            cursor: pointer; border-radius: 50%; border: 4px solid #8b5cf6; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .slider-input::-moz-range-thumb { width: 24px; height: 24px; background: white; cursor: pointer; border-radius: 50%;
            border: 4px solid #8b5cf6; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        .slider-markers { display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af;
            margin: 0.25rem 0.25rem 0; }
        .confirm-btn { margin-top: 1rem; width: 100%; background-color: #7c3aed;
            color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.75rem; transition: background-color 0.2s;
        }
        .confirm-btn:hover { background-color: #6d28d9; }
        .widget-wrapper, .bmi-widget, .analysis-container { padding: 1rem; background-color: #f3f4f6; border-radius: 1rem; max-width: 250px;
            margin: auto; text-align: center; }
        .widget-label { font-weight: 600; color: #6b21a8; margin-bottom: 0.75rem; }
        .sleep-battery { width: 100px; height: 40px; border: 3px solid #c4b5fd; border-radius: 8px;
            margin: 0 auto; position: relative; }
        .sleep-battery::after { content:''; position: absolute; top: 50%;
            right: -10px; transform: translateY(-50%); width: 5px; height: 20px; background-color: #c4b5fd; border-radius: 0 4px 4px 0;
        }
        .sleep-battery-level { position: absolute; top: 3px; left: 3px; height: 30px; border-radius: 4px;
            width: 0%; background-color: #ef4444; transition: width 1.5s ease-out, background-color 1s ease;
        }
        .activity-week { display:flex; justify-content:center; gap: 0.5rem; }
        .activity-day { width: 30px; height: 30px; border-radius: 0.5rem; background-color: #ede9fe; color: #a78bfa;
            font-weight: 600; display:flex; align-items:center; justify-content:center; font-size:0.75rem; transition: all 0.4s ease-out;
        }
        .activity-day.active { background-color: #8b5cf6; color: white; transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4); }
        #hydration-water-fill { transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
        #hydration-percentage { transition: opacity 0.5s; opacity: 0; }
        .stress-bar-track { height: 12px; background-color: #ede9fe; border-radius: 9999px; overflow: hidden; }
        .stress-bar-fill { height: 100%; width: 0%; background-image: linear-gradient(to right, #4ade80, #facc15, #f87171);
            border-radius: 9999px; transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); }
        .stress-value { font-size: 1.5rem;
            font-weight: 700; margin-top: 0.5rem; transition: color 1.5s ease; }
        .bmi-value { font-size: 2.5rem;
            font-weight: 800; color: #5b21b6; line-height: 1; }
        .bmi-scale { position: relative; height: 10px;
            background-image: linear-gradient(to right, #60a5fa, #34d399, #facc15, #f87171); border-radius: 9999px; margin: 0.5rem 0;
        }
        .bmi-indicator { position: absolute; top: 50%; width: 16px; height: 16px; background-color: white;
            border: 3px solid #5b21b6; border-radius: 50%; transform: translate(-50%, -50%); transition: left 1.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
    </style>
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '785592354117222');
        fbq('track', 'PageView');
    </script>
</head>
<body class="bg-gray-50">

<div id="app-container" class="full-screen-container bg-white">
    <div id="swiper-container" class="relative w-full h-full flex flex-col">
        <div class="flex-grow w-full h-full overflow-hidden">
            <div id="swiper-wrapper" class="swiper-wrapper flex h-full">
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center slide-content">
                        <div id="dave-animation" class="w-48 h-48 mx-auto"></div>
                        <h1 class="text-3xl font-bold text-gray-800 mt-4">Hey! I'm Dave.</h1>
                        <p class="text-gray-600 mt-2">Your personal AI wellness assistant. Let's unlock your potential together.</p>
                    </div>
                </div>
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-left w-full max-w-sm slide-content">
                        <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">What you'll get:</h2>
                        <ul class="space-y-4">
                            <li class="flex items-center" style="animation-delay: 0.5s;">
                                <span class="text-2xl mr-3">🎯</span>
                                <div><h3 class="font-semibold">Wellness Score</h3><p class="text-sm text-gray-500">Your comprehensive health rating</p></div>
                            </li>
                            <li class="flex items-center" style="animation-delay: 0.7s;">
                                <span class="text-2xl mr-3">⏳</span>
                                <div><h3 class="font-semibold">Biological Age</h3><p class="text-sm text-gray-500">How "young" you are for your years</p></div>
                            </li>
                            <li class="flex items-center" style="animation-delay: 0.9s;">
                                <span class="text-2xl mr-3">🌿</span>
                                <div><h3 class="font-semibold">Skin & Stress Analysis</h3><p class="text-sm text-gray-500">Learn about hidden factors</p></div>
                            </li>
                            <li class="flex items-center" style="animation-delay: 1.1s;">
                                <span class="text-2xl mr-3">🗺️</span>
                                <div><h3 class="font-semibold">Personalized Plan</h3><p class="text-sm text-gray-500">A 7-day plan for improvement</p></div>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center slide-content">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Lower Your Biological Age</h2>
                        <div class="flex justify-center items-center space-x-4">
                            <div class="text-center">
                                <p class="text-gray-500">Chronological</p>
                                <p id="chrono-age" class="text-5xl font-bold text-gray-400">35</p>
                            </div>
                            <div id="arrow-animation" class="w-20 h-20"></div>
                            <div class="text-center">
                                <p class="text-purple-600 font-semibold">Biological</p>
                                <p id="bio-age" class="text-6xl font-extrabold text-purple-600">32</p>
                            </div>
                        </div>
                        <p class="text-gray-600 mt-6 max-w-xs mx-auto">Our plan is designed to help you feel younger and more energetic.</p>
                    </div>
                </div>
                <div class="swiper-slide flex items-center justify-center p-8">
                    <div class="text-center max-w-sm slide-content">
                        <h2 class="text-2xl font-bold text-gray-800 mb-8">Your Privacy is Our Priority</h2>
                        <div class="space-y-6">
                            <div class="flex items-center text-left" style="animation-delay: 0.5s;">
                                <span class="text-3xl mr-4">📸</span>
                                <p class="text-gray-600">Your photo is never stored and is deleted immediately after analysis.</p>
                            </div>
                            <div class="flex items-center text-left" style="animation-delay: 0.7s;">
                                <span class="text-3xl mr-4">🔒</span>
                                <p class="text-gray-600">All your data is anonymized and protected by encryption.</p>
                            </div>
                            <div class="flex items-center text-left" style="animation-delay: 0.9s;">
                                <span class="text-3xl mr-4">⚕️</span>
                                <p class="text-gray-600">This is not medical advice. All recommendations are for informational purposes only.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="py-8 px-6">
            <div id="dots-container" class="flex justify-center items-center space-x-3 mb-6"></div>
            <button id="start-quiz-btn" class="w-full bg-purple-600 text-white font-bold py-4 px-4 rounded-xl hover:bg-purple-700 transition-transform transform hover:scale-105 shadow-lg shadow-purple-200">Let's start</button>
        </div>
    </div>

    <div id="chat-section">
        <div id="chat-header" class="p-4 border-b border-gray-100 flex items-center gap-3 flex-shrink-0">
            <div id="dave-chat-avatar" class="w-12 h-12"></div>
            <div>
                <h3 class="font-bold text-lg text-gray-800">Dave</h3>
                <p id="dave-status" class="text-sm text-green-500 font-semibold transition-all duration-300">Online</p>
            </div>
        </div>
        <div class="w-full bg-gray-200">
            <div id="progress-bar" class="h-1 bg-gradient-to-r from-purple-500 to-indigo-500" style="width: 0%;
            transition: width 0.5s ease-in-out;"></div>
        </div>
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto chat-container"></div>
        <div id="options-container-wrapper" class="px-4 pt-1 pb-2 hidden">
            <div id="options-container" class="flex gap-2 overflow-x-auto py-2"></div>
        </div>
        <div id="input-area" class="p-4 border-t border-gray-200 hidden">
            <div class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Type your answer..." class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500">
                <button id="send-btn" class="bg-purple-600 text-white rounded-full p-3 hover:bg-purple-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="payment-form-container"></div>
    </div>
</div>

<div id="camera-modal">
    <div id="camera-container">
        <video id="camera-video" autoplay muted playsinline></video>
        <canvas id="camera-canvas"></canvas>
        <div id="camera-loader" class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
            <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loader-text" class="text-lg font-semibold">Initializing AI models...</p>
        </div>
        <div id="camera-overlay">
            <p id="camera-status">Position your face in the frame</p>
        </div>
    </div>
</div>

<script>
    // --- VIEWPORT & INITIALIZATION ---
    const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
    window.addEventListener('resize', setVh);
    setVh();

    // --- GLOBAL STATE ---
    let sessionId = null, userAnswers = {}, currentQuestionIndex = 0;
    let detectionInterval, stream, capturedPhotoDataUrl = null, countdownInterval;
    let stripe, elements, clientSecret;
    // --- DOM ELEMENTS ---
    const chatContainer = document.getElementById('chat-container'),
        optionsContainer = document.getElementById('options-container'),
        optionsContainerWrapper = document.getElementById('options-container-wrapper'),
        inputArea = document.getElementById('input-area'),
        progressBar = document.getElementById('progress-bar'),
        cameraModal = document.getElementById('camera-modal'),
        video = document.getElementById('camera-video'),
        canvas = document.getElementById('camera-canvas'),
        cameraLoader = document.getElementById('camera-loader'),
        loaderText = document.getElementById('loader-text'),
        cameraStatus = document.getElementById('camera-status'),
        paymentFormContainer = document.getElementById('payment-form-container'),
        daveStatusEl = document.getElementById('dave-status');
    let userInput = document.getElementById('user-input'),
        sendBtn = document.getElementById('send-btn');
    const originalInputAreaHTML = inputArea.innerHTML;
    // --- ERROR LOGGING ---
    async function logErrorToServer(errorDetails) {
        if (!sessionId) {
            console.error("Cannot log error: no sessionId.", errorDetails);
            return;
        }
        try {
            await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'logError',
                    sessionId: sessionId,
                    error: {
                        source: 'frontend',
                        message: errorDetails.message,
                        details: errorDetails.details || 'N/A'
                    }
                })
            });
        } catch (e) {
            console.error("Failed to send error log:", e);
        }
    }

    function initializeGlobalErrorHandlers() {
        window.onerror = function(message, source, lineno, colno, error) {
            logErrorToServer({
                message: `Uncaught Error: ${message}`,
                details: `at ${source}:${lineno}:${colno}`
            });
            return false;
        };
        window.addEventListener('unhandledrejection', event => {
            logErrorToServer({
                message: 'Unhandled Promise Rejection',
                details: event.reason?.message || 'No details available'
            });
        });
    }

    // --- EVENT MANAGER ---
    class EventManager {
        constructor() { this.handlers = new Map(); }
        add(element, event, handler, key = null) {
            const handlerKey = key || `${element.id || 'element'}_${event}`;
            this.remove(element, event, handlerKey);
            this.handlers.set(handlerKey, { element, event, handler });
            element.addEventListener(event, handler);
        }
        remove(element, event, key = null) {
            const handlerKey = key || `${element.id || 'element'}_${event}`;
            const data = this.handlers.get(handlerKey);
            if (data) {
                data.element.removeEventListener(data.event, data.handler);
                this.handlers.delete(handlerKey);
            }
        }
        removeAll() {
            this.handlers.forEach((data) => {
                data.element.removeEventListener(data.event, data.handler);
            });
            this.handlers.clear();
        }
    }
    const eventManager = new EventManager();
    // --- ANIMATION MANAGER ---
    class AnimationManager {
        constructor() { this.animations = new Map(); }
        add(containerId, options) {
            this.remove(containerId);
            const container = document.getElementById(containerId);
            if (!container) return null;
            const anim = lottie.loadAnimation({
                container: container,
                ...options
            });
            this.animations.set(containerId, anim);
            return anim;
        }
        remove(containerId) {
            const anim = this.animations.get(containerId);
            if (anim) {
                anim.destroy();
                this.animations.delete(containerId);
            }
        }
        clear() {
            this.animations.forEach(anim => anim.destroy());
            this.animations.clear();
        }
    }
    const animationManager = new AnimationManager();
    // --- ONBOARDING SWIPER ---
    animationManager.add('dave-animation', {
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: 'https://assets2.lottiefiles.com/packages/lf20_g8tG0M.json' // Example Lottie path
    });
    animationManager.add('arrow-animation', {
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: 'https://assets4.lottiefiles.com/packages/lf20_c64I86.json' // Example Lottie path
    });
    const swiperWrapper = document.getElementById('swiper-wrapper');
    const slides = document.querySelectorAll('.swiper-slide');
    const dotsContainer = document.getElementById('dots-container');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    let currentSlide = 0, autoSwipeTimer, touchStartX = 0, touchEndX = 0;
    function goToSlide(slideIndex, isAuto = false) {
        if (!isAuto) resetAutoSwipe();
        currentSlide = slideIndex;
        swiperWrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        slides.forEach((s, i) => s.classList.toggle('active', i === currentSlide));
        document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === currentSlide));
    }

    const nextSlide = () => goToSlide((currentSlide + 1) % slides.length, true);
    const resetAutoSwipe = () => {
        clearInterval(autoSwipeTimer);
        autoSwipeTimer = setInterval(nextSlide, 3500);
    };
    slides.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.className = 'dot w-2 h-2 bg-gray-300 rounded-full cursor-pointer';
        dot.onclick = () => goToSlide(i);
        dotsContainer.appendChild(dot);
    });
    const handleSwipe = () => {
        if (touchEndX < touchStartX - 50) nextSlide();
        if (touchEndX > touchStartX + 50) goToSlide((currentSlide - 1 + slides.length) % slides.length);
    };
    swiperWrapper.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        clearInterval(autoSwipeTimer);
    }, { passive: true });
    swiperWrapper.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
        resetAutoSwipe();
    });
    startQuizBtn.addEventListener('click', () => {
        clearInterval(autoSwipeTimer);
        const swiperContainer = document.getElementById('swiper-container');
        const chatSection = document.getElementById('chat-section');
        swiperContainer.style.opacity = '0';
        swiperContainer.style.transform = 'scale(0.9)';
        setTimeout(() => {
            swiperContainer.style.display = 'none';
            chatSection.classList.add('active');
            animationManager.add('dave-chat-avatar', {
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: 'https://assets2.lottiefiles.com/packages/lf20_g8tG0M.json' // Example Lottie path
            });
            initQuiz();
        }, 600);
    });

    goToSlide(0);

    // --- SESSION MANAGEMENT ---
    function saveQuizState() {
        if (sessionId) {
            localStorage.setItem('quiz_session_id', sessionId);
            localStorage.setItem('quiz_answers', JSON.stringify(userAnswers));
            localStorage.setItem('quiz_current_index', currentQuestionIndex);
            localStorage.setItem('quiz_timestamp', Date.now());
        }
    }

    function loadQuizState() {
        const savedSessionId = localStorage.getItem('quiz_session_id');
        const savedAnswers = localStorage.getItem('quiz_answers');
        const savedIndex = localStorage.getItem('quiz_current_index');
        const savedTimestamp = localStorage.getItem('quiz_timestamp');
        if (savedSessionId && savedTimestamp) {
            const age = Date.now() - parseInt(savedTimestamp);
            if (age < 24 * 60 * 60 * 1000) { // 24-hour session validity
                return {
                    sessionId: savedSessionId,
                    answers: savedAnswers ?
                    JSON.parse(savedAnswers) : {},
                    currentIndex: parseInt(savedIndex) || 0
                };
            }
        }
        return null;
    }

    function clearQuizState() {
        localStorage.removeItem('quiz_session_id');
        localStorage.removeItem('quiz_answers');
        localStorage.removeItem('quiz_current_index');
        localStorage.removeItem('quiz_timestamp');
    }

    // --- DAVE STATUS ---
    const setDaveStatus = (status) => {
        daveStatusEl.style.opacity = '0';
        setTimeout(() => {
            if (status === 'typing...') {
                daveStatusEl.classList.remove('text-green-500');
                daveStatusEl.classList.add('text-yellow-500');
            } else {
                daveStatusEl.classList.remove('text-yellow-500');
                daveStatusEl.classList.add('text-green-500');
            }
            daveStatusEl.textContent = status;
            daveStatusEl.style.opacity = '1';
        }, 200);
    };

    // --- QUIZ QUESTIONS ---
    const quizQuestions = [
        { 
            key: 'userGoal', // New key name
            type: 'question', 
            text: "Great, let's get started! To help me better, what are you most interested in?", 
            options: [
                'Find out my biological age', 
                'Get a skin condition analysis', 
                'Get a 7-day improvement plan', 
                'All of the above!'
            ],
            hideInput: true // Hide the text input field
        },
        { key: 'intro_purpose', type: 'message', text: "Perfect. I'm now calibrating my analysis just for you...", delayBefore: 1500 },
        { key: 'age', type: 'slider', text: "To start, what's your age? 🎂", label: "Select your age", min: 18, max: 90, step: 1, defaultValue: 30, unit: 'years' },
        { key: 'gender', type: 'question', text: "Got it. What's your biological sex? 🧬", options: ['Male', 'Female', 'Other'], hideInput: true },
        { key: 'height', type: 'slider', text: "Perfect. And your height? 📏", label: "Select your height", min: 140, max: 220, step: 1,
            defaultValue: 175, unit: 'cm' },
        { key: 'weight', type: 'slider', text: "Thanks! And your current weight? ⚖️", label: "Select your weight", min: 40, max: 150, step: 1, defaultValue: 70, unit: 'kg' },
        { key: 'bmi_calculation', type: 'message', text: "Calculating your BMI based on your stats...", postAnimationDelay: 2000 },
        { key: 'sleep', type: 'question', text: "Sleep is crucial. 😴 How many hours of <i>quality</i> sleep do you get on an average night?", options: ["Less than 5 hours", "5-6 hours", "7-8 hours", "More than 8 hours"], hideInput: true },
        { key: 'sleep_visual', type: 'message', text: 'Quality sleep recharges your mind and body.' },
        { key: 'activity', type: 'question', text: "Movement is key! 🏃‍♀️ How often do you engage in moderate physical activity per week?", options: ["Rarely", "1-2 times", "3-4 times", "5+ times"], hideInput: true },
        { key: 'activity_visual', type: 'message', text: 'Every bit of movement counts!' },
        { key: 'nutrition', type: 'question', text: "Let's talk nutrition. 🥦 How many servings of fruits or vegetables do you typically eat per day?", options: ["0-1", "2-3", "4-5", "More than 5"], hideInput: true },
        { key: 'processed_food', type: 'question', text: "Honesty is the best policy here. 😉 How often do you eat processed or fast food in a typical week?", options: ["Rarely", "1-2 times", "3-4 times", "Daily"], hideInput: true },
        { key: 'hydration', type: 'question', text: "Hydration check! 💧 How many glasses of water do you drink per day?", options: ["1-3 glasses", "4-6 glasses", "7-9 glasses", "10+ glasses"], hideInput: true },
        { key: 'hydration_visual', type: 'message', text: "Let's see your hydration level:" },
        { key: 'stress', type: 'slider', text: "Now for the mind. 🧠 How would you rate your typical stress level?", label: "Drag to indicate your stress level", min: 1, max: 10, step: 1, defaultValue: 5, unit: 'stress', isGradient: true },
        { key: 'stress_gauge', type: 'message', text: "Thanks for sharing. Here's what that looks like:" },
        { key: 'mindfulness', type: 'question', text: `Finding calm is a superpower. 🧘‍♂️ How often do you practice mindfulness, meditation, or deep breathing?`, options: ["Never", "Occasionally", "Weekly", "Daily"], hideInput: true },
        { key: 'mood', type: 'question', text: "Let's check in. ❤️ How would you describe your overall mood on a typical day?", options: ["Happy & Energetic", "Generally Content", "It varies a lot", "Often Stressed or Sad"], hideInput: true },
        { key: 'alcohol', type: 'question', text: "Time for some lifestyle questions. 🍻 How many alcoholic drinks do you have in a typical week?", options: ["0", "1-3", "4-7", "8+"], hideInput: true },
        { key: 'smoking', type: 'question', text: "This is a safe space. 🚭 Do you smoke or use tobacco products?", options: ["No, never", "Used to, but quit", "Occasionally", "Yes, daily"], hideInput: true },
        { key: 'screen_time', type: 'question', text: "Last question before the final step! 📱 How much time do you spend on screens outside of work?", options: ["Less than 2 hours", "2-4 hours", "4-6 hours", "More than 6 hours"], hideInput: true },
        {   key: 'camera',   type: 'final_step',   text: `Excellent work! 🎉 You're almost done.<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 my-3">  <img src="https://i.ibb.co/6y40YJ7/face.jpg" alt="AI Face Analysis" class="w-full max-w-[200px] mx-auto rounded-lg mb-3">   <p class="text-sm text-gray-700 text-center">   Our AI needs to see your face using advanced analysis tools to provide a comprehensive wellness assessment. To do this, we need permission to access your camera.  </p>   <div class="flex items-center justify-center gap-2 mt-3 text-xs text-gray-600">   <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>   </svg>   <span>Analysis happens instantly • Photo deleted in 3 seconds</span>  </div></div>`}
    ];

    // --- SESSION START ---
    async function startQuizSession() {
        const savedState = loadQuizState();
        if (savedState) {
            sessionId = savedState.sessionId;
            userAnswers = savedState.answers;
            currentQuestionIndex = savedState.currentIndex;
            console.log('Restored session:', sessionId);
            initializeGlobalErrorHandlers();
            return true;
        }
        const getDeviceType = () => {
            const userAgent = navigator.userAgent.toLowerCase();
            const width = window.innerWidth;
            let os = 'Unknown';
            if (/iphone|ipad|ipod/.test(userAgent)) os = 'iOS';
            else if (/android/.test(userAgent)) os = 'Android';
            else if (/windows phone/.test(userAgent)) os = 'Windows Phone';
            else if (/mac os x/.test(userAgent)) os = 'macOS';
            else if (/windows/.test(userAgent)) os = 'Windows';
            else if (/linux/.test(userAgent)) os = 'Linux';

            let device = 'Desktop';
            if (width < 768) device = 'Mobile';
            else if (width < 1024) device = 'Tablet';

            return `${device}/${os}`;
        };
        const getTrafficSource = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const utm_source = urlParams.get('utm_source');
            const utm_medium = urlParams.get('utm_medium');
            const utm_campaign = urlParams.get('utm_campaign');
            const ref = document.referrer.toLowerCase();
            if (utm_source) {
                if (utm_campaign) return `${utm_source}/${utm_campaign}`;
                if (utm_medium) return `${utm_source}/${utm_medium}`;
                return utm_source;
            }

            if (ref === '') return 'Direct';
            if (ref.includes('google.')) return 'Google Search';
            if (ref.includes('bing.')) return 'Bing';
            if (ref.includes('facebook.com')) return 'Facebook';
            if (ref.includes('instagram.com')) return 'Instagram';
            try {
                const refUrl = new URL(ref);
                return `Referral/${refUrl.hostname.replace('www.', '')}`;
            } catch {
                return 'Referral';
            }
        };
        try {
            const response = await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'startSession',
                    source: getTrafficSource(),
                    deviceType: getDeviceType()
                })
            });
            if (!response.ok) throw new Error('Could not start session');
            const data = await response.json();
            sessionId = data.sessionId;
            await new Promise(resolve => setTimeout(resolve, 1000));
            saveQuizState();
            initializeGlobalErrorHandlers();
            return false;
        } catch (error) {
            console.error('Failed to start session:', error);
            addBotMessage("Sorry, I'm having trouble connecting. Please try refreshing the page.");
            inputArea.style.display = 'none';
            return false;
        }
    }

    async function saveAnswerToServer(questionKey, answer, retryCount = 0) {
        if (!sessionId) {
            console.error('No session ID available');
            return false;
        }
        userAnswers[questionKey] = answer;
        saveQuizState();
        try {
            const response = await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveAnswer',
                    sessionId: sessionId,
                    questionId: questionKey,
                    answer: answer
                })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return true;
        } catch (error) {
            console.error('Failed to save answer:', error);
            if (retryCount === 0 && error.message.includes('500')) {
                console.log('Retrying save after delay...');
                await new Promise(resolve => setTimeout(resolve, 1500));
                return saveAnswerToServer(questionKey, answer, 1);
            }
            console.log('Answer saved locally, server sync failed');
            return false;
        }
    }


    // --- UI FUNCTIONS ---
    function scrollToBottom() {
        requestAnimationFrame(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        });
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex justify-start mb-4 chat-bubble';
        typingDiv.innerHTML = `
            <div class="bg-gray-200 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatContainer.appendChild(typingDiv);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator')?.remove();
    }

    function addBotMessage(html) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start mb-4 chat-bubble';
        messageDiv.innerHTML = `
            <div class="bg-gray-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">
                ${html}
            </div>
        `;
        chatContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function addUserMessage(text) {
        const d = document.createElement('div');
        d.className = 'flex justify-end mb-4 chat-bubble';
        d.innerHTML = `
            <div class="bg-purple-600 text-white p-3 rounded-tl-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">
                ${text}
            </div>
        `;
        chatContainer.appendChild(d);
        scrollToBottom();
    }

    function updateProgressBar() {
        const questionKeys = quizQuestions.filter(q =>
            q.type === 'question' || q.type === 'slider'
        ).map(q => q.key);
        const totalSteps = questionKeys.length + 1; // +1 for the photo step
        const completedAnswers = Object.keys(userAnswers).filter(key =>
            questionKeys.includes(key)
        ).length;
        const photoStepCompleted = userAnswers['selfie'] ? 1 : 0;
        const progress = ((completedAnswers + photoStepCompleted) / totalSteps) * 100;
        progressBar.style.width = `${progress}%`;
    }

    function showOptions(options, handlers) {
        optionsContainer.innerHTML = '';
        if (options?.length > 0) {
            optionsContainerWrapper.classList.remove('hidden');
            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = option.class;
                button.onclick = handlers[index];
                optionsContainer.appendChild(button);
            });
        } else {
            optionsContainerWrapper.classList.add('hidden');
        }
    }

    function showSlider(question) {
        optionsContainer.innerHTML = '';
        optionsContainerWrapper.classList.remove('hidden');
        inputArea.classList.add('hidden');

        const sliderWrapper = document.createElement('div');
        sliderWrapper.className = 'slider-widget';

        const formatDisplayValue = (value) => {
            if (question.unit === 'stress') {
                if (value <= 3) return `<span style="color: #22c55e;">Low</span>`;
                if (value <= 7) return `<span style="color: #f59e0b;">Medium</span>`;
                return `<span style="color: #ef4444;">High</span>`;
            }
            if (question.unit === 'cm') {
                const feet = Math.floor(value / 30.48);
                const inches = Math.round((value % 30.48) / 2.54);
                return `${feet}'${inches}" <span class="text-lg ml-2 text-purple-400">(${value} cm)</span>`;
            }
            if (question.unit === 'kg') {
                const lbs = (value * 2.20462).toFixed(0);
                return `${lbs} lbs <span class="text-lg ml-2 text-purple-400">(${value} kg)</span>`;
            }
            return `${value} ${question.unit}`;
        };

        const sliderInputClass = question.isGradient ? 'slider-input slider-input-gradient' : 'slider-input';
        const markersHTML = question.isGradient ?
            `<div class="slider-markers"><span>Low</span><span>Medium</span><span>High</span></div>` : '';

        sliderWrapper.innerHTML = `
            <div class="text-center">
                <div id="slider-value-display" class="slider-value">${formatDisplayValue(question.defaultValue)}</div>
                <div class="slider-label">${question.label}</div>
            </div>
            <input type="range" min="${question.min}" max="${question.max}" value="${question.defaultValue}"
                   step="${question.step}" class="${sliderInputClass}" id="slider-input-range">
            ${markersHTML}
            <button id="slider-confirm-btn" class="confirm-btn">Confirm</button>
        `;
        optionsContainer.appendChild(sliderWrapper);

        const sliderInput = document.getElementById('slider-input-range');
        const valueDisplay = document.getElementById('slider-value-display');
        const confirmBtn = document.getElementById('slider-confirm-btn');
        sliderInput.addEventListener('input', (e) => {
            valueDisplay.innerHTML = formatDisplayValue(e.target.value);
        });
        confirmBtn.onclick = () => {
            const finalValue = sliderInput.value;
            let displayAnswerText = '';

            if (question.unit === 'stress') {
                if (finalValue <= 3) displayAnswerText = 'Low';
                else if (finalValue <= 7) displayAnswerText = 'Medium';
                else displayAnswerText = 'High';
            } else if (question.unit === 'cm') {
                const feet = Math.floor(finalValue / 30.48);
                const inches = Math.round((finalValue % 30.48) / 2.54);
                displayAnswerText = `${feet}'${inches}"`;
            } else if (question.unit === 'kg') {
                const lbs = (finalValue * 2.20462).toFixed(0);
                displayAnswerText = `${lbs} lbs`;
            } else {
                displayAnswerText = `${finalValue} ${question.unit}`;
            }

            handleAnswer(finalValue, displayAnswerText);
        };
    }

    // --- ANIMATIONS ---
    function parseHeightToInches(heightVal) {
        if (!heightVal) return 68;
        if (!isNaN(parseFloat(heightVal))) {
            return parseFloat(heightVal) / 2.54;
        }
        let inches = 0;
        const feetMatch = heightVal.match(/(\d+)\s*(ft|')/);
        const inchesMatch = heightVal.match(/(\d+)\s*(in|")/);
        if (feetMatch) inches += parseInt(feetMatch[1]) * 12;
        if (inchesMatch) inches += parseInt(inchesMatch[1]);
        return inches > 0 ? inches : 68;
    }

    function playBmiAnimation() {
        const heightIn = parseHeightToInches(userAnswers.height);
        const weightLbs = (parseInt(userAnswers.weight) || 70) * 2.20462;

        if (heightIn && weightLbs) {
            const bmi = ((weightLbs / (heightIn * heightIn)) * 703).toFixed(1);
            let category = "Normal";
            let percent = 50;

            if (bmi < 18.5) {
                category = "Underweight";
                percent = (bmi / 18.5) * 25;
            } else if (bmi < 25) {
                category = "Normal";
                percent = 25 + ((bmi - 18.5) / 6.5) * 50;
            } else if (bmi < 30) {
                category = "Overweight";
                percent = 75 + ((bmi - 25) / 5) * 25;
            } else {
                category = "Obese";
                percent = 100;
            }

            percent = Math.max(5, Math.min(95, percent));
            const html = `
                <div class="bmi-widget">
                    <div id="bmi-value-anim" class="bmi-value">0.0</div>
                    <div class="text-sm font-semibold text-gray-600 mb-2">Your Estimated BMI</div>
                    <div class="bmi-scale">
                        <div id="bmi-indicator-anim" class="bmi-indicator" style="left: 0%;"></div>
                    </div>
                    <div id="bmi-category-anim" class="text-sm font-medium text-purple-600 mt-2">&nbsp;</div>
                </div>
            `;
            addBotMessage(html);

            setTimeout(() => {
                const valEl = document.getElementById('bmi-value-anim');
                const catEl = document.getElementById('bmi-category-anim');
                const indEl = document.getElementById('bmi-indicator-anim');

                if(indEl) indEl.style.left = `${percent}%`;
                if(catEl) catEl.textContent = category;

                let start = 0;
                const end = parseFloat(bmi);
                const animDuration = 1500;
                const frameDuration = 1000 / 60;
                const totalFrames = Math.round(animDuration / frameDuration);
                let frame = 0;

                const countUp = setInterval(() => {
                    frame++;
                    const progress = frame / totalFrames;
                    const currentVal = (start + (end - start) * progress).toFixed(1);
                    if(valEl) valEl.textContent = currentVal;

                    if (frame === totalFrames) {
                        clearInterval(countUp);
                        if(valEl) valEl.textContent = bmi;
                    }
                }, frameDuration);
            }, 100);
        }
    }

    function playSleepAnimation() {
        const answer = userAnswers.sleep || "";
        let level = 25;
        if (answer.includes("5-6")) level = 50;
        if (answer.includes("7-8")) level = 90;
        if (answer.includes("More than 8")) level = 100;

        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Sleep Recharge</div>
                <svg class="w-16 h-16 mx-auto text-purple-400 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                </svg>
                <div class="sleep-battery mt-2">
                    <div id="sleep-battery-level-anim" class="sleep-battery-level"></div>
                </div>
            </div>
        `;

        addBotMessage(html);

        setTimeout(() => {
            const levelEl = document.getElementById('sleep-battery-level-anim');
            if (!levelEl) return;

            let color = '#ef4444';
            if (level > 40) color = '#f59e0b';
            if (level > 75) color = '#22c55e';

            levelEl.style.backgroundColor = color;
            levelEl.style.width = `${level}%`;
        }, 100);
    }

    function playActivityAnimation() {
        const answer = userAnswers.activity || "";
        let days = 1;
        if (answer.includes("1-2")) days = 2;
        if (answer.includes("3-4")) days = 4;
        if (answer.includes("5+")) days = 6;
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Your Active Week</div>
                <div class="activity-week" id="activity-week-anim">
                    <div class="activity-day">M</div>
                    <div class="activity-day">T</div>
                    <div class="activity-day">W</div>
                    <div class="activity-day">T</div>
                    <div class="activity-day">F</div>
                    <div class="activity-day">S</div>
                    <div class="activity-day">S</div>
                </div>
            </div>
        `;
        addBotMessage(html);

        setTimeout(() => {
            const weekEl = document.getElementById('activity-week-anim');
            if (!weekEl) return;

            const dayElements = weekEl.children;
            const daysToActivate = [0, 2, 4, 1, 3, 5, 6]; 

            for (let i = 0; i < days; i++) {
                setTimeout(() => {
                    dayElements[daysToActivate[i]].classList.add('active');
                }, i * 250);
            }
        }, 100);
    }

    function playHydrationAnimation() {
        const answer = userAnswers.hydration || "";
        let level = 25;
        if (answer.includes("4-6")) level = 50;
        if (answer.includes("7-9")) level = 75;
        if (answer.includes("10+")) level = 100;
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Body Hydration</div>
                <svg class="w-20 h-24 mx-auto" viewBox="0 0 120 160">
                    <defs>
                        <clipPath id="humanoid-clip">
                            <path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z"></path>
                        </clipPath>
                    </defs>
                    <g clip-path="url(#humanoid-clip)">
                        <rect x="0" y="0" width="120" height="160" fill="#ede9fe"/>
                        <rect id="hydration-water-fill" x="0" y="0" width="120" height="160" fill="#818cf8" style="transform: translateY(160px);"/>
                    </g>
                    <path d="M60,20 C40,20 20,40 20,60 C20,80 40,100 60,100 C80,100 100,80 100,60 C100,40 80,20 60,20 M60,105 C40,105 20,120 20,140 L100,140 C100,120 80,105 60,105 Z" fill="none" stroke="#a78bfa" stroke-width="6"/>
                </svg>
                <div id="hydration-percentage" class="font-bold text-xl text-indigo-600 mt-2">0%</div>
            </div>
        `;

        addBotMessage(html);

        setTimeout(() => {
            const waterEl = document.getElementById('hydration-water-fill');
            const textEl = document.getElementById('hydration-percentage');
            if (!waterEl || !textEl) return;

            const yPos = 160 - (160 * (level / 100));
            waterEl.style.transform = `translateY(${yPos}px)`;
            textEl.style.opacity = '1';

            let currentLevel = 0;
            const levelUp = setInterval(() => {
                currentLevel++;
                textEl.textContent = `${currentLevel}%`;
                if (currentLevel >= level) clearInterval(levelUp);
            }, 1500 / level);
        }, 100);
    }

    function playStressGaugeAnimation() {
        const stressAnswer = userAnswers.stress || "1";
        const level = parseInt(stressAnswer.match(/\d+/)[0]);
        const percent = (level - 1) / 9 * 100;

        let color = '#4ade80';
        if (level > 4) color = '#facc15';
        if (level > 7) color = '#f87171';
        const html = `
            <div class="widget-wrapper">
                <div class="widget-label">Reported Stress Level</div>
                <div class="stress-bar-track">
                    <div id="stress-bar-fill-anim" class="stress-bar-fill"></div>
                </div>
                <div id="stress-value-anim" class="stress-value">${level}/10</div>
            </div>
        `;
        addBotMessage(html);

        setTimeout(() => {
            const fillEl = document.getElementById('stress-bar-fill-anim');
            const textEl = document.getElementById('stress-value-anim');
            if (!fillEl || !textEl) return;

            fillEl.style.width = `${percent}%`;
            textEl.style.color = color;
        }, 100);
    }

    // --- QUIZ FLOW ---
    function handleAnswer(answerToStore, answerToDisplay) {
        const valueToStore = (answerToStore || '').toString();
        if (!valueToStore.trim()) return;

        const currentQuestion = quizQuestions[currentQuestionIndex];
        const valueToDisplay = answerToDisplay || valueToStore;

        addUserMessage(valueToDisplay);
        userAnswers[currentQuestion.key] = valueToStore.trim();
        saveAnswerToServer(currentQuestion.key, valueToStore.trim());
        userInput.value = '';
        userInput.blur();
        inputArea.classList.add('hidden');
        optionsContainerWrapper.classList.add('hidden');

        currentQuestionIndex++;
        updateProgressBar();
        askNextQuestion();
    }

    function askNextQuestion() {
        if (currentQuestionIndex >= quizQuestions.length) return;
        const question = quizQuestions[currentQuestionIndex];
        const messageDelay = 1800;

        setDaveStatus('typing...');
        showTypingIndicator();

        const delay = question.delayBefore || messageDelay;
        setTimeout(() => {
            hideTypingIndicator();
            setDaveStatus('Online');

            let questionText = typeof question.text === 'function' ?
                question.text(userAnswers.name || 'friend') : question.text;

            let postAnimationDelay = question.postAnimationDelay || 0;

            if (question.type === 'message') {
                addBotMessage(questionText);

                if (question.key === 'bmi_calculation') {
                    setTimeout(playBmiAnimation, 100);
                } else if (question.key === 'stress_gauge') {
                    setTimeout(playStressGaugeAnimation, 100);
                } else if (question.key === 'sleep_visual') {
                    setTimeout(playSleepAnimation, 100);
                } else if (question.key === 'activity_visual') {
                    setTimeout(playActivityAnimation, 100);
                } else if (question.key === 'hydration_visual') {
                    setTimeout(playHydrationAnimation, 100);
                }

                currentQuestionIndex++;
                setTimeout(askNextQuestion, postAnimationDelay || 1500);

            } else if (question.type === 'question') {
                addBotMessage(questionText);
                const optionButtons = question.options?.map(opt => ({
                    text: opt,
                    class: 'option-btn bg-white border border-purple-300 text-purple-600 px-4 py-2 rounded-full text-sm flex-shrink-0 hover:bg-purple-50'
                }));
                const handlers = question.options?.map(opt => () => handleAnswer(opt));

                if (question.options && question.options.length > 0) {
                    showOptions(optionButtons, handlers);
                }

                if (question.hideInput) {
                    inputArea.classList.add('hidden');
                } else {
                    inputArea.classList.remove('hidden');
                    userInput.placeholder = question.placeholder || "Type...";
                    if (window.innerWidth > 768) {
                        userInput.focus();
                    }
                }

            } else if (question.type === 'slider') {
                addBotMessage(questionText);
                showSlider(question);

            } else if (question.type === 'final_step') {
                inputArea.classList.add('hidden');
                addBotMessage(questionText);

                fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'endQuiz',
                        sessionId: sessionId
                    })
                });
                showCameraStep();
            }
        }, delay);
    }

    // --- CAMERA FUNCTIONALITY ---
    function resizeAndCompressImage(dataUrl, maxSizeMB = 2) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let maxWidth = 1200;
                let maxHeight = 1200;
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                let quality = 0.9;
                let output = canvas.toDataURL('image/jpeg', quality);
                while (output.length > maxSizeMB * 1024 * 1024 * 1.37 && quality > 0.1) {
                    quality -= 0.1;
                    output = canvas.toDataURL('image/jpeg', quality);
                }
                console.log(`Image compressed: quality=${quality.toFixed(1)}, size=${(output.length/1024/1024).toFixed(2)}MB`);
                resolve(output);
            };
            img.src = dataUrl;
        });
    }

    function showCameraStep() {
        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.remove('hidden');
        inputArea.innerHTML = `
            <div class="space-y-3">
                <div class="text-center text-xs text-gray-500">
                    <span class="inline-flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        Secure & Private Analysis
                    </span>
                </div>
                <button id="open-camera-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-full hover:bg-purple-700 transition-colors shadow-lg">
                    Allow Camera Access
                </button>
                <div class="text-center">
                    <button id="upload-photo-btn" class="text-sm text-gray-600 underline hover:text-gray-800">
                        Or upload a photo
                    </button>
                </div>
            </div>
        `;
        document.getElementById('open-camera-btn').onclick = startCamera;
        document.getElementById('upload-photo-btn').onclick = handlePhotoUpload;

        // ADD NEW LOGIC:
        const skipButton = document.createElement('button');
        skipButton.id = 'skip-photo-btn';
        skipButton.className = 'w-full text-center text-sm text-gray-500 hover:text-gray-700 mt-2';
        skipButton.textContent = 'Skip and continue without photo analysis';
        
        // Add button to the container
        document.getElementById('upload-photo-btn').parentElement.parentElement.appendChild(skipButton);
        
        // Click handler for the "Skip" button
        skipButton.onclick = async () => {
            addUserMessage("I'll skip the photo step");
            // Save that the user skipped the step
            await saveAnswerToServer('selfie', 'skipped');
            updateProgressBar();

            // Hide the camera options
            optionsContainerWrapper.classList.add('hidden');
            inputArea.classList.add('hidden');

            // Proceed to the next step - email request
            await askForEmailAfterPhoto();
            showCompletionAnimation();
            
            // Trigger background report generation without skin analysis data
             try {
                 fetch('/.netlify/functions/result-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
            } catch (error) {
                console.error('Error during result generation (skipped photo):', error);
                 logErrorToServer({
                    message: 'Result Generation Error (skipped photo)',
                    details: error.message
                });
            }
        };
    }

    function handlePhotoUpload() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    addBotMessage("The photo is too large. Please choose a smaller image (max 10MB).");
                    return;
                }
                const reader = new FileReader();
                reader.onload = async (e) => {
                    addBotMessage("Processing your photo...");
                    const compressedDataUrl = await resizeAndCompressImage(e.target.result, 2);
                    capturedPhotoDataUrl = compressedDataUrl;
                    userAnswers['selfie'] = 'Photo uploaded';
                    updateProgressBar();
                    const messages = chatContainer.querySelectorAll('.chat-bubble');
                    if (messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        if (lastMessage.textContent.includes('Processing')) {
                            lastMessage.remove();
                        }
                    }
                    showPhotoForConfirmation();
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    }

    async function startCamera() {
        cameraModal.classList.add('active');
        try {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL)
            ]);
            loaderText.textContent = "Requesting camera access...";
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user' }
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                cameraLoader.style.display = 'none';
                startFaceDetection();
            };
        } catch (err) {
            console.error("Camera/Model Error:", err);
            logErrorToServer({
                message: 'Camera or Face-API Model Error',
                details: err.message
            });
            loaderText.textContent = "Camera access denied. Please refresh and try again.";
            setTimeout(stopCamera, 3000);
        }
    }

    function stopCamera() {
        clearInterval(detectionInterval);
        stream?.getTracks().forEach(track => track.stop());
        cameraModal.classList.remove('active');
        video.srcObject = null;
    }

    function startFaceDetection() {
        let captureTimeout;
        const context = canvas.getContext('2d');

        detectionInterval = setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video,
                new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);


            context.clearRect(0, 0, canvas.width, canvas.height);
            context.save();
            context.translate(canvas.width, 0);
            context.scale(-1, 1);

            if (detections.length > 0) {
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const box = resizedDetections[0].detection.box;

                context.strokeStyle = 'rgba(0, 255, 255, 0.4)';
                context.lineWidth = 1;
                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections[0].landmarks, { drawLines: true });

                context.strokeStyle = '#00FFFF';
                context.lineWidth = 3;
                context.shadowColor = '#00FFFF';
                context.shadowBlur = 10;

                const cornerLength = box.width * 0.1;
                context.beginPath();
                context.moveTo(box.x, box.y + cornerLength);
                context.lineTo(box.x, box.y);
                context.lineTo(box.x + cornerLength, box.y);
                context.moveTo(box.x + box.width - cornerLength, box.y);
                context.lineTo(box.x + box.width, box.y);
                context.lineTo(box.x + box.width, box.y + cornerLength);
                context.moveTo(box.x, box.y + box.height - cornerLength);
                context.lineTo(box.x, box.y + box.height);
                context.lineTo(box.x + cornerLength, box.y + box.height);
                context.moveTo(box.x + box.width - cornerLength, box.y + box.height);
                context.lineTo(box.x + box.width, box.y + box.height);
                context.lineTo(box.x + box.width, box.y + box.height - cornerLength);
                context.stroke();
                context.shadowBlur = 0;

                const isGoodSize = box.width > canvas.width * 0.4;
                if (isGoodSize) {
                    cameraStatus.textContent = "Hold still...";
                    if (!captureTimeout) {
                        captureTimeout = setTimeout(() => takePhoto(), 1500);
                    }
                } else {
                    cameraStatus.textContent = "Move closer";
                    clearTimeout(captureTimeout);
                    captureTimeout = null;
                }
            } else {
                cameraStatus.textContent = "Position your face";
                clearTimeout(captureTimeout);
                captureTimeout = null;
            }
            context.restore();
        }, 100);
    }

    function takePhoto() {
        clearInterval(detectionInterval);
        cameraStatus.textContent = "Perfect!";
        const photoCanvas = document.createElement('canvas');
        photoCanvas.width = video.videoWidth;
        photoCanvas.height = video.videoHeight;
        const photoContext = photoCanvas.getContext('2d');
        photoContext.translate(video.videoWidth, 0);
        photoContext.scale(-1, 1);
        photoContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
        const tempDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9);
        resizeAndCompressImage(tempDataUrl, 2).then(compressedDataUrl => {
            capturedPhotoDataUrl = compressedDataUrl;
            userAnswers['selfie'] = 'Photo taken';
            stopCamera();
            updateProgressBar();
            showPhotoForConfirmation();
        });
    }

    function showPhotoForConfirmation() {
        const d = document.createElement('div');
        d.id = 'photo-preview-wrapper';
        d.className = 'flex justify-start mb-4 chat-bubble';
        d.innerHTML = `
            <div class="bg-gray-100 text-gray-800 p-3 rounded-tr-2xl rounded-br-2xl rounded-bl-2xl max-w-[85%]">
                <p class="mb-2">Here's the photo.
                Happy with it?</p>
                <img src="${capturedPhotoDataUrl}" alt="Your selfie" class="rounded-lg"/>
            </div>
        `;
        chatContainer.appendChild(d);
        scrollToBottom();

        const options = [
            { text: 'Looks Good!', class: 'option-btn bg-green-500 border-green-600 text-white px-4 py-2 rounded-full text-sm flex-shrink-0 font-semibold' },
            { text: 'Retake', class: 'option-btn bg-white border-gray-300 text-gray-700 px-4 py-2 rounded-full text-sm flex-shrink-0' }
        ];
        const handlers = [startAnalysisAndShowForm, retakePhoto];
        showOptions(options, handlers);
        inputArea.classList.add('hidden');
    }

    function retakePhoto() {
        addUserMessage("Retake");
        document.getElementById('photo-preview-wrapper')?.remove();
        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.add('hidden');
        startCamera();
    }

    // --- EMAIL & PAYMENT ---
    function askForEmailAfterPhoto() {
        return new Promise((resolve) => {
            if (userAnswers.email) {
                resolve();
                return;
            }

            addBotMessage("Enter your email to get your personalized report summary. We respect your privacy and are committed to protecting your personal data.");
            inputArea.innerHTML = originalInputAreaHTML;
            userInput = document.getElementById('user-input');
            sendBtn = document.getElementById('send-btn');
            inputArea.classList.remove('hidden');
            userInput.value = '';
            userInput.placeholder = "your@email.com";
            userInput.type = 'email';

            eventManager.remove(sendBtn, 'click', 'email_submit');
            eventManager.remove(userInput, 'keypress', 'email_keypress');

            if (window.innerWidth > 768) {
                userInput.focus();
            }

            const emailSubmitHandler = async () => {
                const email = userInput.value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if (!emailRegex.test(email)) {
                    addBotMessage("Hmm, that doesn't look like a valid email. Could you please double-check it?");
                    userInput.focus();
                    return;
                }

                userAnswers.email = email;
                addUserMessage(email);

                try {
                    await saveAnswerToServer('email', email);
                } catch (error) {
                    console.error('Failed to save email:', error);
                }

                eventManager.remove(sendBtn, 'click', 'email_submit');
                eventManager.remove(userInput, 'keypress', 'email_keypress');
                inputArea.classList.add('hidden');
                userInput.value = '';
                userInput.type = 'text';
                userInput.placeholder = "Type your answer...";
                resolve();
            };
            const keyPressHandler = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    emailSubmitHandler();
                }
            };

            eventManager.add(sendBtn, 'click', emailSubmitHandler, 'email_submit');
            eventManager.add(userInput, 'keypress', keyPressHandler, 'email_keypress');
        });
    }

    async function startAnalysisAndShowForm() {
        addUserMessage("Looks Good!");
        await saveAnswerToServer('selfie', 'Photo taken');
        document.getElementById('photo-preview-wrapper')?.remove();
        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.add('hidden');

        await askForEmailAfterPhoto();
        showCompletionAnimation();
        try {
            const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ photoDataUrl: capturedPhotoDataUrl })
            });
            if (!analyzeResponse.ok) throw new Error('Skin analysis failed');

            const analysisData = await analyzeResponse.json();
            await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveAnalysisData',
                    sessionId: sessionId,
                    analysisData: analysisData
                })
            });
            fetch('/.netlify/functions/result-background', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
            });
        } catch (error) {
            console.error('Error during analysis process:', error);
            logErrorToServer({
                message: 'Skin Analysis or Result Generation Error',
                details: error.message
            });
            hideTypingIndicator();
            addBotMessage("Sorry, an issue occurred. We'll use standard analysis for your report.");
            fetch('/.netlify/functions/result-background', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
            });
        }
    }

    function showCompletionAnimation() {
        const analysisAnimationPath = 'https://assets1.lottiefiles.com/packages/lf20_rJGk7z.json'; // Example Lottie path
        confetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.6 }
        });
        setDaveStatus('typing...');
        showTypingIndicator();

        setTimeout(() => {
            hideTypingIndicator();
            setDaveStatus('Online');
            addBotMessage("Awesome work! You've completed the assessment. 🥳 I'm now analyzing your results...");

            inputArea.innerHTML = `
                <div class="analysis-container">
                    <div id="analysis-animation" class="w-32 h-32 mx-auto mb-4"></div>
                    <p id="analysis-text" class="text-gray-600">Initializing analysis...</p>
                </div>
            `;
            inputArea.classList.remove('hidden');
            scrollToBottom();

            animationManager.add('analysis-animation', {
                renderer: 'svg',
                loop: true,
                autoplay: true,
                path: analysisAnimationPath
            });

            const analysisSteps = [
                "Analyzing your data...",
                "Checking lifestyle factors...",
                "Scanning skin health...",
                "Calculating biological age...",
                "Almost ready..."
            ];
            const analysisTextElement = document.getElementById('analysis-text');
            let currentStep = 0;

            const intervalId = setInterval(() => {
                if (currentStep < analysisSteps.length) {
                    analysisTextElement.style.opacity = '0';
                    setTimeout(() => {
                        analysisTextElement.textContent = analysisSteps[currentStep];
                        analysisTextElement.style.opacity = '1';
                    }, 500);
                    currentStep++;
                } else {
                    clearInterval(intervalId);
                }
            }, 1600);
            setTimeout(() => {
                inputArea.classList.add('hidden');
                setDaveStatus('typing...');
                showTypingIndicator();

                setTimeout(() => {
                    hideTypingIndicator();
                    setDaveStatus('Online');
                    addBotMessage("Great! Your preliminary analysis is complete. Just one final step to unlock your full, personalized report.");
                    showPaymentForm();
                }, 1200);
            }, analysisSteps.length * 1600 + 500);
        }, 1000);
    }

    async function showPaymentForm() {
        fbq('track', 'InitiateCheckout', {value: 9.99, currency: 'USD'});
        let hasSentAddPaymentInfo = false;
        const sendAddPaymentInfoEvent = () => {
            if (!hasSentAddPaymentInfo) {
                fbq('track', 'AddPaymentInfo');
                hasSentAddPaymentInfo = true;
            }
        };

        optionsContainerWrapper.classList.add('hidden');
        inputArea.classList.add('hidden');
        const formHtml = `
            <div class="p-4 bg-gray-50 border-t">
                <div id="payment-wrapper" class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6">
                    <div class="text-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
                            <svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"></path>
                            </svg>
                            Secure Payment
                        </h2>
                    </div>
                    <form id="payment-form" class="space-y-4">
                        <div id="payment-request-button"></div>
                        <div id="card-element" class="p-3 border border-gray-300 rounded-md shadow-sm"></div>
                        <button id="submit-payment" type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 transition-colors text-lg shadow-md">
                            Pay $9.99
                        </button>
                        <div id="payment-message" class="hidden text-center text-red-500 text-sm pt-1"></div>
                    </form>
                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-500 mb-2">All payments are securely processed by Stripe</p>
                        <div class="flex justify-center items-center space-x-4">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_Inc._logo.svg" class="h-6" alt="Visa">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a4/Mastercard_2019_logo.svg" class="h-6" alt="Mastercard">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/American_Express_logo_%282018%29.svg" class="h-8" alt="American Express">
                        </div>
                    </div>
                </div>
            </div>
        `;
        paymentFormContainer.innerHTML = formHtml;
        paymentFormContainer.classList.remove('hidden');
        scrollToBottom();

        // The stripe publishable key is public and safe to expose on the frontend.
        stripe = Stripe('pk_live_51PBaNeRxF5E8Gg7c5iS696WCEeS13eZ8sT7yG59sW0qWv9Zc9D04pD1g8f9X4m7yT8n7h5E6R7d8I9J00B7W5qZ4m');
        try {
            const response = await fetch('/.netlify/functions/payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: sessionId })
            });
            const data = await response.json();
            clientSecret = data.clientSecret;

            if (!clientSecret) throw new Error("Client secret not received.");
            elements = stripe.elements({ clientSecret });

            const paymentRequest = stripe.paymentRequest({
                country: 'US',
                currency: 'usd',
                total: { label: 'AI Wellness Report', amount: 999 },
                requestPayerName: true,
                requestPayerEmail: true
            });

            const prButton = elements.create('paymentRequestButton', { paymentRequest });
            const canMakePayment = await paymentRequest.canMakePayment();

            if (canMakePayment) {
                prButton.mount('#payment-request-button');
            } else {
                document.getElementById('payment-request-button').style.display = 'none';
            }

            paymentRequest.on('paymentmethod', async (ev) => {
                sendAddPaymentInfoEvent();
                const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(
                    clientSecret,
                    { payment_method: ev.paymentMethod.id },
                    { handleActions: false }
                );

                if (confirmError) {
                    ev.complete('fail');
                    document.getElementById('payment-message').textContent = confirmError.message;
                } else {
                    ev.complete('success');
                    if (paymentIntent.status === "succeeded") {
                        handleSuccessfulPayment();
                    }
                }
            });
            const cardElement = elements.create("card", {
                style: { base: { fontSize: '16px' } }
            });
            cardElement.mount("#card-element");

            cardElement.on('focus', () => {
                sendAddPaymentInfoEvent();
            });
            const paymentForm = document.getElementById('payment-form');
            paymentForm.addEventListener('submit', handlePayment);

        } catch (error) {
            console.error("Failed to initialize payment form:", error);
            logErrorToServer({
                message: 'Stripe Payment Form Initialization Failed',
                details: error.message
            });
            document.getElementById('payment-wrapper').innerHTML =
                `<p class="text-center text-red-500">Could not load payment form. Error: ${error.message}</p>`;
        }
    }

    async function handlePayment(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submit-payment');
        const messageDiv = document.getElementById('payment-message');

        submitButton.disabled = true;
        try {
            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: elements.getElement('card')
                }
            });
            if (error) {
                logErrorToServer({
                    message: 'Stripe Payment Confirmation Error',
                    details: error.message
                });
                messageDiv.textContent = error.message;
                messageDiv.classList.remove('hidden');
                submitButton.disabled = false;

                await fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updatePayment',
                        sessionId: sessionId,
                        status: 'failed',
                        amountUSD: '0'
                    })
                });
            } else if (paymentIntent) {
                if (paymentIntent.status === 'succeeded') {
                    await fetch('/.netlify/functions/quiz', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'updatePayment',
                            sessionId: sessionId,
                            status: 'succeeded',
                            amountUSD: '9.99'
                        })
                    });
                    handleSuccessfulPayment();
                } else if (paymentIntent.status === 'requires_action') {
                    messageDiv.textContent = 'Additional authentication required';
                    messageDiv.classList.remove('hidden');
                }
            }
        } catch (err) {
            logErrorToServer({
                message: 'Unexpected error in handlePayment function',
                details: err.message
            });
            messageDiv.textContent = "An unexpected error occurred. Please try again.";
            messageDiv.classList.remove('hidden');
            submitButton.disabled = false;
        }
    }

    function handleSuccessfulPayment() {
        clearQuizState();
        fbq('track', 'Purchase', {value: 9.99, currency: 'USD'});

        paymentFormContainer.innerHTML = `
            <div class="p-8 text-center">
                <svg class="w-16 h-16 mx-auto text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-2xl font-bold mt-4">Payment Successful!</h3>
                <p class="text-gray-600 mt-2">Finalizing your report...</p>
            </div>
        `;
        scrollToBottom();

        setTimeout(() => {
            window.location.href = `result.html?session_id=${sessionId}&payment=success`;
        }, 2500);
    }

    // --- INITIALIZATION ---
    async function initQuiz() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlSessionId = urlParams.get('session');

        if (urlSessionId) {
            sessionId = urlSessionId;
            initializeGlobalErrorHandlers();

            try {
                const response = await fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getSession',
                        sessionId: sessionId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.answers) {
                        userAnswers = data.answers;
                        saveQuizState();
                    }
                }
            } catch (error) {
                console.error('Failed to load session data:', error);
                logErrorToServer({
                    message: 'Failed to load session data from URL',
                    details: error.message
                });
            }

            showCompletionAnimation();
            setTimeout(() => {
                inputArea.classList.add('hidden');
                setDaveStatus('typing...');
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    setDaveStatus('Online');
                    addBotMessage("Welcome back! Let's complete your payment to get your full report.");
                    showPaymentForm();
                }, 1200);
            }, 1000);
            return;
        }

        const isResumedSession = await startQuizSession();
        if (isResumedSession && currentQuestionIndex > 0) {
            addBotMessage("Welcome back! Let's continue where you left off.");
            updateProgressBar();
            askNextQuestion();
        } else {
            if (sessionId) {
                askNextQuestion();
            }
        }
    }

    // --- GLOBAL EVENT HANDLERS ---
    let globalHandlersActive = false;
    function setupGlobalHandlers() {
        if (globalHandlersActive) return;

        const globalClickHandler = () => {
            if (!inputArea.classList.contains('hidden') && userInput.type !== 'email') {
                handleAnswer(userInput.value);
            }
        };

        const globalKeyHandler = (e) => {
            if (e.key === 'Enter' && !inputArea.classList.contains('hidden') && userInput.type !== 'email') {
                e.preventDefault();
                handleAnswer(userInput.value);
            }
        };

        eventManager.add(sendBtn, 'click', globalClickHandler, 'global_click');
        eventManager.add(userInput, 'keypress', globalKeyHandler, 'global_keypress');
        globalHandlersActive = true;
    }

    // --- CLEANUP ---
    function cleanup() {
        eventManager.removeAll();
        animationManager.clear();
        if (detectionInterval) {
            clearInterval(detectionInterval);
            detectionInterval = null;
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        if (video && video.srcObject) {
            video.srcObject = null;
        }
    }

    // --- INITIAL SETUP ---
    window.addEventListener('beforeunload', cleanup);
    document.addEventListener('DOMContentLoaded', () => {
        setupGlobalHandlers();
    });

    // Check if in-app browser
    function isInAppBrowser() {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        return ua.includes('FBAN') || ua.includes('FBAV') ||
            ua.includes('Instagram') || ua.includes('Telegram');
    }

    if (isInAppBrowser()) {
        console.log('In-app browser detected:', navigator.userAgent);
    }

    // Facebook tracking
    fbq('track', 'ViewContent');
</script>

</body>
</html>
