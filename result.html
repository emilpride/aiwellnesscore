<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (все ваши DOM-элементы и функции populatePage, showError и т.д. остаются) ...

        async function main() {
            showLoadingState();
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('sessionId');

            if (!sessionId) {
                showError('Error: Session ID not found. Please take the quiz again.');
                return;
            }

            try {
                // 1. Запускаем генерацию отчета через ФОНОВУЮ функцию
                const initialResponse = await fetch('/.netlify/functions/result-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });

                // Фоновая функция вернет 202, если успешно принята в работу
                if (initialResponse.status !== 202) {
                    throw new Error('Failed to start report generation process.');
                }

                // 2. Начинаем опрос о готовности
                pollingInterval = setInterval(() => checkStatus(sessionId), 3000); // Проверяем каждые 3 секунды

            } catch (error) {
                showError(`An error occurred while starting the report: ${error.message}`);
            }
        }

        // ... (остальной JS код, включая checkStatus, остается без изменений) ...
        main();
    });
</script>
