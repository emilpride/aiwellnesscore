<!-- result.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI WELLNESSCORE — Report</title>

  <!-- Tailwind + Inter -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f7fafc; color: #0f172a; }
    .card { background: white; border-radius: 16px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .muted { color: #64748b; }
    .accent { color: #2563eb; }
    .cta { background: linear-gradient(90deg,#10b981,#34d399); color: #042f2e; }
    /* premium blur */
    .locked { filter: blur(6px); pointer-events: none; user-select: none; position: relative; }
    .lock-overlay {
      position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.0), rgba(255,255,255,0.55));
      border-radius: 12px;
    }
    .gauge { width: 240px; height: 120px; }
    .small { font-size: 0.85rem; }
  </style>

  <!-- Chart.js & html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="max-w-6xl mx-auto p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-sky-500 to-indigo-600 grid place-items-center text-white font-bold">W</div>
        <div>
          <h1 class="text-xl font-semibold">AI WELLNESSCORE</h1>
          <div class="muted text-sm">Personalized wellness intelligence</div>
        </div>
      </div>
      <div class="flex items-center gap-4 muted small">
        <div class="px-3 py-1 bg-white rounded-lg shadow text-xs">SSL Secured</div>
        <div class="px-3 py-1 bg-white rounded-lg shadow text-xs">PCI-ready</div>
        <div class="px-3 py-1 bg-white rounded-lg shadow text-xs">GDPR friendly</div>
      </div>
    </header>

    <!-- Top summary: gauge + quick metrics -->
    <section class="card p-6 grid lg:grid-cols-2 gap-6 mb-6">
      <div class="flex flex-col items-center justify-center">
        <div class="text-sm muted">Wellness Archetype</div>
        <div id="archetype" class="text-2xl font-bold accent mt-1">—</div>

        <div class="mt-6 flex items-center gap-10">
          <canvas id="gauge" class="gauge" width="240" height="120"></canvas>
          <div class="space-y-3 text-left">
            <div><div class="muted small">Biological Age</div><div id="biologicalAge" class="text-lg font-semibold">—</div></div>
            <div><div class="muted small">Energy Index</div><div id="energyIndex" class="text-lg font-semibold">—</div></div>
            <div><div class="muted small">Stress Level</div><div id="stressLevel" class="text-lg font-semibold">—</div></div>
          </div>
        </div>
      </div>

      <div>
        <h2 class="text-lg font-semibold">Quick Insights</h2>
        <div class="mt-4 grid grid-cols-1 gap-3">
          <div class="p-4 rounded-lg border">
            <div class="muted small">Main barrier</div>
            <div id="mainBarrier" class="font-medium">—</div>
          </div>
          <div class="p-4 rounded-lg border">
            <div class="muted small">Quick win</div>
            <div id="quickWin" class="font-medium">—</div>
          </div>
          <div class="p-4 rounded-lg border">
            <div class="muted small">Comparison</div>
            <div id="comparison" class="font-medium">—</div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-sm muted mb-2">Core Four Overview</h3>
          <canvas id="coreRadar" height="200"></canvas>
        </div>
      </div>
    </section>

    <!-- Free report detail -->
    <section class="card p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">Free report — metrics & Core Four</h2>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div class="p-4 rounded-lg border">
            <div class="muted small">Wellness Score</div>
            <div id="wellnessScore" class="text-3xl font-bold accent">—</div>
          </div>

          <div class="p-4 rounded-lg border">
            <div class="muted small">Biological Age</div>
            <div id="bioAge2" class="font-semibold">—</div>
          </div>

          <div class="p-4 rounded-lg border">
            <div class="muted small">Energy Index</div>
            <div id="energyIndex2" class="font-semibold">—</div>
          </div>

          <div class="p-4 rounded-lg border">
            <div class="muted small">Stress Level</div>
            <div id="stressLevel2" class="font-semibold">—</div>
          </div>
        </div>

        <div class="space-y-3">
          <!-- Mind -->
          <div class="p-4 rounded-lg border">
            <div class="muted small">Mind</div>
            <div class="flex items-center justify-between">
              <div>
                <div id="mindScore" class="text-xl font-semibold">—</div>
                <div id="mindSummary" class="muted small">—</div>
              </div>
              <div class="text-sm muted">Stress & mindfulness</div>
            </div>
          </div>

          <!-- Body -->
          <div class="p-4 rounded-lg border">
            <div class="muted small">Body</div>
            <div class="flex items-center justify-between">
              <div>
                <div id="bodyScore" class="text-xl font-semibold">—</div>
                <div id="bodySummary" class="muted small">—</div>
                <div id="bodyBMI" class="muted small mt-1">BMI: —</div>
              </div>
              <div class="text-sm muted">Activity & BMI</div>
            </div>
          </div>

          <!-- Nutrition -->
          <div class="p-4 rounded-lg border">
            <div class="muted small">Nutrition</div>
            <div id="nutritionScore" class="text-xl font-semibold">—</div>
            <div id="nutritionSummary" class="muted small">—</div>
            <div class="mt-2 muted small">F/V per day: <span id="fruitsVeg">—</span> • Processed: <span id="processedLevel">—</span> • Water (L): <span id="waterL">—</span></div>
          </div>

          <!-- Sleep -->
          <div class="p-4 rounded-lg border">
            <div class="muted small">Sleep</div>
            <div id="sleepScore" class="text-xl font-semibold">—</div>
            <div id="sleepSummary" class="muted small">—</div>
            <div class="mt-2 muted small">Hours: <span id="sleepHours">—</span> • Visual: <span id="sleepVisual">—</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PREMIUM REPORT area (headers visible) -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Premium report — advanced analytics (locked)</h2>
        <div class="text-sm muted">Unlock for full insights</div>
      </div>

      <div id="premiumWrap" class="grid md:grid-cols-2 gap-6">
        <!-- Detailed Analytics -->
        <div class="card p-4 relative">
          <h3 class="font-semibold">Detailed Analytics</h3>
          <div class="mt-3 lockable" data-key="detailedAnalytics">
            <div class="grid grid-cols-2 gap-2">
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Metabolic Age</div>
                <div id="metabolicAge" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Recovery Score</div>
                <div id="recoveryScore" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Inflammation Risk</div>
                <div id="inflammationRisk" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Digital Wellness</div>
                <div id="digitalWellness" class="font-semibold">—</div>
              </div>
            </div>
            <canvas id="premiumBar" class="mt-4" height="140"></canvas>
          </div>
          <div class="lock-overlay hidden" aria-hidden="true"><button class="cta px-4 py-2 rounded">Unlock Premium</button></div>
        </div>

        <!-- Face Analysis -->
        <div class="card p-4 relative">
          <h3 class="font-semibold">Face Analysis (Face++)</h3>
          <div class="mt-3 lockable" data-key="faceAnalysis">
            <div class="grid grid-cols-2 gap-2">
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Skin Health Score</div>
                <div id="skinHealthScore" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Hydration Assessment</div>
                <div id="hydrationAssessment" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border col-span-2">
                <div class="muted small">Sleep Debt Visualization</div>
                <div id="sleepDebtVisualization" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border col-span-2">
                <div class="muted small">Stress Markers</div>
                <div id="stressMarkers" class="font-semibold">—</div>
              </div>
            </div>
          </div>
          <div class="lock-overlay hidden" aria-hidden="true"><button class="cta px-4 py-2 rounded">Unlock Premium</button></div>
        </div>

        <!-- Recommendations -->
        <div class="card p-4 relative">
          <h3 class="font-semibold">Personalized Recommendations</h3>
          <div class="mt-3 lockable" data-key="recommendations">
            <div class="grid gap-2">
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Circadian Reset Protocol</div>
                <div id="circadianReset" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Nutrition Gaps</div>
                <div id="nutritionGaps" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Exercise Prescription</div>
                <div id="exercisePrescription" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Stress Management Toolkit</div>
                <div id="stressToolkit" class="font-semibold">—</div>
              </div>
            </div>
          </div>
          <div class="lock-overlay hidden" aria-hidden="true"><button class="cta px-4 py-2 rounded">Unlock Premium</button></div>
        </div>

        <!-- Forecasts -->
        <div class="card p-4 relative">
          <h3 class="font-semibold">Forecasts</h3>
          <div class="mt-3 lockable" data-key="forecasts">
            <div class="p-3 rounded bg-white/5 border">
              <div class="muted small">30-Day Potential</div>
              <div id="thirtyDayPotential" class="font-semibold">—</div>
            </div>
            <div class="p-3 rounded bg-white/5 border mt-2">
              <div class="muted small">Risk Timeline</div>
              <div id="riskTimeline" class="font-semibold">—</div>
            </div>
            <div class="p-3 rounded bg-white/5 border mt-2">
              <div class="muted small">Habit Stacking Plan</div>
              <div id="habitStackingPlan" class="font-semibold">—</div>
            </div>
          </div>
          <div class="lock-overlay hidden" aria-hidden="true"><button class="cta px-4 py-2 rounded">Unlock Premium</button></div>
        </div>

        <!-- Unique features -->
        <div class="card p-4 relative">
          <h3 class="font-semibold">Unique Features</h3>
          <div class="mt-3 lockable" data-key="uniqueFeatures">
            <div class="grid gap-2">
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Wellness Weather (7d)</div>
                <div id="wellnessWeather" class="font-semibold small">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Energy Management Matrix</div>
                <div id="energyMatrix" class="font-semibold small">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Social Health Score</div>
                <div id="socialHealthScore" class="font-semibold">—</div>
              </div>
              <div class="p-3 rounded bg-white/5 border">
                <div class="muted small">Personalized Supplement Stack</div>
                <div id="supplementStack" class="font-semibold small">—</div>
                <div class="muted small mt-2">*Not medical advice — consult a physician</div>
              </div>
            </div>
          </div>
          <div class="lock-overlay hidden" aria-hidden="true"><button class="cta px-4 py-2 rounded">Unlock Premium</button></div>
        </div>

        <!-- AI Coach notes (full text blurred) -->
        <div class="card p-4 relative md:col-span-2">
          <h3 class="font-semibold">AI Coach Notes</h3>
          <div class="mt-3 lockable" data-key="aiCoachNotes">
            <div id="aiCoachNotes" class="muted">—</div>
          </div>
          <div class="lock-overlay hidden" aria-hidden="true"><button class="cta px-4 py-2 rounded">Unlock Premium</button></div>
        </div>

      </div>
    </section>

    <!-- Payment strip -->
    <footer class="mt-6 card p-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-green-400 to-emerald-500 grid place-items-center font-bold text-white">★</div>
        <div>
          <div class="text-sm muted">Limited time offer</div>
          <div class="font-semibold">Premium unlock — <span class="text-green-600">30% off</span></div>
          <div class="muted small">Offer expires in <span id="timer" class="font-bold">15:00</span></div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-right mr-2">
          <div class="muted small line-through">$49</div>
          <div class="text-xl font-bold">$34.30</div>
        </div>
        <button id="unlockBtn" class="cta px-5 py-3 rounded-lg font-semibold">Unlock Premium</button>
        <button id="downloadPDFBtn" class="hidden px-4 py-2 rounded border">Download PDF</button>
      </div>
    </footer>
  </div>

  <!-- Payment modal -->
  <div id="paymentModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md">
      <h3 class="font-semibold text-lg">Payment success</h3>
      <p class="muted small mt-2">Your premium report has been unlocked. You can now view all details and download a PDF.</p>
      <div class="mt-4 text-right"><button id="closeModal" class="px-4 py-2 rounded bg-blue-600 text-white">OK</button></div>
    </div>
  </div>

<script>
/* =========================
   Utilities & Mock fallback
   ========================= */
const $ = id => document.getElementById(id);
function fmt(v, def = '—') { return (v === null || v === undefined || v === '') ? def : v; }

async function fetchReportFromServer(sessionId) {
  try {
    const res = await fetch('/.netlify/functions/generateReport', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId })
    });
    const json = await res.json();
    if (!json || !json.data) throw new Error('Invalid server response');
    return json.data;
  } catch (e) {
    console.warn('Server fetch failed', e);
    // If server fails, rely on embedded fallback by calling endpoint again or use local mock
    // Here we will try to use a minimal mock so UI still shows complete schema.
    return localMockReport();
  }
}

/* Local mock fallback (complete schema) to ensure all fields exist and the UI never breaks */
function localMockReport() {
  return {
    freeReport: {
      metrics: { wellnessScore: 72, biologicalAge: 33, energyIndex: 66, stressLevel: 44 },
      coreFour: {
        mind: { score: 68, summary: "Moderate stress; benefit from daily breathwork" },
        body: { score: 64, summary: "Active but inconsistent; increase weekly strength", bmi: 26.1 },
        nutrition: { score: 62, summary: "Low veg intake, some processed food", fruitsVegPerDay: 2, processedFoodLevel: "Moderate", waterLiters: 1.8 },
        sleep: { score: 55, summary: "Short sleep windows; accumulate sleep debt", hours: 6, visualSigns: "Under-eye shadows" }
      },
      insights: { mainBarrier: "Erratic sleep schedule", quickWin: "Establish consistent bedtime", comparison: "Your sleep is lower than ~70% of peers" }
    },
    premiumReport: {
      detailedAnalytics: { metabolicAge: 36, recoveryScore: 58, inflammationRiskIndex: 35, digitalWellnessScore: 52 },
      faceAnalysis: { skinHealthScore: 64, hydrationAssessment: "Slight dehydration signs", sleepDebtVisualization: "Mild under-eye bags", stressMarkers: "Forehead lines present" },
      recommendations: {
        circadianReset: { bedtime: "22:30", wakeTime: "06:30", steps: ["Dim screens after 21:00", "Morning sunlight for 10 min", "Consistent bedtime schedule"] },
        nutritionGaps: [{ nutrient: "Vitamin D", why: "Low sun exposure" }, { nutrient: "Iron", why: "Low red meat/leafy greens" }],
        exercisePrescription: { type: "Brisk walking + resistance twice/week", durationMin: 30, timeOfDay: "Morning" },
        stressToolkit: ["4-4-8 breathing", "Daily 10-min mindfulness", "Walk breaks every 90 minutes"]
      },
      forecasts: {
        thirtyDayPotential: { expectedWellnessScoreIncrease: 6, notes: "With consistent sleep and one nutrition change" },
        riskTimeline: [{ yearsFromNow: 3, risk: "Worsening sleep may impact metabolic health" }],
        habitStackingPlan: [{ week: 1, habit: "Set bedtime" }, { week: 2, habit: "Morning walk" }]
      },
      uniqueFeatures: {
        wellnessWeather: [
          { day: "Mon", forecast: "Good", scoreModifier: 1 },
          { day: "Tue", forecast: "Moderate", scoreModifier: 0 },
          { day: "Wed", forecast: "Good", scoreModifier: 1 },
          { day: "Thu", forecast: "Low", scoreModifier: -1 },
          { day: "Fri", forecast: "Moderate", scoreModifier: 0 },
          { day: "Sat", forecast: "Good", scoreModifier: 1 },
          { day: "Sun", forecast: "Rest", scoreModifier: 2 }
        ],
        energyMatrix: [
          { timeRange: "06:00-09:00", recommendedTask: "Deep Work", intensity: "High" },
          { timeRange: "12:00-14:00", recommendedTask: "Light tasks / walk", intensity: "Low" },
          { timeRange: "18:00-20:00", recommendedTask: "Social / family time", intensity: "Medium" }
        ],
        socialHealthScore: 68,
        personalizedSupplementStack: [
          { name: "Vitamin D", reason: "Low exposure", dose: "1000 IU" },
          { name: "Omega-3", reason: "Inflammation support", dose: "1000 mg" }
        ]
      },
      aiCoachNotes: "This is a mock coach note. Upgrade to Premium to unlock full personalization."
    }
  };
}

/* =========================
   Rendering functions
   ========================= */

let gaugeChart, coreRadar, premiumBar;

function renderGauge(score) {
  const ctx = document.getElementById('gauge').getContext('2d');
  if (gaugeChart) gaugeChart.destroy();
  gaugeChart = new Chart(ctx, {
    type: 'doughnut',
    data: { datasets: [{ data: [score, 100 - score], backgroundColor: ['#2563eb', '#e6eefc'], borderWidth: 0 }] },
    options: {
      rotation: -90 * (Math.PI/180),
      circumference: 180 * (Math.PI/180),
      cutout: '70%',
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      animation: { animateRotate: true, duration: 1000 }
    }
  });
  $('wellnessScore').textContent = score;
}

function renderCoreRadar(coreFour) {
  const ctx = document.getElementById('coreRadar').getContext('2d');
  if (coreRadar) coreRadar.destroy();
  const data = [
    coreFour.mind.score || 0,
    coreFour.body.score || 0,
    coreFour.nutrition.score || 0,
    coreFour.sleep.score || 0
  ];
  coreRadar = new Chart(ctx, {
    type: 'radar',
    data: { labels: ['Mind','Body','Nutrition','Sleep'], datasets: [{ data, fill: true, backgroundColor: 'rgba(37,99,235,0.12)', borderColor: '#2563eb' }] },
    options: { scales: { r: { min: 0, max: 100 } }, plugins: { legend: { display: false } } }
  });
}

function renderPremiumBar(metrics) {
  const ctx = document.getElementById('premiumBar').getContext('2d');
  if (premiumBar) premiumBar.destroy();
  premiumBar = new Chart(ctx, {
    type: 'bar',
    data: { labels: ['Metabolic Age','Recovery','Inflammation','Digital'], datasets: [{ data: [metrics.metabolicAge || 0, metrics.recoveryScore || 0, metrics.inflammationRiskIndex || 0, metrics.digitalWellnessScore || 0], backgroundColor: ['#34d399','#60a5fa','#fb7185','#f59e0b'] }] },
    options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
  });
}

/* Fill the DOM with the report data */
function fillFree(free) {
  $('archetype').textContent = fmt(free.archetype || 'Wellness Explorer');
  renderGauge(Number(free.metrics.wellnessScore || 0));
  $('biologicalAge').textContent = fmt(free.metrics.biologicalAge);
  $('energyIndex').textContent = fmt(free.metrics.energyIndex);
  $('stressLevel').textContent = fmt(free.metrics.stressLevel);

  $('wellnessScore').textContent = fmt(free.metrics.wellnessScore);

  $('bioAge2').textContent = fmt(free.metrics.biologicalAge);
  $('energyIndex2').textContent = fmt(free.metrics.energyIndex);
  $('stressLevel2').textContent = fmt(free.metrics.stressLevel);

  $('mindScore').textContent = fmt(free.coreFour.mind.score);
  $('mindSummary').textContent = fmt(free.coreFour.mind.summary);
  $('bodyScore').textContent = fmt(free.coreFour.body.score);
  $('bodySummary').textContent = fmt(free.coreFour.body.summary);
  $('bodyBMI').textContent = 'BMI: ' + fmt(free.coreFour.body.bmi || '—');
  $('nutritionScore').textContent = fmt(free.coreFour.nutrition.score);
  $('nutritionSummary').textContent = fmt(free.coreFour.nutrition.summary);
  $('fruitsVeg').textContent = fmt(free.coreFour.nutrition.fruitsVegPerDay);
  $('processedLevel').textContent = fmt(free.coreFour.nutrition.processedFoodLevel);
  $('waterL').textContent = fmt(free.coreFour.nutrition.waterLiters);

  $('sleepScore').textContent = fmt(free.coreFour.sleep.score);
  $('sleepSummary').textContent = fmt(free.coreFour.sleep.summary);
  $('sleepHours').textContent = fmt(free.coreFour.sleep.hours);
  $('sleepVisual').textContent = fmt(free.coreFour.sleep.visualSigns);

  $('mainBarrier').textContent = fmt(free.insights.mainBarrier);
  $('quickWin').textContent = fmt(free.insights.quickWin);
  $('comparison').textContent = fmt(free.insights.comparison);

  renderCoreRadar(free.coreFour);
}

/* Premium: populate locked content but keep it blurred initially */
function fillPremium(premium) {
  // detailed analytics
  $('metabolicAge').textContent = fmt(premium.detailedAnalytics.metabolicAge);
  $('recoveryScore').textContent = fmt(premium.detailedAnalytics.recoveryScore);
  $('inflammationRisk').textContent = fmt(premium.detailedAnalytics.inflammationRiskIndex);
  $('digitalWellness').textContent = fmt(premium.detailedAnalytics.digitalWellnessScore);
  renderPremiumBar(premium.detailedAnalytics);

  // face analysis
  $('skinHealthScore').textContent = fmt(premium.faceAnalysis.skinHealthScore);
  $('hydrationAssessment').textContent = fmt(premium.faceAnalysis.hydrationAssessment);
  $('sleepDebtVisualization').textContent = fmt(premium.faceAnalysis.sleepDebtVisualization);
  $('stressMarkers').textContent = fmt(premium.faceAnalysis.stressMarkers);

  // recommendations
  $('circadianReset').textContent = premium.recommendations.circadianReset ? `${premium.recommendations.circadianReset.bedtime} → ${premium.recommendations.circadianReset.wakeTime} • ${premium.recommendations.circadianReset.steps.join('; ')}` : '—';
  $('nutritionGaps').textContent = (premium.recommendations.nutritionGaps || []).map(n => `${n.nutrient}: ${n.why}`).join('; ');
  $('exercisePrescription').textContent = premium.recommendations.exercisePrescription ? `${premium.recommendations.exercisePrescription.type} • ${premium.recommendations.exercisePrescription.durationMin} min • ${premium.recommendations.exercisePrescription.timeOfDay}` : '—';
  $('stressToolkit').textContent = (premium.recommendations.stressToolkit || []).join('; ');

  // forecasts
  $('thirtyDayPotential').textContent = premium.forecasts.thirtyDayPotential ? `${premium.forecasts.thirtyDayPotential.expectedWellnessScoreIncrease} points • ${premium.forecasts.thirtyDayPotential.notes}` : '—';
  $('riskTimeline').textContent = (premium.forecasts.riskTimeline || []).map(r => `${r.yearsFromNow}y: ${r.risk}`).join('; ');
  $('habitStackingPlan').textContent = (premium.forecasts.habitStackingPlan || []).map(h => `W${h.week}: ${h.habit}`).join('; ');

  // unique features
  $('wellnessWeather').textContent = (premium.uniqueFeatures.wellnessWeather || []).map(d => `${d.day}: ${d.forecast} (${d.scoreModifier>=0? '+'+d.scoreModifier:d.scoreModifier})`).join(' • ');
  $('energyMatrix').textContent = (premium.uniqueFeatures.energyMatrix || []).map(e => `${e.timeRange}: ${e.recommendedTask}`).join(' • ');
  $('socialHealthScore').textContent = fmt(premium.uniqueFeatures.socialHealthScore);
  $('supplementStack').textContent = (premium.uniqueFeatures.personalizedSupplementStack || []).map(s => `${s.name}: ${s.reason} (${s.dose})`).join('; ');

  $('aiCoachNotes').textContent = fmt(premium.aiCoachNotes);
}

/* Activate unlock (called after simulated payment) */
function unlockPremiumUI() {
  // remove locked state for all .lockable containers
  document.querySelectorAll('.lockable').forEach(el => {
    el.classList.remove('locked');
  });
  // hide overlay buttons
  document.querySelectorAll('.lock-overlay').forEach(o => o.classList.add('hidden'));
  // enable Download
  $('downloadPDFBtn').classList.remove('hidden');
}

/* Generate PDF of report root */
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const el = document.querySelector('.max-w-6xl') || document.body;
  // increase scale for clarity
  const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#f7fafc' });
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'px' });
  const pageWidth = pdf.internal.pageSize.getWidth();
  const ratio = pageWidth / canvas.width;
  const pageHeight = canvas.height * ratio;
  pdf.addImage(img, 'PNG', 0, 0, pageWidth, pageHeight);
  pdf.save('AI-WELLNESSCORE-Report.pdf');
}

/* Timer for 15-minute discount */
function startCountdown(seconds = 15*60) {
  let left = seconds;
  const t = setInterval(()=> {
    left--;
    if (left < 0) { clearInterval(t); $('timer').textContent = '00:00'; return; }
    const m = String(Math.floor(left/60)).padStart(2,'0'), s = String(left%60).padStart(2,'0');
    $('timer').textContent = `${m}:${s}`;
  },1000);
}

/* Intro: set everything locked initially by adding .locked */
function setInitialLockedState() {
  document.querySelectorAll('.lockable').forEach(el => {
    el.classList.add('locked');
    // add overlay button if not present
    const parent = el.closest('.card') || el.parentElement;
    const overlay = parent.querySelector('.lock-overlay');
    if (overlay) overlay.classList.remove('hidden');
  });
}

/* =========================
   Bootstrap: Fetch, render, wire UI
   ========================= */
(async function init() {
  startCountdown(15*60);
  setInitialLockedState();

  // UI handlers
  $('unlockBtn').addEventListener('click', async () => {
    // simulate payment action
    $('paymentModal').classList.remove('hidden');
    // simulate backend payment processing delay
    setTimeout(()=> {
      $('paymentModal').classList.add('hidden');
      unlockPremiumUI();
      // show modal success too
      document.getElementById('paymentModal').classList.add('hidden');
    }, 800);
  });

  $('closeModal').addEventListener('click', () => {
    $('paymentModal').classList.add('hidden');
  });

  $('downloadPDFBtn').addEventListener('click', downloadPDF);

  // load sessionId
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get('sessionId') || 'demo-session';

  const report = await fetchReportFromServer(sessionId);

  // ensure top-level optional fields exist for older fallback compatibility
  if (!report.freeReport) report.freeReport = localMockReport().freeReport;
  if (!report.premiumReport) report.premiumReport = localMockReport().premiumReport;

  // freeReport may include an 'archetype' key in freeReport; ensure we map it
  if (!report.freeReport.archetype && report.freeReport.metrics && report.freeReport.metrics.wellnessScore) {
    report.freeReport.archetype = "Wellness Explorer";
  }

  // Fill UI
  fillFree(report.freeReport);
  fillPremium(report.premiumReport);

})();
</script>
</body>
</html>
