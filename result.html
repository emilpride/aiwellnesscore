<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your AI WELLNESSCORE Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            background-color: #0f172a;
        }
        .gradient-bg-dark-animated {
            background: linear-gradient(300deg, #0f172a, #1e1b4b, #312e81, #0f172a);
            background-size: 200% 200%;
            animation: slow-pan 25s ease infinite;
        }
        @keyframes slow-pan {
            0% { background-position: 0% 0%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 0%; }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .blurry-content {
            filter: blur(5px);
            user-select: none;
            pointer-events: none;
        }
        .premium-feature-lock .premium-feature-lock-overlay {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.2);
            border-radius: 0.5rem;
        }
        .premium-feature-unlocked .blurry-content {
            filter: blur(0);
        }
        .premium-feature-unlocked .premium-feature-lock-overlay {
            display: none;
        }
        /* ... и другие ваши стили ... */
    </style>
</head>
<body class="bg-slate-900 text-gray-200">

    <div class="gradient-bg-dark-animated min-h-screen py-8">
        <div class="max-w-md mx-auto px-4 space-y-12">

            <section class="fade-in-section text-center">
                <span class="text-teal-300 text-sm font-medium px-4 py-1.5 rounded-full bg-teal-900/50 border border-teal-800">Your Wellness Archetype</span>
                <h1 data-report="archetype" class="text-4xl font-black text-white mt-3 tracking-tight">Loading...</h1>
                <p data-report="archetypeDescription" class="text-base text-gray-400 mt-2 mx-auto max-w-sm">Analyzing your results...</p>
            </section>

            <section class="fade-in-section text-center">
                <div class="relative w-56 h-56 mx-auto">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                        <defs>
                            <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#14E3E3; stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4F46E5; stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path class="text-slate-700" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="2" />
                        <path id="score-circle-path" class="score-circle-path" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="2" stroke="url(#scoreGradient)" stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-6xl font-black text-white" id="score-text">0</span>
                        <span class="text-lg text-gray-400">Overall Score</span>
                    </div>
                </div>
            </section>

            <div class="glass-card p-6 rounded-xl">
                <h3 class="text-xl font-bold text-white mb-2">Key AI Insight</h3>
                <p data-report="keyInsight" class="text-sm text-gray-300">Loading insight...</p>
            </div>
            
            <div class="glass-card p-4 rounded-lg flex flex-col premium-feature-lock relative">
                 <h3 class="font-semibold text-white text-lg text-left">Full Photo Analysis</h3>
                 <div class="content-unlocked text-left mt-3">
                    <div class="blurry-content">
                         <p data-premium-id="fullPhotoAnalysis" class="text-sm text-gray-300 flex-1">...</p>
                    </div>
                 </div>
                 <div class="premium-feature-lock-overlay">
                    </div>
            </div>

        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let SCORE_CONFIG = {};
        let fullReportData = null; 
        const elements = {
            scoreText: document.getElementById('score-text'),
            scoreCircle: document.getElementById('score-circle-path'),
            paymentForm: document.getElementById('payment-form'),
            scoreBreakdownSection: document.getElementById('score-breakdown-section'),
            wellnessWheelCanvas: document.getElementById('wellnessWheel')
        };

        // --- ФУНКЦИИ АНИМАЦИИ И ГРАФИКОВ ---
        function animateScore() {
            let currentScore = 0;
            const interval = setInterval(() => {
                if (currentScore >= SCORE_CONFIG.total) {
                    clearInterval(interval);
                    elements.scoreText.textContent = SCORE_CONFIG.total;
                } else {
                    currentScore++;
                    elements.scoreText.textContent = currentScore;
                }
            }, 20);
        }

        function animateScoreCircle() {
            const score = SCORE_CONFIG.total;
            const scoreCircle = elements.scoreCircle;
            if (!scoreCircle) return;
            const circumference = 2 * Math.PI * 15.9155;
            const offset = (score / 100) * circumference;
            scoreCircle.style.strokeDasharray = `0 ${circumference}`;
            setTimeout(() => {
                scoreCircle.style.strokeDasharray = `${offset} ${circumference}`;
            }, 100);
        }

        function createWellnessWheel() {
            if (!elements.wellnessWheelCanvas) return;
            const ctx = elements.wellnessWheelCanvas.getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Energy', 'Stress', 'Nutrition', 'Activity', 'Sleep'],
                    datasets: [{
                        label: 'Your Score',
                        data: SCORE_CONFIG.wheel,
                        backgroundColor: 'rgba(20, 227, 227, 0.2)',
                        borderColor: 'rgba(20, 227, 227, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(20, 227, 227, 1)',
                        pointBorderColor: '#fff',
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: { font: { size: 12, weight: '600' }, color: '#cbd5e1' },
                            ticks: { backdropColor: 'transparent', color: '#94a3b8', stepSize: 25 },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                    responsive: true
                }
            });
        }
        
        // --- ЛОГИКА ОТОБРАЖЕНИЯ И ОПЛАТЫ ---
        function populatePremiumContent(premiumData) {
            if (!premiumData) return;
            // Динамическое заполнение премиум полей по data-атрибутам
            Object.keys(premiumData).forEach(key => {
                const element = document.querySelector(`[data-premium-id="${key}"]`);
                if (element) {
                    if (Array.isArray(premiumData[key])) { // Для списков, как 7-day plan
                        element.innerHTML = premiumData[key].map(item => 
                            `<div class="p-2 border-b border-slate-700/50 text-left"><strong>${item.day ? `Day ${item.day}` : item.type}:</strong> ${item.task || item.title} - <em>${item.description || ''}</em></div>`
                        ).join('');
                    } else if (typeof premiumData[key] === 'object' && premiumData[key] !== null) { // для BMI
                         element.innerHTML = `Value: ${premiumData[key].value} <br> <span class="text-xs text-gray-400">${premiumData[key].interpretation}</span>`;
                    }
                    else { // для простого текста
                        element.innerHTML = premiumData[key];
                    }
                }
            });
        }

        function unlockPremiumContent() {
            document.querySelectorAll('.premium-feature-lock').forEach(item => {
                item.classList.remove('premium-feature-lock');
                item.classList.add('premium-feature-unlocked');
            });

            if (fullReportData && fullReportData.premiumReport) {
                populatePremiumContent(fullReportData.premiumReport);
            }
            
            const paymentSection = document.getElementById('payment-section');
            if (paymentSection) {
                paymentSection.style.display = 'none';
            }
        }

        function handlePayment(e) {
            e.preventDefault();
            // Здесь будет ваша логика вызова Stripe
            // Для теста симулируем успешную оплату
            setTimeout(() => {
                unlockPremiumContent();
            }, 1500);
        }

        // --- ГЛАВНАЯ ФУНКЦИЯ ЗАГРУЗКИ И ОТОБРАЖЕНИЯ ---
        async function fetchAndRenderReport() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('sessionId');

            if (!sessionId) {
                document.body.innerHTML = `<div class="text-center p-8 text-red-400"><h1>Error</h1><p>Session ID not found.</p></div>`;
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }
                
                fullReportData = await response.json();
                const freeData = fullReportData.freeReport;

                if (!freeData || !freeData.coreFour) { // Добавили проверку на coreFour
                    throw new Error("AI response is missing critical data (freeReport or coreFour).");
                }

                // Обновляем SCORE_CONFIG с ИСПРАВЛЕННЫМИ путями
                SCORE_CONFIG = {
                    total: freeData.wellnessScore || 0,
                    breakdown: {
                        body: freeData.coreFour.body.score || 0,
                        mind: freeData.coreFour.mind.score || 0,
                        nutrition: freeData.coreFour.nutrition.score || 0,
                        lifestyle: freeData.coreFour.lifestyle.score || 0
                    },
                    wheel: [
                        freeData.coreFour.body.score,
                        100 - (freeData.coreFour.mind.score || 0), // Stress инвертирован
                        freeData.coreFour.nutrition.score,
                        freeData.coreFour.lifestyle.score, // Lifestyle вместо второй Activity
                        60 // Placeholder для Sleep
                    ]
                };

                // Заполнение HTML
                document.querySelector('[data-report="archetype"]').textContent = freeData.archetype;
                document.querySelector('[data-report="archetypeDescription"]').textContent = freeData.archetypeDescription;
                document.querySelector('[data-report="keyInsight"]').innerHTML = freeData.keyInsight;
                // ...добавьте data-report атрибуты в HTML для остальных полей и они заполнятся здесь...
                
                init();

            } catch (error) {
                console.error('Failed to fetch or render report:', error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-400"><h1>Analysis Failed</h1><p>${error.message}</p></div>`;
            }
        }

        function init() {
            animateScore();
            animateScoreCircle();
            // Запускаем Intersection Observers для анимаций
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        if (entry.target.id === 'score-breakdown-section') {
                             Object.keys(SCORE_CONFIG.breakdown).forEach(key => {
                                const barEl = document.getElementById(`${key}-bar`);
                                if(barEl) barEl.classList.add('bar-animation');
                             });
                        }
                        if (entry.target.id === 'wellnessWheel') createWellnessWheel();
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.fade-in-section').forEach(section => observer.observe(section));
            if (elements.wellnessWheelCanvas) observer.observe(elements.wellnessWheelCanvas);
            
            if (elements.paymentForm) {
                elements.paymentForm.addEventListener('submit', handlePayment);
            }
        }

        fetchAndRenderReport();
    });
</script>
</body>
</html>

