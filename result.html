<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your AI WELLNESSCORE Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .premium-blur {
            filter: blur(10px);
            user-select: none;
            pointer-events: none;
        }
        .premium-section {
            position: relative;
        }
        .lock-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            z-index: 10;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        .score-ring {
            transform: rotate(-90deg);
            transform-origin: center;
        }
        .score-ring-fill {
            stroke-dasharray: 314;
            stroke-dashoffset: 314;
            animation: fillRing 2s ease-out forwards;
        }
        @keyframes fillRing {
            to { stroke-dashoffset: calc(314 - (314 * var(--score)) / 100); }
        }
        .gradient-text {
            background: linear-gradient(135deg, #14e3e3 0%, #6366f1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(20, 227, 227, 0.5); }
            50% { box-shadow: 0 0 40px rgba(20, 227, 227, 0.8); }
        }
    </style>
</head>
<body class="text-gray-200">
    <div class="container max-w-4xl mx-auto px-4 py-8">
        <div id="report-container"></div>
    </div>

<script>
// –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® STRIPE –ü–£–ë–õ–ò–ß–ù–´–ô –ö–õ–Æ–ß
const STRIPE_PUBLIC_KEY = 'pk_test_YOUR_KEY_HERE';

let globalReportData = null;
let sessionId = null;
let isPremiumUnlocked = false;

function showLoadingState() {
    document.getElementById('report-container').innerHTML = `
        <div class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-teal-400"></div>
            <h2 class="text-2xl font-bold text-white mt-6">Analyzing your wellness data...</h2>
            <p class="text-gray-400 mt-2">Our AI is crafting your personalized report</p>
        </div>`;
}

function generateFullHTML(data, unlocked = false) {
    const free = data.freeReport;
    const premium = data.premiumReport || {};
    
    return `
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-black gradient-text mb-2">AI WELLNESSCORE</h1>
            <p class="text-gray-400">Your Personalized Wellness Analysis</p>
        </div>

        <!-- Free Report Section -->
        <div class="space-y-8">
            <!-- Archetype Card -->
            <div class="glass-card rounded-2xl p-8 text-center">
                <span class="inline-block px-4 py-1 bg-teal-500/20 text-teal-300 rounded-full text-sm mb-4">
                    Your Wellness Archetype
                </span>
                <h2 class="text-4xl font-bold text-white mb-3">${free.archetype}</h2>
                <p class="text-gray-300 max-w-2xl mx-auto">${free.archetypeDescription}</p>
            </div>

            <!-- Main Score -->
            <div class="glass-card rounded-2xl p-8">
                <div class="flex flex-col md:flex-row items-center justify-around">
                    <div class="text-center mb-6 md:mb-0">
                        <div class="relative w-40 h-40 mx-auto">
                            <svg class="w-full h-full">
                                <circle cx="80" cy="80" r="70" stroke="rgba(255,255,255,0.1)" stroke-width="12" fill="none"/>
                                <circle cx="80" cy="80" r="70" stroke="url(#gradient)" stroke-width="12" fill="none"
                                    class="score-ring score-ring-fill" style="--score: ${free.wellnessScore}"/>
                                <defs>
                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#14e3e3"/>
                                        <stop offset="100%" stop-color="#6366f1"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div>
                                    <div class="text-5xl font-bold text-white">${free.wellnessScore}</div>
                                    <div class="text-sm text-gray-400">Overall Score</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-400 mb-2">Wellness Age</h3>
                        <div class="text-5xl font-bold gradient-text">${free.wellnessAge}</div>
                        <p class="text-sm text-gray-500 mt-1">years</p>
                    </div>
                </div>
            </div>

            <!-- Core Four -->
            <div class="glass-card rounded-2xl p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Core Four Breakdown</h3>
                <div class="space-y-6">
                    ${['mind', 'body', 'nutrition', 'lifestyle'].map(key => {
                        const item = free.coreFour[key];
                        const colors = {
                            mind: 'indigo',
                            body: 'teal',
                            nutrition: 'emerald',
                            lifestyle: 'purple'
                        };
                        const color = colors[key];
                        return `
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-lg font-semibold text-${color}-400 capitalize">${key}</span>
                                    <span class="text-xl font-bold text-white">${item.score}%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-3">
                                    <div class="bg-${color}-500 h-3 rounded-full transition-all duration-1000" 
                                         style="width: ${item.score}%"></div>
                                </div>
                                <p class="text-sm text-gray-400 mt-2">${item.summary}</p>
                            </div>`;
                    }).join('')}
                </div>
            </div>

            <!-- Key Insights Grid -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="glass-card rounded-xl p-6">
                    <h4 class="text-lg font-bold text-teal-400 mb-3">üéØ Key AI Insight</h4>
                    <p class="text-gray-300">${free.keyInsight}</p>
                </div>
                <div class="glass-card rounded-xl p-6">
                    <h4 class="text-lg font-bold text-indigo-400 mb-3">üë• Peer Comparison</h4>
                    <p class="text-gray-300">${free.peerComparison}</p>
                </div>
            </div>

            <!-- Action Steps -->
            <div class="glass-card rounded-2xl p-8 text-center">
                <h3 class="text-2xl font-bold text-white mb-4">Your First Step</h3>
                <div class="bg-gradient-to-r from-teal-500/20 to-indigo-500/20 rounded-xl p-6 mb-4">
                    <p class="text-lg text-white font-medium">${free.firstStep}</p>
                </div>
                <p class="text-sm text-gray-400 italic">"${free.motivationTrigger}"</p>
            </div>

            <!-- Premium Section -->
            <div class="glass-card rounded-2xl p-8 ${!unlocked ? 'premium-section' : ''}">
                ${!unlocked ? '<div class="lock-overlay"><span class="text-6xl">üîí</span></div>' : ''}
                
                <div class="${!unlocked ? 'premium-blur' : ''}">
                    <h2 class="text-3xl font-bold text-center gradient-text mb-8">Premium Wellness Report</h2>
                    
                    <!-- Deep Dive Analysis -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-white mb-4">üìä Deep Dive Analysis</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="bg-slate-800/50 rounded-lg p-4">
                                <h4 class="text-teal-400 font-semibold">Sleep Efficiency</h4>
                                <p class="text-gray-300 text-sm mt-1">${premium.deepDive?.sleepEfficiency || 'Detailed sleep pattern analysis...'}</p>
                            </div>
                            <div class="bg-slate-800/50 rounded-lg p-4">
                                <h4 class="text-indigo-400 font-semibold">Stress Recovery Index</h4>
                                <p class="text-gray-300 text-sm mt-1">${premium.deepDive?.stressRecovery || 'Your body\'s stress response metrics...'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Analysis -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-white mb-4">üì∏ Full Photo Analysis</h3>
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <p class="text-gray-300">${premium.fullPhotoAnalysis || 'Detailed facial analysis revealing stress markers, energy levels, and wellness indicators...'}</p>
                        </div>
                    </div>

                    <!-- 7-Day Action Plan -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-white mb-4">üìÖ Your 7-Day Action Plan</h3>
                        <div class="space-y-3">
                            ${premium.sevenDayActionPlan ? premium.sevenDayActionPlan.map(day => `
                                <div class="bg-slate-800/50 rounded-lg p-4 flex justify-between items-center">
                                    <div>
                                        <span class="text-teal-400 font-bold">Day ${day.day}</span>
                                        <p class="text-gray-300 text-sm mt-1">${day.task}</p>
                                    </div>
                                    <span class="px-3 py-1 bg-indigo-500/20 text-indigo-300 rounded-full text-xs">${day.focus}</span>
                                </div>
                            `).join('') : '<p class="text-gray-400">Personalized daily tasks will appear here...</p>'}
                        </div>
                    </div>

                    <!-- BMI Calculation -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-white mb-4">üìè BMI Analysis</h3>
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <p class="text-gray-300">${premium.bmiAnalysis || 'Your Body Mass Index calculation and health implications...'}</p>
                        </div>
                    </div>

                    <!-- Wellness Trajectory -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-white mb-4">üìà 5-Year Wellness Forecast</h3>
                        <div class="bg-slate-800/50 rounded-lg p-4">
                            <p class="text-gray-300">${premium.trajectoryForecast || 'Your wellness trajectory based on current habits vs. recommended changes...'}</p>
                        </div>
                    </div>

                    <!-- AI Coach Notes -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-white mb-4">üí¨ Personal AI Coach Notes</h3>
                        <div class="bg-gradient-to-r from-teal-500/10 to-indigo-500/10 rounded-lg p-6">
                            <p class="text-gray-300 italic">"${premium.aiCoachNotes || 'Your personalized coaching insights and encouragement...'}"</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment/Download Section -->
            ${!unlocked ? `
                <div class="glass-card rounded-2xl p-8 text-center">
                    <h3 class="text-2xl font-bold text-white mb-4">Unlock Your Complete Wellness Blueprint</h3>
                    <p class="text-gray-400 mb-6">Get instant access to your premium report with personalized action plans</p>
                    
                    <div class="bg-gradient-to-r from-teal-500/20 to-indigo-500/20 rounded-xl p-6 mb-6">
                        <div class="text-3xl font-bold text-white mb-2">$9.99</div>
                        <p class="text-sm text-gray-400">One-time payment ‚Ä¢ Instant access ‚Ä¢ Download as PDF</p>
                    </div>
                    
                    <button id="unlock-btn" class="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-teal-500 to-indigo-500 text-white font-bold rounded-xl hover:from-teal-400 hover:to-indigo-400 transition-all transform hover:scale-105 pulse-glow">
                        üîì Unlock Premium Report Now
                    </button>
                </div>
            ` : `
                <div class="glass-card rounded-2xl p-8 text-center">
                    <div class="mb-6">
                        <span class="text-4xl">‚úÖ</span>
                        <h3 class="text-2xl font-bold text-green-400 mt-2">Premium Report Unlocked!</h3>
                    </div>
                    <button id="download-pdf" class="px-8 py-3 bg-gradient-to-r from-teal-500 to-indigo-500 text-white font-bold rounded-xl hover:from-teal-400 hover:to-indigo-400 transition-all">
                        üì• Download PDF Report
                    </button>
                </div>
            `}
        </div>
    `;
}

async function handlePayment() {
    const btn = document.getElementById('unlock-btn');
    btn.disabled = true;
    btn.textContent = 'Processing...';

    try {
        const response = await fetch('/.netlify/functions/payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
        });

        const session = await response.json();
        const stripe = Stripe(STRIPE_PUBLIC_KEY);
        
        await stripe.redirectToCheckout({ sessionId: session.id });
    } catch (error) {
        console.error('Payment error:', error);
        btn.disabled = false;
        btn.textContent = 'üîì Unlock Premium Report Now';
    }
}

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(20);
    doc.text('AI WELLNESSCORE Report', 20, 20);
    
    // Add report content to PDF
    doc.setFontSize(12);
    doc.text(`Archetype: ${globalReportData.freeReport.archetype}`, 20, 40);
    doc.text(`Wellness Score: ${globalReportData.freeReport.wellnessScore}`, 20, 50);
    doc.text(`Wellness Age: ${globalReportData.freeReport.wellnessAge}`, 20, 60);
    
    doc.save('wellness-report.pdf');
}

async function init() {
    showLoadingState();
    
    const params = new URLSearchParams(window.location.search);
    sessionId = params.get('sessionId');
    isPremiumUnlocked = params.get('payment') === 'success';
    
    if (!sessionId) {
        document.getElementById('report-container').innerHTML = '<div class="text-center text-red-400">Session not found</div>';
        return;
    }

    try {
        const response = await fetch('/.netlify/functions/generateReport', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
        });

        const result = await response.json();
        
        if (result.status === 'complete') {
            globalReportData = result.data;
            document.getElementById('report-container').innerHTML = generateFullHTML(result.data, isPremiumUnlocked);
            
            if (!isPremiumUnlocked) {
                document.getElementById('unlock-btn').addEventListener('click', handlePayment);
            } else {
                document.getElementById('download-pdf').addEventListener('click', downloadPDF);
            }
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

init();
</script>
</body>
</html>
