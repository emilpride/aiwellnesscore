<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI WELLNESSCORE — Your Report</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    body { 
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
        background-color: #0f172a; 
        color: #e2e8f0; 
        overflow-x: hidden;
    }
    .gradient-bg-dark-animated {
        background: linear-gradient(300deg, #0f172a, #1e1b4b, #312e81, #0f172a);
        background-size: 200% 200%;
        animation: slow-pan 25s ease infinite;
    }
    @keyframes slow-pan { 0% { background-position: 0% 0%; } 25% { background-position: 100% 0%; } 50% { background-position: 100% 100%; } 75% { background-position: 0% 100%; } 100% { background-position: 0% 0%; } }
    .glass-card {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .glass-card:before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(255, 255, 255, 0.06), transparent 40%);
        opacity: 0; transition: opacity 0.5s;
    }
    .glass-card:hover:before { opacity: 1; }
    .glass-card:hover { border-color: rgba(255, 255, 255, 0.2); transform: translateY(-5px); box-shadow: 0 20px 30px rgba(0,0,0,0.2); }
    .animated-gradient-text {
        background: linear-gradient(90deg, #e0e7ff, #a5b4fc, #6366f1, #14e3e3);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        background-size: 200% auto; animation: text-shine 5s linear infinite;
    }
    @keyframes text-shine { to { background-position: 200% center; } }
    .muted { color: #94a3b8; }
    .cta { 
        background-color: #14e3e3; color: #0f172a; 
        transition: all 0.2s ease; transform: scale(1);
    }
    .cta:hover { 
        background-color: #67e8f9;
        box-shadow: 0 4px 12px rgba(20, 227, 227, 0.3);
        transform: scale(1.05);
    }
     .pulsate { animation: pulse 2s infinite; }
    @keyframes pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(20, 227, 227, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(20, 227, 227, 0); }
    }
    .locked { filter: blur(8px); pointer-events: none; user-select: none; position: relative; }
    .lock-overlay {
      position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(15,23,42,0.4), rgba(15,23,42,0.8));
      border-radius: 1rem;
    }
    .small { font-size: 0.85rem; }
    .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.8s ease-out forwards;
    }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="gradient-bg-dark-animated">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="fade-in-up flex items-center justify-between mb-6" style="animation-delay: 0.1s;">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-indigo-500 to-teal-500 grid place-items-center text-white font-black text-2xl">W</div>
        <div>
          <h1 class="text-xl font-semibold text-white">AI WELLNESSCORE</h1>
          <div class="muted text-sm">Personalized Wellness Intelligence</div>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-2 muted small">
        <div class="px-3 py-1 bg-white/5 border border-white/10 rounded-lg text-xs">SSL Secured</div>
        <div class="px-3 py-1 bg-white/5 border border-white/10 rounded-lg text-xs">PCI-ready</div>
      </div>
    </header>

    <section class="fade-in-up glass-card rounded-2xl p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6" style="animation-delay: 0.2s;">
      <div class="flex flex-col items-center justify-center">
        <div class="text-sm muted">Your Wellness Archetype</div>
        <div id="archetype" class="text-3xl font-bold animated-gradient-text mt-1">—</div>

        <div class="mt-6 flex flex-col sm:flex-row items-center gap-6 sm:gap-10">
          <canvas id="gauge" class="w-[240px] h-[120px]"></canvas>
          <div class="space-y-4 text-center sm:text-left">
            <div><div class="muted small">Biological Age</div><div id="biologicalAge" class="text-2xl font-semibold">0</div></div>
            <div><div class="muted small">Energy Index</div><div id="energyIndex" class="text-2xl font-semibold">0</div></div>
            <div><div class="muted small">Stress Level</div><div id="stressLevel" class="text-2xl font-semibold">0</div></div>
          </div>
        </div>
      </div>

      <div class="border-t border-white/10 lg:border-none pt-6 lg:pt-0">
        <h2 class="text-lg font-semibold text-white text-center lg:text-left">Quick Insights</h2>
        <div class="mt-4 grid grid-cols-1 gap-4">
          <div class="p-4 rounded-lg border border-white/10 bg-white/5"><div class="muted small">Main Barrier</div><div id="mainBarrier" class="font-medium text-white">—</div></div>
          <div class="p-4 rounded-lg border border-white/10 bg-white/5"><div class="muted small">Quick Win</div><div id="quickWin" class="font-medium text-white">—</div></div>
          <div class="p-4 rounded-lg border border-white/10 bg-white/5"><div class="muted small">Comparison</div><div id="comparison" class="font-medium text-white">—</div></div>
        </div>
      </div>
    </section>

    <section class="fade-in-up glass-card rounded-2xl p-4 sm:p-6 mb-6" style="animation-delay: 0.3s;">
      <h2 class="text-xl font-semibold text-white mb-4">Free Report — Metrics & Core Four</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <div class="p-4 rounded-lg border border-white/10 bg-white/5">
            <div class="muted small">Wellness Score</div>
            <div id="wellnessScore" class="text-5xl font-black animated-gradient-text">0</div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
               <div class="p-3 rounded-lg border border-white/10 bg-white/5"><div class="muted small">Biological Age</div><div id="bioAge2" class="font-semibold text-white text-lg">0</div></div>
               <div class="p-3 rounded-lg border border-white/10 bg-white/5"><div class="muted small">Energy Index</div><div id="energyIndex2" class="font-semibold text-white text-lg">0</div></div>
               <div class="p-3 rounded-lg border border-white/10 bg-white/5"><div class="muted small">Stress Level</div><div id="stressLevel2" class="font-semibold text-white text-lg">0</div></div>
          </div>
        </div>

        <div>
            <h3 class="text-base font-semibold text-white mb-2 text-center">Core Four Balance</h3>
            <canvas id="coreRadar" height="250"></canvas>
        </div>
      </div>
    </section>
    
    <section class="fade-in-up mb-6" style="animation-delay: 0.4s;">
         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass-card rounded-xl p-4"><div class="muted small">Mind</div><div id="mindScore" class="text-xl font-semibold text-white">0</div><div id="mindSummary" class="muted small leading-relaxed mt-1">—</div></div>
            <div class="glass-card rounded-xl p-4"><div class="muted small">Body</div><div id="bodyScore" class="text-xl font-semibold text-white">0</div><div id="bodySummary" class="muted small leading-relaxed mt-1">—</div><div id="bodyBMI" class="muted small mt-1">BMI: —</div></div>
            <div class="glass-card rounded-xl p-4"><div class="muted small">Nutrition</div><div id="nutritionScore" class="text-xl font-semibold text-white">0</div><div id="nutritionSummary" class="muted small leading-relaxed mt-1">—</div></div>
            <div class="glass-card rounded-xl p-4"><div class="muted small">Sleep</div><div id="sleepScore" class="text-xl font-semibold text-white">0</div><div id="sleepSummary" class="muted small leading-relaxed mt-1">—</div></div>
        </div>
    </section>

    <section class="fade-in-up" style="animation-delay: 0.5s;">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-bold text-white">Unlock Your Premium Report</h2>
        <p class="muted max-w-2xl mx-auto mt-2">Go deeper with advanced analytics, personalized recommendations, and future wellness forecasts.</p>
      </div>

      <div id="premiumWrap" class="grid md:grid-cols-2 gap-6">
        </div>
    </section>

    <footer class="fade-in-up mt-8 glass-card rounded-2xl p-4 flex flex-col md:flex-row items-center justify-between gap-4" style="animation-delay: 0.6s;">
      <div class="flex items-center gap-4 text-center md:text-left">
        <div class="hidden sm:grid w-12 h-12 rounded-lg bg-gradient-to-br from-teal-500 to-cyan-500 place-items-center font-bold text-white text-2xl flex-shrink-0">★</div>
        <div>
          <div class="font-semibold text-white">Limited Time Offer — <span class="text-teal-400">30% Off</span></div>
          <div class="muted small">Unlock your full potential. Offer expires in <span id="timer" class="font-bold text-white">15:00</span></div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-right mr-2">
          <div class="muted small line-through">$49</div>
          <div class="text-2xl font-bold text-white">$34.30</div>
        </div>
        <button id="unlockBtn" class="cta px-5 py-3 rounded-lg font-bold pulsate">Unlock Premium</button>
        <button id="downloadPDFBtn" class="hidden px-4 py-2 rounded-lg border border-white/20 bg-white/10 text-white hover:bg-white/20">Download PDF</button>
      </div>
    </footer>
  </div>
</div>

  <div id="paymentModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 p-4">
    <div class="glass-card rounded-xl p-6 w-full max-w-md border-teal-400/50">
      <h3 class="font-semibold text-lg text-white">Payment Success</h3>
      <p class="muted small mt-2">Your premium report has been unlocked. You can now view all details and download a PDF.</p>
      <div class="mt-4 text-right"><button id="closeModal" class="cta px-4 py-2 rounded-lg text-sm font-semibold">OK</button></div>
    </div>
  </div>

<script>
/* =========================
   SETUP & DOM ELEMENTS
   ========================= */
const $ = id => document.getElementById(id);

// Глобальные переменные для хранения графиков
let gaugeChart, coreRadar;

/* =========================
   ЛОГИКА ПОЛУЧЕНИЯ ДАННЫХ
   ========================= */
async function init() {
  const loadingHTML = `
    <div id="loading-state" class="text-center p-10">
      <h2 class="text-2xl font-bold animated-gradient-text">Анализируем ваши данные...</h2>
      <p class="muted mt-2">Нейронные сети генерируют ваш персональный отчёт. Это может занять до 30 секунд.</p>
      <div class="w-16 h-16 mx-auto mt-6 animate-spin rounded-full border-4 border-slate-600 border-t-teal-400"></div>
    </div>
  `;
  // Скрываем основной контент и показываем загрузку
  const mainContent = document.querySelector('.max-w-6xl');
  mainContent.style.display = 'none';
  document.body.insertAdjacentHTML('afterbegin', loadingHTML);
  
  const sessionId = new URLSearchParams(window.location.search).get('sessionId');

  if (!sessionId) {
    showError("Ошибка: Session ID не найден. Пожалуйста, начните анализ заново.");
    return;
  }
  
  pollForResult(sessionId);
}

function pollForResult(sessionId, retries = 15) {
  if (retries <= 0) {
    showError("Не удалось сгенерировать отчёт. Пожалуйста, попробуйте позже.");
    return;
  }

  fetch('/.netlify/functions/checkResult', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sessionId })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === 'complete') {
      document.getElementById('loading-state')?.remove();
      document.querySelector('.max-w-6xl').style.display = 'block';
      renderReport(result.data);
    } else if (result.status === 'error') {
      showError(result.message);
    } else {
      // Статус 'pending', продолжаем опрос
      setTimeout(() => pollForResult(sessionId, retries - 1), 3000);
    }
  })
  .catch(err => {
    console.error(err);
    showError("Произошла ошибка при связи с сервером.");
  });
}

function showError(message) {
    const loadingState = document.getElementById('loading-state');
    if (loadingState) {
        loadingState.innerHTML = `
            <h2 class="text-2xl font-bold text-red-400">Произошла ошибка</h2>
            <p class="muted mt-2">${message}</p>
            <a href="quiz.html" class="cta inline-block mt-6 px-5 py-3 rounded-lg font-bold">Начать заново</a>
        `;
    }
}


/* =========================
   ANIMATION & RENDERING
   ========================= */

function renderReport(reportData) {
  const { freeReport, premiumReport } = reportData;

  // -- Populate Free Report --
  // $('archetype').textContent = freeReport.insights.archetype || 'Wellness Explorer'; // 'archetype' нет в новой схеме
  $('mainBarrier').textContent = freeReport.insights.mainBarrier;
  $('quickWin').textContent = freeReport.insights.quickWin;
  $('comparison').textContent = freeReport.insights.comparison;

  const DURATION = 1500;
  animateValue($('wellnessScore'), 0, freeReport.metrics.wellnessScore, DURATION);
  animateValue($('biologicalAge'), 0, freeReport.metrics.biologicalAge, DURATION);
  animateValue($('energyIndex'), 0, freeReport.metrics.energyIndex, DURATION);
  animateValue($('stressLevel'), 0, freeReport.metrics.stressLevel, DURATION);
  animateValue($('bioAge2'), 0, freeReport.metrics.biologicalAge, DURATION);
  animateValue($('energyIndex2'), 0, freeReport.metrics.energyIndex, DURATION);
  animateValue($('stressLevel2'), 0, freeReport.metrics.stressLevel, DURATION);
  animateValue($('mindScore'), 0, freeReport.coreFour.mind.score, DURATION);
  animateValue($('bodyScore'), 0, freeReport.coreFour.body.score, DURATION);
  animateValue($('nutritionScore'), 0, freeReport.coreFour.nutrition.score, DURATION);
  animateValue($('sleepScore'), 0, freeReport.coreFour.sleep.score, DURATION);

  $('mindSummary').textContent = freeReport.coreFour.mind.summary;
  $('bodySummary').textContent = freeReport.coreFour.body.summary;
  $('bodyBMI').textContent = freeReport.coreFour.body.bmi ? `BMI: ${freeReport.coreFour.body.bmi}` : 'BMI: —';
  $('nutritionSummary').textContent = freeReport.coreFour.nutrition.summary;
  $('sleepSummary').textContent = freeReport.coreFour.sleep.summary;

  setTimeout(() => {
      renderGauge(freeReport.metrics.wellnessScore);
      renderCoreRadar(freeReport.coreFour);
  }, 300);
  
  // -- Populate Premium Section --
  populatePremiumCards(premiumReport); // Будет работать с новой структурой
  setupEventListeners();
}

// ... Оставьте функции animateValue, renderGauge, renderCoreRadar без изменений ...
// [cite: 526, 527, 528-531]

function populatePremiumCards(premiumData) {
    // Эта функция должна быть адаптирована для работы с объектами, а не простыми значениями
    // Для краткости, этот раздел опущен, но его нужно будет доработать для красивого вывода сложных данных (массивов, объектов)
    console.log("Premium Data to render:", premiumData);
    $('premiumWrap').innerHTML = `<div class="glass-card rounded-xl p-4 md:col-span-2 text-center">
        <h3 class="font-semibold text-white">Детальный Премиум-отчет</h3>
        <p class="muted small mt-2">Разблокируйте, чтобы увидеть полную аналитику, включая метаболический возраст, персональные рекомендации и прогнозы.</p>
        <div class="lock-overlay" style="position: relative; background: none; filter: blur(5px); pointer-events: none;">
            <p class="p-3 rounded-lg bg-white/5 border border-white/10 mt-2">Метаболический возраст: ${premiumData.detailedAnalytics.metabolicAge}</p>
            <p class="p-3 rounded-lg bg-white/5 border border-white/10 mt-2">Рекомендации по питанию: ${premiumData.recommendations.nutritionGaps[0].nutrient}</p>
        </div>
    </div>`;
}

function setupEventListeners() {
    startCountdown(15 * 60);
    // Остальные слушатели событий (нажатие на кнопки, модальные окна)
    // ... Скопируйте эту часть из вашего оригинального файла ...
    // [cite: 543-551]
}

// Запуск приложения
init();

</script>
</body>
</html>
