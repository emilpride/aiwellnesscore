<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '785592354117222');
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=785592354117222&ev=PageView&noscript=1"
    /></noscript>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skin AI - Intelligent Skin Analysis</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta name="description" content="Upload or capture a live photo to unlock dermatologist-style insights in seconds.">
    <link rel="canonical" href="https://aiwellnesscore.com/skin.html" />
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aiwellnesscore.com/skin.html">
    <meta property="og:title" content="AI WELLNESSCORE - Skin Intelligence">
    <meta property="og:description" content="Real skin analysis insights at your fingertips.">
    <meta property="og:image" content="https://aiwellnesscore.com/og-image.png">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://aiwellnesscore.com/skin.html">
    <meta property="twitter:title" content="AI WELLNESSCORE - Skin Intelligence">
    <meta property="twitter:description" content="Real skin analysis insights at your fingertips.">
    <meta property="twitter:image" content="https://aiwellnesscore.com/og-image.png">

    <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "SoftwareApplication",
          "name": "AI WELLNESSCORE",
          "applicationCategory": "HealthApplication",
          "operatingSystem": "Web",
          "offers": {
            "@type": "Offer",
            "price": "9.99",
            "priceCurrency": "USD"
          },
          "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "reviewCount": "250"
          },
          "description": "An educational tool that provides insights into your lifestyle and general well-being through an AI-powered quiz and photo analysis."
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-accent: #A385E9;
            --brand-highlight: #53E5FF;
            --brand-dark-text: #2d2b33;
            --brand-muted: #6b7280;
            --border-soft: rgba(163, 133, 233, 0.18);
            --surface-strong: #ffffff;
            --surface-soft: rgba(255, 255, 255, 0.9);
            --bg-gradient: linear-gradient(135deg, #f7f5ff 0%, #ffffff 45%, #eff8ff 100%);
        }

        html, body {
            font-family: "Inter", sans-serif;
            background: var(--bg-gradient);
            color: var(--brand-dark-text);
            min-height: 100%;
            -webkit-font-smoothing: antialiased;
        }

        body { margin: 0; }

        @media (prefers-reduced-motion: no-preference) {
            body {
                background-size: 200% 200%;
                animation: bgGlow 24s ease-in-out infinite;
            }
        }

        @keyframes bgGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .page-shell { display: flex; flex-direction: column; min-height: 100vh; }

        header.sticky {
            background: rgba(255, 255, 255, 0.92);
            border-bottom: 1px solid rgba(163, 133, 233, 0.16);
            backdrop-filter: blur(16px);
        }

        .stage-card {
            background: var(--surface-soft);
            border: 1px solid rgba(163, 133, 233, 0.12);
            border-radius: 1.75rem;
            box-shadow: 0 24px 60px rgba(53, 46, 88, 0.12);
        }

        .tab-switch {
            display: inline-flex;
            padding: 0.3rem;
            background: rgba(163, 133, 233, 0.1);
            border-radius: 999px;
            border: 1px solid rgba(163, 133, 233, 0.2);
        }

        .tab-button {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.55rem 1.6rem;
            border-radius: 999px;
            color: var(--brand-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background: var(--surface-strong);
            color: var(--brand-dark-text);
            box-shadow: 0 12px 24px rgba(163, 133, 233, 0.2);
        }

        .upload-dropzone {
            border: 2px dashed rgba(163, 133, 233, 0.4);
            border-radius: 1.5rem;
            width: 18rem;
            height: 18rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            background: rgba(255, 255, 255, 0.85);
            transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .upload-dropzone:hover {
            border-color: var(--brand-accent);
            transform: translateY(-2px);
            box-shadow: 0 18px 36px rgba(163, 133, 233, 0.24);
        }

        .camera-panel {
            background: rgba(255, 255, 255, 0.88);
            border: 1px solid rgba(163, 133, 233, 0.18);
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .camera-panel video {
            width: 100%;
            max-width: 20rem;
            border-radius: 1.25rem;
            border: 1px solid rgba(163, 133, 233, 0.18);
            box-shadow: 0 16px 30px rgba(53, 46, 88, 0.12);
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--brand-accent);
            color: #ffffff;
            border-radius: 999px;
            padding: 0.85rem 1.8rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            box-shadow: 0 18px 30px rgba(163, 133, 233, 0.26);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            background: #8f72e0;
            box-shadow: 0 24px 40px rgba(163, 133, 233, 0.32);
        }

        .cta-button.secondary {
            background: rgba(163, 133, 233, 0.15);
            color: var(--brand-dark-text);
            box-shadow: none;
        }

        .cta-button.secondary:hover {
            background: rgba(163, 133, 233, 0.25);
            transform: none;
        }
        .plan-grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .plan-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        .plan-card {
            position: relative;
            padding: 1.75rem;
            border-radius: 1.5rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(163, 133, 233, 0.16);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .plan-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 24px 42px rgba(53, 46, 88, 0.15);
        }

        .plan-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.75rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 700;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(163, 133, 233, 0.24);
            background: rgba(163, 133, 233, 0.12);
            color: var(--brand-dark-text);
        }

        .plan-price {
            font-size: 2.35rem;
            font-weight: 800;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 0.65rem;
            font-size: 0.95rem;
            color: var(--brand-muted);
        }

        .feature-list li::before {
            content: '?';
            color: var(--brand-highlight);
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .results-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(163, 133, 233, 0.14);
            border-radius: 1.25rem;
            box-shadow: 0 18px 40px rgba(53, 46, 88, 0.14);
        }

        .analysis-overlay {
            position: fixed;
            inset: 0;
            background: rgba(17, 16, 26, 0.55);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 80;
        }

        .analysis-overlay.hidden { display: none; }

        .overlay-card {
            background: rgba(28, 26, 38, 0.88);
            border-radius: 1.5rem;
            padding: 2.5rem 2.25rem;
            max-width: 24rem;
            text-align: center;
            color: #f8f7ff;
            box-shadow: 0 32px 70px rgba(18, 16, 31, 0.45);
        }

        .overlay-spinner {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 999px;
            border: 4px solid rgba(255, 255, 255, 0.18);
            border-top-color: #ffffff;
            margin: 0 auto 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(17, 16, 26, 0.55);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 70;
        }

        .modal-backdrop.hidden { display: none; }

        .modal-card {
            position: relative;
            background: var(--surface-strong);
            border-radius: 1.75rem;
            padding: 2.25rem 2rem;
            max-width: 28rem;
            width: 100%;
            box-shadow: 0 32px 70px rgba(53, 46, 88, 0.2);
            border: 1px solid rgba(163, 133, 233, 0.18);
            display: grid;
            gap: 1.25rem;
        }

        .modal-close {
            position: absolute;
            top: 1.2rem;
            right: 1.2rem;
            border: none;
            background: rgba(163, 133, 233, 0.12);
            color: var(--brand-dark-text);
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 999px;
            font-size: 1.35rem;
            line-height: 2.25rem;
            text-align: center;
            cursor: pointer;
        }

        .modal-close:hover { background: rgba(163, 133, 233, 0.22); }

        .modal-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.75rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-weight: 700;
            padding: 0.4rem 1rem;
            border-radius: 999px;
            border: 1px solid rgba(163, 133, 233, 0.24);
            background: rgba(163, 133, 233, 0.12);
            color: var(--brand-dark-text);
        }

        .overlay-subtitle { color: rgba(255, 255, 255, 0.72); font-size: 0.9rem; margin-top: 0.35rem; }

        footer {
            color: var(--brand-muted);
            font-size: 0.75rem;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body class="antialiased">
    <div class="page-shell">
        <header class="sticky top-0 z-40">
            <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 flex items-center justify-between gap-6">
                <a href="index.html" class="flex items-center gap-3">
                    <img src="logo.png" alt="AI WELLNESSCORE" class="h-10 w-auto">
                    <span class="hidden sm:inline text-sm font-semibold tracking-wide text-[color:var(--brand-muted)]">Skin Intelligence</span>
                </a>
                <nav class="flex items-center gap-3 sm:gap-5 text-sm font-semibold text-[color:var(--brand-muted)]">
                    <a href="quiz-new.html" class="hidden md:inline-flex hover:text-[color:var(--brand-dark-text)] transition">Wellness Quiz</a>
                    <a href="result.html" class="hidden md:inline-flex hover:text-[color:var(--brand-dark-text)] transition">Sample Report</a>
                    <a href="#plans" class="cta-button px-4 py-2 text-sm">Start Analysis</a>
                </nav>
            </div>
        </header>

        <main class="flex-1">
            <section class="max-w-6xl mx-auto px-4 md:px-6 py-14 md:py-18">
                <div class="grid gap-10 lg:grid-cols-[1.05fr_minmax(0,0.95fr)] items-start">
                    <div id="upload-stage" class="stage-card p-8 md:p-10">
                        <header class="space-y-4 mb-8 text-center md:text-left">
                            <span class="text-xs font-semibold tracking-[0.18em] uppercase text-[color:var(--brand-muted)]">Step 1</span>
                            <h1 class="text-3xl md:text-4xl font-black tracking-tight">Capture or upload your skin snapshot</h1>
                            <p class="text-sm md:text-base text-[color:var(--brand-muted)] max-w-xl">Use a clear, well-lit photo (or take a live selfie) so our analysis engine can map 40+ dermatologist-grade skin indicators within seconds.</p>
                            <div class="tab-switch">
                                <button class="tab-button active" data-input-tab="upload">Upload photo</button>
                                <button class="tab-button" data-input-tab="camera">Use live camera</button>
                            </div>
                        </header>
                        <div id="upload-tab" class="flex flex-col items-center gap-6">
                            <input type="file" id="photo-upload" accept="image/jpeg,image/jpg" class="hidden">
                            <label for="photo-upload" class="upload-dropzone text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-[color:var(--brand-muted)]"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                <div>
                                    <p class="text-sm font-semibold">Drag & drop or click to upload</p>
                                    <p id="file-label" class="text-xs text-[color:var(--brand-muted)]">JPG or JPEG, up to 8 MB</p>
                                </div>
                            </label>
                            <p id="image-error" class="hidden text-sm font-semibold text-red-500"></p>
                        </div>
                        <div id="camera-tab" class="hidden camera-panel">
                            <video id="camera-stream" playsinline autoplay muted class="hidden"></video>
                            <div class="flex flex-wrap gap-3">
                                <button id="start-camera-btn" class="cta-button secondary">Enable camera</button>
                                <button id="capture-photo-btn" class="cta-button hidden">Capture photo</button>
                                <button id="cancel-camera-btn" class="cta-button secondary hidden">Cancel</button>
                            </div>
                            <p class="text-xs text-[color:var(--brand-muted)] text-center">Tip: keep your face centered, remove glasses, and use even lighting.</p>
                        </div>
                        <p id="analysis-error" class="hidden text-sm font-semibold text-red-500 text-center mt-6"></p>
                    </div>
                    <div id="plan-stage" class="stage-card p-8 md:p-10 hidden">
                        <header class="space-y-3 text-center md:text-left">
                            <span class="text-xs font-semibold tracking-[0.18em] uppercase text-[color:var(--brand-muted)]">Step 2</span>
                            <h2 class="text-2xl md:text-3xl font-bold">Choose how deep you want to go</h2>
                            <p class="text-sm md:text-base text-[color:var(--brand-muted)]">Every plan includes a downloadable report. Higher tiers unlock advanced overlays, coordinate maps, and richer severity scoring.</p>
                        </header>
                        <div class="plan-grid mt-8">
                            <article class="plan-card" data-plan="basic">
                                <span class="plan-tag">Starter</span>
                                <div>
                                    <h3 class="text-xl font-bold">Basic</h3>
                                    <p class="plan-price">$1</p>
                                    <p class="text-sm text-[color:var(--brand-muted)]">Capture the essentials: wrinkle, pore, pigment, and under-eye readouts.</p>
                                </div>
                                <ul class="feature-list">
                                    <li>Wrinkle, acne, pore & pigmentation flags</li>
                                    <li>Under-eye puffiness detection</li>
                                    <li>Skin type classification</li>
                                </ul>
                                <button class="cta-button w-full" data-plan-select="basic">Choose Basic</button>
                            </article>

                            <article class="plan-card" data-plan="advanced">
                                <span class="plan-tag">Most popular</span>
                                <div>
                                    <h3 class="text-xl font-bold">Advanced</h3>
                                    <p class="plan-price">$5</p>
                                    <p class="text-sm text-[color:var(--brand-muted)]">Unlock severity scoring, hydration maps, and sensitivity overlays.</p>
                                </div>
                                <ul class="feature-list">
                                    <li>All Basic insights plus severity scores</li>
                                    <li>Hydration & sensitivity heat maps</li>
                                    <li>Blackhead & pore coordinate exports</li>
                                </ul>
                                <button class="cta-button w-full" data-plan-select="advanced">Choose Advanced</button>
                            </article>

                            <article class="plan-card" data-plan="pro">
                                <span class="plan-tag">Clinic grade</span>
                                <div>
                                    <h3 class="text-xl font-bold">Professional</h3>
                                    <p class="plan-price">$9</p>
                                    <p class="text-sm text-[color:var(--brand-muted)]">Full dermatologist-grade overlays, wrinkle matrices, and ROI maps.</p>
                                </div>
                                <ul class="feature-list">
                                    <li>All Advanced insights plus wrinkle outlines</li>
                                    <li>Roughness & texture maps (PNG overlays)</li>
                                    <li>Dark-circle contours & ROI combined map</li>
                                </ul>
                                <button class="cta-button w-full" data-plan-select="pro">Choose Professional</button>
                            </article>
                        </div>
                    </div>

                    <div id="results-stage" class="stage-card p-8 md:p-10 hidden">
                        <header class="space-y-3 text-center md:text-left">
                            <span class="text-xs font-semibold tracking-[0.18em] uppercase text-[color:var(--brand-muted)]">Step 3</span>
                            <h2 class="text-2xl md:text-3xl font-bold">Your skin intelligence report</h2>
                            <p class="text-sm md:text-base text-[color:var(--brand-muted)]">Every metric below is returned directly from our analysis engine.</p>
                        </header>
                        <div class="mt-8 flex flex-col md:flex-row gap-6 md:gap-8 items-center md:items-start">
                            <img id="result-image" src="#" alt="Analyzed face preview" class="w-48 h-48 rounded-2xl object-cover border-2 border-[color:var(--brand-accent)] shadow-lg">
                            <div class="text-center md:text-left space-y-1">
                                <h3 id="result-plan-title" class="text-xl font-bold"></h3>
                                <p id="result-price" class="text-lg font-semibold"></p>
                                <p id="result-description" class="text-sm text-[color:var(--brand-muted)]"></p>
                            </div>
                        </div>
                        <div id="results-content" class="mt-6 space-y-5"></div>
                        <div class="mt-8 flex flex-wrap gap-3">
                            <button id="analyze-again-btn" class="cta-button secondary px-5 py-2.5">Analyze another photo</button>
                            <a href="quiz-new.html" class="cta-button px-5 py-2.5">Explore wellness quiz</a>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="px-4 md:px-6 py-10 border-t border-[color:var(--border-soft)] bg-white/70">
            <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                <p>AI WELLNESSCORE &copy; 2025. Educational insights - Not a medical service.</p>
                <div class="flex items-center gap-4">
                    <a href="privacy.html" class="hover:text-[color:var(--brand-dark-text)]">Privacy</a>
                    <a href="terms.html" class="hover:text-[color:var(--brand-dark-text)]">Terms</a>
                    <a href="contact.html" class="hover:text-[color:var(--brand-dark-text)]">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <div id="analysis-overlay" class="analysis-overlay hidden">
        <div class="overlay-card">
            <div class="overlay-spinner"></div>
            <h3 id="analysis-overlay-message" class="text-lg font-semibold">Processing...</h3>
            <p id="analysis-overlay-subtitle" class="overlay-subtitle"></p>
        </div>
    </div>
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="payment-modal-content" class="w-full max-w-3xl bg-white rounded-2xl shadow-xl transform scale-95 opacity-0 transition duration-300">
            <div class="p-6 md:p-8 relative">
                <button id="payment-modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-3xl leading-none" aria-label="Close">&times;</button>
                <h2 class="text-2xl md:text-3xl font-extrabold text-center mb-6" style="color: var(--brand-dark-text);">Secure your plan</h2>
                <div class="grid md:grid-cols-2 gap-6">
                                                            <div class="bg-gray-50 rounded-xl p-5 md:p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Plan summary</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Selected plan</span>
                                <span id="modal-plan-name">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Regular price</span>
                                <span id="modal-plan-regular">$0.00</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-gray-900 font-bold text-xl py-3 border-t border-gray-200 mt-4">
                            <span>Today's price</span>
                            <span id="modal-plan-total">$0.00</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 md:p-6 border border-gray-100">
                        <p id="modal-plan-description" class="text-sm text-[color:var(--brand-muted)] mb-4"></p>
                        <ul id="modal-plan-features" class="feature-list mb-4"></ul>
                        <div id="payment-element" class="mb-3"></div>
                        <p id="payment-error" class="text-sm text-red-600 mb-3 hidden"></p>
                        <button id="payment-modal-confirm" class="cta-button w-full flex items-center justify-center gap-2">
                            <svg id="payment-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
                            <span id="payment-btn-text">Pay & analyze</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
    (function () {
        const PLAN_DETAILS = {
            basic: {
                title: 'Basic plan',
                tag: 'Starter',
                price: '$1',
                description: 'Essential skin metrics to understand your baseline skin health.',
                modalFeatures: [
                    'Skin type classification with confidence levels',
                    'Wrinkle, acne, pore and pigmentation detection',
                    'Under-eye puffiness and skin age snapshot'
                ],
                subtitle: 'Delivering core skin insights'
            },
            advanced: {
                title: 'Advanced plan',
                tag: 'Most popular',
                price: '$5',
                description: 'Severity scores, hydration mapping, and coordinate overlays for targeted care.',
                modalFeatures: [
                    'Hydration, oiliness & sensitivity overlays (PNG / JPG)',
                    'Pigmentation & roughness scoring with area ratios',
                    'Blackhead and pore coordinate exports'
                ],
                subtitle: 'Unlocking severity scores and overlays'
            },
            pro: {
                title: 'Professional plan',
                tag: 'Clinic grade',
                price: '$9',
                description: 'Full dermatologist-inspired dataset with wrinkle outlines and ROI heatmaps.',
                modalFeatures: [
                    'Wrinkle outlines + deep vs shallow metrics',
                    'Dark circle contours & ROI combined map',
                    'Texture, roughness, pigmentation, and sensitivity heatmaps'
                ],
                subtitle: 'Delivering the complete full dataset'
            }
        };

        const PLAN_COPY = {
            basic: {
                title: 'Basic',
                price: '$1',
                blurb: "Focused essentials to understand your skin's baseline today."
            },
            advanced: {
                title: 'Advanced',
                price: '$5',
                blurb: 'Granular metrics, severity scoring, and visual overlays for targeted care.'
            },
            pro: {
                title: 'Professional',
                price: '$9',
                blurb: 'Dermatologist-style coordinates, scoring, and imagery for deep analysis.'
            }
        };

        const SKIN_TYPE_LABELS = ['Oily', 'Dry', 'Balanced', 'Combination'];
        const SKIN_TONE_LABELS = ['Very light', 'Light', 'Intermediate', 'Tan', 'Brown', 'Dark', 'Unclassified'];
        const SKIN_HUE_LABELS = ['Warm (yellow-leaning)', 'Neutral', 'Warm (red-leaning)', 'Unclassified'];
        const SEVERITY_SCALE = ['None / minimal', 'Mild', 'Moderate', 'Severe'];
        const MAP_LABELS = {
            red_area: 'Redness (sensitivity) map',
            brown_area: 'Pigmentation concentration map',
            water_area: 'Hydration deficiency map',
            texture_enhanced_pores: 'Texture: enlarged pores highlight',
            texture_enhanced_blackheads: 'Texture: blackhead highlight',
            texture_enhanced_lines: 'Texture: wrinkle highlight',
            rough_area: 'Texture: roughness map',
            roi_outline_map: 'ROI outline map'
        };
        const MARK_LABELS = {
            melanin_mark: 'Pigmentation coordinates',
            sensitivity_mark: 'Sensitivity (redness) coordinates',
            blackheads_mark: 'Blackhead coordinates',
            pores_mark: 'Pore coordinates',
            wrinkle_mark: 'Wrinkle outlines',
            dark_circle_outline: 'Dark circle outlines'
        };

        let uploadedImageDataUrl = null;
        let selectedPlan = null;
        let chartInstances = [];
        let cameraStream = null;

        const uploadStage = document.getElementById('upload-stage');
        const planStage = document.getElementById('plan-stage');
        const resultsStage = document.getElementById('results-stage');
        const uploadInput = document.getElementById('photo-upload');
        const imageError = document.getElementById('image-error');
        const errorBanner = document.getElementById('analysis-error');
        const imagePreview = document.getElementById('result-image');
        const overlay = document.getElementById('analysis-overlay');
        const overlayMessage = document.getElementById('analysis-overlay-message');
        const overlaySubtitle = document.getElementById('analysis-overlay-subtitle');
        const paymentModal = document.getElementById('payment-modal');
        const paymentModalContent = document.getElementById('payment-modal-content');
        const paymentModalClose = document.getElementById('payment-modal-close');
        const modalPlanName = document.getElementById('modal-plan-name');
        const modalPlanRegular = document.getElementById('modal-plan-regular');
        const modalPlanTotal = document.getElementById('modal-plan-total');
        const modalPlanDescription = document.getElementById('modal-plan-description');
        const modalPlanFeatures = document.getElementById('modal-plan-features');
        const paymentModalConfirm = document.getElementById('payment-modal-confirm');
        const resultsContent = document.getElementById('results-content');
        const resultPlanTitle = document.getElementById('result-plan-title');
        const resultPrice = document.getElementById('result-price');
        const resultDescription = document.getElementById('result-description');
        const tabButtons = document.querySelectorAll('[data-input-tab]');
        const uploadTab = document.getElementById('upload-tab');
        const cameraTab = document.getElementById('camera-tab');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const videoEl = document.getElementById('camera-stream');
        const analyzeAgainBtn = document.getElementById('analyze-again-btn');

        function destroyCharts() {
            chartInstances.forEach((chart) => chart?.destroy?.());
            chartInstances = [];
        }

        function clearAllStates() {
            errorBanner.classList.add('hidden');
            errorBanner.textContent = '';
            imageError.classList.add('hidden');
            imageError.textContent = '';
        }

        function showOverlay(message, subtitle) {
            overlayMessage.textContent = message;
            overlaySubtitle.textContent = subtitle || '';
            overlay.classList.remove('hidden');
        }

        function hideOverlay() {
            overlay.classList.add('hidden');
        }

        function showError(message) {
            errorBanner.textContent = message;
            errorBanner.classList.remove('hidden');
        }

        async function handleImageReady(dataUrl, fileLabelText) {
            async function compressIfNeeded(srcDataUrl) {
                try {
                    const img = new Image();
                    await new Promise((res, rej) => { img.onload = () => res(true); img.onerror = rej; img.src = srcDataUrl; });
                    const maxSide = 1600;
                    let { width, height } = img;
                    const scale = Math.min(1, maxSide / Math.max(width, height));
                    if (scale < 1) { width = Math.round(width * scale); height = Math.round(height * scale); }
                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    let q = 0.9; let out = canvas.toDataURL('image/jpeg', q);
                    const bytes = (d) => Math.ceil((d.length * 3) / 4);
                    while (bytes((out.split(',')[1]||'')) > 7.5 * 1024 * 1024 && q > 0.5) { q -= 0.1; out = canvas.toDataURL('image/jpeg', q); }
                    return out;
                } catch (e) { return srcDataUrl; }
            }
            uploadedImageDataUrl = await compressIfNeeded(dataUrl);
            if (fileLabelText) {
                document.getElementById('file-label').textContent = fileLabelText;
            }
            clearAllStates();
            uploadStage.classList.add('hidden');
            showOverlay('Validating photo...', 'Ensuring clarity and face position');
            setTimeout(() => {
                hideOverlay();
                planStage.classList.remove('hidden');
            }, 1600);
        }

        function switchInputTab(tab) {
            tabButtons.forEach((btn) => btn.classList.toggle('active', btn.dataset.inputTab === tab));
            if (tab === 'camera') {
                uploadTab.classList.add('hidden');
                cameraTab.classList.remove('hidden');
            } else {
                uploadTab.classList.remove('hidden');
                cameraTab.classList.add('hidden');
                stopCamera();
            }
        }

        async function startCamera() {
            try {
                clearAllStates();
                if (!navigator.mediaDevices?.getUserMedia) {
                    showError('Camera access is not supported on this device.');
                    return;
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                cameraStream = stream;
                videoEl.srcObject = stream;
                videoEl.classList.remove('hidden');
                startCameraBtn.classList.add('hidden');
                capturePhotoBtn.classList.remove('hidden');
                cancelCameraBtn.classList.remove('hidden');
            } catch (error) {
                console.error('Camera error:', error);
                showError('Unable to access camera. Please allow permission or upload a photo instead.');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach((track) => track.stop());
                cameraStream = null;
            }
            videoEl.srcObject = null;
            videoEl.classList.add('hidden');
            startCameraBtn.classList.remove('hidden');
            capturePhotoBtn.classList.add('hidden');
            cancelCameraBtn.classList.add('hidden');
        }

        function capturePhoto() {
            if (!cameraStream) return;
            const trackSettings = cameraStream.getVideoTracks()[0]?.getSettings?.() || {};
            const width = trackSettings.width || 720;
            const height = trackSettings.height || 960;
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoEl, 0, 0, width, height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            stopCamera();
            handleImageReady(dataUrl, 'Captured from camera');
        }

        function formatPercentage(value, digits = 1) {
            if (typeof value !== 'number' || !isFinite(value)) return null;
            return `${(value * 100).toFixed(digits)}%`;
        }

        function describeSeverity(value) {
            if (typeof value !== 'number') return 'Not available';
            return SEVERITY_SCALE[value] || `Level ${value}`;
        }
        function buildScoresSummary(scores) {
            if (!scores || typeof scores !== 'object') return null;
            const summary = [];
            if (typeof scores.total_score === 'number') {
                summary.push(`Overall skin score: ${scores.total_score}`);
            }
            const highlighted = ['wrinkle_score', 'water_score', 'melanin_score', 'oily_intensity_score', 'dark_circle_score'];
            const details = highlighted
                .filter((key) => typeof scores[key] === 'number')
                .map((key) => `${key.replace(/_/g, ' ').replace('score', '').trim()}: ${scores[key]}`);
            if (details.length) {
                summary.push(details.join(' · '));
            }
            return summary.join('. ');
        }

        function summariseMark(data) {
            if (!data || typeof data !== 'object') return 'Coordinate data available';
            const pieces = [];
            if (typeof data.count === 'number') {
                pieces.push(`Detected ${data.count} region${data.count === 1 ? '' : 's'}`);
            }
            if (Array.isArray(data.coord)) {
                pieces.push(`${data.coord.length} coordinate point${data.coord.length === 1 ? '' : 's'}`);
            }
            if (Array.isArray(data.rectangle)) {
                pieces.push(`${data.rectangle.length} bounding box${data.rectangle.length === 1 ? '' : 'es'}`);
            }
            if (Array.isArray(data.polygon)) {
                pieces.push(`${data.polygon.length} polygon${data.polygon.length === 1 ? '' : 's'}`);
            }
            return pieces.length ? pieces.join('; ') : 'Coordinate data available';
        }

        function buildPlanPresentation(plan, apiData) {
            const copy = PLAN_COPY[plan] || PLAN_COPY.basic;
            const result = apiData?.result || {};
            const scores = apiData?.score_info || result.score_info;
            const imageQuality = apiData?.image_quality || result.image_quality;
            const content = [];

            if (result.skin_type) {
                const typeIdx = typeof result.skin_type.value === 'number' ? result.skin_type.value : null;
                const typeLabel = typeIdx !== null ? (SKIN_TYPE_LABELS[typeIdx] || 'Unclassified') : 'Unclassified';
                const confidence = result.skin_type.details?.[typeIdx]?.confidence;
                const confidenceText = typeof confidence === 'number' ? ` (confidence ${(confidence * 100).toFixed(0)}%)` : '';
                content.push({ title: 'Skin type', text: `Detected ${typeLabel.toLowerCase()} skin${confidenceText}.` });
            }

            if (result.oily_intensity?.full_face) {
                const oily = result.oily_intensity.full_face;
                const areaText = formatPercentage(oily.area);
                content.push({ title: 'Oil distribution', text: `Full-face oil coverage ${areaText || 'N/A'} with severity: ${describeSeverity(oily.intensity)}.` });
            }

            if (result.water) {
                const severity = typeof result.water.water_severity === 'number' ? `${result.water.water_severity}` : 'N/A';
                const waterArea = formatPercentage(result.water.water_area);
                content.push({ title: 'Hydration status', text: `Water deficiency area ${waterArea || 'N/A'}. Severity index ${severity}.` });
            }

            if (result.skintone_ita) {
                const tone = result.skintone_ita;
                const toneLabel = SKIN_TONE_LABELS[tone.skintone] || 'Unclassified';
                content.push({ title: 'Skin tone (ITA)', text: `ITA angle ${tone.ita}°. Categorised as ${toneLabel.toLowerCase()}.` });
            } else if (result.skintone) {
                const toneLabel = SKIN_TONE_LABELS[result.skintone.value] || 'Unclassified';
                content.push({ title: 'Skin tone', text: `Categorised as ${toneLabel.toLowerCase()} with confidence ${(result.skintone.confidence * 100).toFixed(0)}%.` });
            }

            if (result.skin_hue_ha) {
                const hueLabel = SKIN_HUE_LABELS[result.skin_hue_ha.skin_hue] || 'Unclassified';
                content.push({ title: 'Skin hue (HA)', text: `Hue angle ${result.skin_hue_ha.HA}°. Tone classified as ${hueLabel.toLowerCase()}.` });
            }

            if (result.melanin) {
                const melaninArea = formatPercentage(result.melanin.brown_area);
                const concentration = result.melanin.melanin_concentration;
                content.push({ title: 'Pigmentation summary', text: `Overall pigmented area ${melaninArea || 'N/A'} with intensity score ${typeof concentration === 'number' ? concentration : 'N/A'}.` });
            }

            if (result.blackhead) {
                content.push({ title: 'Blackhead severity', text: `Severity: ${describeSeverity(result.blackhead.value)}${typeof result.blackhead_count === 'number' ? ` · Estimated count ${result.blackhead_count}` : ''}.` });
            }

            if (result.enlarged_pore_count) {
                const segments = Object.entries(result.enlarged_pore_count)
                    .map(([region, value]) => `${region.replace(/_/g, ' ')}: ${value}`)
                    .join(' · ');
                if (segments) {
                    content.push({ title: 'Enlarged pore count', text: segments });
                }
            }

            if (result.rough) {
                const areaText = formatPercentage(result.rough.rough_area);
                content.push({ title: 'Texture & roughness', text: `Overall roughness area ${areaText || 'N/A'} with severity ${result.rough.rough_severity ?? 'N/A'}.` });
            }

            if (result.sensitivity) {
                const areaText = formatPercentage(result.sensitivity.sensitivity_area);
                const intensity = result.sensitivity.sensitivity_intensity;
                content.push({ title: 'Sensitivity', text: `Redness coverage ${areaText || 'N/A'} with intensity score ${typeof intensity === 'number' ? intensity : 'N/A'}.` });
            }

            if (result.skin_age) {
                content.push({ title: 'Skin age estimate', text: `Estimated skin age: ${result.skin_age.value}` });
            }

            if (scores) {
                const summary = buildScoresSummary(scores);
                if (summary) content.push({ title: 'Score summary', text: summary });
            }

            if (imageQuality) {
                const bits = [];
                if (typeof imageQuality.face_ratio === 'number') bits.push(`Face ratio ${formatPercentage(imageQuality.face_ratio, 0)}`);
                if (imageQuality.face_orientation) {
                    const { yaw, pitch, roll } = imageQuality.face_orientation;
                    bits.push(`Yaw ${yaw?.toFixed?.(1) ?? '—'}° · Pitch ${pitch?.toFixed?.(1) ?? '—'}° · Roll ${roll?.toFixed?.(1) ?? '—'}°`);
                }
                if (typeof imageQuality.hair_occlusion === 'number') bits.push(`Hair covering ${formatPercentage(imageQuality.hair_occlusion)}`);
                if (typeof imageQuality.glasses === 'number') bits.push(imageQuality.glasses ? 'Glasses detected' : 'No glasses detected');
                if (bits.length) content.push({ title: 'Image quality checks', text: bits.join(' · ') });
            }

            if (Array.isArray(apiData?.maps)) {
                apiData.maps.forEach((map) => {
                    const title = MAP_LABELS[map.type] || map.type;
                    content.push({ title, text: 'Overlay generated by the analysis engine', image: map.dataUrl });
                });
            }

            if (apiData?.marks && typeof apiData.marks === 'object') {
                Object.entries(apiData.marks).forEach(([key, value]) => {
                    const label = MARK_LABELS[key] || key;
                    content.push({ title: label, text: summariseMark(value) });
                });
            }

            if (!content.length) {
                content.push({ title: 'Analysis summary', text: 'The analysis completed successfully, but no detailed metrics were returned. Please try requesting a richer plan.' });
            }

            return {
                title: copy.title,
                price: copy.price,
                description: copy.blurb,
                content
            };
        }
        function renderResults(presentation) {
            destroyCharts();
            resultsContent.innerHTML = '';
            presentation.content.forEach((item) => {
                const card = document.createElement('div');
                card.className = 'results-card p-5 md:p-6';

                const heading = document.createElement('h4');
                heading.className = 'text-lg font-semibold mb-2';
                heading.textContent = item.title;
                card.appendChild(heading);

                if (item.text) {
                    const para = document.createElement('p');
                    para.className = 'text-sm text-[color:var(--brand-muted)]';
                    para.textContent = item.text;
                    card.appendChild(para);
                }

                if (item.image) {
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.title;
                    img.className = 'mt-4 rounded-xl border border-[color:var(--border-soft)] shadow-sm';
                    card.appendChild(img);
                }

                resultsContent.appendChild(card);
            });
        }

        async function analyzeSkin(plan) {
            const response = await fetch('/.netlify/functions/faceppSkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageDataUrl: uploadedImageDataUrl, plan })
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(payload?.error || 'Unable to analyze the photo.');
            }
            return payload;
        }

        async function analyzeSkinWithRetry(plan, attempts = 3) {
            let lastErr;
            for (let i = 0; i < attempts; i++) {
                try { return await analyzeSkin(plan); } catch (e) { lastErr = e; await new Promise(r => setTimeout(r, 800 * (i + 1))); }
            }
            throw lastErr || new Error('Analysis failed');
        }

        async function handlePlanPayment(plan) {
            try {
                if (!uploadedImageDataUrl) { showError('Please upload or capture a photo first.'); return; }
                selectedPlan = plan;
                showOverlay('Analyzing your skin...', 'Mapping 40+ dermatologist-style signals');
                const apiData = await analyzeSkinWithRetry(plan);
                hideOverlay();
                planStage.classList.add('hidden');
                const presentation = buildPlanPresentation(plan, apiData);
                imagePreview.src = uploadedImageDataUrl;
                resultPlanTitle.textContent = `${presentation.title} report`;
                resultPrice.textContent = presentation.price;
                resultDescription.textContent = presentation.description;
                renderResults(presentation);
                resultsStage.classList.remove('hidden');
            } catch (error) {
                console.error('Analysis error:', error);
                hideOverlay();
                planStage.classList.remove('hidden');
                showError(error.message || 'Unable to analyze your skin right now. Please try again.');
            } finally {
                closePaymentModal();
            }
        }

                async function openPaymentModal(plan) {
            if (!PLAN_DETAILS[plan]) return;
            if (!uploadedImageDataUrl) { showError('Please upload or capture a photo first.'); return; }
            const details = PLAN_DETAILS[plan];
            modalPlanName.textContent = details.title;
            modalPlanRegular.textContent = details.regular || details.price;
            modalPlanTotal.textContent = details.price;
            modalPlanDescription.textContent = details.description;
            modalPlanFeatures.innerHTML = '';
            details.modalFeatures.forEach((feature) => {
                const li = document.createElement('li');
                li.textContent = feature;
                modalPlanFeatures.appendChild(li);
            });
            paymentModalConfirm.dataset.plan = plan;

            // Initialize Stripe Elements inside modal
            try {
                const keyResp = await fetch('/.netlify/functions/get-stripe-key');
                const { publishableKey } = await keyResp.json();
                if (!publishableKey) throw new Error('Stripe key missing');
                const stripe = Stripe(publishableKey);

                const piResp = await fetch('/.netlify/functions/payment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ plan }) });
                const piJson = await piResp.json();
                if (!piResp.ok) throw new Error(piJson.error || piJson.userError || 'Payment init failed');
                const clientSecret = piJson.clientSecret;

                const appearance = { theme: 'flat', variables: { colorPrimary: '#7f9efb' } };
                const elements = stripe.elements({ clientSecret, appearance });
                const paymentElement = elements.create('payment');
                const mountPoint = document.getElementById('payment-element');
                mountPoint.innerHTML = '';
                paymentElement.mount('#payment-element');

                paymentModalConfirm.onclick = async () => {
                    const errEl = document.getElementById('payment-error');
                    const spinner = document.getElementById('payment-spinner');
                    const btnText = document.getElementById('payment-btn-text');
                    errEl.classList.add('hidden');
                    paymentModalConfirm.disabled = true;
                    spinner.classList.remove('hidden');
                    btnText.textContent = 'Processing…';
                    try {
                        const { error } = await stripe.confirmPayment({ elements, confirmParams: {} });
                        if (error) throw error;
                        closePaymentModal();
                        await handlePlanPayment(plan); // continue with analysis after success
                    } catch (e) {
                        errEl.textContent = e.message || 'Payment failed';
                        errEl.classList.remove('hidden');
                    } finally {
                        paymentModalConfirm.disabled = false;
                        spinner.classList.add('hidden');
                        btnText.textContent = 'Pay & analyze';
                    }
                };
            } catch (e) {
                console.error('Stripe init error:', e);
                const errEl = document.getElementById('payment-error');
                errEl.textContent = e.message || 'Payment is unavailable';
                errEl.classList.remove('hidden');
            }

            paymentModal.classList.remove('opacity-0', 'pointer-events-none');
            paymentModalContent.classList.remove('scale-95', 'opacity-0');
        }

        function closePaymentModal() {
            paymentModal.classList.add('opacity-0', 'pointer-events-none');
            paymentModalContent.classList.add('scale-95', 'opacity-0');
        }

        function resetFlow() {
            stopCamera();
            destroyCharts();
            uploadedImageDataUrl = null;
            selectedPlan = null;
            uploadInput.value = '';
            document.getElementById('file-label').textContent = 'JPG or JPEG, up to 8 MB';
            clearAllStates();
            resultsStage.classList.add('hidden');
            planStage.classList.add('hidden');
            uploadStage.classList.remove('hidden');
            switchInputTab('upload');
        }

        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files?.[0];
            clearAllStates();
            if (!file) return;
            const validTypes = ['image/jpeg', 'image/jpg'];
            const maxSize = 8 * 1024 * 1024;
            if (!validTypes.includes(file.type)) {
                imageError.textContent = 'Invalid file format. Please use JPG or JPEG.';
                imageError.classList.remove('hidden');
                event.target.value = '';
                return;
            }
            if (file.size > maxSize) {
                imageError.textContent = 'File is too large. Maximum size is 8 MB.';
                imageError.classList.remove('hidden');
                event.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                const result = e.target?.result;
                if (typeof result !== 'string') {
                    imageError.textContent = 'Unable to read the selected file.';
                    imageError.classList.remove('hidden');
                    return;
                }
                const img = new Image();
                img.onload = function () {
                    if (img.width < 200 || img.height < 200 || img.width > 4096 || img.height > 4096) {
                        imageError.textContent = 'Image dimensions must be between 200 x 200 and 4096 x 4096 pixels.';
                        imageError.classList.remove('hidden');
                        uploadInput.value = '';
                        return;
                    }
                    handleImageReady(result, file.name);
                };
                img.src = result;
            };
            reader.readAsDataURL(file);
        });

        tabButtons.forEach((btn) => {
            btn.addEventListener('click', () => switchInputTab(btn.dataset.inputTab));
        });

        startCameraBtn.addEventListener('click', startCamera);
        capturePhotoBtn.addEventListener('click', capturePhoto);
        cancelCameraBtn.addEventListener('click', () => {
            stopCamera();
            switchInputTab('upload');
        });

        paymentModalClose.addEventListener('click', closePaymentModal);
        paymentModal.addEventListener('click', (event) => {
            if (event.target === paymentModal) closePaymentModal();
        });

        document.querySelectorAll('[data-plan-select]').forEach((btn) => {
            btn.addEventListener('click', () => openPaymentModal(btn.dataset.planSelect));
        });

        // paymentModalConfirm click is assigned dynamically in openPaymentModal after Stripe Elements mounts

        analyzeAgainBtn.addEventListener('click', () => {
            resetFlow();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    })();
    </script>
</body>
</html>







































