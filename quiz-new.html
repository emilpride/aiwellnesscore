<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "taixn4310d");
</script>
    <script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '785592354117222');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=785592354117222&ev=PageView&noscript=1"
/></noscript>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Wellness Quiz 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!--    (   ):
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core/dist/tf-core.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter/dist/tf-converter.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    -->
    
    <style>
        :root { 
            --brand-accent: #A385E9;
            --brand-dark-text: #2d2b33; 
        }
        
        /* --- UPDATED LIGHTER ANIMATED BACKGROUND --- */
        html, body { 
            overscroll-behavior: none; 
            font-family: 'Raleway', 'Inter', sans-serif; 
            min-height: 100%;
            background: linear-gradient(120deg, #f8fbff, #fff7fb, #f8fbff);
            background-size: 400% 400%;
            animation: moveBackground 40s ease infinite;
            position: relative;
            overflow-x: hidden;
        }
        body::before, body::after {
            content: "";
            position: fixed;
            inset: auto;
            width: 420px; height: 420px;
            filter: blur(100px);
            opacity: 0.45;
            z-index: 0;
            pointer-events: none;
        }
        body::before { left: -60px; top: 10vh; background: #53E5FF; transform: rotate(14.51deg); }
        body::after  { right: -60px; bottom: 8vh; background: #FF99CC; transform: rotate(-12deg); }

        @keyframes moveBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* --- END NEW BACKGROUND --- */

        #quiz-container { 
            display: flex; flex-direction: column; position: relative; 
            width: 100vw; height: 100vh; height: calc(var(--vh, 1vh) * 100); 
            overflow: hidden;
        }
        main#steps-wrapper { position: relative; width: 100%; flex-grow: 1; overflow-x: hidden; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        .quiz-step {
            position: absolute; left: 0; width: 100%;
            top: var(--header-offset, 0px);
            height: calc(100% - var(--header-offset, 0px));
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; 
            background-color: transparent; /* Changed to show animated background */
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1; overflow-y: auto; z-index: 1;
        }
        .quiz-step:not(.active) { 
            opacity: 0; 
            pointer-events: none; 
            transform: scale(1.05); 
        }
        /* Avoid transform on the active step to prevent iOS Safari range-slider drag bugs */
        .quiz-step.active { transform: none; }
        .quiz-step.prev:not(.active) { transform: scale(0.95); }
        #quiz-card {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
            min-height: 100%;
            gap: clamp(2rem, 4vw, 3rem);
            padding: clamp(2rem, 6vh, 3.5rem) clamp(1.5rem, 4vw, 3rem);
        }
        #quiz-card > * { width: 100%; }
        #step-quiz { justify-content: flex-start; align-items: stretch; }

        @keyframes contentFadeInUp {
            from { opacity: 0; transform: translateY(25px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .question-content-enter {
            animation: contentFadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Improve range slider touch behavior across devices */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            touch-action: pan-x; /* allow vertical scrolling, keep horizontal drag for slider */
            -webkit-user-select: none;
            user-select: none;
        }
        input[type="range"]:focus { outline: none; }
        /* Make the clickable area slightly larger on iOS */
        input[type="range"]::-webkit-slider-runnable-track { height: 10px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 26px; width: 26px; margin-top: -8px; border-radius: 50%; background: #3c3b31; }
        input[type="range"]::-moz-range-track { height: 10px; }
        input[type="range"]::-moz-range-thumb { height: 26px; width: 26px; border-radius: 50%; background: #3c3b31; border: none; }

        /* Micro-interaction: press feedback for option cards */
        .answer-option, .gender-option {
            transition: transform 120ms ease-out, box-shadow 120ms ease-out;
            will-change: transform;
        }
        .answer-option.pressed, .gender-option.pressed { transform: scale(0.96) translateZ(0); box-shadow: 0 10px 20px rgba(0,0,0,0.08) !important; }
        
        /* --- UPDATED HEADER STYLE WITH BLUR --- */
        #quiz-header { 
            flex-shrink: 0; 
            background: rgba(255, 255, 255, 0.6); /* Semi-transparent white */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            border-bottom: 1px solid rgba(0, 0, 0, 0.05); /* Lighter border */
            z-index: 50; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        #quiz-header.onboarding-header {
            background: transparent; border-color: transparent;
        }
        #quiz-header.onboarding-header .text-gray-600 {
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #side-menu { position: fixed; top: 0; right: 0; height: 100%; width: 280px; background-color: white; z-index: 150; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -10px 0 30px rgba(0,0,0,0.1); }
        #side-menu.active { transform: translateX(0); }
        #menu-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 140; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        #menu-overlay.active { opacity: 1; pointer-events: all; }

                /*        <style>  */

#step-landing > .w-full {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
}

@media (max-height: 750px) {
    #landing-animation {
        width: 100px;
        height: 100px;
        margin-bottom: 0.75rem !important;
    }
    #step-landing h1 {
        font-size: 1.875rem !important;
        line-height: 2.25rem !important;
    }
    #step-landing p.text-lg {
        font-size: 1rem !important;
        line-height: 1.5rem !important;
        margin-top: 0.75rem !important;
    }
    #step-landing .grid {
        margin-top: 1.25rem !important;
        gap: 1rem !important;
    }
    #step-landing .grid h3 {
        font-size: 0.875rem;
    }
    #step-landing .grid p {
        font-size: 0.75rem;
    }
    #step-landing div[style*="animation-delay: 400ms"] {
        margin-top: 1.25rem !important;
    }
}

/*        */
/*   */
#step-landing > .w-full {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-around; /*     */
}

/* -      ( ) */
@media (max-height: 750px) {
    #landing-animation {
        width: 100px;  /*   */
        height: 100px;
        margin-bottom: 0.75rem !important; /*   */
    }
    #step-landing h1 {
        font-size: 1.875rem !important; /*   (text-3xl) */
        line-height: 2.25rem !important;
    }
    #step-landing p.text-lg {
        font-size: 1rem !important; /*   */
        line-height: 1.5rem !important;
        margin-top: 0.75rem !important;
    }
    #step-landing .grid {
        margin-top: 1.25rem !important; /*    */
        gap: 1rem !important;
    }
    #step-landing .grid h3 {
        font-size: 0.875rem;
    }
    #step-landing .grid p {
        font-size: 0.75rem;
    }
    #step-landing div[style*="animation-delay: 400ms"] {
        margin-top: 1.25rem !important;
    }
}

    
    .dot.active { background-color: var(--brand-accent); transform: scale(1.25); }

        
        button.answer-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: rgba(255, 255, 255, 0.85);
            color: var(--brand-dark-text);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 18px;
            padding: 1rem 1.25rem;
            font: inherit;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
        }
        button.answer-option span {
            flex: 1;
            pointer-events: none;
        }
        button.answer-option::after {
            content: "\203A";
            font-size: 1.3rem;
            line-height: 1;
            color: rgba(100, 116, 139, 0.85);
            transition: transform 0.2s ease, color 0.2s ease;
        }
        .answer-option:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(15, 23, 42, 0.12);
            border-color: rgba(148, 163, 184, 0.6);
            background-color: rgba(255, 255, 255, 0.95);
        }
        .answer-option:hover::after {
            transform: translateX(4px);
            color: rgba(30, 41, 59, 0.85);
        }
        .answer-option.selected {
            border-color: var(--brand-accent);
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.25), rgba(56, 189, 248, 0.25));
            color: var(--brand-dark-text);
            box-shadow: 0 18px 32px rgba(80, 56, 140, 0.18);
        }
        .answer-option.selected::after {
            transform: translateX(4px);
            color: var(--brand-dark-text);
        }
        .answer-option:disabled {
            opacity: 0.75;
            cursor: not-allowed;
        }
        .gender-stack {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            width: 100%;
            flex-wrap: nowrap;
        }
        .gender-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 260px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--brand-dark-text);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 18px;
            padding: 1.25rem 1rem;
            font: inherit;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
        }
        .gender-stack .gender-option {
            flex: 1 1 0;
        }
        .gender-option .gender-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .gender-option:hover:not(:disabled) .gender-image { transform: scale(1.05); }

        #bmi-image-section {
            display: flex;
            align-items: flex-end;
            height: 250px;
            flex-grow: 1;
            justify-content: center;
        }
        #bmi-image {
            height: 100%;
            width: auto;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
        }
        /* BMI vertical scale (match profile.html) */
        #bmi-details { display: flex; align-items: center; justify-content: center; gap: 1.25rem; height: 250px; }
        #bmi-scale-container { position: relative; width: 32px; height: 100%; flex: 0 0 auto; }
        #bmi-scale-gradient-vertical { width: 100%; height: 100%; background: linear-gradient(to top, #43B7FF, #33C75A, #FBF447, #FFA64D, #FF7D7E); border-radius: 100px; position: absolute; inset: 0; }
        #bmi-thumb { position: absolute; width: 40px; height: 40px; background: linear-gradient(180deg, #F2F2F2 0%, #E8E8E8 100%); border: 2px solid #FFFFFF; box-shadow: 0 0 6.9px rgba(0,0,0,0.25); border-radius: 50%; left: 50%; transform: translateX(-50%); bottom: 0%; transition: bottom 1.5s cubic-bezier(0.22, 1, 0.36, 1); z-index: 1; }
        #bmi-value-display {
            position: absolute;
            bottom: var(--thumb-position, 0%);
            left: calc(100% + 0.75rem); /* place to the right of the scale */
            transform: translateY(50%);
            font-weight: 900;
            color: var(--brand-dark-text);
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(0,0,0,0.06);
            border-radius: 999px;
            padding: 0.2rem 0.6rem;
            font-size: clamp(1.1rem, 3.5vw, 1.6rem); /* larger digits */
            line-height: 1;
            box-shadow: 0 6px 16px rgba(15,23,42,0.12);
            white-space: nowrap;
            pointer-events: none;
            transition: bottom 1.5s cubic-bezier(0.22, 1, 0.36, 1), color 0.6s ease;
        }
        
        .sleep-animation-container {
            background-color: #1c2a4e; border-radius: 50%;
            box-shadow: 0 0 25px rgba(76, 104, 186, 0.4); color: #f0f0f0;
            position: relative;
        }
        .sleep-moon { position: relative; z-index: 1; font-size: 2.25rem; filter: drop-shadow(0 4px 12px rgba(255,255,255,0.25)); }
        .sleep-moon.animate { animation: moonFloat 3.5s ease-in-out infinite; }
        @keyframes moonFloat { 0%, 100% { transform: translateY(2px); } 50% { transform: translateY(-3px); } }
        .sleep-star { position: absolute; width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.95); box-shadow: 0 0 10px rgba(255,255,255,0.6); opacity: 0.8; animation: starTwinkle 2.4s ease-in-out infinite; }
        .sleep-star.sm { width: 4px; height: 4px; }
        .sleep-star.lg { width: 8px; height: 8px; }
        @keyframes starTwinkle { 0%, 100% { opacity: 0.5; transform: scale(0.85); } 50% { opacity: 1; transform: scale(1); } }
        .sleep-ring-bg { stroke: rgba(255, 255, 255, 0.2); }
        .sleep-ring-fg { stroke: #a7b2ff; stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .activity-day { width: 36px; height: 36px; border-radius: 10px; background-color: #e5e7eb; color: #6b7280; font-weight: 700; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .activity-day.active { background-color: var(--brand-accent); color: var(--brand-dark-text); transform: scale(1.15) translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }

        #camera-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #camera-modal.active { opacity: 1; pointer-events: all; }
        /*   */
/*   */
/* ,    */
/* ,  CSS */
#camera-container {
    position: relative;
    /*    - JS    */
    overflow: hidden;
    border-radius: 1.5rem;
    background: #111;
    border: 1px solid rgba(255,255,255,0.2);
    /*  flex      */
    display: flex;
    justify-content: center;
    align-items: center;
}
        /*  */
#camera-video, #camera-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transform: scaleX(-1); /*     */
}

#camera-video {
    object-fit: cover; /*     */
}
        #camera-guide-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); text-align: center; pointer-events: none; }
        #camera-guide-box { width: 70%; aspect-ratio: 1/1.2; border: 2px dashed rgba(255,255,255,0.5); border-radius: 50%; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        #camera-guide-box.locked { border-color: #34d399; box-shadow: 0 0 20px #34d399; }
        #close-camera-btn { position: absolute; top: 1rem; right: 1rem; background-color: rgba(0,0,0,0.5); border-radius: 50%; color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        
        /* --- UPDATED FOOTER STYLE WITH BLUR --- */
        #quiz-footer { 
            flex-shrink: 0; 
            background-color: rgba(255, 255, 255, 0.6); /* Semi-transparent white */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            border-top: 1px solid rgba(0, 0, 0, 0.05); /* Lighter border */
            box-shadow: none; /* Removed shadow, blur is enough */
            display: none; 
            pointer-events: none;
            padding: 1rem; 
        }
        /*      */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in-up {
    /*    */
    opacity: 0; 
    /*  ,  JS   'visible' */
    animation-fill-mode: forwards;
}

.fade-in-up.visible {
    animation-name: fadeInUp;
    animation-duration: 0.8s;
    animation-timing-function: cubic-bezier(0.2, 0.8, 0.2, 1);
}
            /* Quiz content readability */
        #question-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: clamp(1.25rem, 4vw, 3.5rem);
        }
        .question-content {
            width: 100%;
        }
        .question-shell {
            width: min(100%, 860px);
            margin: 0 auto;
            padding: clamp(2.25rem, 4.5vw, 3.25rem);
            border-radius: 32px;
            background: rgba(255, 255, 255, 0.68);
            border: 1px solid rgba(255, 255, 255, 0.55);
            box-shadow: 0 24px 60px rgba(80, 56, 140, 0.15);
            backdrop-filter: blur(26px);
            -webkit-backdrop-filter: blur(26px);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: clamp(1.75rem, 4vw, 3rem);
            position: relative;
            overflow: hidden;
        }
        .question-shell::before {
            content: "";
            position: absolute;
            inset: -18% auto auto -18%;
            width: 55%;
            height: 130%;
            background: radial-gradient(circle at top, rgba(163, 133, 233, 0.35), transparent 70%);
            transform: rotate(-10deg);
            pointer-events: none;
        }
        .question-shell > * {
            position: relative;
            z-index: 1;
            width: 100%;
        }
        .question-shell.cardless {
            background: rgba(255, 255, 255, 0.52);
            border: 1px solid rgba(255, 255, 255, 0.38);
            box-shadow: 0 18px 40px rgba(60, 44, 115, 0.15);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 1.5rem;
            text-align: center;
        }
        .question-shell.cardless::before {
            display: none;
        }
        .question-lead {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1.5rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .question-shell.cardless .question-lead {
            align-items: center;
            text-align: center;
            max-width: 640px;
            margin: 0 auto;
        }
        .question-icon { display: none; }
        .question-copy {
            width: 100%;
            max-width: 800px;
        }
        .question-shell.cardless .question-copy {
            max-width: 640px;
            margin: 0 auto;
        }
        .question-copy h2 {
            color: #1f2937;
            font-weight: 800;
            letter-spacing: -0.015em;
        }
        .question-copy p {
            color: #475569;
        }
        .question-body {
            align-self: stretch;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .answer-stack {
            display: grid;
            gap: 1rem;
            width: 100%;
        }
        .question-media {
            width: 144px;
            height: 144px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 20px 46px rgba(80, 56, 140, 0.22);
            margin: 0 auto;
        }
        .question-illustration {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .slider-panel {
            background: rgba(255, 255, 255, 0.82);
            border-radius: 26px;
            padding: clamp(1.75rem, 3vw, 2.25rem);
            min-height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid rgba(148, 163, 184, 0.28);
            box-shadow: 0 20px 40px rgba(80, 56, 140, 0.14);
        }
        .slider-readout {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        #slider-value-display {
            display: inline-flex;
            justify-content: center;
            text-align: center;
            font-variant-numeric: tabular-nums;
            min-width: 12ch;
            line-height: 1;
            align-items: baseline;
            gap: 0.75rem;
            font-size: clamp(2.5rem, 4vw, 3.25rem);
            font-weight: 800;
            color: var(--brand-dark-text);
        }
        #slider-value-display span,
        #slider-value-display strong {
            font-weight: inherit;
        }
        #slider-value-display small,
        #slider-value-display span.text-lg {
            font-size: 1rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: #94a3b8;
        }
        #slider-value-display .stress-score {
            font-weight: 800;
        }
        #slider-value-display[data-level="low"] .stress-score {
            color: #22c55e;
        }
        #slider-value-display[data-level="medium"] .stress-score {
            color: #f97316;
        }
        #slider-value-display[data-level="high"] .stress-score {
            color: #ef4444;
        }
        .question-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(167, 139, 250, 0.65), rgba(56, 189, 248, 0.65));
            outline: none;
        }
        .question-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #ffffff;
            border: 3px solid var(--brand-accent);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
            cursor: pointer;
        }
        .question-slider::-moz-range-thumb {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #ffffff;
            border: 3px solid var(--brand-accent);
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
            cursor: pointer;
        }
        .slider-range {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }
        .stress-panel {
            background: rgba(255, 255, 255, 0.88);
        }
        .stress-slider {
            background: linear-gradient(to right, #22c55e, #f97316, #ef4444);
        }
        .stress-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #a1a1aa;
        }
        #mood-slider-container {
            width: min(100%, 360px);
            margin-top: 1.5rem;
            padding: 1.5rem 1.75rem;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.82);
            border: 1px solid rgba(148, 163, 184, 0.24);
            box-shadow: 0 18px 36px rgba(80, 56, 140, 0.15);
        }
        #mood-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #94a3b8; gap: 0.5rem; }
        #mood-labels .mood-label { flex: 1 1 0; text-align: center; line-height: 1.2; }
        #mood-slider {
            width: 100%;
            margin-top: 1.25rem;
        }
        .mood-slider {
            background: linear-gradient(to right, #38bdf8, #facc15, #34d399);
        }
        .mood-slider::-webkit-slider-thumb,
        .mood-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            border-width: 4px;
        }
        #mood-emojis {
            display: flex;
            justify-content: space-between;
            font-size: 2.5rem;
            margin-bottom: 1.25rem;
            padding: 0 0.5rem;
        }
        #mood-emojis span {
            width: 48px; height: 48px; border-radius: 999px;
            display: inline-flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at 40% 35%, #ffffff, #eef2ff);
            box-shadow: 0 8px 18px rgba(80, 56, 140, 0.18);
            transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s, background 0.3s;
            position: relative;
        }
        #mood-emojis span:nth-child(1){ background: radial-gradient(circle at 40% 35%, #e0f2fe, #bfdbfe); }
        #mood-emojis span:nth-child(2){ background: radial-gradient(circle at 40% 35%, #ede9fe, #ddd6fe); }
        #mood-emojis span:nth-child(3){ background: radial-gradient(circle at 40% 35%, #fef9c3, #fde68a); }
        #mood-emojis span:nth-child(4){ background: radial-gradient(circle at 40% 35%, #bbf7d0, #86efac); }
        #mood-emojis span:after { content: ""; position: absolute; inset: 0; border-radius: inherit; box-shadow: inset 0 1px 3px rgba(255,255,255,0.4), inset 0 -2px 6px rgba(0,0,0,0.08); opacity: 0.9; }
        #mood-emojis span.selected { box-shadow: 0 14px 28px rgba(41, 37, 107, 0.25); }
        #mood-emojis span.spring { animation: springPop 260ms ease-out; }
        @keyframes springPop { 0% { transform: scale(1); } 60% { transform: scale(1.55); } 100% { transform: scale(1.45); } }
        #mood-labels .mood-label { font-weight: 600; }
        @media (max-width: 1024px) {
            #question-wrapper {
                padding: clamp(1rem, 6vw, 2.5rem);
            }
            .question-shell {
                padding: clamp(1.75rem, 5vw, 3rem);
                gap: clamp(1.5rem, 4vw, 2.5rem);
            }
            .question-lead,
            .question-body {
                width: 100%;
            }
            .question-lead {
                align-items: center;
                text-align: center;
            }
            .question-copy {
                margin: 0 auto;
            }
        }
        .question-content.animation-wrapper {
            background: transparent;
            box-shadow: none;
            padding: 0;
        }
        #progress-bar-inner {
            width: 0%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #a78bfa, #38bdf8);
            box-shadow: 0 8px 18px rgba(59, 130, 246, 0.3);
        }

        /* Widen question views to near full-screen with minimal margins */
        #step-quiz.quiz-step { padding: 0.25rem; }
        #step-quiz #quiz-card {
            max-width: none;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
            box-sizing: border-box;
        }
        #step-quiz #question-wrapper { padding: 0.25rem; }
        #step-quiz .question-shell {
            width: 100%;
            max-width: none;
            padding: clamp(0.5rem, 1.5vw, 1rem);
            box-sizing: border-box;
        }
        /* Ensure animation views are vertically centered */
        #step-quiz .animation-wrapper { min-height: 100%; }
        #question-wrapper.is-animation {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        #step-quiz .question-lead,
        #step-quiz .question-copy,
        #step-quiz .question-body {
            max-width: none;
            width: 100%;
        }
        #step-quiz .question-body { margin: 0; }
        #step-quiz .question-shell.cardless { padding: clamp(0.5rem, 1.5vw, 1rem); }
        /* --- FIX 1: только для экрана загрузки — выравниваем контент сверху, а не по центру --- */
#step-loading.quiz-step {
  justify-content: flex-start;                 /* вместо center из .quiz-step */
  padding-top: clamp(16px, 4vh, 24px);         /* небольшой верхний отступ */
}


        /* Loading steps styling */
        #step-loading { position: relative; z-index: 1; }
        /* Шаги просто располагаются НИЖЕ анимации и не перекрывают её */
/* --- FIX 3: шаги сразу под заголовком, без огромного зазора --- */
#step-loading .steps-list {
  position: static;                 /* на всякий случай: точно в документном потоке */
  width: min(90%, 22rem);
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 0.5rem;               /* <-- ключ: маленький отступ сверху */
  margin-bottom: 0.5rem;
}

/* Резервируем высоту под анимацию, чтобы шаги при маленьких экранах её не догоняли */
/* --- FIX 2: блок-герой НЕ растягивается, идёт обычным потоком --- */
#step-loading .loader-guard {
  min-height: 0;          /* отменяем резервирование места */
  flex: 0 0 auto;         /* запрещаем растяжение (заменяет flex-1) */
}



        .analysis-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.9rem;
            color: #433b6b;
            background: rgba(255, 255, 255, 0.78);
            border-radius: 999px;
            box-shadow: 0 14px 32px rgba(163, 133, 233, 0.16);
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.4s ease, transform 0.4s ease;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        /* Скрыть обводку кружка до момента done */
.analysis-step .circle { border-color: transparent; }
.analysis-step .circle.done { background: #a385e9; border-color: #a385e9; }

        .analysis-step.show {
            opacity: 1;
            transform: translateY(0);
        }
        .analysis-step .circle {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #a385e9;
            position: relative;
            overflow: hidden;
        }
        .analysis-step .circle.done {
            background: #a385e9;
            border-color: #a385e9;
        }
        /* Галочка скрыта по умолчанию — появится только когда кружку добавим класс .done */
.analysis-step .circle::after {
    content: "✓";                     /* нормальный символ галочки */
    position: absolute;
    inset: 0;
    color: white;
    font-size: 14px;
    line-height: 22px;
    text-align: center;
    opacity: 0;                       /* скрыто, пока шаг не "done" */
    transition: opacity .2s ease;
}
.analysis-step .circle.done::after {
    opacity: 1;                       /* показываем галочку, когда шаг отмечен done */
}
        .analysis-step .step-text {
            flex: 1;
            font-size: 0.875rem;
        }

        /* Insight animation cards */
        .insight-card {
            width: min(100%, 420px);
            margin: 0 auto;
            padding: 2rem 2.2rem;
            border-radius: 26px;
            box-shadow: 0 28px 80px rgba(41, 37, 107, 0.18);
            background: linear-gradient(140deg, rgba(255,255,255,0.9), rgba(255,255,255,0.55));
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            text-align: center;
            position: relative;
        }
        .insight-card h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.4rem;
        }
        .insight-card p {
            font-size: 0.95rem;
            color: rgba(30, 41, 59, 0.76);
            margin-bottom: 0;
        }
        .insight-card .insight-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        .insight-card.nutrition-card {
            background: linear-gradient(150deg, rgba(16, 185, 129, 0.22), rgba(56, 189, 248, 0.12)), rgba(255,255,255,0.82);
        }
        .insight-card.mindfulness-card {
            background: linear-gradient(150deg, rgba(129, 140, 248, 0.3), rgba(244, 114, 182, 0.12)), rgba(255,255,255,0.82);
        }
        .insight-card.alcohol-card {
            background: linear-gradient(150deg, rgba(251, 191, 36, 0.28), rgba(249, 115, 22, 0.1)), rgba(255,255,255,0.85);
        }
        .insight-card.screen-card {
            background: linear-gradient(160deg, rgba(99, 102, 241, 0.32), rgba(45, 212, 191, 0.12)), rgba(255,255,255,0.85);
        }
        .insight-meter {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 999px;
            overflow: hidden;
            margin: 1rem 0 0.5rem;
        }
        .insight-meter-fill {
            width: 0%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #34d399, #38bdf8);
            box-shadow: 0 10px 18px rgba(56, 189, 248, 0.25);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .insight-meter-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(17, 24, 39, 0.55);
        }
        .breath-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 0.75rem;
            border: 2px dashed rgba(255,255,255,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, rgba(255,255,255,0.55), rgba(129, 140, 248, 0.3));
        }
        .breath-pulse {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: rgba(255,255,255,0.8);
            opacity: 0.6;
            transform: scale(0.75);
        }
        .breath-pulse.breathing {
            animation: breathPulse var(--breath-duration, 3s) ease-in-out infinite;
        }
        @keyframes breathPulse {
            0%, 100% { transform: scale(0.75); opacity: 0.6; }
            50% { transform: scale(1); opacity: 1; }
        }
        .glass-meter {
            width: 96px;
            height: 160px;
            margin: 0 auto 1rem;
            border-radius: 24px 24px 34px 34px;
            border: 3px solid rgba(255,255,255,0.7);
            background: rgba(255,255,255,0.45);
            position: relative;
            overflow: hidden;
        }
        .glass-fill {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 0%;
            background: linear-gradient(180deg, #fcd34d, #f97316);
            transition: height 1.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .screen-device {
            width: 180px;
            height: 120px;
            margin: 0 auto 1rem;
            border-radius: 24px;
            border: 3px solid rgba(255,255,255,0.65);
            background: rgba(15, 23, 42, 0.88);
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        }
        .screen-glow {
            position: absolute;
            inset: 10px;
            border-radius: 18px;
            background: radial-gradient(circle at top, rgba(125, 211, 252, 0.55), rgba(15, 23, 42, 0.85));
        }
        .screen-scan {
            position: absolute;
            left: 10px;
            right: 10px;
            top: 100%;
            height: 24px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0));
            opacity: 0;
            animation: screenScan 3s ease-in-out infinite;
            animation-play-state: paused;
        }
        .screen-scan.active {
            animation-play-state: running;
        }
        @keyframes screenScan {
            0% { top: 100%; opacity: 0; }
            20% { opacity: 0.85; }
            50% { top: 25%; opacity: 0.75; }
            100% { top: -30%; opacity: 0; }
        }
        @media (max-width: 640px) {
            body::before, body::after { opacity: 0.18; width: 260px; height: 260px; }
            #quiz-container { background: rgba(255,255,255,0.94); }
            #quiz-card { padding: clamp(1.5rem, 10vw, 2.5rem) 1.25rem 2.5rem; gap: 2rem; }
            .question-shell { padding: 1.75rem 1.25rem; border-radius: 24px; }
            .question-body { max-width: 100%; }
            .question-content { padding: 1.4rem; border-radius: 22px; box-shadow: 0 18px 40px rgba(96, 78, 159, 0.2); }
            #progress-container { height: 10px; }
            .insight-card { padding: 1.6rem 1.75rem; }
            .question-content .answer-option { background: rgba(255,255,255,0.95); }
            #slider-value-display { font-size: clamp(2.25rem, 8vw, 2.75rem); }
            .gender-stack { flex-wrap: wrap; gap: 0.75rem; }
            .gender-stack .gender-option { flex: 1 1 calc(50% - 0.75rem); max-width: 100%; }
            .gender-option { padding: 1rem 0.75rem; }
            .gender-option .gender-image-container { width: 88px; height: 88px; margin-bottom: 0.5rem; }
        }
        @media (min-width: 1024px) {
  #quiz-container {
    max-width: 1100px; /* или 42rem (как max-w-2xl) */
    margin-left: auto;
    margin-right: auto;
  }
}
html, body {
  overflow-x: hidden;
}

    </style>
</head>
<body>

    <!-- Global Loader Overlay -->
    <div id="global-loader" class="fixed inset-0 bg-white/85 backdrop-blur-sm z-50 flex flex-col items-center justify-center p-6">
        <div class="w-14 h-14 border-4 border-gray-300 border-t-[--brand-accent] rounded-full animate-spin"></div>
        <p id="global-loader-text" class="mt-4 text-lg font-semibold text-gray-700 text-center">Preparing your quiz...</p>
        <p class="text-sm text-gray-500 mt-2">Warming up your personalized experience</p>
    </div>

<div id="quiz-container" class="mx-auto px-4 lg:max-w-2xl">
    <header id="quiz-header" class="w-full p-4 fixed top-0 left-0 right-0">
        <div class="flex items-center gap-4 max-w-2xl mx-auto">
            <a href="index.html" class="flex-shrink-0"><img src="logo.png" alt="Logo" class="h-8 w-auto"></a>
            <button id="back-btn" class="text-gray-600 hover:text-gray-900 transition hidden p-2 -ml-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
            <div id="progress-container" class="flex-grow h-2 rounded-full overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div id="progress-bar-inner" class="h-full transition-all duration-500 ease-out"></div></div>
            <button id="burger-menu-btn" aria-label="Menu" class="text-gray-600 hover:text-gray-900 transition p-2 -mr-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
        </div>
    </header>

    <main id="steps-wrapper">
        <section id="step-landing" class="quiz-step active">
    <div class="w-full max-w-2xl mx-auto text-center px-4">

<br>
<br>
        <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-[--brand-dark-text] fade-in-up" style="animation-delay: 100ms;">
            Your Biological Age is the Number That Matters
        </h1>

        <p class="mt-4 text-lg md:text-xl text-gray-600 max-w-xl mx-auto fade-in-up" style="animation-delay: 200ms;">
            Our AI analyzes your lifestyle and selfie to reveal your true wellness age, then creates a personalized plan to help you feel younger. Lower your bio-age by 3+ years.
        </p>

        <div class="grid grid-cols-3 gap-4 sm:gap-6 text-center" style="animation-delay: 300ms;">
    
    <div class="flex flex-col items-center">
        <div class="flex items-center justify-center h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-white shadow-md mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[--brand-accent]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M12 6V3m0 18v-3M5.636 5.636l-1.414-1.414M19.778 19.778l-1.414-1.414M18.364 5.636l-1.414 1.414M4.222 19.778l1.414-1.414M12 12a6 6 0 100-12 6 6 0 000 12z"></path></svg>
        </div>
        <h3 class="font-semibold text-gray-800 text-sm sm:text-base">AI-Powered Analysis</h3>
        <p class="text-xs sm:text-sm text-gray-500 hidden sm:block">Our model identifies hidden factors affecting your aging.</p>
    </div>
    
    <div class="flex flex-col items-center">
        <div class="flex items-center justify-center h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-white shadow-md mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[--brand-accent]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
        </div>
        <h3 class="font-semibold text-gray-800 text-sm sm:text-base">Personalized Action Plan</h3>
        <p class="text-xs sm:text-sm text-gray-500 hidden sm:block">Simple, daily tasks to reduce stress and boost energy.</p>
    </div>
    
    <div class="flex flex-col items-center">
        <div class="flex items-center justify-center h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-white shadow-md mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[--brand-accent]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
        </div>
        <h3 class="font-semibold text-gray-800 text-sm sm:text-base">Trackable Results</h3>
        <p class="text-xs sm:text-sm text-gray-500 hidden sm:block">See a real impact on your wellness score and skin health.</p>
    </div>
</div>

        <div class="fade-in-up" style="animation-delay: 400ms;">
            <button id="start-quiz-btn" class="w-full sm:max-w-xs mx-auto block bg-[--brand-accent] text-[--brand-dark-text] font-bold py-4 px-4 rounded-xl hover:opacity-90 transition-opacity shadow-lg shadow-[--brand-accent]/40">
                Start My Free Analysis
            </button>
            <p class="text-xs text-gray-500 text-center mt-4">
                By continuing, you agree to our 
                <a href="terms.html" class="underline hover:text-gray-700" target="_blank">Terms of Service</a> 
                and 
                <a href="privacy.html" class="underline hover:text-gray-700" target="_blank">Privacy Policy</a>.
            </p>
        </div>
    </div>
</section>

        <section id="step-quiz" class="quiz-step prev">
            <div id="quiz-card" class="w-full max-w-2xl mx-auto min-h-full flex flex-col items-center justify-center gap-5 sm:gap-6 px-4">
                <div id="question-wrapper" class="w-full"></div>
                <div id="footer-actions" class="w-full"></div>
            </div>
        </section>
        
        <section id="step-bmi" class="quiz-step prev">
             <div id="bmi-display-wrapper" class="flex flex-col items-center">
                 <div id="bmi-category" class="text-lg"></div>
                 <p id="bmi-description" class="text-gray-600 mt-1 text-center max-w-xs"></p>

                 <div id="bmi-details" class="w-full mt-6">
                     <div id="bmi-scale-container" class="relative">
                         <div id="bmi-scale-gradient-vertical"></div>
                         <div id="bmi-thumb"></div>
                         <div id="bmi-value-display" style="--thumb-position: 0%;"></div>
                     </div>
                     <div id="bmi-image-section">
                         <img id="bmi-image" src="" alt="BMI category illustration">
                     </div>
                 </div>
                 <button id="bmi-continue-btn" class="w-full sm:max-w-xs block bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 rounded-full text-lg hover:opacity-90 transition mt-8">Continue</button>
             </div>
        </section>
        
        <section id="step-loading" class="quiz-step prev">
  <div class="w-full h-full flex flex-col items-center relative">
    <!-- ГЕРОЙ (анимация + заголовок) всегда по центру по вертикали -->
    <div id="loading-hero" class="loader-guard flex flex-col items-center">
      <div id="loading-animation" class="w-48 h-48"></div>
      <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-800 mt-4 text-center">
        Analyzing Your Unique Profile...
      </h2>
    </div>

    <!-- ШАГИ: всегда внизу, не перекрывают героя -->
    <div id="analysis-steps" class="steps-list"></div>
  </div>
</section>


        <!-- NEW: Selfie Confirmation Step -->
        <section id="step-selfie-confirm" class="quiz-step prev">
            <div class="text-center max-w-sm mx-auto">
                <h2 class="text-3xl font-bold text-gray-900">Looks good?</h2>
                <img id="selfie-preview-img" src="" alt="Your selfie" class="w-full max-w-xs aspect-[3/4] object-cover rounded-2xl my-6 mx-auto shadow-lg border-2 border-white">
                <div class="flex flex-col sm:flex-row gap-3">
                    <button id="selfie-retake-btn" class="w-full bg-white text-gray-800 font-bold py-3 px-6 rounded-full text-lg hover:bg-gray-100 transition border border-gray-300">Retake</button>
                    <!-- MODIFIED BUTTON FOR LOADING STATE -->
                    <button id="selfie-confirm-btn" class="w-full bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 px-6 rounded-full text-lg hover:opacity-90 transition flex items-center justify-center disabled:opacity-75">
                        <span class="btn-text">Confirm Photo</span>
                        <span class="spinner hidden">
                            <svg class="animate-spin h-5 w-5 text-[--brand-dark-text]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>
        </section>
    </main>
    
    <footer id="quiz-footer" class="w-full z-10">
        
    </footer>
</div>

<div id="menu-overlay"></div>
<nav id="side-menu" class="p-6">
    <div class="flex justify-between items-center mb-8">
        <h3 class="text-xl font-bold">Menu</h3>
        <button id="close-menu-btn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
    </div>
    <div class="flex flex-col space-y-2">
        <a href="index.html" class="text-lg text-gray-700 hover:text-[--brand-dark-text] p-3 rounded-md transition-colors">Home</a>
        <a href="terms.html" class="text-lg text-gray-700 hover:text-[--brand-dark-text] p-3 rounded-md transition-colors">Terms of Service</a>
        <a href="privacy.html" class="text-lg text-gray-700 hover:text-[--brand-dark-text] p-3 rounded-md transition-colors">Privacy Policy</a>
        <a href="contact.html" class="text-lg text-gray-700 hover:text-[--brand-dark-text] p-3 rounded-md transition-colors">Contact</a>
    </div>
</nav>

<div id="camera-modal" role="dialog" aria-modal="true" aria-labelledby="camera-guide-text">
    <div id="camera-container">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas"></canvas>
        <div id="camera-guide-overlay">
            <h3 id="camera-guide-text" class="text-lg font-semibold">Center your face in the oval</h3>
            <div id="camera-guide-box"></div>
        </div>
        <button id="close-camera-btn" title="Close Camera" aria-label="Close Camera">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>
</div>
<canvas id="photo-canvas" style="display: none;"></canvas>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        currentStep: 'onboarding',
        currentQuestionIndex: -1,
        userAnswers: {},
        lastAnswer: null,
        sessionId: null, // To hold the user's session ID
        cameraStream: null,
        faceMesh: null,
        cameraAnimFrame: null,
        captureTimeout: null,
        lastPhotoDataUrl: null, // To hold photo data for confirmation
        faceMeshDrawState: { startTime: null, duration: 500 }, // Added for mesh fade-in
        // Replace the old quizQuestions array with this one
        quizQuestions: [
            { key: 'userGoal', type: 'options', text: "What's your main goal?", subtext: "This helps us tailor the final report to your interests.", options: [{ text: 'Find out my Biological Age', value: 'bio_age' }, { text: 'Get a Skin Health Analysis', value: 'skin' }, { text: 'Receive a 7-Day Improvement Plan', value: 'plan' }, { text: 'All of the above!', value: 'all' }] },
            { key: 'age', type: 'slider', text: "How old are you?", subtext: "Your age is a key factor in calculating your biological age baseline.", min: 16, max: 120, defaultValue: 30, unit: 'years' },
            { key: 'gender', type: 'gender_selection', text: "What's your biological sex?", subtext: "Biological sex influences body composition and metabolic rate.", options: [{ value: 'male', img: 'male.svg' }, { value: 'female', img: 'female.svg' }] },
            { key: 'height', type: 'slider', text: "What's your height?", subtext: "We use this to calculate your Body Mass Index (BMI).", min: 140, max: 220, defaultValue: 175, unit: 'cm' },
            { key: 'weight', type: 'slider', text: "What's your weight?", subtext: "We use this to calculate your Body Mass Index (BMI).", min: 40, max: 150, defaultValue: 77, unit: 'kg' },
            { key: 'bmi_display', type: 'animation' },
            { key: 'sleep', type: 'options', text: "On average, how much do you sleep?", subtext: "Quality sleep is crucial for cellular repair and mental clarity.", options: [{ text: 'Less than 5 hours' }, { text: '5-6 hours' }, { text: '7-8 hours' }, { text: 'More than 8 hours' }] },
            { key: 'sleep_visual', type: 'animation' },
            { key: 'activity', type: 'options', text: "How often do you exercise?", subtext: "Regular exercise impacts cardiovascular health and longevity.", options: [{ text: 'Rarely / Never' }, { text: '1-2 times a week' }, { text: '3-4 times a week' }, { text: '5+ times a week' }] },
            { key: 'activity_visual', type: 'animation' },
            { key: 'nutrition', type: 'options', text: "How many servings of fruits & veggies do you eat daily?", subtext: "A diet rich in nutrients is vital for your overall well-being.", options: ['0-1 serving', '2-3 servings', '4-5 servings', 'More than 5 servings'] },
            { key: 'processed_food', type: 'options', text: "How often do you eat processed or fast food?", subtext: "High consumption can lead to inflammation and other health issues.", options: ['Rarely', '1-2 times a week', '3-4 times a week', 'Daily'] },
            { key: 'hydration', type: 'options', text: "How much water do you drink per day?", subtext: "Proper hydration is essential for every bodily function.", options: ['1-3 cups', '4-6 cups', '7-9 cups', '10+ cups'] },
            { key: 'hydration_visual', type: 'animation' },
            { key: 'stress', type: 'slider', text: "How stressed do you usually feel?", subtext: "Chronic stress can significantly accelerate the aging process.", min: 1, max: 10, defaultValue: 5, unit: '' },
            { key: 'mindfulness', type: 'options', text: "How often do you practice mindfulness?", subtext: "Mindfulness practices can reduce stress and improve focus.", options: ['Never', 'Sometimes', 'Weekly', 'Daily'] },
            { key: 'mood', type: 'emoji_slider', text: "How would you describe your overall mood?", subtext: "Your mental state is deeply connected to your physical health.", options: [{ text: ':(', value: 'Often stressed or down' }, { text: ':/', value: 'Changes a lot' }, { text: ':)', value: 'Mostly content' }, { text: ':D', value: 'Happy & energetic' }] },
            { key: 'alcohol', type: 'options', text: "How much alcohol do you drink weekly?", subtext: "Alcohol consumption can affect sleep, hydration, and cellular health.", options: ['None', '1-3 drinks', '4-7 drinks', '8+ drinks'] },
            { key: 'smoking', type: 'options', text: "Do you smoke?", subtext: "Smoking is a major factor in premature aging and disease.", options: ['Never', 'Used to, but quit', 'Occasionally', 'Yes, daily'] },
            { key: 'screen_time', type: 'options', text: "How much screen time do you have daily (outside of work)?", subtext: "Excessive screen time can impact sleep and mental well-being.", options: ['Less than 2 hours', '2-4 hours', '4-6 hours', 'More than 6 hours'] },
            { key: 'selfie', type: 'camera_step', text: 'AI Photo Analysis (Optional)', subtext: 'Helps us analyze skin health and fine lines.' },
            { key: 'email', type: 'email_step', text: 'Enter your email', subtext: "We'll send your personalized report summary and respect your privacy." }
        ],
    };

    // Utils
    function escapeHtml(value) {
        if (value === undefined || value === null) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Fix mojibake in quizQuestions texts/options
    // Normalize texts/options only if they are clearly broken (defensive, idempotent)
    (function normalizeQuizQuestions(){
        try {
            const list = (typeof App !== 'undefined' && Array.isArray(App.quizQuestions)) ? App.quizQuestions : [];
            list.forEach(item => {
                if (!item) return;
                if (typeof item.text === 'string') {
                    item.text = item.text.replace(/What.?Ts/g, "What's");
                }
                // Sleep: fix collapsed dashes like '56' -> '5-6', '78' -> '7-8'
                if (item.key === 'sleep' && Array.isArray(item.options)) {
                    item.options = item.options.map(opt => {
                        const t = (typeof opt === 'string') ? opt : (opt?.text || opt);
                        if (!t) return opt;
                        if (/^56\s*hours$/.test(t)) return { text: '5-6 hours' };
                        if (/^78\s*hours$/.test(t)) return { text: '7-8 hours' };
                        return (typeof opt === 'string') ? opt : { text: opt.text };
                    });
                }
                // Activity: '12 times' -> '1-2 times', '34 times' -> '3-4 times'
                if (item.key === 'activity' && Array.isArray(item.options)) {
                    item.options = item.options.map(opt => {
                        const t = (typeof opt === 'string') ? opt : (opt?.text || opt);
                        if (!t) return opt;
                        if (/^12\s+times/.test(t)) return { text: '1-2 times a week' };
                        if (/^34\s+times/.test(t)) return { text: '3-4 times a week' };
                        return (typeof opt === 'string') ? opt : { text: opt.text };
                    });
                }
                // Nutrition: '01/23/45' -> '0-1/2-3/4-5'
                if (item.key === 'nutrition' && Array.isArray(item.options)) {
                    item.options = item.options.map(opt => {
                        const s = String(typeof opt === 'string' ? opt : opt?.text || opt);
                        return s.replace(/^01\b/, '0-1').replace(/^23\b/, '2-3').replace(/^45\b/, '4-5');
                    });
                }
                // Processed food: same numeric collapse
                if (item.key === 'processed_food' && Array.isArray(item.options)) {
                    item.options = item.options.map(opt => {
                        const s = String(typeof opt === 'string' ? opt : opt?.text || opt);
                        return s.replace(/^12\b/, '1-2').replace(/^34\b/, '3-4');
                    });
                }
                // Hydration: '13/46/79' -> '1-3/4-6/7-9'
                if (item.key === 'hydration' && Array.isArray(item.options)) {
                    item.options = item.options.map(opt => {
                        const s = String(typeof opt === 'string' ? opt : opt?.text || opt);
                        return s.replace(/^13\b/, '1-3').replace(/^46\b/, '4-6').replace(/^79\b/, '7-9');
                    });
                }
                // Screen time: '24/46' -> '2-4/4-6'
                if (item.key === 'screen_time' && Array.isArray(item.options)) {
                    item.options = item.options.map(opt => {
                        const s = String(typeof opt === 'string' ? opt : opt?.text || opt);
                        return s.replace(/^24\b/, '2-4').replace(/^46\b/, '4-6');
                    });
                }
            });
        } catch (e) { /* noop */ }
    })();

    // Interleave extra animations after every other non-animation question if not already followed by one
    (function interleaveAnimations(){
        if (App.animationsInterleaved) return;
        const mapKeyToAnim = {
            nutrition: 'nutrition_visual',
            processed_food: 'food_visual',
            mindfulness: 'mindfulness_visual',
            mood: 'mood_visual',
            alcohol: 'alcohol_visual',
            smoking: 'smoking_visual',
            screen_time: 'screen_time_visual'
        };
        const out = [];
        let nonAnimCount = 0;
        for (let i = 0; i < App.quizQuestions.length; i++) {
            const cur = App.quizQuestions[i];
            out.push(cur);
            if (cur.type === 'animation') continue;
            if (cur.type === 'camera_step' || cur.type === 'email_step') continue;
            nonAnimCount++;
            const next = App.quizQuestions[i+1];
            const hasAnimNext = next && next.type === 'animation';
            if (!hasAnimNext && nonAnimCount % 2 === 0) {
                const animKey = mapKeyToAnim[cur.key] || null;
                if (animKey) out.push({ key: animKey, type: 'animation' });
            }
        }
        App.quizQuestions = out;
        App.animationsInterleaved = true;
    })();
async function trackEvent(eventName) {

        if (!App.sessionId) return;

        try {

            await fetch('/.netlify/functions/quiz', {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({

                    action: 'trackEvent',

                    sessionId: App.sessionId,

                    eventName: eventName

                })

            });

        } catch (e) {

            console.error(`Failed to track event: ${eventName}`, e);

        }

    }
const LibraryLoader = {
        faceMeshLoaded: false,
        loadingPromise: null,
        
        async loadFaceMeshLibraries() {
            if (this.faceMeshLoaded) return true;
            if (this.loadingPromise) return this.loadingPromise;
            
            this.loadingPromise = new Promise(async (resolve, reject) => {
                try {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'face-mesh-loading';
                    loadingDiv.className = 'fixed top-4 right-4 bg-white rounded-lg shadow-lg p-4 z-50';
                    loadingDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="animate-spin h-5 w-5 border-2 border-gray-300 border-t-[--brand-accent] rounded-full"></div>
                            <span class="text-sm text-gray-600">Loading camera AI...</span>
                        </div>
                    `;
                    document.body.appendChild(loadingDiv);
                    
                    const scripts = [
                        'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js',
                        'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core/dist/tf-core.js',
                        'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter/dist/tf-converter.js',
                        'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl/dist/tf-backend-webgl.js',
                        'https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js'
                    ];
                    
                    for (const src of scripts) {
                        await this.loadScript(src);
                    }
                    
                    this.faceMeshLoaded = true;
                    document.getElementById('face-mesh-loading')?.remove();
                    resolve(true);
                } catch (error) {
                    document.getElementById('face-mesh-loading')?.remove();
                    reject(error);
                }
            });
            
            return this.loadingPromise;
        },
        
        loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = 'anonymous';
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }
    };
    const AnimationManager = {
        animations: new Map(),
        add(id, path) {
            if (this.animations.has(id) || !document.getElementById(id)) return;
            const container = document.getElementById(id);
            if(!container) return;
            container.innerHTML = '';
            try {
                const anim = lottie.loadAnimation({ container, renderer: 'svg', loop: true, autoplay: true, path });
                this.animations.set(id, anim);
            } catch(e) { console.error(`Lottie error on container #${id}:`, e); }
        }
    };
    
    const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);

    async function processAndSavePhoto() {
    const confirmBtn = document.getElementById('selfie-confirm-btn');
    const btnText = confirmBtn.querySelector('.btn-text');
    const spinner = confirmBtn.querySelector('.spinner');
    
    if (!App.lastPhotoDataUrl || !App.sessionId) {
        alert('An error occurred. Missing photo data or session ID.');
        return;
    }

    confirmBtn.disabled = true;
    btnText.classList.add('hidden');
    spinner.classList.remove('hidden');

    try {
        // 1.    
        console.log('Sending photo for analysis...');
        const analyzeResponse = await fetch('/.netlify/functions/analyzeSkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ photoDataUrl: App.lastPhotoDataUrl })
        });

        const responseData = await analyzeResponse.json();
        
        if (!analyzeResponse.ok) {
            // ,    
            if (responseData.error && responseData.error.includes('not configured')) {
                console.warn('Face analysis service not configured, skipping...');
                //    
                await saveAnswerToServer('selfie', App.lastPhotoDataUrl);
                await saveAnswerToServer('faceAnalysisSkipped', 'service_not_configured');
                handleAnswer('selfie', App.lastPhotoDataUrl);
                return;
            }
            throw new Error(`Face analysis failed: ${responseData.error || 'Unknown error'}`);
        }

        // 2. ,       
        if (!responseData.faces || responseData.faces.length === 0) {
            const retry = confirm('No face detected in the photo. Would you like to retake it?');
            if (retry) {
                document.getElementById('selfie-retake-btn').click();
                return;
            } else {
                //   
                await saveAnswerToServer('selfie', App.lastPhotoDataUrl);
                await saveAnswerToServer('faceAnalysisSkipped', 'no_face_detected');
                handleAnswer('selfie', App.lastPhotoDataUrl);
                return;
            }
        }

        // 3.   
        console.log('Saving analysis data...');
        const saveResponse = await fetch('/.netlify/functions/quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'saveAnalysisData',
                sessionId: App.sessionId,
                analysisData: responseData
            })
        });
        
        if (!saveResponse.ok) {
            throw new Error('Failed to save analysis data.');
        }
        
        console.log('Data saved successfully.');
        handleAnswer('selfie', App.lastPhotoDataUrl);

    } catch (error) {
        console.error('Error during photo processing:', error);
        
        //   
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h2 class="text-xl font-bold text-yellow-600 mb-2">Photo Analysis Issue</h2>
                <p class="text-gray-700 mb-4">We couldn't analyze your photo, but you can still continue.</p>
                <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                <div class="flex gap-3">
                    <button onclick="
                        document.getElementById('selfie-retake-btn').click();
                        this.closest('.fixed').remove();
                    " class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        Retake Photo
                    </button>
                    <button onclick="
                        App.handleAnswer('selfie', 'skipped');
                        this.closest('.fixed').remove();
                    " class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                        Skip Photo
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
    } finally {
        //     
        confirmBtn.disabled = false;
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
    }
}

    //       
    async function saveAnswerToServer(questionKey, answer) {
        if (!App.sessionId) {
            console.error("Cannot save answer, session ID is missing.");
            return;
        }
        try {
            const response = await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'saveAnswer',
                    sessionId: App.sessionId,
                    questionId: questionKey,
                    answer: answer
                })
            });
            if (!response.ok) {
                console.error('Failed to save answer for question:', questionKey);
            } else {
                console.log(`Answer for "${questionKey}" saved successfully.`);
            }
        } catch (error) {
            console.error('Error saving answer:', error);
        }
    }

    //   handleAnswer
async function handleAnswer(questionKey, answer) {
        App.userAnswers[questionKey] = answer;
        App.lastAnswer = { key: questionKey, value: answer };
        
        //       
        await saveAnswerToServer(questionKey, answer);
        
        //       
        setTimeout(next, 100);
    }
    App.handleAnswer = handleAnswer;

    //   handleOptionClick
    async function handleOptionClick(event, key, value) {
        const clickedButton = event.currentTarget;
        const parent = clickedButton.parentElement;
        parent.querySelectorAll('button').forEach(btn => btn.disabled = true);
        clickedButton.classList.add('selected');
        
        //  await,    handleAnswer
        await handleAnswer(key, value);
    }

    function goToStep(stepKey) {
        const prevStepEl = document.querySelector('.quiz-step.active');
        if (prevStepEl) prevStepEl.classList.add('prev');

        App.currentStep = stepKey;
        document.querySelectorAll('.quiz-step').forEach(step => {
            const isActive = step.id === `step-${stepKey}`;
            step.classList.toggle('active', isActive);
            if (!isActive) step.classList.remove('prev');
        });

        const quizHeader = document.getElementById('quiz-header');
        const progressContainer = document.getElementById('progress-container');
        const backBtn = document.getElementById('back-btn');
        
        if (stepKey === 'onboarding') {
            quizHeader.classList.add('onboarding-header');
            progressContainer.style.visibility = 'hidden';
            backBtn.classList.add('hidden');
        } else {
            quizHeader.classList.remove('onboarding-header');
            progressContainer.style.visibility = 'visible';
            backBtn.classList.toggle('hidden', App.currentQuestionIndex <= 0);
        }
        // Keep global footer hidden to avoid overlay issues on mobile; using in-card footer actions instead
        document.getElementById('quiz-footer').style.display = 'none';
    }
    
    // : /quiz-new.html

    //      

function next() {
    // ----   ----
    //   "Lead"  Facebook    "quizStarted"  
    if (App.currentQuestionIndex === -1) {
        fbq('track', 'Lead');
        trackEvent('quizStarted'); // <--   
    }
    // ----   ----

    App.currentQuestionIndex++;
    const stepConfig = App.quizQuestions[App.currentQuestionIndex];
    if (!stepConfig) {
        startAnalysis();
        return;
    }

    if (stepConfig.type === 'animation') {
        renderAnimation(stepConfig.key);
    } else {
        goToStep('quiz');
        renderQuestion();
    }
    updateProgressBar();
}

//      

    function previous() {
        if (App.currentQuestionIndex < 0) return;

        App.currentQuestionIndex--;

        while (App.currentQuestionIndex >= 0 && App.quizQuestions[App.currentQuestionIndex]?.type === 'animation') {
            App.currentQuestionIndex--;
        }

        if (App.currentQuestionIndex < 0) {
            goToStep('landing');
            updateProgressBar();
            return;
        }

        goToStep('quiz');
        renderQuestion();
        updateProgressBar();
    }
    function updateProgressBar() {
        const totalNonAnimationCount = App.quizQuestions.filter(q => q.type !== 'animation').length;
        if (totalNonAnimationCount === 0) return;

        const passedQuestions = App.quizQuestions.slice(0, App.currentQuestionIndex + 1);
        const passedNonAnimationCount = passedQuestions.filter(q => q.type !== 'animation').length;
        
        const progress = (passedNonAnimationCount / totalNonAnimationCount) * 100;
        const clamped = Math.min(100, progress);
        const bar = document.getElementById('progress-bar-inner');
        const container = document.getElementById('progress-container');
        if (bar) bar.style.width = `${clamped}%`;
        if (container) container.setAttribute('aria-valuenow', String(Math.round(clamped)));
        document.getElementById('back-btn').classList.toggle('hidden', App.currentQuestionIndex <= 0);
    }

    function renderQuestion() {
        const question = App.quizQuestions[App.currentQuestionIndex];
        if (!question) return;

        const wrapper = document.getElementById('question-wrapper');
        // Ensure normal questions are not in animation centering mode
        if (wrapper) wrapper.classList.remove('is-animation');
        const footerWrapper = document.getElementById('footer-actions');
        footerWrapper.innerHTML = '';

        const iconMap = {
            userGoal: 'UG',
            age: 'AG',
            gender: 'SX',
            height: 'HT',
            weight: 'WT',
            sleep: 'ZZ',
            activity: 'AC',
            nutrition: 'NU',
            processed_food: 'PF',
            hydration: 'HY',
            stress: 'ST',
            mindfulness: 'MI',
            mood: 'MO',
            alcohol: 'AL',
            smoking: 'SM',
            screen_time: 'SC',
            genetics: 'GN',
            chronic: 'CH',
            sun_protection: 'SP',
            selfie: 'SF'
        };
        const icon = escapeHtml(iconMap[question.key] || '');
        const questionText = escapeHtml(question.text || '');
        const subtextRaw = question.subtext || '';
        const subtext = escapeHtml(subtextRaw);
        const showSubtext = subtextRaw && question.type !== 'camera_step' && question.type !== 'email_step';

        let leadHTML = '';
        if (question.type === 'camera_step') {
            leadHTML = `
                <div class="question-lead">
                    <div class="question-media">
                        <img src="face.jpeg" alt="Face scan illustration" class="question-illustration">
                    </div>
                    <div class="question-copy text-center">
                        <h2 class="text-3xl font-bold text-gray-900">${questionText}</h2>
                        ${showSubtext ? `<p class="mt-3 text-gray-600 max-w-sm mx-auto">${subtext}</p>` : ''}
                    </div>
                </div>`;
        } else if (question.type === 'email_step') {
            leadHTML = `
                <div class="question-lead">
                    <span class="question-icon">${icon}</span>
                    <div class="question-copy text-center">
                        <h2 class="text-3xl font-bold text-gray-900">${questionText}</h2>
                        ${showSubtext ? `<p class="mt-3 text-gray-600 max-w-sm mx-auto">${subtext}</p>` : ''}
                    </div>
                </div>`;
        } else {
            leadHTML = `
                <div class="question-lead">
                    <span class="question-icon">${icon}</span>
                    <div class="question-copy">
                        <h2 class="text-3xl sm:text-4xl font-extrabold tracking-tight leading-tight text-gray-900">${questionText}</h2>
                        ${showSubtext ? `<p class="mt-3 text-base sm:text-lg text-gray-600 max-w-xl">${subtext}</p>` : ''}
                    </div>
                </div>`;
        }

        const sliderValue = question.key === 'stress'
            ? (App.userAnswers[question.key] ?? question.defaultValue ?? question.min ?? 5)
            : null;
        const baseBodyHTML = question.key === 'stress'
            ? `
                <div class="question-body">
                    <div class="slider-panel stress-panel">
                        <div class="slider-readout"><span id="slider-value-display"></span></div>
                        <input type="range" min="${question.min}" max="${question.max}" step="1" value="${sliderValue}" class="question-slider stress-slider" id="slider-input">
                        <div class="stress-scale">
                            <span>Relaxed</span>
                            <span>Stressed</span>
                        </div>
                    </div>
                </div>`
            : '<div class="question-body"></div>';

        wrapper.innerHTML = `
            <div class="question-shell cardless question-content question-content-enter">
                ${leadHTML}
                ${baseBodyHTML}
            </div>`;

        const bodyEl = wrapper.querySelector('.question-body');
        const previousAnswer = App.userAnswers[question.key];

        if (question.key === 'stress') {
            const sliderEl = wrapper.querySelector('#slider-input');
            if (sliderEl) {
                updateSliderDisplay(question, sliderEl.value);
                sliderEl.addEventListener('input', (event) => updateSliderDisplay(question, event.target.value));
            }
            footerWrapper.innerHTML = `<button id="slider-continue-btn" class="w-full sm:max-w-xs mx-auto block bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 rounded-full text-lg hover:opacity-90 transition">Continue</button>`;
            const continueBtn = footerWrapper.querySelector('#slider-continue-btn');
            if (continueBtn && sliderEl) {
                continueBtn.addEventListener('click', () => {
                    handleAnswer(question.key, Number(sliderEl.value));
                });
            }
            return;
        }

        switch (question.type) {
            case 'slider': {
                if (!bodyEl) break;
                const sliderMin = question.min ?? 0;
                const sliderMax = question.max ?? 100;
                const startValue = Number(previousAnswer ?? question.defaultValue ?? sliderMin);
                bodyEl.innerHTML = `
                    <div class="slider-panel">
                        <div class="slider-readout"><span id="slider-value-display"></span></div>
                        <input type="range" min="${sliderMin}" max="${sliderMax}" step="1" value="${startValue}" class="question-slider" id="slider-input" aria-valuemin="${sliderMin}" aria-valuemax="${sliderMax}" aria-valuenow="${startValue}">
                    </div>`;
                const sliderEl = bodyEl.querySelector('#slider-input');
                if (sliderEl) {
                    updateSliderDisplay(question, sliderEl.value);
                    sliderEl.addEventListener('input', (event) => updateSliderDisplay(question, event.target.value));
                }
                footerWrapper.innerHTML = `<button id="slider-continue-btn" class="w-full sm:max-w-xs mx-auto block bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 rounded-full text-lg hover:opacity-90 transition">Continue</button>`;
                const continueBtn = footerWrapper.querySelector('#slider-continue-btn');
                if (continueBtn && sliderEl) {
                    continueBtn.addEventListener('click', () => {
                        handleAnswer(question.key, Number(sliderEl.value));
                    });
                }
                break;
            }
            case 'options': {
                if (!bodyEl) break;
                const options = Array.isArray(question.options) ? question.options : [];
                if (!options.length) {
                    bodyEl.innerHTML = '<p class="text-center text-gray-500 mt-6">No options available.</p>';
                    break;
                }
                bodyEl.innerHTML = `
                    <div class="flex flex-col gap-3 mt-6">
                        ${options.map((opt, idx) => {
                            let optionText;
                            if (typeof opt === 'object' && opt !== null) {
                                optionText = escapeHtml(opt.text ?? opt.value ?? `Option ${idx + 1}`);
                            } else {
                                optionText = escapeHtml(opt);
                            }
                            return `<button type="button" class="answer-option" data-index="${idx}"><span>${optionText}</span></button>`;
                        }).join('')}
                    </div>`;
                const buttons = bodyEl.querySelectorAll('button.answer-option');
                buttons.forEach((btn) => {
                    btn.addEventListener('pointerdown', () => btn.classList.add('pressed'));
                    btn.addEventListener('pointerup', () => btn.classList.remove('pressed'));
                    btn.addEventListener('pointerleave', () => btn.classList.remove('pressed'));
                    btn.addEventListener('click', (event) => {
                        const index = Number(btn.getAttribute('data-index'));
                        const opt = options[index];
                        const value = (typeof opt === 'object' && opt !== null)
                            ? (opt.value ?? opt.text ?? opt)
                            : opt;
                        handleOptionClick(event, question.key, value);
                    });
                });
                break;
            }
            case 'gender_selection': {
                if (!bodyEl) break;
                const options = Array.isArray(question.options) ? question.options : [];
                bodyEl.innerHTML = `
                    <div class="gender-stack gap-4 mt-6">
                        ${options.map((opt, idx) => {
                            const value = escapeHtml(opt?.value ?? `option_${idx}`);
                            const label = escapeHtml(opt?.label ?? opt?.text ?? (opt?.value ?? `Option ${idx + 1}`));
                            const img = opt?.img ? `<img src="${opt.img}" alt="${label}" class="gender-image">` : '';
                            return `
                                <button type="button" class="gender-option" data-value="${value}">
                                    <div class="gender-image-container">${img}</div>
                                    <span class="gender-label font-semibold text-lg">${label}</span>
                                </button>`;
                        }).join('')}
                    </div>`;
                const buttons = bodyEl.querySelectorAll('button.gender-option');
                buttons.forEach((btn) => {
                    btn.addEventListener('pointerdown', () => btn.classList.add('pressed'));
                    btn.addEventListener('pointerup', () => btn.classList.remove('pressed'));
                    btn.addEventListener('pointerleave', () => btn.classList.remove('pressed'));
                    btn.addEventListener('click', (event) => {
                        const value = btn.getAttribute('data-value');
                        handleOptionClick(event, question.key, value);
                    });
                });
                break;
            }
            case 'camera_step': {
                if (!bodyEl) break;
                bodyEl.innerHTML = `
                    <div class="flex flex-col gap-4 items-center mt-6">
                        <button type="button" id="open-camera-btn" class="w-full sm:max-w-xs bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 px-6 rounded-full text-lg hover:opacity-90 transition">Open Camera</button>
                        <button type="button" id="skip-camera-btn" class="text-sm text-gray-500 underline hover:text-gray-700">Skip photo</button>
                    </div>`;
                const openBtn = bodyEl.querySelector('#open-camera-btn');
                if (openBtn) {
                    openBtn.addEventListener('click', () => {
                        openCamera();
                        try { trackEvent('selfieCameraOpened'); } catch (e) { /* ignore */ }
                    });
                }
                const skipBtn = bodyEl.querySelector('#skip-camera-btn');
                if (skipBtn) {
                    skipBtn.addEventListener('click', () => {
                        handleAnswer('selfie', 'skipped');
                    });
                }
                break;
            }
            case 'email_step': {
                if (!bodyEl) break;
                const previousValue = (previousAnswer && previousAnswer !== 'skipped') ? previousAnswer : '';
                bodyEl.innerHTML = `
                    <div class="flex flex-col gap-4 mt-6 max-w-sm mx-auto w-full">
                        <input type="email" id="email-input" value="${escapeHtml(previousValue)}" placeholder="you@example.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[--brand-accent] focus:border-[--brand-accent]" autocomplete="email">
                        <p class="text-sm text-gray-500 text-center">We only use your email to send the personalized summary.</p>
                    </div>`;
                footerWrapper.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-3 max-w-sm mx-auto mt-6 w-full">
                        <button id="email-submit-btn" class="flex-1 bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 px-5 rounded-lg hover:opacity-90 transition">Next</button>
                        <button id="email-skip-btn" class="flex-1 bg-white border border-gray-300 text-gray-600 font-semibold py-3 px-5 rounded-lg hover:bg-gray-50 transition">Skip for now</button>
                    </div>`;
                const emailInput = bodyEl.querySelector('#email-input');
                const submitBtn = footerWrapper.querySelector('#email-submit-btn');
                const skipBtn = footerWrapper.querySelector('#email-skip-btn');
                const submitEmail = () => {
                    if (!emailInput) return;
                    const email = emailInput.value.trim();
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                        alert('Please enter a valid email address.');
                        return;
                    }
                    handleAnswer('email', email);
                };
                if (submitBtn) {
                    submitBtn.addEventListener('click', submitEmail);
                }
                if (emailInput) {
                    emailInput.addEventListener('keyup', (event) => {
                        if (event.key === 'Enter') { submitEmail(); }
                    });
                }
                if (skipBtn) {
                    skipBtn.addEventListener('click', async () => {
                        try { await trackEvent('emailSkipped'); } catch (e) { /* noop */ }
                        handleAnswer('email', 'skipped');
                    });
                }
                break;
            }
            case 'emoji_slider': {
                if (!bodyEl) break;
                const options = Array.isArray(question.options) ? question.options : [];
                if (!options.length) {
                    bodyEl.innerHTML = '<p class="text-center text-gray-500 mt-6">No options available.</p>';
                    break;
                }
                const fallbackFaces = ['\u{1F61F}', '\u{1F610}', '\u{1F642}', '\u{1F929}'];
                const emojiData = options.map((opt, idx) => {
    const asciiMap = { ':(': '\u{1F641}', ':/': '\u{1F615}', ':)': '\u{1F642}', ':D': '\u{1F929}' };
    if (typeof opt === 'object' && opt !== null) {
        const raw = opt.text?.trim() || opt.emoji || fallbackFaces[idx] || '\u{1F642}';
        const face = asciiMap[raw] || raw;
        const value = (typeof opt === 'object' && opt !== null) ? (opt.value ?? opt.text ?? face) : (typeof opt === 'string' ? opt : face);
        return { face, value, label: opt.value ?? value };
    }
    const raw = typeof opt === 'string' ? opt.trim() : fallbackFaces[idx] || '\u{1F642}';
    const face = asciiMap[raw] || raw;
    return { face, value: face, label: face };
});
                let activeIndex = 1;
                if (previousAnswer) {
                    const foundIndex = emojiData.findIndex(item => item.value === previousAnswer);
                    if (foundIndex >= 0) activeIndex = foundIndex;
                }
                const initialDescription = previousAnswer || emojiData[activeIndex].label;
                bodyEl.innerHTML = `
                    <div id="mood-slider-container" class="flex flex-col gap-4 items-center mt-4">
                        <div class="w-full space-y-2">
                            <div id="mood-emojis" class="flex justify-between text-3xl">${emojiData.map((item, idx) => `<span data-index="${idx}">${escapeHtml(item.face)}</span>`).join('')}</div>
                            <div id="mood-labels" class="flex justify-between text-xs text-gray-500">${emojiData.map(item => `<span class="mood-label">${escapeHtml(item.label)}</span>`).join('')}</div>
                        </div>
                        <input type="range" min="0" max="${Math.max(emojiData.length - 1, 0)}" value="${activeIndex}" step="1" id="mood-slider" class="question-slider mood-slider" aria-valuemin="0" aria-valuemax="${Math.max(emojiData.length - 1, 0)}" aria-valuenow="${activeIndex}">
                        <p id="mood-selection-label" class="text-sm text-gray-600 text-center">${escapeHtml(initialDescription)}</p>
                    </div>`;
                footerWrapper.innerHTML = `<button class="w-full sm:max-w-xs mx-auto block bg-[--brand-accent] text-[--brand-dark-text] font-bold py-3 rounded-full text-lg hover:opacity-90 transition" id="mood-confirm-btn">Confirm</button>`;
                const moodSlider = document.getElementById('mood-slider');
                const emojiSpans = document.querySelectorAll('#mood-emojis span');
                const selectionLabel = document.getElementById('mood-selection-label');
                const updateEmojiSelection = () => {
    if (!moodSlider) return;
    emojiSpans.forEach((span, index) => {
        const isSel = index == moodSlider.value;
        span.style.transform = isSel ? 'scale(1.45)' : 'scale(1)';
        span.style.opacity = isSel ? '1' : '0.5';
        span.classList.toggle('selected', isSel);
        if (isSel) { span.classList.remove('spring'); void span.offsetWidth; span.classList.add('spring'); }
    });
    const current = emojiData[moodSlider.value];
    if (selectionLabel && current) {
        selectionLabel.textContent = current.label;
    }
};
                if (moodSlider) {
                    updateEmojiSelection();
                    moodSlider.addEventListener('input', updateEmojiSelection);
                }
                const moodConfirm = document.getElementById('mood-confirm-btn');
                if (moodConfirm && moodSlider) {
                    moodConfirm.addEventListener('click', () => {
                        const selected = emojiData[moodSlider.value];
                        handleAnswer(question.key, selected ? selected.value : previousAnswer);
                    });
                }
                break;
            }
            default: {
                break;
            }
        }
    }

    // Replace the old updateSliderDisplay function with this one
//        updateSliderDisplay
    function updateSliderDisplay(question, value) {
        const valueDisplay = document.getElementById('slider-value-display');
        if (!valueDisplay) return;

        const numericValue = Number(value);
        if (question.key === 'stress') {
            valueDisplay.innerHTML = `<span class="stress-score">${numericValue}</span><small>/10</small>`;
            if (numericValue <= 4) {
                valueDisplay.dataset.level = 'low';
            } else if (numericValue <= 7) {
                valueDisplay.dataset.level = 'medium';
            } else {
                valueDisplay.dataset.level = 'high';
            }
            return;
        }

        if (valueDisplay.dataset.level) {
            delete valueDisplay.dataset.level;
        }

        let displayHTML = `${numericValue}${question.unit ? ` ${question.unit}` : ''}`;

        if (question.unit === 'cm') {
            const totalInches = numericValue / 2.54;
            let feet = Math.floor(totalInches / 12);
            let inches = Math.round(totalInches % 12);
            if (inches === 12) {
                feet += 1;
                inches = 0;
            }
            displayHTML = `${feet}'${inches}" <span class="text-lg text-gray-400 font-medium">(${numericValue} cm)</span>`;
        } else if (question.unit === 'kg') {
            const lbs = Math.round(numericValue * 2.20462);
            displayHTML = `${lbs} lbs <span class="text-lg text-gray-400 font-medium">(${numericValue} kg)</span>`;
        }

        valueDisplay.innerHTML = displayHTML;
    }
    
    function renderAnimation(key) {
        goToStep('quiz'); // Keep quiz step active for animation
        const wrapper = document.getElementById('question-wrapper');
        if (wrapper) wrapper.classList.add('is-animation');
        document.getElementById('footer-actions').innerHTML = '';
        document.getElementById('back-btn').classList.add('hidden'); // Hide back button for animations

        let animationHTML = '';
        // Motivation based on the user's last answer
        let motivation = '';
        const la = App.lastAnswer || {};
        const motiv = {
            sleep: (v) => v && (''+v).includes('Less') ? "Short nights add up. Even +20–30 minutes can boost energy tomorrow." : v && (''+v).includes('7') ? "Great sleep window — your recovery rhythm is on point." : "Aim for a steady schedule — consistency drives deeper rest.",
            activity: (v) => v && (''+v).includes('Rarely') ? "Small starts matter: a 10‑minute walk still counts — today’s the day." : v && (''+v).includes('5+') ? "Powerful routine — your heart and brain thank you." : "Consistency beats intensity. Keep moving and build momentum.",
            hydration: (v) => v && (''+v).includes('1') ? "Your cells are thirsty. Keep a bottle nearby — sip, don’t wait." : v && (''+v).includes('10') ? "Hydration hero — this keeps skin and energy stable." : "A steady sip routine can lift focus and mood.",
            nutrition: (v) => v && (''+v).includes('0') ? "Add one colorful serving today — simple, tangible, effective." : v && (''+v).includes('More') ? "Antioxidant‑rich — you’re feeding longevity." : "Try a ‘colors on the plate’ rule for balance.",
            processed_food: (v) => v && (''+v).includes('Daily') ? "Tiny swaps beat big overhauls — try one whole‑food swap today." : v && (''+v).includes('Rarely') ? "Nice baseline — your gut and skin benefit." : "Plan a quick snack kit to skip impulse grabs.",
            mindfulness: (v) => v==='Daily' ? "Calm is a skill — you’re practicing longevity." : v==='Never' ? "60 seconds of breathing shifts your nervous system — try now." : "Make micro‑pauses your superpower during the day.",
            mood: (v) => v && (''+v).toLowerCase().includes('stressed') ? "You’re not alone — short walks and breath cycles help quickly." : v && (''+v).toLowerCase().includes('happy') ? "That spark fuels better choices everywhere — keep it going." : "Label the mood, lighten the load — awareness already helps.",
            alcohol: (v) => v && (''+v).includes('8+') ? "Your sleep will love one dry day. Notice the morning after." : v==='None' ? "Clear head, clear gains — your biology likes it." : "Try a hydration chaser — better sleep, better recovery.",
            smoking: (v) => v && (''+v).toLowerCase().includes('daily') ? "Micro‑wins count: delay the first cigarette by 10 minutes." : v==='Never' ? "Massive long‑term edge — keep it that way." : "Swap one trigger routine for a quick breath walk.",
            screen_time: (v) => v && (''+v).includes('More than 6') ? "Screens steal sleep — set a tiny cutoff 15 minutes earlier tonight." : v && (''+v).includes('Less than 2') ? "Nice boundary — your circadian rhythm thanks you." : "Batch the scrolling — fewer switches, calmer brain."
        };
        if (la.key && typeof motiv[la.key] === 'function') {
            try { motivation = motiv[la.key](la.value) || ''; } catch (e) { motivation = ''; }
        }

        if (key === 'bmi_display') {
            goToStep('bmi'); // Switch to dedicated BMI step
            renderBmiResult();
            return;
        } else if (key === 'sleep_visual') {
            animationHTML = `<div class="w-full max-w-sm mx-auto"><div class="relative mx-auto my-3 w-48 h-48 sleep-animation-container flex items-center justify-center"><svg class="w-full h-full absolute inset-0" viewBox="0 0 120 120"><circle class="sleep-ring-bg" stroke-width="10" fill="transparent" cx="60" cy="60" r="52" /><circle id="sleep-ring-fg-anim" class="sleep-ring-fg" stroke-width="10" fill="transparent" cx="60" cy="60" r="52" style="stroke-dasharray: 327; stroke-dashoffset: 327;"/></svg><span class="sleep-star sm" style="top:12%; left:20%; animation-delay:.2s;"></span><span class="sleep-star" style="top:22%; left:70%; animation-delay:.8s;"></span><span class="sleep-star sm" style="bottom:18%; left:30%; animation-delay:.5s;"></span><span class="sleep-star lg" style="bottom:22%; right:18%; animation-delay:1.1s;"></span><div class="sleep-moon animate">&#127769;</div></div></div>`;
        } else if (key === 'activity_visual') {
            animationHTML = `<div class="w-full max-w-sm mx-auto bg-white p-6 rounded-2xl shadow-sm"><div class="font-semibold text-gray-600 text-center mb-4">Your Active Week</div><div class="activity-week flex justify-around gap-2" id="activity-week-anim">${['M','T','W','T','F','S','S'].map(d => `<div class="activity-day">${d}</div>`).join('')}</div></div>`;
        } else if (key === 'hydration_visual') {
            animationHTML = `<div class="w-full max-w-sm mx-auto"><div id="water-animation" class="w-48 h-48 mx-auto"></div></div>`;
        } else if (key === 'nutrition_visual') {
            animationHTML = `<div class="insight-card nutrition-card"><div class="insight-icon"></div><h3>Plant-Powered Score</h3><p>Every colorful serving supports cellular health.</p><div class="insight-meter"><div class="insight-meter-fill" id="nutrition-meter"></div></div><div class="insight-meter-labels"><span>0</span><span>3</span><span>6+</span></div></div>`;
        } else if (key === 'food_visual') {
            animationHTML = `<div class="w-full max-w-sm mx-auto bg-white p-6 rounded-2xl shadow-sm text-center"><div class="font-semibold text-gray-600 mb-3">Smart Swaps</div><div class="flex justify-center gap-3"><div class="px-3 py-2 rounded-lg bg-rose-100 text-rose-600 line-through"> Soda</div><div class="px-3 py-2 rounded-lg bg-emerald-100 text-emerald-700"> Water</div></div></div>`;
        } else if (key === 'mindfulness_visual') {
            animationHTML = `<div class="insight-card mindfulness-card"><div class="breath-circle"><div class="breath-pulse" id="mindfulness-pulse"></div></div><h3>Mindfulness Rhythm</h3><p id="mindfulness-cue">Inhale slowly</p></div>`;
        } else if (key === 'alcohol_visual') {
            animationHTML = `<div class="insight-card alcohol-card"><div class="insight-icon"></div><div class="glass-meter"><div class="glass-fill" id="alcohol-fill"></div></div><h3>Alcohol Balance</h3><p id="alcohol-tip">Even small breaks restore deeper sleep.</p></div>`;
        } else if (key === 'smoking_visual') {
            animationHTML = `<div class="w-full max-w-sm mx-auto text-center"><div class="mx-auto w-32 h-32 relative"><div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-2 h-16 bg-gray-400"></div><div class="absolute -top-2 left-1/2 -translate-x-1/2 w-6 h-6 bg-gray-200 rounded-full animate-ping"></div></div></div>`;
        } else if (key === 'screen_time_visual') {
            animationHTML = `<div class="insight-card screen-card"><div class="screen-device"><div class="screen-glow"></div><div class="screen-scan" id="screen-scan"></div></div><h3>Screen Time Pulse</h3><p id="screen-tip">Protect your evening wind-down routine.</p></div>`;
        }
        
        wrapper.innerHTML = `<div class="question-content animation-wrapper w-full question-content-enter flex-1 flex items-center justify-center flex-col gap-4">${animationHTML}${motivation ? `<p class='mt-4 text-center text-gray-700 max-w-sm mx-auto'>${motivation}</p>` : ''}</div>`;
        
        setTimeout(() => playAnimation(key), 100); 
        setTimeout(next, 2200);
    }

    function playAnimation(key) {
        if (key === 'sleep_visual') {
            const answer = App.userAnswers.sleep || "";
            let percent = 50;
            if (answer.startsWith("Less than 5")) percent = 25;
            else if (answer.startsWith("56")) percent = 50;
            else if (answer.startsWith("78")) percent = 90;
            else if (answer.startsWith("More than 8")) percent = 100;
            
            const ringEl = document.getElementById('sleep-ring-fg-anim');
            const circumference = 2 * Math.PI * 52; // For r=52
            if(ringEl) {
                ringEl.style.strokeDasharray = circumference;
                ringEl.style.strokeDashoffset = String(circumference - (percent / 100) * circumference);
            }
        } else if (key === 'activity_visual') {
            let days = 0;
            const answer = App.userAnswers.activity || "";
            if (answer.includes("5+")) {
                days = 7; 
            } else if (answer.includes("34") || answer.includes("3-4")) {
                days = 4;
            } else if (answer.includes("12") || answer.includes("1-2")) {
                days = 2;
            } else if (answer.includes("Rarely")) {
                days = 1;
            }
            
            const dayElements = document.querySelectorAll('#activity-week-anim .activity-day');
            if (dayElements.length > 0) {
                dayElements.forEach(day => day.classList.remove('active')); // Reset
                for (let i = 0; i < Math.min(days, 7); i++) {
                    setTimeout(() => { dayElements[i]?.classList.add('active'); }, i * 200);
                }
            }
        } else if (key === 'hydration_visual') {
            AnimationManager.add('water-animation', 'water.json');
        } else if (key === 'nutrition_visual') {
            const answer = App.userAnswers.nutrition || "";
            let percent = 40;
            if (answer.includes("0-1")) percent = 20;
            else if (answer.includes("2-3")) percent = 45;
            else if (answer.includes("4-5")) percent = 70;
            else if (answer.includes("More")) percent = 100;
            const meter = document.getElementById('nutrition-meter');
            if (meter) {
                requestAnimationFrame(() => {
                    meter.style.width = `${percent}%`;
                });
            }
        } else if (key === 'mindfulness_visual') {
            const pulse = document.getElementById('mindfulness-pulse');
            const cue = document.getElementById('mindfulness-cue');
            const answer = App.userAnswers.mindfulness || "";
            const durations = { 'Never': 3.6, 'Sometimes': 3.1, 'Weekly': 2.7, 'Daily': 2.3 };
            const duration = durations[answer] || 3;
            if (pulse) {
                pulse.style.setProperty('--breath-duration', `${duration}s`);
                pulse.classList.add('breathing');
            }
            if (cue) {
                cue.textContent = 'Inhale slowly';
                setTimeout(() => { cue.textContent = 'Gentle pause'; }, 600);
                setTimeout(() => { cue.textContent = 'Exhale for four'; }, 1300);
            }
        } else if (key === 'alcohol_visual') {
            const answer = App.userAnswers.alcohol || "";
            const map = {
                'None': { fill: 8, tip: 'Rested mornings stay your norm.' },
                '1-3 drinks': { fill: 35, tip: 'Keep a glass of water between pours.' },
                '4-7 drinks': { fill: 65, tip: 'Plan one lighter night for deeper sleep.' },
                '8+ drinks': { fill: 90, tip: 'Two dry days reboot recovery and focus.' }
            };
            const config = map[answer] || { fill: 45, tip: 'Buffer with hydration and true rest days.' };
            const fillEl = document.getElementById('alcohol-fill');
            const tipEl = document.getElementById('alcohol-tip');
            if (tipEl) tipEl.textContent = config.tip;
            if (fillEl) {
                requestAnimationFrame(() => {
                    fillEl.style.height = `${config.fill}%`;
                });
            }
        } else if (key === 'screen_time_visual') {
            const answer = App.userAnswers.screen_time || "";
            let duration = 3;
            let tip = 'Protect your evening wind-down routine.';
            if (answer.includes('Less than 2')) {
                duration = 3.6;
                tip = 'Nice boundaries  your eyes and sleep thank you.';
            } else if (answer.includes('2-4')) {
                duration = 3;
                tip = 'Set a soft limits timer to keep evenings calm.';
            } else if (answer.includes('4-6')) {
                duration = 2.4;
                tip = 'Batch notifications to free up recovery time.';
            } else if (answer.includes('More than 6')) {
                duration = 2;
                tip = 'Try a 30-minute digital sunset to reset sleep.';
            }
            const tipEl = document.getElementById('screen-tip');
            if (tipEl) tipEl.textContent = tip;
            const scanEl = document.getElementById('screen-scan');
            if (scanEl) {
                scanEl.style.animationDuration = `${duration}s`;
                scanEl.classList.add('active');
            }
        }
    }
    
    function renderBmiResult() {
        const heightM = App.userAnswers.height / 100;
        const weightKg = App.userAnswers.weight;
        const gender = App.userAnswers.gender;
        const bmi = (weightKg / (heightM * heightM));

        const categories = [
            { max: 16, img: 'under16', title: 'Severely Underweight', desc: 'Extremely low body mass.', color: '#43B7FF' },
            { max: 18.4, img: '16-18.4', title: 'Underweight', desc: 'Below healthy weight.', color: '#33C75A' },
            { max: 24.9, img: '18.5-24.9', title: 'Normal Weight', desc: 'Ideal weight range.', color: '#FBF447' },
            { max: 29.9, img: '25.0-29.9', title: 'Overweight', desc: 'Slightly above normal. Risk of heart and metabolic issues.', color: '#FFA64D' },
            { max: 34.9, img: '30-above', title: 'Obesity (Class I)', desc: 'Increased health risk.', color: '#FF7D7E' },
            { max: 39.9, img: '30-above', title: 'Obesity (Class II)', desc: 'High health risk.', color: '#FF7D7E' },
            { max: Infinity, img: '30-above', title: 'Obesity (Class III)', desc: 'Very high health risk.', color: '#FF7D7E' }
        ];
        const result = categories.find(c => bmi < c.max);
        const prefix = gender === 'female' ? 'f' : 'm';
        
        document.getElementById('bmi-image').src = `${prefix}-${result.img}.svg`;
        document.getElementById('bmi-category').textContent = result.title;
        document.getElementById('bmi-description').textContent = result.desc;

        const minBmi = 15, maxBmi = 40; 
        const normalizedBmi = Math.max(0, Math.min(1, (bmi - minBmi) / (maxBmi - minBmi)));
        const thumbBottomPosition = normalizedBmi * 100;
        
        const bmiThumb = document.getElementById('bmi-thumb');
        const bmiValueDisplay = document.getElementById('bmi-value-display');
        
        bmiValueDisplay.style.setProperty('--thumb-position', `${thumbBottomPosition}%`);
        bmiThumb.style.bottom = `${thumbBottomPosition}%`;

        // Dynamic color along scale (blue -> green -> yellow -> orange -> red)
        const stops = [
            { t: 0.0,  c: [0x43, 0xB7, 0xFF] }, // blue
            { t: 0.33, c: [0x33, 0xC7, 0x5A] }, // green
            { t: 0.60, c: [0xFB, 0xF4, 0x47] }, // yellow
            { t: 0.80, c: [0xFF, 0xA6, 0x4D] }, // orange
            { t: 1.0,  c: [0xFF, 0x7D, 0x7E] }  // red
        ];
        const clamp01 = (x) => Math.max(0, Math.min(1, x));
        const lerp = (a,b,t) => a + (b - a) * t;
        const toHex = (rgbArr) => '#' + rgbArr.map(v => Math.round(v).toString(16).padStart(2,'0')).join('');
        const colorAt = (t) => {
            t = clamp01(t);
            for (let i = 0; i < stops.length - 1; i++) {
                const a = stops[i], b = stops[i+1];
                if (t <= b.t) {
                    const local = (t - a.t) / (b.t - a.t);
                    const rgb = [0,1,2].map(ch => lerp(a.c[ch], b.c[ch], local));
                    return toHex(rgb);
                }
            }
            return toHex(stops[stops.length - 1].c);
        };

        let currentBmi = 0;
        const startTimestamp = performance.now();
        const duration = 1500;

        const animateBmiValue = (timestamp) => {
            const elapsed = timestamp - startTimestamp;
            const progress = Math.min(elapsed / duration, 1);
            currentBmi = progress * bmi;
            bmiValueDisplay.textContent = currentBmi.toFixed(1);
            const tNow = clamp01((currentBmi - minBmi) / (maxBmi - minBmi));
            bmiValueDisplay.style.color = colorAt(tNow);

            if (progress < 1) {
                requestAnimationFrame(animateBmiValue);
            } else {
                bmiValueDisplay.textContent = bmi.toFixed(1);
                bmiValueDisplay.style.color = colorAt(normalizedBmi);
            }
        };
        requestAnimationFrame(animateBmiValue);
        
        document.getElementById('bmi-continue-btn').onclick = next;
    }

    // /quiz-new.html

        async function startAnalysis() {
            goToStep('loading');
            //    
            if (App.sessionId) {
                fetch('/.netlify/functions/quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'endQuiz',
                        sessionId: App.sessionId
                    })
                }).catch(err => console.error('Failed to save quiz end time:', err));
            }
            AnimationManager.add('loading-animation', 'loader.json');
            const analysisStepsContainer = document.getElementById('analysis-steps');
            analysisStepsContainer.innerHTML = '';
            const steps = ["Analyzing lifestyle data...", "Calculating metabolic rate...", "Processing facial biomarkers...", "Compiling wellness report..."];
            
            //        
            for (let i = 0; i < steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 800));
                const item = document.createElement('div');
                item.className = 'analysis-step';
                const circle = document.createElement('span');
                circle.className = 'circle';
                const text = document.createElement('span');
                text.className = 'step-text';
                text.textContent = steps[i];
                item.appendChild(circle);
                item.appendChild(text);
                analysisStepsContainer.appendChild(item);
                requestAnimationFrame(() => item.classList.add('show'));
                setTimeout(() => circle.classList.add('done'), 350);
            }

            try {
                const response = await fetch('/.netlify/functions/generateProfile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: App.sessionId })
                });

                // ---    ---
                // ,     ( 200-299)
                if (!response.ok) {
                    //      
                    const errorData = await response.json().catch(() => {
                        //     JSON,   ,   
                        return { error: 'The server responded with an unexpected error.' };
                    });
                    //      ,   
                    throw new Error(errorData.error || ('Server error: ' + response.status));
                }
                
                //      response.ok === true
                console.log('Profile generated successfully, redirecting...');
                window.location.href = `profile.html?session_id=${App.sessionId || ''}`;

            } catch (error) {
                //       ,   
                console.error('Failed to generate profile:', error);
                analysisStepsContainer.innerHTML = `<p class="text-red-600 font-bold text-lg">An error occurred while creating your profile.</p><p class="text-gray-600 mt-2">${error.message}</p><p class="mt-4"><a href="#" onclick="location.reload()" class="text-blue-600 font-semibold underline">Please click here to try again.</a></p>`;
            }
        }
    
    //    openCamera   

async function openCamera() {
    try {
        await LibraryLoader.loadFaceMeshLibraries();
    } catch (error) {
        alert('Failed to load camera AI libraries. Please check your internet connection and try again.');
        return;
    }

    const cameraModal = document.getElementById('camera-modal');
    const cameraContainer = document.getElementById('camera-container');
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    
    cameraModal.classList.add('active');
        
    //   
if (!App.faceMesh) {
    try {
        App.faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        App.faceMesh.onResults(onFaceMeshResults);
        await App.faceMesh.initialize();
    } catch (error) {
        console.error("Failed to initialize FaceMesh:", error); //   
        alert('Failed to initialize AI model for camera. Please try again.');
        closeCamera(); 
        return;
    }
}

    try {
        const videoConstraints = {
            video: {
                facingMode: 'user',
                aspectRatio: { ideal: 3 / 4 },
                height: { ideal: 1080 }
            }
        };
        
        App.cameraStream = await navigator.mediaDevices.getUserMedia(videoConstraints);
        video.srcObject = App.cameraStream;
        
        video.addEventListener('loadeddata', () => {
            // ---     ---
            const videoRatio = video.videoWidth / video.videoHeight;
            
            //    (90%   )
            const maxWidth = cameraModal.clientWidth * 0.9;
            const maxHeight = cameraModal.clientHeight * 0.9;
            
            let finalWidth, finalHeight;

            //      
            if ((maxWidth / maxHeight) > videoRatio) {
                //    ,   ->   
                finalHeight = maxHeight;
                finalWidth = finalHeight * videoRatio;
            } else {
                //    ,   ->   
                finalWidth = maxWidth;
                finalHeight = finalWidth / videoRatio;
            }

            //       
            cameraContainer.style.width = `${finalWidth}px`;
            cameraContainer.style.height = `${finalHeight}px`;

            video.style.width = `${finalWidth}px`;
            video.style.height = `${finalHeight}px`;

            canvas.style.width = `${finalWidth}px`;
            canvas.style.height = `${finalHeight}px`;
            
            // ---    ---

            cameraLoop();
        });

    } catch (err) {
        console.error("Camera Error:", err);
        let message = "Camera access was denied. Please allow camera access in your browser settings to continue.";
        if (window.location.protocol !== 'https:') {
            message += "\n\nNOTE: Camera access requires a secure connection (https://) or a local server (localhost).";
        }
        alert(message);
        closeCamera();
    }
}

    function closeCamera() {
        const cameraModal = document.getElementById('camera-modal');
        const guideBox = document.getElementById('camera-guide-box');
        if (App.cameraStream) App.cameraStream.getTracks().forEach(track => track.stop());
        cancelAnimationFrame(App.cameraAnimFrame);
        clearTimeout(App.captureTimeout);
        App.captureTimeout = null;
        cameraModal.classList.remove('active');
        if(guideBox) guideBox.classList.remove('locked');
    }
    
    async function cameraLoop() {
        const video = document.getElementById('camera-video');
        if (video.readyState >= 2) {
           await App.faceMesh.send({image: video});
        }
        App.cameraAnimFrame = requestAnimationFrame(cameraLoop);
    };

    function onFaceMeshResults(results) {
        const guideBox = document.getElementById('camera-guide-box');
        const guideText = document.getElementById('camera-guide-text');
        const canvas = document.getElementById('camera-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        ctx.clearRect(0,0,canvas.width, canvas.height);

        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            const landmarks = results.multiFaceLandmarks[0];
            
            if (App.faceMeshDrawState.startTime === null) {
                App.faceMeshDrawState.startTime = performance.now();
            }
            const elapsed = performance.now() - App.faceMeshDrawState.startTime;
            const finalOpacity = 0.3; 
            const opacity = Math.min(1, elapsed / App.faceMeshDrawState.duration) * finalOpacity;

            if (window.drawConnectors && window.FACEMESH_TESSELATION) {
                drawConnectors(ctx, landmarks, window.FACEMESH_TESSELATION, {color: `rgba(222, 190, 169, ${opacity})`, lineWidth: 1});
            }

            if (isFaceCentered(landmarks)) {
                guideBox.classList.add('locked');
                guideText.textContent = 'Perfect, hold still!';
                if (!App.captureTimeout) {
                    App.captureTimeout = setTimeout(takePhoto, 2000);
                }
            } else {
                guideBox.classList.remove('locked');
                guideText.textContent = 'Center your face in the oval';
                clearTimeout(App.captureTimeout);
                App.captureTimeout = null;
            }
        } else {
            App.faceMeshDrawState.startTime = null; 
            guideBox.classList.remove('locked');
            guideText.textContent = 'Center your face in the oval';
            clearTimeout(App.captureTimeout);
            App.captureTimeout = null;
        }
    }

    function isFaceCentered(landmarks) {
        const nose = landmarks[4];
        return nose.x > 0.3 && nose.x < 0.7 && nose.y > 0.3 && nose.y < 0.7 && nose.z < -0.03;
    }

    function takePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('photo-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const photoDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        
        App.lastPhotoDataUrl = photoDataUrl;
        document.getElementById('selfie-preview-img').src = photoDataUrl;

        closeCamera();
        goToStep('selfie-confirm');
    }

    
    function initMenu() {
        const menuBtn = document.getElementById('burger-menu-btn');
        const closeBtn = document.getElementById('close-menu-btn');
        const overlay = document.getElementById('menu-overlay');
        const menu = document.getElementById('side-menu');
        const toggleMenu = () => {
            overlay.classList.toggle('active');
            menu.classList.toggle('active');
        };
        menuBtn.addEventListener('click', toggleMenu);
        closeBtn.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
    }

    // Utility: resize any image file to JPEG DataURL (maxSide px)
    async function resizeToJpegDataUrl(file, maxSide = 1500) {
        const blobUrl = URL.createObjectURL(file);
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = blobUrl; });
        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        const scale = Math.min(1, maxSide / Math.max(w, h));
        const tw = Math.max(1, Math.round(w * scale));
        const th = Math.max(1, Math.round(h * scale));
        const canvas = document.createElement('canvas');
        canvas.width = tw; canvas.height = th;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, tw, th);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        URL.revokeObjectURL(blobUrl);
        return dataUrl;
    }
    // Global loader helpers and session readiness util
    function showGlobalLoader(message = 'Preparing your quiz...') {
        const overlay = document.getElementById('global-loader');
        const textEl = document.getElementById('global-loader-text');
        if (textEl) textEl.textContent = message;
        if (overlay) overlay.classList.remove('hidden');
    }
    function hideGlobalLoader() {
        const overlay = document.getElementById('global-loader');
        if (overlay) overlay.classList.add('hidden');
    }
    let sessionPromise = null;
    async function ensureSessionReady() {
        if (App.sessionId) return App.sessionId;
        if (sessionPromise) return sessionPromise;
        sessionPromise = startQuizSession();
        try {
            await sessionPromise;
            return App.sessionId;
        } finally {
            sessionPromise = null;
        }
    }

    async function startQuizSession() {
    const startBtn = document.getElementById('start-quiz-btn');
    let retryCount = 0;
    const maxRetries = 3;
    
    //     
    const attemptSessionCreation = async () => {
        try {
            //       
            const getDeviceType = () => {
    const userAgent = navigator.userAgent.toLowerCase();
    let os = 'Unknown';
    if (/iphone|ipad|ipod/.test(userAgent)) os = 'iOS';
    else if (/android/.test(userAgent)) os = 'Android';
    else if (/windows phone/.test(userAgent)) os = 'Windows Phone';
    else if (/mac os x/.test(userAgent)) os = 'macOS';
    else if (/windows/.test(userAgent)) os = 'Windows';
    else if (/linux/.test(userAgent)) os = 'Linux';

    let device = 'Desktop';
    if (window.innerWidth < 768) device = 'Mobile';
    else if (window.innerWidth < 1024) device = 'Tablet';
    return `${device}/${os}`;
};
const deviceType = getDeviceType();
            const urlParams = new URLSearchParams(window.location.search);
            const trafficSource = urlParams.get('utm_source') || urlParams.get('ref') || 'direct';
            
            const response = await fetch('/.netlify/functions/quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'startSession',
                    deviceType: deviceType,
                    source: trafficSource
                })
            });
            
            if (!response.ok) {
                throw new Error(`Could not start session. Status: ${response.status}`);
            }
            
            const data = await response.json();
            if (!data.sessionId) {
                throw new Error('Session ID not received from server');
            }
            
            App.sessionId = data.sessionId;
            console.log('Session successfully started:', App.sessionId);
            if (typeof fbq === 'function') { fbq('track', 'ViewContent'); }
            //  sessionId  sessionStorage   
            sessionStorage.setItem('quiz_session_id', App.sessionId);
            
            //       
            if(startBtn) {
                startBtn.disabled = false;
                startBtn.textContent = "Let's start";
            }
            hideGlobalLoader();
            
            return true;
            
        } catch (error) {
            console.error(`Session creation attempt ${retryCount + 1} failed:`, error);
            retryCount++;
            
            if (retryCount < maxRetries) {
                //     ( )
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, retryCount)));
                return attemptSessionCreation();
            } else {
                throw error;
            }
        }
    };
    
    //   
    try {
        await attemptSessionCreation();
        return true;
    } catch (error) {
        console.error('CRITICAL: Failed to start session after all retries:', error);
        
        if(startBtn) {
            startBtn.textContent = 'Connection Error - Refresh Page';
            startBtn.classList.add('bg-red-500');
        }
        
        //      
        const errorModal = document.createElement('div');
        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        errorModal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h2 class="text-xl font-bold text-red-600 mb-2">Connection Error</h2>
                <p class="text-gray-700 mb-4">We couldn't connect to our servers. This might be due to:</p>
                <ul class="list-disc list-inside text-gray-600 mb-4">
                    <li>Poor internet connection</li>
                    <li>Browser blocking cookies</li>
                    <li>Ad blocker interference</li>
                </ul>
                <div class="flex gap-3">
                    <button onclick="location.reload()" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        Try Again
                    </button>
                    <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(errorModal);
        throw error;
    }
}


    // --- App Initialization ---
    const startBtnEl = document.getElementById('start-quiz-btn');
    const handleStart = async (event) => {
        if (event && event.type === 'touchend') event.preventDefault();
        if (startBtnEl) startBtnEl.disabled = true;
        try {
            showGlobalLoader('Preparing your quiz...');
            await ensureSessionReady();
            hideGlobalLoader();
            next();
        } catch (err) {
            hideGlobalLoader();
            if (startBtnEl) {
                startBtnEl.disabled = false;
                startBtnEl.textContent = 'Try Again';
            }
        }
    };

    if (startBtnEl) {
        startBtnEl.addEventListener('click', handleStart);
        startBtnEl.addEventListener('touchend', handleStart);
    }
    document.getElementById('back-btn').addEventListener('click', previous);
    document.getElementById('close-camera-btn').addEventListener('click', closeCamera);
    document.getElementById('selfie-confirm-btn').addEventListener('click', processAndSavePhoto);
    document.getElementById('selfie-retake-btn').addEventListener('click', openCamera);

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });
    document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));

    setVh();
    window.addEventListener('resize', setVh);
    startQuizSession();
    goToStep('landing');
    initMenu();

    function adjustMainPadding() {
        const header = document.getElementById('quiz-header');
        const main = document.getElementById('steps-wrapper');
        if (header && main) {
            const headerHeight = header.offsetHeight || 0;
            document.documentElement.style.setProperty('--header-offset', `${headerHeight}px`);
            // Use CSS variable for absolute-positioned steps; no extra padding needed
            main.style.paddingTop = '0px';
        }
    }
    window.addEventListener('resize', adjustMainPadding);
    adjustMainPadding();
});
</script>

</body>
</html>








